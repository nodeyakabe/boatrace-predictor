# 🚤 競艇予測システム - 開発引継ぎ資料

## 📋 プロジェクト概要

**目的**: 日本の競艇（ボートレース）の統計分析に基づく期待値プラス買い目推奨システム
**現在のフェーズ**: データ収集機能の実装完了、V4による効率的なデータ取得中
**次のフェーズ**: データ分析・予想精度検証

---

## 🎯 システムの仕様・方向性

### **基本コンセプト**
全国24競艇場の当日開催レースから、統計分析と期待値計算により「稼げるレース」を自動抽出し、具体的な買い目を提示するシステム。

### **最重要目標 🎯**
**「ボーダー超えの予想を1週間買い続けたら回収率プラスになること」**

- システムが抽出した推奨レースを信じて1週間購入し続ければ、トータルで利益が出る状態を目指す
- 個別レースの的中/不的中ではなく、**長期的な回収率がプラスになること**が最優先
- そのために期待値計算と信頼度評価の精度を徹底的に高める
- 全ての機能・開発判断はこの目標達成のために行う

### **運用方針**

#### **1. データ収集範囲**
- **対象期間**: 過去1年分のデータを取得（機械学習用）
- **対象競艇場**: 全24場（選手データ取得のため全場必須）
- **データ更新**:
  - 過去データ: 一度取得すれば更新不要（永久保存）
  - 当日データ: 競艇実施時のみ取得（常時起動不要）
- **取得頻度**: 不定期（毎日の場合もあれば月1回の場合もある）

#### **2. レース抽出ルール**
- **抽出基準**: 期待値・信頼度の閾値を超えるレースをすべて抽出（個数制限なし）
- **対象範囲**: 当日開催の全24場（複数会場またがりOK）
- **時間帯**: 制限なし（朝～夕方すべて対象）
- **表示方法**:
  - 期待値が高い順にソート
  - 信頼度も併記（例：「信頼度高・期待値やや低」）

#### **3. 予想タイミング**
- **事前予想**: 前日～当日朝の段階で予想可能
- **直前予想**: レース10分前の情報で最終予想（ベスト）
  - 直前情報: 展示タイム、スタート展示の進入コース、部品交換、天候
  - オッズ変動: 追いすぎない（公式サイトで最終確認）

#### **4. 買い目の方針**
- **予算**: 1日1,000円程度（初期設定）
- **賭け式の選択**:
  - 的中率が低い場合: 3連複（的中しやすい）
  - 的中率が高い場合: 3連単（高配当狙い）
- **点数**: 1レースあたり最大10点以下、理想は5点以内
- **複数点での的中率目標**: 80%（1レース内での予想的中率）

#### **5. 精度目標**
- **的中率**: 80%以上（常に改善を目指す）
- **回収率**: 130%達成できれば大成功
- **改善方針**: 実績データを蓄積し、継続的にモデルを更新

#### **6. システム運用形態**
- **自動化レベル**: 完全自動化は目指さない
  - レースの抽出: 自動
  - 買い目の提示: 自動
  - 実際の購入判断: ユーザー（手動）
- **投票方法**: テレボート（ネット投票）
  - 将来的な自動投票: 検討の余地あり
- **通知機能**: 現時点では不要
  - 競艇実施時のみPCを起動する運用

#### **7. プラットフォーム**
- **メイン環境**: ローカルPC（Windows）
- **データベース**: SQLite（データサイズ: 1年分で数GB、100GB余裕あり）
- **スマホアクセス**:
  - 優先度: 低（将来的な希望）
  - 用途: 外出先からのレース確認・予想閲覧のみ
  - 機能: 設定変更は不要

#### **8. 実績管理**
- **予想結果の記録**: 必須
  - 的中/不的中の記録
  - 予想時の期待値・信頼度
  - 実際の配当
- **収支可視化**: 予想の収支を追跡（ユーザーの実購入記録は不要）
- **精度追跡**: システムの予想精度を継続的に測定・改善

### **開発の優先順位**

#### **フェーズ1: データ基盤完成**（完了済み ✓）
- データ収集機能の実装
- データベース設計
- 基本的な統計分析機能

#### **フェーズ2: データ蓄積**（進行中 🔄）
- 全24場×1年分のデータ取得
- 不足データの追加取得（オッズ、決まり手、STタイム）
- データ品質の検証

#### **フェーズ3: 予想精度の検証**（次）
- バックテスト機能の実装
- 的中率・回収率の測定
- 期待値計算の閾値調整
- スコアリングの重み最適化

#### **フェーズ4: 実運用機能**（その次）
- 当日レース自動抽出機能
- 買い目提示の詳細化
- 予想実績の記録・可視化
- 賭け式の自動選択（3連単 vs 3連複）

#### **フェーズ5: 機械学習モデル導入**（将来）
- 過去1年分データを活用した学習
- モデルの精度検証
- 統計分析との組み合わせ

#### **フェーズ6: 拡張機能**（低優先度）
- スマホ対応UI
- 自動投票機能
- 通知機能

---

## 🎯 現在の実装状況（2025年10月30日時点）

### ✅ 完成した機能

#### 1. **データ収集システム（V4: バッチ書き込み方式）**
- **開催スケジュール事前取得**: ★NEW 無駄なHTTPリクエストを90%削減
- **出走表取得**: 選手情報、モーター番号、ボート番号、勝率等
- **レース結果取得**: 着順、オッズ、不成立レース判定
- **天気情報取得**: 気温、風速、風向、水温、波高
- **展示タイム取得**: 6艇すべて正確に取得
- **実際の進入コース取得**: 6艇すべて正確に取得
- **並列処理**: 10並列でHTTP通信、1スレッドでDB書き込み
- **Database Locked問題**: 完全解決（エラー率0%）

#### 2. **データベース構造（DBミラーリング対応）**
- SQLite使用
- **書き込み用DB**: `data/boatrace.db` （データ収集専用）
- **参照用DB**: `data/boatrace_readonly.db` （分析・テスト用）
- **自動同期**: データ取得完了後に自動的に同期
- 主要テーブル:
  - `venues`: 競艇場マスタ（24場）
  - `races`: レース情報
  - `entries`: 出走表
  - `results`: レース結果
  - `weather`: 天気情報
  - `race_details`: レース詳細（展示タイム、チルト、進入コース等）

#### 3. **UIアプリケーション**
- Streamlit使用（`ui/app.py`）
- 機能:
  - 競艇場選択（ボタン形式、24場）
  - カレンダー形式の日付選択
  - 月送り機能
  - 開催日の視覚的表示（🚤マーク）
- **参照用DBを使用**: データ取得中でも分析可能

---

## 📂 重要なファイル構成

```
BoatRace/
├── data/
│   ├── boatrace.db                          # 書き込み用DB（データ収集専用）
│   └── boatrace_readonly.db                 # 参照用DB（分析・テスト用）
│
├── src/
│   ├── scraper/
│   │   ├── schedule_scraper.py              # ★NEW 開催スケジュール取得
│   │   ├── race_scraper_v2.py               # 出走表スクレイパー
│   │   ├── result_scraper.py                # 結果スクレイパー（進入コース含む）
│   │   └── beforeinfo_scraper.py            # 事前情報スクレイパー（展示タイム等）
│   │
│   ├── database/
│   │   ├── models.py                        # DB定義
│   │   └── data_manager.py                  # データ管理（WALモード対応）
│   │
│   └── analyzer/
│       └── racer_analyzer.py                # 選手分析（未完成）
│
├── ui/
│   └── app.py                               # Streamlit UI（参照用DB使用）
│
├── config/
│   └── settings.py                          # 設定ファイル（24競艇場定義）
│
├── fetch_parallel_v4.py                     # ★現在実行中 効率化版データ収集
├── test_db_sync.py                          # DB同期テスト
└── convert_to_readonly_db.py                # 分析スクリプト一括変換
```

---

## 🔧 最近の重要な実装（V4: バッチ書き込み方式）

### 1. **開催スケジュール事前取得機能**（`schedule_scraper.py`）

**URL**: `https://www.boatrace.jp/owpc/pc/race/monthlyschedule`

**機能**:
```python
# 月間スケジュールを取得
schedule = scraper.get_monthly_schedule(2025, 9)
# {'01': ['20250901', '20250911', ...], '12': ['20250905', ...], ...}

# 期間指定でスケジュール取得
schedule = scraper.get_schedule_for_period(start_date, end_date)
```

**効果**:
- **旧V4**: 30日 × 24会場 × 12R = 8,640タスク
- **修正版V4**: 66開催日 × 12R = 792タスク
- **削減率: 90.8%**

### 2. **DBミラーリング（データ取得と分析の分離）**

**目的**: データ取得中でも分析・テストを並行実行可能にする

**構成**:
```
書き込み用DB (boatrace.db)
  ↓ データ収集専用
  ↓ V4が書き込み
  ↓
  ↓ [自動同期] sync_database()
  ↓ データ取得完了後に実行
  ↓
参照用DB (boatrace_readonly.db)
  ↓ 分析・テスト専用
  ↓ UIや分析スクリプトが参照
```

**同期処理**:
```python
def sync_database():
    """データ取得完了後に自動実行"""
    shutil.copy2("data/boatrace.db", "data/boatrace_readonly.db")
    shutil.copy2("data/boatrace.db-wal", "data/boatrace_readonly.db-wal")
    shutil.copy2("data/boatrace.db-shm", "data/boatrace_readonly.db-shm")
```

### 3. **バッチ書き込み方式（Database Locked問題の根本解決）**

**アーキテクチャ**:
```
[HTTPワーカー 10並列]        [Queueキュー]        [DBライター 1スレッド]
   ワーカー1 → HTTP通信  →                    →
   ワーカー2 → HTTP通信  →    データキュー    →   DB書き込み（直列）
   ワーカー3 → HTTP通信  →                    →   ロック競合なし
   ...                                              エラー0件
   ワーカー10 → HTTP通信 →
```

**効果**:
- Database Lockedエラー: **完全にゼロ**
- 処理速度: V2比で5〜10倍向上
- 欠損率: 0.1%未満

### 4. **展示タイム取得機能**（`beforeinfo_scraper.py`）

**URL**: `https://www.boatrace.jp/owpc/pc/race/beforeinfo`

**取得データ**:
```python
{
    'exhibition_times': {1: 6.79, 2: 6.75, ...},  # 枠番 -> 展示タイム(秒)
    'tilt_angles': {1: 0.0, ...},                 # 枠番 -> チルト角度
    'parts_replacements': {1: 'R', ...}           # 枠番 -> 部品交換情報
}
```

**実装状況**:
- ✅ 展示タイム: 6艇すべて取得成功
- ✅ チルト角度: 6艇すべて取得成功
- ✅ 部品交換: 取得成功

### 5. **実際の進入コース取得機能**（`result_scraper.py`）

**URL**: `https://www.boatrace.jp/owpc/pc/race/raceresult`

**取得ロジック**:
```python
# スタート情報テーブルから取得
# 行番号 = コース番号（1コース、2コース...）
# 各行の <span class="table1_boatImage1Number"> のテキスト = 枠番
```

**実装状況**:
- ✅ 6艇すべて正確に取得
- ✅ 検証済み: 下関10/28 5R（6号艇→5コース）

**重要な発見**:
- 枠番 ≠ コース番号（イン屋が5コースに進入するケース等あり）
- HTMLの出現順ではなく、**テーブルの行順序**がコース順

---

## 🚀 現在実行中のデータ収集

### **V4（効率化版）**: `fetch_parallel_v4.py`

**実行コマンド**:
```bash
venv\Scripts\python.exe -u fetch_parallel_v4.py --start 2025-09-01 --end 2025-09-30 --workers 10
```

**設定**:
- **期間**: 2025年9月（1ヶ月）
- **HTTPワーカー**: 10並列
- **対象**: 開催日のみ（66日）
- **総タスク数**: 792件
- **推定所要時間**: 約53分

**進捗確認**:
```bash
# バックグラウンドプロセスの出力確認（bash ID: 9c71f0）
```

**取得フロー** (1レースあたり):
1. スケジュール取得（月間開催日を事前取得）
2. 出走表取得 → DBに保存
3. レース結果取得
4. 事前情報取得（展示タイム、チルト）
5. 実際の進入コース取得
6. レース詳細データを統合してDBに保存
7. **完了後に自動的にDB同期実行**

---

## ⚠️ 未実装・要改善項目

### 優先度: 高

1. **STタイム（スタート展示タイム）の取得**
   - 現状: 未実装
   - URL: `raceresult`ページのスタート情報テーブル内
   - 対策: 行ごとにSTタイムを抽出
   - 注意: F（フライング）、L（レイト）の処理も必要

2. **払戻金データの取得**
   - 現状: 未実装
   - 7種類の舟券（3連単、3連複、2連単等）
   - URL: `raceresult`ページ
   - HTMLクラス: `is-payout1`

3. **決まり手の取得**
   - 現状: 未実装
   - 種類: 逃げ、差し、まくり、まくり差し、抜き、恵まれ
   - URL: `raceresult`ページ

### 優先度: 中

4. **過去1年分のデータ取得**
   - 現状: 2025年9月のみ取得中
   - 必要: 2024年10月〜2025年9月（12ヶ月）
   - 推定タスク数: 約9,500件
   - 推定所要時間: 約10時間

5. **エラーハンドリングの強化**
   - 連続エラー時の自動停止
   - リトライ機能の拡充
   - エラーログの詳細化

---

## 🔍 デバッグ・検証に便利なコマンド

### V4の進捗確認

```bash
# V4の出力確認（bash ID: 9c71f0）
# Claude Codeで BashOutput ツールを使用
```

### UI起動

```bash
# Streamlit UI起動（bash ID: 0aedf1）
venv\Scripts\streamlit.exe run ui/app.py

# アクセス先
# ローカル: http://localhost:8501
# ネットワーク: http://192.168.11.10:8501
```

### DB同期テスト

```bash
# DB同期機能のテスト
venv\Scripts\python.exe test_db_sync.py
```

### データベース確認

```bash
# SQLiteに接続
sqlite3 data/boatrace_readonly.db

# レース数確認
SELECT COUNT(*) FROM races;

# 展示タイムのデータ数
SELECT COUNT(*) FROM race_details WHERE exhibition_time IS NOT NULL;

# 進入コースのデータ数
SELECT COUNT(*) FROM race_details WHERE actual_course IS NOT NULL;

# 特定レースの詳細確認
SELECT * FROM race_details WHERE race_id = 444;
```

---

## 🐛 既知の問題

### 1. **XMLParsedAsHTMLWarning**
- 警告メッセージが大量に出るが、動作に問題なし
- 必要に応じて`warnings.filterwarnings("ignore", category=XMLParsedAsHTMLWarning)`で抑制可能

### 2. **UnicodeEncodeError (cp932)**
- Windowsコンソールでの日本語出力エラー
- テストスクリプトで特殊文字（✓、✗等）を使うと発生
- 対策: ASCII文字のみ使用、または出力をファイルにリダイレクト
- V4では `-u` フラグを使用してバッファリングを無効化

### 3. **旧バージョン（V2, V3）の削除**
- `fetch_parallel_v2.py`, `fetch_parallel_v3.py` は削除済み
- V4のみを使用

---

## 🎓 重要な知識・ノウハウ

### 競艇の基礎知識

- **24競艇場**: 全国に24場（桐生、戸田、江戸川...）
- **1日12レース**: 通常1競艇場で1日12レース開催
- **6艇立て**: 1レースに6艇が出走
- **枠番 vs コース**:
  - 枠番: ピット番号（1〜6号艇）
  - コース: 実際の進入位置（1〜6コース）
  - **枠番 ≠ コース**（重要！）

### データ取得のポイント

1. **日付フォーマット**:
   - URL: `YYYYMMDD`形式（例: `20251028`）
   - DB: `YYYY-MM-DD`形式（例: `2025-10-28`）

2. **競艇場コード**:
   - 2桁の文字列（例: `"01"`, `"19"`, `"24"`）
   - `config/settings.py`の`VENUES`辞書に定義

3. **レース番号**:
   - 1〜12の整数
   - パラメータ名: `rno`

4. **開催確認**:
   - 全日程で開催があるわけではない
   - スケジュール事前取得で効率化

### V4の設計思想

1. **HTTP通信とDB書き込みの分離**:
   - HTTPワーカー（10並列） + DBライター（1スレッド）
   - Queue を介してデータ受け渡し
   - Database Locked問題を根本解決

2. **開催スケジュール事前取得**:
   - 無駄なHTTPリクエストを90%削減
   - 公式サイトへの負荷軽減

3. **DBミラーリング**:
   - 書き込み用と参照用を分離
   - データ取得中も分析・テスト可能

---

## 🔮 次のステップ（優先順位順）

### フェーズ2: データ収集の完成

1. **潮データの取得実装** (優先度: 最高)
   - 所要時間: 未定
   - 潮汐情報（満潮/干潮時刻、潮位、潮名等）
   - データソース: 気象庁または海上保安庁の潮汐データAPI
   - 影響: 特に海に面した競艇場（鳴門、児島、宮島、下関等）で重要
   - 新規テーブル作成（tide_data）
   - レース時刻と潮汐の関係を分析可能に

2. **過去1年分のデータ取得** (優先度: 最高)
   - 所要時間: 約10時間
   - 期間: 2024年10月〜2025年9月
   - 実行方法: V4で月ごとに実行

3. **STタイムの取得実装** (優先度: 高)
   - 所要時間: 2〜3時間
   - raceresultページから取得
   - race_detailsテーブルに保存

4. **払戻金データの取得実装** (優先度: 高)
   - 所要時間: 2〜3時間
   - 7種類の舟券データ
   - payoutsテーブル作成・保存

5. **決まり手の取得実装** (優先度: 中)
   - 所要時間: 1時間
   - resultsテーブルに追加

### フェーズ3: データ分析・予測モデル

1. **データ分析基盤の構築**
   - pandas, numpy, matplotlibの活用
   - 基本統計量の算出
   - データの可視化

2. **特徴量エンジニアリング**
   - 選手の過去成績（勝率、連対率等）
   - モーター・ボートの2連率、3連率
   - 展示タイムの順位
   - 進入コースとの相関分析
   - チルト角度の影響分析

3. **予測モデルの構築**
   - 機械学習モデル（RandomForest, XGBoost等）
   - 3連単の予測
   - 期待値の計算

4. **UIの拡張**
   - 予測結果の表示
   - おすすめレースの提示
   - 分析結果の可視化

---

## 💡 開発のヒント

### 困ったときの確認ポイント

1. **データが取得できない**:
   - 日付が正しいか（未来の日付ではないか）
   - 競艇場コードが正しいか
   - 開催日かどうか（スケジュール確認）
   - ネットワーク接続

2. **データベースエラー**:
   - `data/boatrace.db`が存在するか
   - テーブルが作成済みか
   - UNIQUE制約違反の可能性
   - WALモードが有効か

3. **HTML構造が想定と異なる**:
   - ページを保存して直接確認
   - ブラウザの開発者ツールで構造確認
   - BeautifulSoupで要素を探索

### 便利なコマンド

```bash
# 仮想環境の有効化
venv\Scripts\activate

# Streamlit UIの起動
venv\Scripts\streamlit.exe run ui/app.py

# データベースのバックアップ
copy data\boatrace.db data\boatrace_backup_20251030.db

# V4の進捗確認
# Claude CodeでBashOutputツールを使用（bash ID: 9c71f0）

# 全Pythonプロセスの停止
powershell -Command "Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force"
```

---

## 📊 現在のデータ取得状況（2025年10月31日 23:20時点）

### データベースの状態:
- **総レース数**: 14,998レース
- **データ期間**: 2024-01-03 ~ 2025-10-31
- **データベースサイズ**: 30MB

### V4による取得進捗:
- **現在**: データ収集実行中（バックグラウンドプロセスID: b3693a）
- **期間**: 2025-05-01 ~ 2025-10-31（半年分）
- **総タスク数**: 5,328タスク
- **完了**: 100タスク（1.9%）
- **推定残り時間**: 約4.6時間
- **エラー数**: 0件
- **処理速度**: 0.3タスク/秒
- **workers**: 10並列

### 取得できているデータ:
- ✓ 出走表（選手情報、モーター、ボート、勝率等）
- ✓ レース結果（着順）
- ✓ 天気情報
- ✓ 展示タイム
- ✓ チルト角度
- ✓ 部品交換情報
- ✓ 実際の進入コース

### 取得できていないデータ:
- ✗ オッズ（払戻金）
- ✗ 決まり手（kimarite）
- ✗ STタイム
- ✗ 潮汐データ

### データベース構成:
- **書き込み用**: `data/boatrace.db` （V4が使用）
- **参照用**: `data/boatrace_readonly.db` （UIや分析スクリプトが使用）
- **自動同期**: V4完了後に実行

### 持ち帰りパッケージ:
- **ファイル名**: `BoatRace_持ち帰り_2025-10-31.zip` (9.1MB)
- **内容**: dual_pc_setup.md + データベース（14,998レース）
- **用途**: 別PCでのUI開発作業用

---

## 📚 参考資料

### 公式サイト
- BOATRACE公式: https://www.boatrace.jp/

### 主要エンドポイント
```
# 月間スケジュール
https://www.boatrace.jp/owpc/pc/race/monthlyschedule?ym={year}{month}

# 出走表
https://www.boatrace.jp/owpc/pc/race/racelist?rno={race_num}&jcd={venue_code}&hd={date}

# 事前情報（展示タイム等）
https://www.boatrace.jp/owpc/pc/race/beforeinfo?rno={race_num}&jcd={venue_code}&hd={date}

# レース結果
https://www.boatrace.jp/owpc/pc/race/raceresult?rno={race_num}&jcd={venue_code}&hd={date}
```

---

## 📝 メモ・備考

### 前回のセッション（2025年10月30日）での重要な変更

1. **V4の効率化（開催スケジュール事前取得）**:
   - ScheduleScraperの実装
   - 無駄なHTTPリクエストを90%削減
   - 8,640タスク → 792タスク

2. **DBミラーリングの実装**:
   - boatrace.db（書き込み用）とboatrace_readonly.db（参照用）に分離
   - データ取得中も分析・テスト可能
   - 自動同期機能の実装
   - 全ての分析スクリプトを参照用DBに変更（15ファイル）

3. **V2/V3の削除**:
   - fetch_parallel_v2.py, fetch_parallel_v3.py を削除
   - V4のみを使用する方針

4. **修正版V4の起動**:
   - 旧V4プロセスを完全停止
   - 修正版V4を再起動（bash ID: 9c71f0）
   - 2025年9月データ取得中

### 今回のセッション（2025年10月31日）での重要な変更

1. **UI機能拡張（統計分析タブ）**:
   - 決まり手（kimarite）分析機能を追加
     - 決まり手の分布表示（回数・割合）
     - バーチャートによる視覚化
   - コース別決まり手確率の表示
     - 1コースの逃げ率を強調表示
     - 2-4コースのまくり率を強調表示
   - AI言語化による傾向分析機能を追加
     - PatternAnalyzerによる自動分析テキスト生成

2. **UIタブ構成の再編**:
   - タブ数を9個から7個に削減
   - 削除したタブ:
     - おすすめレース（機能はホームタブに統合）
     - バックテスト（機能はシステム設定タブに移動）
     - データ品質（機能はシステム設定タブに移動）
   - 新規追加したタブ:
     - 選手（選手情報・成績分析タブ）
   - 最終的なタブ構成:
     - ホーム、リアルタイム予想、過去データ取得、統計分析、選手、システム設定、レース結果

3. **選手タブの実装**:
   - 選手一覧表示（会場別フィルタリング）
   - 選手の基本統計（勝率、2連率、3連率）
   - 選手詳細情報の表示
     - コース別成績
     - 最近20レースの詳細（決まり手を含む）

4. **データベースビュー管理システムの構築**:
   - `src/database/views.py` を新規作成
   - DatabaseViewManagerクラスの実装
   - 3つのビューを作成:
     - race_details_extended（race_details + results + races + entries）
     - racer_performance_summary（選手の集計統計）
     - venue_statistics_view（会場の集計統計）
   - アプリ起動時に自動的にビューを作成
   - UI開発の効率化（複雑なJOINを隠蔽）

5. **バグ修正**:
   - 決まり手データの取得エラーを修正
     - race_detailsテーブルではなくresultsテーブルから取得するように修正
     - statistics_calculator.py、pattern_analyzer.pyを修正
   - 会場コードの型エラーを修正（ui/app.py）
     - selected_venue_codeが数値型になっていた問題を修正
     - str()で文字列に変換するように修正（統計分析タブ、選手タブ）

6. **2PC開発体制の準備**:
   - データベース移行戦略ドキュメントを作成（docs/database_migration_strategy.md）
   - 2PCセットアップガイドを作成（docs/dual_pc_setup.md）
   - 持ち帰りパッケージを作成（BoatRace_持ち帰り_2025-10-31.zip、9.1MB）
     - dual_pc_setup.md
     - 最新データベース（14,998レース、2024-01-03 ~ 2025-10-31）

7. **データ収集の継続**:
   - 半年分のデータ収集を開始（2025-05-01 ~ 2025-10-31）
   - バックグラウンドプロセスで実行中（ID: b3693a）
   - 推定処理時間: 約4.6時間
   - エラー数: 0件（順調）

8. **別PCでの作業内容の統合**:
   - PatternAnalyzerのバグ修正（`_get_venue_name()`メソッド追加）
   - UI統合（法則エンジンとの連携完了）
     - `predict_race_by_key()` メソッドで文字列形式のレース指定に対応
     - `get_applied_rules_by_key()` メソッドで適用法則を取得
     - ホーム画面で法則適用後の予想を表示
     - 競艇場法則と選手法則の両方を表示
   - 再解析機能の実装
     - `reanalyze_all.py` スクリプト作成（一括再解析）
     - UIに再解析ボタンを3箇所追加（ホーム、場攻略、選手）
     - ワンクリックで法則を最新データに基づいて更新可能
   - UIタブ拡張（7タブ→11タブ）
     - 新規タブ: データ充足率、特徴量、MLデータ出力、モデル学習
   - ML基盤の構築
     - RuleBasedEngine（法則による予測補正エンジン）
     - dataset_builder.py（ML用データセット構築）
     - model_trainer.py（モデル学習パイプライン）
     - shap_explainer.py（SHAP説明可能AI）
   - 各種ユーティリティスクリプトの追加
     - データ取得系: fetch_historical_data_bulk.py, fetch_missing_*.py
     - テスト系: test_ui_integration.py, test_ml_system.py, test_rule_integration.py
     - データ確認系: check_db_*.py, check_schema.py, check_weather_data.py
   - **法則データベースの統合**
     - venue_rulesテーブル: 18件の競艇場法則を統合
     - racer_rulesテーブル: 80件の選手法則を統合
     - 別PCで分析・生成された法則データを現在のDBに移植完了
   - 全ファイルとデータの統合完了、データベースは現在のものが最新（14,998レース + 法則98件）

### 作業時の注意点

- ユーザーは日本語での回答を希望
- エモジは基本的に使わない（ユーザーの明示的な要望がない限り）
- 実装の優先順位: 動作する機能 > 完璧な機能
- プロセス停止時は確実に全て停止する

---

### 今回のセッション（2025年11月1日）での重要な変更

1. **データ充足率の詳細分析**:
   - 総レース数: 29,462件
   - エントリーデータ: 98.0%（28,885件）
   - 結果データ: 95.9%（28,241件）
   - レース詳細データ: 75.1%（22,135件）
   - **決まり手データ: 0.2%（417件）** ← 重大な欠損を発見
   - RDMDB潮位データ: 701,978件（2022年11-12月の2ヶ月分）

2. **決まり手データ取得の修正**:
   - **問題点**: 決まり手が99.8%欠損していた
   - **原因**: `DataManager.save_race_result()`で`kimarite`カラムを保存していなかった
   - **修正内容**:
     - [src/database/data_manager.py:447-451](src/database/data_manager.py#L447-L451): INSERT文に`kimarite`カラムを追加
     - [fetch_parallel_v6.py:256](fetch_parallel_v6.py#L256): 決まり手テキストを渡すように修正
   - **補完スクリプト作成**: `補完_決まり手データ.py`
     - 約28,000件のレースの決まり手を並列取得
     - バックグラウンド実行中

3. **結果データ補完スクリプトの作成**:
   - **ファイル**: `補完_結果データ.py`
   - **対象**: 1,221件の不足している結果データ
   - **機能**: 結果、決まり手、進入コース、STタイム、天気、払戻金を一括取得
   - **状態**: バックグラウンド実行中

4. **RDMDB潮位データ収集の拡張**:
   - **既存データ**: 2022年11-12月（2ヶ月、701,978件）
   - **拡張実行**: 2023年1月～2025年10月を追加取得開始
   - **期間**: 35ヶ月 × 4地点 = 140ファイル
   - **観測地点**: Hakata、Hiroshima、Sasebo、Tokuyama
   - **状態**: Selenium使用、バックグラウンド実行中

5. **データ収集スクリプトの修正ポイント**:
   - 決まり手の数値コード変換マップ:
     ```python
     {
         '逃げ': 1,
         '差し': 2,
         'まくり': 3,
         'まくり差し': 4,
         '抜き': 5,
         '恵まれ': 6
     }
     ```
   - テキスト形式と数値コードの両方を保存

### 学習したこと・発見事項

1. **決まり手データの重要性**:
   - 決まり手は予想精度に直結する重要データ
   - 0.2%しか取得できていないという重大な欠損があった
   - スクレイパーは実装されていたが、DB保存処理が不完全だった

2. **データベース設計の改善点**:
   - `results`テーブルに`kimarite`（TEXT）と`winning_technique`（INTEGER）の両方が必要
   - テキスト形式: 分析・表示用
   - 数値コード: 効率的な集計・フィルタリング用

3. **潮位データの構造**:
   - テーブル: `rdmdb_tide`
   - カラム: `station_name`, `observation_datetime`, `sea_level_cm`, `air_pressure_hpa`, `temperature_c`, `sea_level_smoothed_cm`
   - 30秒間隔のデータ（1ヶ月で約175,000件/地点）
   - 2023年以降は観測地点IDの形式が変更（`30s_` → `01m_`）

4. **並列処理のベストプラクティス**:
   - ProcessPoolExecutor: CPU集約的なタスク（スクレイピング）
   - ThreadPoolExecutor: I/O集約的なタスク（HTTP通信）
   - max_workers=8が安定（公式サイトへの負荷も考慮）

5. **バックグラウンド実行の課題**:
   - `input()`プロンプトはバックグラウンド実行でEOFErrorになる
   - ログファイルへの出力が推奨
   - UTF-8エンコーディングの明示的設定が必要

### 現在実行中のバックグラウンドプロセス（2025年11月1日 16:40時点）

1. **決まり手データ補完** (Bash ID: 3ed6e9)
   - タスク: 約28,000件
   - 状態: 実行中

2. **結果データ補完** (Bash ID: 2243fc)
   - タスク: 1,221件
   - 状態: 実行中

3. **RDMDB潮位データ収集** (Bash ID: f6936f)
   - タスク: 2023-2025年（35ヶ月 × 4地点 = 140ファイル）
   - 状態: Selenium起動中

4. **Streamlit UI** (Bash ID: 5e8e79)
   - ポート: 8502
   - URL: http://localhost:8502

### 次のタスク（優先順位順）

1. **バックグラウンドプロセスの完了確認** (最優先)
   - 決まり手データ補完の完了確認
   - 結果データ補完の完了確認
   - RDMDB潮位データ収集の完了確認
   - データ充足率の再確認

2. **レース詳細データの補完** (高)
   - 不足件数: 7,327件（24.9%）
   - 対象: 展示タイム、チルト角度、進入コース、STタイム
   - スクリプト作成が必要

3. **直線・一周・回り足タイムの取得** (中)
   - 現在0件（chikusen_time、isshu_time、mawariashi_time）
   - データソースの調査が必要
   - スクレイパーの新規実装

4. **潮位データの活用準備** (中)
   - レースデータと潮位データの紐付けロジック
   - 最寄り観測地点のマッピング確認
   - 時刻のマッチング処理

5. **データ品質検証** (中)
   - 欠損データの最終確認
   - データの整合性チェック
   - 異常値の検出

### 問題点・注意事項

1. **文字エンコーディング**:
   - Windowsコンソールでcp932エラーが頻発
   - `sys.stdout.reconfigure(encoding='utf-8')`で対処
   - ログファイル出力推奨

2. **Selenium実行の不安定性**:
   - RDMDB潮位データ収集はSelenium使用
   - ChromeDriverのバージョン互換性に注意
   - ヘッドレスモード実行

3. **プロセス管理**:
   - 複数のバックグラウンドプロセスが同時実行中
   - DB Lockedを避けるため、書き込みは直列実行
   - プロセスID管理が重要

4. **データベース容量**:
   - 現在: 約86MB
   - 潮位データ追加後: 約200MB見込み
   - SQLiteの制限は問題なし

---

## 🚨 重要な更新（2025年11月3日）

### コード品質監査の実施と修正完了

**実施内容**: 全プロジェクトコード（26,000行以上）の包括的解析
**発見したエラー**: 合計49+件
**修正済み**: 重大なエラー15箇所を完全修正 ✅

#### 修正した重大なエラー

1. **SQL構文エラー（12箇所）** ✅
   - ファイル: `src/analysis/data_coverage_checker.py`
   - 問題: `e. racer_number` のような不要なスペース
   - 影響: データカバレッジチェック機能が完全に動作不能だった
   - 修正: 全12箇所を自動修正スクリプトで修正
   - バックアップ: `data_coverage_checker.py.backup_20251103_013053`

2. **SQLインジェクション脆弱性（2ファイル）** ✅
   - ファイル: `ui/components/venue_strategy.py`, `backtest_prediction.py`
   - 問題: 文字列フォーマットでSQLクエリを組み立て
   - 影響: セキュリティリスク
   - 修正: パラメータ化クエリに変更

3. **モジュールインポートエラー（1箇所）** ✅
   - ファイル: `ui/app.py`
   - 問題: shapライブラリ未インストールでインポートエラー
   - 影響: Streamlit UIが起動できなかった
   - 修正: 未使用のインポートをコメントアウト

#### 新規作成ドキュメント

- **[CODE_ANALYSIS_REPORT.md](CODE_ANALYSIS_REPORT.md)** - 全エラー解析レポート（詳細）
- **[FIXES_APPLIED.md](FIXES_APPLIED.md)** - 修正内容サマリー（即座確認用）

#### 残存する重要な問題（未修正）

**優先度: 高**
- Stage2 モデル学習機能が未実装（`ui/components/model_training.py:299-301`）
- モデル評価タブが未実装（`ui/components/model_training.py:339-340`）
- 予想シミュレーション機能が未実装（`ui/components/model_training.py:356-357`）
- Phase 3.3 特徴量生成が未実装（`src/analysis/feature_generator.py:137-140`）

**優先度: 中**
- モジュール重複設計（analysis/ と analyzer/）
- スクレイパーモジュールの乱立（17ファイル、バージョン管理曖昧）
- 例外処理の不足（多数のファイルで `except: pass`）

**詳細**: [CODE_ANALYSIS_REPORT.md](CODE_ANALYSIS_REPORT.md) を参照

---

**最終更新**: 2025年11月3日 01:35
**作成者**: Claude (Anthropic)
**次の担当者へ**:

### 最優先タスク
1. **動作確認テストの実施** - 修正後の動作確認必須
   ```bash
   streamlit run ui/app.py
   # ブラウザで http://localhost:8501 にアクセス
   # - エラーなく起動すること
   # - 「場攻略」タブが正常に動作すること
   # - データカバレッジチェックが正常に動作すること
   ```

2. **未実装機能の実装検討**
   - Stage2モデル学習機能（ML予測の中核）
   - モデル評価・シミュレーション機能
   - Phase 3.3 高度な特徴量生成

3. **設計改善の検討**
   - モジュール重複の解消（analysis/ ⇔ analyzer/）
   - スクレイパーの整理統合

### データ状況（前回セッション時点）
- 決まり手データの欠損（0.2%）修正・補完処理実行済み
- DataManagerの修正完了（kimarite保存対応）
- 潮位データ拡張: 2022-2025年（37ヶ月）

### 重要な注意事項
- **SQL構文エラーは修正済み**: データ分析機能が正常動作するようになった
- **セキュリティ脆弱性は修正済み**: SQLインジェクション対策完了
- **バックアップファイル**: 万一問題があれば `.backup_*` ファイルから復元可能
