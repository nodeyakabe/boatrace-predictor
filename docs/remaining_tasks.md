# 残タスク一覧

**最終更新**: 2025-12-06

---

## 2025-12-06 分析結果: コース別特徴量の検証

### 検証内容
11月予測データに対し、以下の新規特徴量の効果を検証：
- `course_win_rate`: 選手×コース別勝率
- `course_2ren_rate`: 選手×コース別2連対率
- `venue_course_win`: 選手×会場×コース別勝率

### 検証結果

| テスト | AUC変化 | 結論 |
|--------|---------|------|
| venue_course_win 追加（生データ） | **-10.18%** | 過学習で大幅悪化 |
| Bayesian smoothing適用後 | -0.34% | 悪化は抑えたが改善なし |
| スムージング強度チューニング（0〜50） | -0.07%〜-0.68% | どの設定でも改善せず |

**ベースライン**: AUC 0.8224, 1着的中率 62.14%

### 結論
**コース別特徴量の追加は見送り**
- 既存の選手統計（win_rate, second_rate, third_rate）が十分な情報を含む
- 新特徴量は冗長であり、追加してもモデル性能は向上しない
- venue_course_win はスパースデータによる過学習リスクが高い

### 今後の方針
1. **新規特徴量追加より、以下のアプローチを優先**：
   - モデルパラメータのチューニング（n_estimators, max_depth, learning_rate）
   - 訓練データ期間の調整（直近データの重み付け）
   - 未使用データの活用（展示タイム、天候、節間成績など）

2. **作成した検証スクリプト（temp/配下）を今後の特徴量評価に再利用**：
   - `temp/additive_comparison.py`: 追加効果の検証
   - `temp/improved_features_test.py`: Bayesian smoothing付き検証
   - `temp/smoothing_tuning.py`: スムージング強度チューニング
   - `temp/strict_comparison.py`: 時系列厳密版比較

---

## 優先度：高（運用に影響）

### 1. DB接続最適化（パフォーマンス改善）

**現状の問題**:
- 1レースあたり32秒の処理時間（98回のDB接続が発生）
- 100レース予測に53分かかる

**目標**:
- 1レースあたり3-5秒に短縮（90%削減）
- 100レース予測を5-10分に短縮

**作業内容**:
- [db_optimization_task.md](./db_optimization_task.md) を参照
- DB接続プールの全Analyzerへの統合
- 100+ メソッドの修正が必要

**見積もり**: 3-5時間

**優先度**: 高（バックテストや大量予測に影響）

---

## 優先度：中（精度向上）

### 2. 動的統合の重み配分最適化

**現状**:
- PRE_SCORE: 85%, BEFORE_SCORE: 15%
- 保守的な設定で1位予測がPRE単体と同じになりやすい

**目標**:
- データに基づいた最適な重み配分の発見
- 精度を維持しつつ、BEFORE_SCOREの影響力を高める

**作業内容**:
1. **データ収集（1-2ヶ月）**
   - 現在の設定（PRE 85% / BEFORE 15%）で運用
   - 実レースでの的中率を記録
   - BEFORE_SCOREが高い/低い艇の実際の成績を分析

2. **バックテストで重み配分を試行**
   ```
   試行パターン:
   - PRE 70% / BEFORE 30%
   - PRE 60% / BEFORE 40%
   - PRE 50% / BEFORE 50%
   - 条件別（PRE差が小さい場合はBEFORE重視など）
   ```

3. **最適化実装**
   - 最も精度が高かった配分を採用
   - [src/analysis/dynamic_integration.py](../src/analysis/dynamic_integration.py) の調整

**見積もり**:
- データ収集: 1-2ヶ月（自動）
- 分析・実装: 1-2日

**優先度**: 中（精度向上の可能性）

**参考資料**: [feature_validation_final_report.md](./feature_validation_final_report.md) の「改善効果を高めるには」セクション

---

### 3. BEFORE_SCOREのスケール調整

**現状**:
- BEFORE_SCOREの範囲: -15〜+18点程度
- 15%の重みでは影響力が限定的（-2.25〜+2.7点）

**目標**:
- BEFORE_SCOREの影響力を適切な範囲に調整
- PRE_SCOREとのバランスを最適化

**作業内容**:
1. **スコアリングロジックの見直し**
   - [src/analysis/beforeinfo_scorer.py](../src/analysis/beforeinfo_scorer.py) の各項目の配点を調整
   - 現在: 展示タイム25点、ST25点、進入20点、前走15点、チルト・風10点、部品・重量5点
   - 検討: 各項目を2倍に拡大（-30〜+36点範囲）

2. **バックテストで効果確認**
   - スケール変更後の的中率を測定
   - PRE_SCOREとの相関分析

3. **実装**
   - 最適なスケールを決定
   - beforeinfo_scorer.py を更新

**見積もり**: 1日

**優先度**: 中（タスク2と併せて実施推奨）

---

### 4. 条件別重み配分の実装

**現状**:
- 全レースで一律の重み配分（PRE 85% / BEFORE 15%）

**目標**:
- レース状況に応じて重み配分を動的に変更
- 拮抗したレースでは直前情報を重視

**作業内容**:
```python
# 実装例
if abs(1位PRE_SCORE - 2位PRE_SCORE) < 10点:
    # 拮抗している → BEFORE重視
    PRE_WEIGHT = 0.5
    BEFORE_WEIGHT = 0.5
elif abs(1位PRE_SCORE - 2位PRE_SCORE) > 30点:
    # 圧倒的差 → PRE重視
    PRE_WEIGHT = 0.9
    BEFORE_WEIGHT = 0.1
else:
    # 通常 → 現在の設定
    PRE_WEIGHT = 0.85
    BEFORE_WEIGHT = 0.15
```

**見積もり**: 半日

**優先度**: 中（効果的だが実装は後回し可）

---

## 優先度：低（機能追加）

### 5. 統合スコア詳細のUI表示

**現状**:
- UIには統合後のスコアのみ表示

**目標**:
- PRE_SCORE、BEFORE_SCORE、重み配分を個別表示
- ユーザーが判断材料にできるようにする

**作業内容**:
- Streamlit UIの予測結果表示部分を拡張
- 各艇の詳細情報（PRE/BEFORE/重み）を表形式で表示

**見積もり**: 2-3時間

**優先度**: 低（分析用途では有用）

---

### 6. A/Bテスト機能の実装

**現状**:
- 段階的導入の仕組みは実装済み（Gradual Rollout）
- 実際のA/Bテストは未実装

**目標**:
- 新しい重み配分と従来の設定を同時運用
- 実データで効果を比較

**作業内容**:
1. **A/Bテスト用モード追加**
   - ユーザーIDベースで設定を分岐
   - グループA: 現在の設定（PRE 85%）
   - グループB: 新しい設定（PRE 60-70%）

2. **結果収集機能**
   - 各グループの的中率を自動記録
   - Performance Monitorに保存

3. **分析ダッシュボード**
   - 両グループの比較レポート生成

**見積もり**: 1-2日

**優先度**: 低（データ収集期間後に実施）

---

### 7. Walk-forward Backtestの実行

**現状**:
- Walk-forward Backtest機能は実装済み
- 実際のテストは未実行

**目標**:
- 時系列を考慮した精度検証
- 過学習の有無を確認

**作業内容**:
- [scripts/walkforward_backtest.py](../scripts/walkforward_backtest.py) を実行
- 結果を分析してレポート作成

**見積もり**: 半日（実行時間 + 分析）

**優先度**: 低（運用開始後でも可）

---

## 完了済みタスク

### ✅ Phase 1: 基本機能実装
- [x] 動的統合ロジック（DynamicIntegrator）
- [x] 進入予測モデル（EntryPredictionModel）
- [x] 直前情報スコアラー（BeforeInfoScorer）
- [x] 統合スコア計算

### ✅ Phase 2-3: 展開機能実装
- [x] Walk-forward Backtest
- [x] Performance Monitor
- [x] Gradual Rollout

### ✅ 検証・テスト
- [x] BeforeInfoScorer単体テスト
- [x] 統合スコア動作確認
- [x] 30レーステスト
- [x] 順位変動の確認

### ✅ ドキュメント作成
- [x] 最終検証レポート
- [x] パフォーマンス最適化計画
- [x] DB最適化タスク
- [x] 予想ロジック仕様書（更新）

---

## タスク管理

### すぐに着手すべき
1. **予想ロジック仕様書の更新**（このタスク）
2. **運用開始の準備**

### データ収集期間中（1-2ヶ月）
- 自動：実レースでの的中率記録
- 手動：週次で結果確認

### データ収集後
1. タスク2: 重み配分最適化
2. タスク3: スケール調整
3. タスク4: 条件別重み配分
4. タスク6: A/Bテスト

### 運用安定後
1. タスク1: DB最適化（必須）
2. タスク5: UI表示拡張
3. タスク7: Walk-forward Backtest実行

---

## 備考

- すべてのタスクは現在の機能を壊さないように実装
- 精度向上施策は必ずバックテストで効果確認
- DB最適化は運用開始後、バックテスト頻度が高くなったら着手
