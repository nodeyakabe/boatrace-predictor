# ボートレース予想ロジック最適化レポート

## 作成日: 2025-12-12
## 目的: 現状把握と回収率向上のための最適化提案

---

# Part 1: 現状分析

## 1. スコアリングシステムの概要

### 1.1 事前スコア（PRE_SCORE）の構成

事前スコアは以下の要素で構成される（合計100点満点）：

| 要素 | 基本重み | 範囲 | 説明 |
|------|---------|------|------|
| コーススコア | 35点 | 動的調整あり | コース×ランク別実績勝率ベース |
| 選手スコア | 35点 | 動的調整あり | 全国/当地/直近成績 |
| モータースコア | 20点 | 動的調整あり | モーター2連率 |
| 決まり手適性 | 5点 | 0-5点 | 会場×決まり手×コース適性 |
| グレード適性 | 5点 | 0-5点 | レースグレード別成績 |
| 拡張スコア | 20点 | -10〜62点→正規化 | 級別/F・L/節間成績/展示タイム等 |
| 複合バフ | ±15点 | -15〜+15点 | 複合条件による補正 |

**動的重み調整の仕組み**:
- 会場タイプ（インが強い/弱い）により配分を調整
- レースグレード（SG/G1/G2/G3/一般）により調整
- データ充実度（選手50レース、モーター30レース基準）により調整

**コース×ランク実績勝率テーブル**:
```
コース  A1級   A2級   B1級   B2級
  1     71.5%  61.1%  42.4%  30.3%
  2     19.5%  16.7%   9.6%   8.1%
  3     18.2%  16.2%   9.1%   6.6%
  4     13.8%  11.9%   7.6%   3.9%
  5     10.0%   7.3%   4.4%   2.0%
  6      6.6%   3.4%   1.7%   0.6%
```

### 1.2 直前スコア（BEFORE_SCORE）の構成

直前スコアは115点満点で以下の要素から構成される：

| 要素 | 配点 | 説明 |
|------|------|------|
| 展示タイム | 25点 | 6艇内での相対順位 |
| ST（スタートタイミング） | 25点 | 0に近いほど高得点 |
| 進入隊形 | 20点 | 枠なり進入か否か |
| 前走成績 | 15点 | 同節内の直前レース結果 |
| チルト・風 | 10点 | チルト角度×風向補正 |
| 調整重量/部品交換 | 5点 | 調整状況 |
| 気象条件 | 5点 | 会場×コース×風向の78パターン |
| モーター成績補正 | 5点 | motor_performance_adjuster |
| 選手×コース別得意・不得意 | 5点 | racer_course_skill_adjuster |

### 1.3 統合ロジックの現状

**現在有効な統合モード**: `before_pattern_bonus`（パターンボーナス方式）

```
FINAL_SCORE = PRE_SCORE × pattern_multiplier
```

**パターンボーナスの仕組み**:
- PRE順位、展示タイム順位、ST順位の組み合わせでパターンマッチ
- マッチしたパターンに応じて乗算係数（1.02〜1.41）を適用

**1着予測パターン（4種）**:
| パターン名 | 条件 | 倍率 |
|-----------|------|------|
| pre1_st1 | PRE1位 & ST1位 | 1.411 |
| pre1_ex1 | PRE1位 & 展示1位 | 1.286 |
| pre1_ex1_3_st1_3 | PRE1位 & 展示1-3位 & ST1-3位 | 1.328 |
| pre1_st1_3 | PRE1位 & ST1-3位 | 1.310 |

**適用条件**:
- 信頼度B/C: パターン適用
- 信頼度A/E: パターンスキップ（A:不要、E:データ不足）
- 信頼度D: フラグで制御（現在は無効）

**過去に試行された他の統合方式（全て無効化）**:
1. レガシーモード: `FINAL = PRE × 0.6 + BEFORE × 0.4` - 逆相関のため停止
2. 正規化統合: 同一レース内で正規化して統合 - 的中率悪化
3. 階層的予測: BEFORE順位でボーナス加算 - 的中率悪化
4. ゲーティング: PRE拮抗時のみBEFORE使用 - 効果限定的
5. 状態フラグ方式: 個別フラグで調整 - 的中率悪化

### 1.4 戦略A（トップ3艇ボックス3連単）の構成

**ベッティング条件**（3層構造）:

**Tier 1: 超高配当狙い**
| 条件 | オッズ範囲 | 1コース級別 | 期待ROI | 賭け金 |
|------|-----------|-------------|---------|--------|
| 信頼度D | 200-300倍 | B1 | 838.4% | 300円 |
| 信頼度D | 100-150倍 | A1 | 425.5% | 300円 |
| 信頼度D | 200-300倍 | A1 | 397.9% | 300円 |
| 信頼度C | 150-200倍 | B1 | 376.3% | 300円 |

**Tier 2: 中高配当狙い**
| 条件 | オッズ範囲 | 1コース級別 | 期待ROI | 賭け金 |
|------|-----------|-------------|---------|--------|
| 信頼度D | 30-40倍 | A2 | 273.9% | 300円 |
| 信頼度D | 40-50倍 | A1 | 537.8% | 300円 |
| 信頼度D | 20-25倍 | A1 | 277.9% | 300円 |

**Tier 3: 堅実狙い**
| 条件 | オッズ範囲 | 1コース級別 | 期待ROI | 賭け金 |
|------|-----------|-------------|---------|--------|
| 信頼度D | 5-10倍 | B1 | 111.1% | 300円 |

**除外条件**:
- 信頼度A, B: サンプル不足・安定性低
- B2級のみ: 回収率低

---

## 2. 現状パフォーマンス

### 2.1 バックテスト結果（2025年データ）

最新のバックテスト実行結果:

| 指標 | 値 | 目標 | 達成状況 |
|------|-----|------|----------|
| 年間購入レース | 253レース | - | - |
| 月間購入レース | 21.1レース | - | - |
| 年間的中 | 14回 | - | - |
| 月間的中 | 1.2回 | 5-10回 | 未達 |
| 的中率 | 5.5% | - | - |
| 年間投資 | 75,900円 | - | - |
| 年間払戻 | 66,630円 | - | - |
| 年間収支 | -9,270円 | +300,000円 | 未達 |
| ROI | 87.8% | 150%以上 | 未達 |

**内訳分析**:
- Tier 1 (超高配当): 123レース購入、1回的中、ROI 99.7%
- Tier 2 (中高配当): 30レース購入、0回的中、ROI 0%
- Tier 3 (堅実): 100レース購入、13回的中、ROI 99.5%

### 2.2 ドキュメント記載との差異

betting_implementation_status.md記載の期待値:
- 年間ROI 304.6%
- 年間収支 +383,670円

**差異の原因（推定）**:
1. バックテスト期間・データの違い
2. パターンボーナス適用のタイミング
3. オッズ取得タイミング（事前オッズ vs 確定オッズ）
4. 予測モデルの更新による変化

### 2.3 現状の問題点

1. **Tier 1の的中率が極めて低い（0.8%）**
   - 超高配当狙いだが、当たらなすぎる
   - 56レース購入で0回的中のケースあり

2. **Tier 2が全く的中しない（0%）**
   - 30レース購入で0回的中
   - 条件設定が厳しすぎる可能性

3. **Tier 3は的中するが収益が出ない（ROI 99.5%）**
   - 13回/100レースの的中率は悪くない
   - 配当が低すぎて利益が出ない

4. **信頼度D中心の戦略の限界**
   - 信頼度Dは予測精度が低い（1着予測的中率約55%）
   - トップ3艇ボックスでも的中しにくい

---

# Part 2: 最適化提案

## 3. スコア構成の再設計案

### 3.1 提案方式の比較

**方式A**: 加算方式
```
FINAL = PRE + BEFORE_ADJUSTMENT
```
- BEFORE_ADJUSTMENTは-10〜+10点の範囲
- メリット: PRE_SCOREの順位が維持されやすい
- デメリット: BEFORE情報の影響が限定的

**方式B**: 乗算方式（現在のパターンボーナス拡張版）
```
FINAL = PRE × (1 + BEFORE_ADJUSTMENT_RATE)
```
- BEFORE_ADJUSTMENT_RATEは-0.1〜+0.1（±10%）
- メリット: PRE_SCOREの大小に比例した影響
- デメリット: 上位艇に影響が集中

**方式C**: 条件付き乗算（推奨）
```
IF BEFORE条件良好:
    FINAL = PRE × pattern_multiplier
ELSE IF BEFORE条件悪い:
    FINAL = PRE × negative_multiplier
ELSE:
    FINAL = PRE × 1.0
```
- 現在のパターンボーナスを拡張
- ネガティブパターン（既に実装済み）を活用

### 3.2 推奨: 方式Cの強化版

現在の実装を維持しつつ、以下を追加:

1. **ネガティブパターンの本格活用**
   - 現在: `negative_patterns`フラグは有効だが軽量実装
   - 提案: ネガティブ条件をより厳密に定義

2. **信頼度別の乗数調整**
   - 信頼度B: 乗数を強化（1.5倍まで許容）
   - 信頼度C: 現状維持（1.4倍まで）
   - 信頼度D: 乗数を抑制（1.2倍まで）

3. **展示タイム加点ルールの適用強化**
   - 既に`exhibition_time_score`として実装済み
   - 条件別加点を強化

## 4. 戦略Aの条件見直し

### 4.1 問題点と改善案

**問題1: 信頼度D中心で的中しない**

改善案:
- 信頼度B/Cを購入対象に追加
- ただし、信頼度B/Cはサンプル数が少ないため条件を厳選

**問題2: 高オッズ条件が厳しすぎる**

改善案:
- オッズ下限を引き下げ（例: 200倍→100倍）
- 1コース級別条件を緩和

**問題3: 低オッズ条件（Tier 3）で利益が出ない**

改善案:
- 的中率を上げてもROI向上しない可能性
- 賭け金を増やすか、条件を絞る

### 4.2 新戦略提案

**戦略A改（バランス改善版）**:

```
Tier 1 (超高配当):
- 信頼度D × B1級 × 100-200倍（オッズ下限引下げ）
- 信頼度C × B1級 × 100-200倍（Cも追加）

Tier 2 (中配当):
- 信頼度D × A1級 × 25-50倍（範囲拡大）
- 信頼度C × A1級 × 25-50倍（Cも追加）

Tier 3 (堅実):
- 信頼度B × 全級別 × 10-30倍（Bで的中率向上）
- 信頼度C × A1級 × 10-20倍
```

## 5. 重み付け最適化

### 5.1 パターン倍率の最適化

現在の倍率は固定値だが、条件によって動的に調整することを提案:

```python
# 現在（固定）
pattern_multiplier = 1.411  # pre1_st1

# 提案（条件別）
if confidence == 'B':
    pattern_multiplier = 1.5  # 高信頼度は強化
elif confidence == 'C':
    pattern_multiplier = 1.411  # 現状維持
elif confidence == 'D':
    pattern_multiplier = 1.2  # 低信頼度は抑制
```

### 5.2 BEFORE情報の重み調整

現在のBEFORE情報は「パターンマッチ」のみで使用。

追加提案:
1. **展示タイム差分によるスコア調整**
   - 1位と2位の差が0.1秒以上 → 1位にボーナス
   - 全艇が僅差（0.05秒以内） → 展示情報を無視

2. **ST一致度によるスコア調整**
   - 平均STと展示STが一致 → 信頼度上昇
   - 展示STが平均より0.1秒以上遅い → ペナルティ

## 6. 実装ロードマップ

### 6.1 Phase 1: 即座に実装可能（リスク低）

1. **戦略Aのオッズ条件緩和**
   - `bet_target_evaluator.py`の条件修正
   - Tier 1のオッズ下限を200→100倍に変更

2. **信頼度B/Cの購入対象追加**
   - `EXCLUDED_CONFIDENCE`から'B'を除外
   - 追加条件を定義

3. **ネガティブパターンの強化**
   - `negative_pattern_checker.py`の条件追加
   - PRE1位でもBEFORE情報が悪ければ減点

### 6.2 Phase 2: 検証後に実装（リスク中）

1. **信頼度別パターン倍率の動的調整**
   - 機能フラグで制御
   - バックテストで検証後に有効化

2. **展示タイム差分によるスコア調整**
   - `beforeinfo_scorer.py`の拡張
   - 閾値のチューニング

### 6.3 Phase 3: 長期的改善（リスク高）

1. **機械学習モデルとの統合**
   - LightGBMランキングモデルは既に実装済み
   - PRE_SCOREとMLスコアのアンサンブル

2. **オッズ情報の活用**
   - 市場オッズと予測オッズの乖離分析
   - 期待値最大化戦略

---

## 7. 結論と推奨アクション

### 7.1 最優先アクション

1. **戦略Aの条件緩和**（即座に実装可能）
   - 現状の条件が厳しすぎて的中しない
   - オッズ下限の引き下げ、信頼度B追加

2. **バックテスト環境の整備**
   - 現状のパフォーマンスを正確に測定
   - 変更前後の比較を可能に

### 7.2 スコアリング構成について

**結論: 現在の方式（パターンボーナス乗算）を維持**

理由:
- レガシー方式（PRE×0.6 + BEFORE×0.4）は逆相関が確認されている
- パターンボーナスは一定の効果（信頼度B: +9.5pt、C: +8.3pt）
- 大幅な変更はリスクが高い

**追加改善案:**
- 現在の乗算方式を維持しつつ
- ネガティブパターンの強化
- 信頼度別の乗数調整

### 7.3 回収率向上のための根本的対策

1. **予測精度の向上**
   - 1着予測の的中率向上が最優先
   - 現状60-64%を70%以上に

2. **ベッティング戦略の最適化**
   - 信頼度とオッズの組み合わせ最適化
   - サンプル数の確保

3. **データ品質の向上**
   - 展示タイム、ST情報の充実
   - オッズデータの正確な取得

---

## 付録: 現在の機能フラグ状態

```python
'before_pattern_bonus': True,      # パターンボーナス（有効）
'negative_patterns': True,         # ネガティブパターン（有効）
'entry_prediction_model': True,    # 進入予測（有効）
'lightgbm_ranking': True,          # LightGBM（有効）
'hierarchical_predictor': True,    # 階層的予測（有効）

'beforeinfo_flag_adjustment': False,  # 状態フラグ（無効）
'hierarchical_before_prediction': False,  # 階層的BEFORE（無効）
'normalized_before_integration': False,   # 正規化統合（無効）
'dynamic_integration': False,      # 動的統合（無効）
'gated_before_integration': False, # ゲーティング（無効）
'before_safe_integration': False,  # BEFORE_SAFE（無効）
'apply_pattern_to_confidence_d': False,  # 信頼度Dパターン（無効）
```

---

## 改訂履歴

- 2025-12-12: 初版作成
