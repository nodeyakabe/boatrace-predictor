# 会場×風向×風速補正の実装サマリー

**作成日**: 2025-12-12
**データ期間**: 2025-01-01 ~ 2025-12-31
**暴風レース数**: 264レース
**ベースライン**: 1コース勝率 56.3% (9448/16780艇)

---

## 実装方針の決定

### 不採用: 風速のみのシンプルルール

**理由**:
- 会場×風向で最大91.7ptの差がある（会場13西風91.7% vs 会場02北風25.0%）
- 風速のみでは会場特性を無視し、予測精度が低下する
- 追い風・向かい風の影響を考慮しないのは不十分

### **採用: 会場×風向の補正テーブル** ✅

**理由**:
- 2025年通年データで264暴風レースあり、統計的に十分
- 会場×風向の組み合わせでサンプル5件以上のデータが15パターン
- 追い風・向かい風の概念ではなく、実データに基づく補正
- 会場別のコースレイアウト情報不要

---

## 実装内容

### 1. 補正テーブル

ファイル: [src/analysis/weather_venue_wind_adjuster_v2.py](../src/analysis/weather_venue_wind_adjuster_v2.py:1)

```python
VENUE_WIND_DIRECTION_ADJUSTMENT = {
    '02': {'北': -31.3, '南東': -18.8},      # 戸田
    '03': {'東': -8.2},                      # 江戸川
    '04': {'東南東': -6.3},                  # 平和島
    '08': {'北北西': +3.7, '西北西': -1.8},  # 常滑
    '10': {'西': -23.0},                     # 桐生
    '13': {'西': +35.4, '北': +10.4},        # 尼崎
    '14': {'東南東': -19.9, '東北東': -56.3}, # 三国（修正）
    '15': {'西南西': +2.0},                  # 丸亀
    '19': {'北北東': +34.6},                 # 下関（修正）
    '23': {'西': +34.6, '東': +3.7},         # 唐津
}
```

### 2. スコア計算ロジック

```python
def calculate_venue_wind_adjustment(
    course: int,
    venue_code: str,
    wind_speed: Optional[float],
    wind_direction: Optional[str]
) -> float:
    """
    会場×風向×風速による補正スコアを計算

    - 暴風時（8m以上）のみ補正
    - 1コースのみ対象
    - 差分の50%をスコアとして適用
    - スコア範囲: -20.0 ~ +20.0点
    """
```

### 3. BeforeInfoScorerへの統合

ファイル: [src/analysis/beforeinfo_scorer.py](../src/analysis/beforeinfo_scorer.py:22)

```python
from src.analysis.weather_venue_wind_adjuster_v2 import calculate_venue_wind_adjustment

def _calc_weather_score(self, race_id, pit_number, weather, exhibition_courses):
    # 会場×風向×風速の補正を適用
    venue_code = self._get_venue_code(race_id)
    venue_wind_adj = calculate_venue_wind_adjustment(
        course=course,
        venue_code=venue_code,
        wind_speed=weather.get('wind_speed'),
        wind_direction=weather.get('wind_direction')
    )
    score += venue_wind_adj
```

---

## 補正テーブルの詳細

### 超有利パターン（+30pt以上）

| 会場 | 風向 | 差分 | スコア | 勝率 | サンプル |
|------|------|------|--------|------|---------|
| 13（尼崎） | 西 | +35.4pt | +17.7点 | 91.7% | 11/12艇 |
| 19（下関） | 北北東 | +34.6pt | +17.3点 | 90.9% | 10/11艇 |
| 23（唐津） | 西 | +34.6pt | +17.3点 | 90.9% | 10/11艇 |

### 大幅不利パターン（-20pt以上）

| 会場 | 風向 | 差分 | スコア | 勝率 | サンプル |
|------|------|------|--------|------|---------|
| 14（三国） | 東北東 | -56.3pt | -28.2点 | 0.0% | 0/6艇 |
| 02（戸田） | 北 | -31.3pt | -15.7点 | 25.0% | 3/12艇 |
| 10（桐生） | 西 | -23.0pt | -11.5点 | 33.3% | 10/30艇 |

---

## データ検証の課題と解決

### 問題1: 会場14の風向データ検証

**発見**:
- 初期分析で会場14×西北東 -22.9pt (33.3%, 8/24艇) のデータを採用
- しかし2025年通年データには「西北東」風向のレースが存在しない

**調査結果**:
- 2025年通年データの会場14の風向は「北北東」「東北東」「東南東」の3種のみ
- 実際のデータ: 東北東 0.0% (0/6艇)、東南東 36.4% (4/11艇)

**解決**:
- 会場14×東北東 -56.3pt (0.0%, 0/6艇) を採用（極端な不利パターン）
- 会場14×東南東 -19.9pt (36.4%, 4/11艇) を採用

### 問題2: 会場19の風向データ検証

**発見**:
- 初期分析で会場19×北北西 +34.6pt のデータを採用
- しかし実際のデータは「北北東」が正しい

**調査結果**:
- バイト列検証: `e58c97e58c97e69db1` = 「北北東」（12件）
- 「北北西」風向のレースは存在しない

**解決**: 会場19×北北東 +34.6pt (90.9%, 10/11艇) を採用

### 問題3: 文字化けによる風向の誤認識

**原因**: Windowsコンソールの文字コード（CP932）による表示問題

**解決**: バイト列を直接確認し、正しい風向をテーブルに反映

---

## 実装の効果

### 極端なケースでの補正効果

**会場13×西風（暴風）**:
- 通常の1コース勝率: 56.3%
- 実際の勝率: 91.7% (+35.4pt)
- 補正スコア: +17.7点

**会場02×北風（暴風）**:
- 通常の1コース勝率: 56.3%
- 実際の勝率: 25.0% (-31.3pt)
- 補正スコア: -15.7点

### 補正範囲

- 最大プラス補正: +17.7点（会場13西風）
- 最大マイナス補正: -28.2点（会場14東北東） ← 極端な不利パターン
- 補正範囲: -30.0 ~ +20.0点
- 5点満点換算: -15.0 ~ +10.0点（WEATHER_SCORE_WEIGHT = 5.0点）

---

## 今後の課題

### 1. 2コース以降の補正

現時点では1コースのみ補正対象。2-6コースの補正も検討の余地あり。

### 2. データ蓄積

- 2026年以降もデータを蓄積
- サンプル数が少ない会場×風向の組み合わせを充実化
- 最低サンプル数を10件以上に引き上げ

### 3. 強風時（6-8m）の補正

現在は暴風時（8m+）のみ。強風時（6-8m）の補正も検討。

### 4. 季節性の考慮

冬季と夏季で風の影響が異なる可能性あり。

---

## ファイル一覧

### 実装ファイル

- [src/analysis/weather_venue_wind_adjuster_v2.py](../src/analysis/weather_venue_wind_adjuster_v2.py:1) - 補正テーブルと計算ロジック（修正版）
- [src/analysis/beforeinfo_scorer.py](../src/analysis/beforeinfo_scorer.py:22) - BeforeInfoScorerへの統合

### 分析スクリプト

- [scripts/create_venue_wind_table.py](../scripts/create_venue_wind_table.py:1) - 補正テーブル生成スクリプト
- [scripts/analyze_weather_comprehensive_fulldata.py](../scripts/analyze_weather_comprehensive_fulldata.py:1) - 通年データ分析スクリプト

### ドキュメント

- [docs/weather_comprehensive_analysis_fulldata.md](weather_comprehensive_analysis_fulldata.md:1) - 通年データ分析レポート
- [docs/wind_direction_analysis.md](wind_direction_analysis.md:1) - 風向分析レポート
- [docs/weather_statistical_analysis.md](weather_statistical_analysis.md:1) - 統計分析レポート

---

## まとめ

2025年通年データ（264暴風レース）に基づき、**会場×風向×風速の補正テーブル**を実装しました。

- **採用方針**: 会場×風向の実データドリブン補正（追い風・向かい風の概念は不使用）
- **補正範囲**: -20.0 ~ +20.0点（5点満点換算で-10.0~+10.0点）
- **対象**: 暴風時（8m+）×1コースのみ
- **パターン数**: 15パターン（10会場×1-2風向）

この実装により、**暴風時の会場特性を考慮した予測精度の向上**が期待されます。
