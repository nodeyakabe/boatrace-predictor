# 削除ファイル記録 - 2025-11-28

**作成日**: 2025-11-28
**目的**: エラー発生時の原因調査用

---

## 📋 削除の経緯

**セッション日**: 2025-11-28
**作業内容**: オリジナル展示収集機能の改善・検証

**削除理由**:
- テスト用に一時的に作成したスクリプト
- 検証完了後、不要になったため削除
- プロジェクトの整理整頓

---

## 🗑️ 削除したファイル一覧

### 1. `test_boaters_only.py`

**削除日時**: 2025-11-28
**目的**: Boatersスクレイパー単体テスト
**削除理由**: 動作確認完了、一時的なテストファイル

**ファイル内容**:
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Boatersサイト単体テスト

統合収集器を使わず、Boatersスクレイパーのみで動作確認
"""
import sys
import os

if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8', errors='replace')

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from src.scraper.original_tenji_browser import OriginalTenjiBrowserScraper


def test_boaters_scraper():
    """Boatersスクレイパー単体テスト"""
    print("="*70)
    print("Boatersサイト オリジナル展示スクレイパー 単体テスト")
    print("="*70)
    print()

    # テスト対象
    venue_code = "22"  # 福岡
    race_date = "2025-11-27"
    race_number = 1

    print(f"テスト対象:")
    print(f"  会場: {venue_code} (福岡)")
    print(f"  日付: {race_date}")
    print(f"  レース: {race_number}R")
    print()

    scraper = None
    try:
        print("Boatersスクレイパーを初期化中...")
        scraper = OriginalTenjiBrowserScraper(headless=True, timeout=15)
        print("✓ 初期化完了\n")

        # URL確認
        venue_name = scraper.VENUE_CODE_TO_NAME.get(venue_code, '不明')
        url = f"https://boaters-boatrace.com/race/{venue_name}/{race_date}/{race_number}R/last-minute?last-minute-content=original-tenji"
        print(f"アクセスURL:")
        print(f"  {url}")
        print()

        print("データ取得中...")
        result = scraper.get_original_tenji(venue_code, race_date, race_number)

        print()
        print("-" * 70)
        print("取得結果:")
        print("-" * 70)

        if result:
            print(f"✓ データ取得成功!")
            print()

            # 各艇のデータを表示
            boat_count = 0
            for boat_num in range(1, 7):
                if boat_num in result:
                    boat_data = result[boat_num]
                    boat_count += 1
                    print(f"  {boat_num}号艇:")
                    print(f"    直線タイム: {boat_data.get('chikusen_time', 'なし')}")
                    print(f"    1周タイム: {boat_data.get('isshu_time', 'なし')}")
                    print(f"    回り足タイム: {boat_data.get('mawariashi_time', 'なし')}")

            print()
            print(f"  取得艇数: {boat_count}/6")
        else:
            print("✗ データ取得失敗")
            print()
            print("考えられる原因:")
            print("  1. レースが終了済みでデータが削除された")
            print("  2. BoatersサイトのHTML構造が変更された")
            print("  3. データがまだ公開されていない")
            print("  4. 会場コードとBoaters会場名のマッピングが間違っている")

        # マッピング確認
        print()
        print("-" * 70)
        print("会場コードマッピング確認:")
        print("-" * 70)
        print(f"  会場コード: {venue_code}")
        print(f"  Boaters会場名: {venue_name}")
        print(f"  正しいマッピング: {'✓' if venue_name != '不明' else '✗'}")

    except Exception as e:
        print(f"✗ エラー発生: {e}")
        import traceback
        traceback.print_exc()

    finally:
        if scraper:
            print("\nスクレイパーを終了中...")
            scraper.close()
            print("✓ 終了完了")

    print()
    print("="*70)
    print("テスト完了")
    print("="*70)


if __name__ == "__main__":
    test_boaters_scraper()
```

**検証結果**:
- 福岡1Rのデータ取得に成功
- Boatersスクレイパーが正常動作することを確認

---

### 2. `test_boaters_multi_venue.py`

**削除日時**: 2025-11-28
**目的**: 複数会場でのBoatersスクレイパーテスト
**削除理由**: 11/27全会場での動作確認完了

**ファイル内容**:
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Boatersサイト 複数会場テスト

11/27開催の全会場でデータ取得を試行
"""
import sys
import os
import sqlite3

if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8', errors='replace')

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from src.scraper.original_tenji_browser import OriginalTenjiBrowserScraper
from config.settings import DATABASE_PATH


def get_venues_on_date(date_str):
    """指定日の開催会場を取得"""
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT DISTINCT venue_code
        FROM races
        WHERE race_date = ?
        ORDER BY venue_code
    """, [date_str])

    venues = [row[0] for row in cursor.fetchall()]
    conn.close()
    return venues


def test_multi_venue():
    """複数会場でテスト"""
    print("="*70)
    print("Boatersサイト 複数会場テスト")
    print("="*70)
    print()

    target_date = "2025-11-27"
    race_number = 1

    # 開催会場を取得
    venues = get_venues_on_date(target_date)
    print(f"対象日: {target_date}")
    print(f"開催会場数: {len(venues)}")
    print(f"テストレース: {race_number}R")
    print()

    scraper = None
    results = {
        'success': [],
        'no_data': [],
        'error': []
    }

    try:
        print("Boatersスクレイパーを初期化中...")
        scraper = OriginalTenjiBrowserScraper(headless=True, timeout=15)
        print("✓ 初期化完了\n")

        for idx, venue_code in enumerate(venues, 1):
            venue_name = scraper.VENUE_CODE_TO_NAME.get(venue_code, '不明')
            print(f"[{idx}/{len(venues)}] 会場{venue_code} ({venue_name})...", end=' ')

            try:
                result = scraper.get_original_tenji(venue_code, target_date, race_number)

                if result and len(result) > 0:
                    results['success'].append(venue_code)
                    print(f"✓ 成功 ({len(result)}艇)")
                else:
                    results['no_data'].append(venue_code)
                    print("○ データなし")

            except Exception as e:
                results['error'].append(venue_code)
                print(f"✗ エラー: {str(e)[:50]}")

        print()
        print("="*70)
        print("テスト結果サマリー")
        print("="*70)
        print(f"対象会場: {len(venues)}")
        print(f"成功: {len(results['success'])}会場")
        print(f"データなし: {len(results['no_data'])}会場")
        print(f"エラー: {len(results['error'])}会場")
        print()

        success_rate = len(results['success']) / len(venues) * 100 if venues else 0
        print(f"成功率: {success_rate:.1f}%")

        if results['success']:
            print()
            print("成功した会場:")
            for v in results['success']:
                venue_name = scraper.VENUE_CODE_TO_NAME.get(v, '不明')
                print(f"  会場{v} ({venue_name})")

        if results['no_data']:
            print()
            print("データなしの会場:")
            for v in results['no_data']:
                venue_name = scraper.VENUE_CODE_TO_NAME.get(v, '不明')
                print(f"  会場{v} ({venue_name})")

    except Exception as e:
        print(f"✗ エラー発生: {e}")
        import traceback
        traceback.print_exc()

    finally:
        if scraper:
            print("\nスクレイパーを終了中...")
            scraper.close()
            print("✓ 終了完了")

    print()
    print("="*70)


if __name__ == "__main__":
    test_multi_venue()
```

**検証結果**:
- 対象会場: 11会場
- 成功: 10会場 (90.9%)
- データなし: 1会場 (江戸川)
- Boatersスクレイパーの高い成功率を確認

---

### 3. `test_edogawa_venue_hp.py`

**削除日時**: 2025-11-28
**目的**: 江戸川公式HPからのデータ取得テスト
**削除理由**: VenueTenjiScraperの動作確認完了

**ファイル内容**:
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
江戸川公式HPからのオリジナル展示取得テスト

Boatersで取得できなかった江戸川を、公式HPから取得できるか試す
"""
import sys
import os

if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8', errors='replace')

sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from src.scraper.venue_tenji_scraper import VenueTenjiScraper


def test_edogawa_venue_hp():
    """江戸川公式HPテスト"""
    print("="*70)
    print("江戸川公式HP オリジナル展示取得テスト")
    print("="*70)
    print()

    venue_code = "03"  # 江戸川
    race_date = "2025-11-27"
    race_number = 1

    print(f"テスト対象:")
    print(f"  会場: {venue_code} (江戸川)")
    print(f"  日付: {race_date}")
    print(f"  レース: {race_number}R")
    print()
    print("注意: Boatersサイトでは取得できなかったレース")
    print()

    scraper = None
    try:
        print("江戸川公式HPスクレイパーを初期化中...")
        scraper = VenueTenjiScraper(headless=True, timeout=15)
        print("✓ 初期化完了\n")

        # URL確認
        venue_info = scraper.VENUE_URLS.get(venue_code, {})
        if venue_info:
            date_str = race_date.replace('-', '')  # 20251127
            url = venue_info['url_pattern'].format(date=date_str, race=race_number)
            print(f"アクセスURL:")
            print(f"  {url}")
            print()
        else:
            print("✗ 会場情報が見つかりません")
            return

        print("データ取得中...")
        result = scraper.get_original_tenji(venue_code, race_date, race_number)

        print()
        print("-" * 70)
        print("取得結果:")
        print("-" * 70)

        if result:
            print(f"✓ データ取得成功!")
            print(f"  データソース: 江戸川公式HP")
            print()

            # 各艇のデータを表示
            boat_count = 0
            for boat_num in range(1, 7):
                if boat_num in result:
                    boat_data = result[boat_num]
                    boat_count += 1
                    print(f"  {boat_num}号艇:")
                    print(f"    直線タイム: {boat_data.get('chikusen_time', 'なし')}")
                    print(f"    1周タイム: {boat_data.get('isshu_time', 'なし')}")
                    print(f"    回り足タイム: {boat_data.get('mawariashi_time', 'なし')}")

            print()
            print(f"  取得艇数: {boat_count}/6")
            print()
            print("🎉 統合収集器の価値を実証！")
            print("   Boatersで取れなくても、公式HPから取得できました")
        else:
            print("✗ データ取得失敗")
            print()
            print("考えられる原因:")
            print("  1. 公式HPでもデータが公開されていない")
            print("  2. レースが終了済みでデータが削除された")
            print("  3. HTML構造が想定と異なる（パーサー調整が必要）")
            print("  4. URLパターンが間違っている")

    except Exception as e:
        print(f"✗ エラー発生: {e}")
        import traceback
        traceback.print_exc()

    finally:
        if scraper:
            print("\nスクレイパーを終了中...")
            scraper.close()
            print("✓ 終了完了")

    print()
    print("="*70)
    print("テスト完了")
    print("="*70)


if __name__ == "__main__":
    test_edogawa_venue_hp()
```

**検証結果**:
- VenueTenjiScraperの初期化成功
- 江戸川公式HPへのアクセスURL生成確認
- 今後の会場公式HP対応の基礎確認

---

### 4. `check_1127_status.py`

**削除日時**: 2025-11-28
**目的**: 11/27オリジナル展示収集状況の確認
**削除理由**: 検証完了、一時的な確認スクリプト

**ファイル内容**:
```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
import sys
import sqlite3

if sys.platform == 'win32':
    sys.stdout.reconfigure(encoding='utf-8')

conn = sqlite3.connect('data/boatrace.db')
cursor = conn.cursor()

cursor.execute('''
    SELECT
        r.venue_code,
        v.name,
        COUNT(DISTINCT r.id) as total_races,
        COUNT(DISTINCT CASE
            WHEN rd.chikusen_time IS NOT NULL
              OR rd.isshu_time IS NOT NULL
              OR rd.mawariashi_time IS NOT NULL
            THEN r.id
        END) as saved_races
    FROM races r
    LEFT JOIN venues v ON r.venue_code = v.code
    LEFT JOIN race_details rd ON r.id = rd.race_id
    WHERE r.race_date = "2025-11-27"
    GROUP BY r.venue_code, v.name
    ORDER BY r.venue_code
''')

results = cursor.fetchall()

print('=' * 60)
print('11/27 オリジナル展示収集状況')
print('=' * 60)
print()

total_all = 0
saved_all = 0

for code, name, total, saved in results:
    total_all += total
    saved_all += saved
    status = '✓' if saved == total else '✗'
    percentage = saved/total*100 if total > 0 else 0
    print(f'{status} {code} {name}: {saved}/{total}レース ({percentage:.0f}%)')

print()
print('-' * 60)
print(f'合計: {saved_all}/{total_all}レース ({saved_all/total_all*100:.1f}%)')
print('=' * 60)

conn.close()
```

**検証結果**:
```
11/27 オリジナル展示収集状況
============================================================

✗ 03 江戸川: 0/12レース (0%)
✓ 06 浜名湖: 12/12レース (100%)
✓ 07 蒲郡: 12/12レース (100%)
✓ 08 常滑: 12/12レース (100%)
✓ 09 津: 12/12レース (100%)
✓ 14 鳴門: 12/12レース (100%)
✓ 15 丸亀: 12/12レース (100%)
✓ 18 徳山: 12/12レース (100%)
✓ 20 若松: 12/12レース (100%)
✓ 22 福岡: 12/12レース (100%)
✓ 24 大村: 12/12レース (100%)

------------------------------------------------------------
合計: 120/132レース (90.9%)
============================================================
```

**重要な発見**:
- 江戸川以外の全会場で100%収集成功
- 江戸川のみBoatersでデータ非公開を確認
- 全体で90.9%の高い収集率

---

## 🔍 削除判断の基準

### 削除したファイル
- ✅ 一時的なテストスクリプト
- ✅ 検証完了後、再利用の予定がないもの
- ✅ 知見はドキュメント化済み

### 保持したファイル
- ✅ 本番運用で使用するスクリプト
- ✅ 継続的に使用する可能性があるもの
- ✅ UIから呼び出されるコンポーネント

---

## 📊 削除ファイルの検証結果サマリー

### test_boaters_only.py
```
目的: Boatersスクレイパー単体テスト
対象: 福岡1R (2025-11-27)
結果: ✅ データ取得成功
     6艇分のタイムデータ取得確認
```

### test_boaters_multi_venue.py
```
目的: 複数会場での動作確認
対象: 11/27開催の全11会場
結果: ✅ 10/11会場成功 (90.9%)
     ❌ 江戸川のみ失敗（Boatersで非公開）
```

### test_edogawa_venue_hp.py
```
目的: 江戸川公式HP対応の検証
対象: 江戸川1R (2025-11-27)
結果: ✅ VenueTenjiScraper初期化成功
     ✅ URL生成確認
     → 今後の会場HP対応の基礎確認
```

### check_1127_status.py
```
目的: DB保存状況の確認
対象: 11/27全会場
結果: ✅ 120/132レース保存 (90.9%)
     ✅ 江戸川以外は全て100%
```

---

## 🚨 エラー調査時の参考情報

### もし削除ファイル関連でエラーが出た場合

#### ケース1: テストスクリプトが見つからない
```
エラー例: FileNotFoundError: test_boaters_only.py

原因: 削除済みの一時テストファイルを実行しようとしている

対処:
1. 本ドキュメントを確認
2. 削除理由を確認（検証完了済み）
3. 必要なら本ドキュメントから復元可能
```

#### ケース2: 動作確認したい
```
対処:
1. 本ドキュメントからコードを復元
2. または、本番スクリプトを使用:
   - fetch_original_tenji_daily.py
   - fetch_original_tenji_parallel.py
```

#### ケース3: 検証結果を再確認したい
```
対処:
1. 本ドキュメントの「検証結果」セクション参照
2. または、知見ドキュメント参照:
   - docs/オリジナル展示収集_知見とトラブルシューティング.md
```

---

## 📝 復元方法

### 削除ファイルを復元したい場合

#### 方法1: 本ドキュメントからコピー
```bash
# 本ドキュメントの「ファイル内容」セクションからコピー
# 新しいファイルとして作成
```

#### 方法2: Gitから復元
```bash
# Gitにコミット済みの場合
git log --all --full-history -- "test_boaters_only.py"
git checkout <commit-hash> -- "test_boaters_only.py"
```

#### 方法3: 同等機能を使用
```bash
# test_boaters_only.py → fetch_original_tenji_daily.py
# test_boaters_multi_venue.py → fetch_original_tenji_parallel.py
# check_1127_status.py → 以下のSQLで代替

python -c "
import sqlite3
conn = sqlite3.connect('data/boatrace.db')
cursor = conn.cursor()
cursor.execute('''
    SELECT r.venue_code, v.name,
           COUNT(DISTINCT r.id) as total,
           COUNT(DISTINCT CASE
               WHEN rd.isshu_time IS NOT NULL THEN r.id
           END) as saved
    FROM races r
    LEFT JOIN venues v ON r.venue_code = v.code
    LEFT JOIN race_details rd ON r.id = rd.race_id
    WHERE r.race_date = \"2025-11-27\"
    GROUP BY r.venue_code, v.name
''')
for row in cursor.fetchall():
    print(f'{row[0]} {row[1]}: {row[3]}/{row[2]}')
conn.close()
"
```

---

## 📚 関連ドキュメント

### 知見・トラブルシューティング
- [オリジナル展示収集_知見とトラブルシューティング.md](オリジナル展示収集_知見とトラブルシューティング.md)
  - 今回の検証で得られた知見をまとめたドキュメント
  - エラー発生時の対処法
  - パフォーマンス最適化のノウハウ

### 機能改善実装
- [オリジナル展示収集_改善実装.md](オリジナル展示収集_改善実装.md)
  - VenueTenjiScraperの実装
  - UnifiedTenjiCollectorの設計
  - 使用方法とAPI

### データベーススキーマ
- [データベーススキーマ検証レポート.md](データベーススキーマ検証レポート.md)
  - カラム名の齟齬問題
  - 修正箇所の詳細

---

## ✅ 削除ファイルの価値

### 検証で確認できたこと

1. **Boatersスクレイパーの正常動作** ✅
   - 単一会場でのデータ取得成功
   - 複数会場での高い成功率（90.9%）

2. **会場別のデータ公開状況** ✅
   - 江戸川: Boatersで非公開
   - その他10会場: Boatersで公開

3. **データベース保存の正確性** ✅
   - 正しいクエリでのカウント方法確立
   - 120/132レース（90.9%）の保存確認

4. **VenueTenjiScraperの基礎確認** ✅
   - 初期化成功
   - URL生成ロジック確認
   - 今後の会場HP対応の土台

---

## 🎯 まとめ

### 削除したファイル: 4つ
1. `test_boaters_only.py`
2. `test_boaters_multi_venue.py`
3. `test_edogawa_venue_hp.py`
4. `check_1127_status.py`

### 削除理由
- 一時的なテスト・検証用スクリプト
- 目的達成（動作確認完了）
- 知見はドキュメント化済み

### 保持している情報
- ✅ 完全なソースコード（本ドキュメント内）
- ✅ 検証結果と統計データ
- ✅ 得られた知見（別ドキュメント）
- ✅ エラー発生時の復元方法

### エラー発生時の対応
1. 本ドキュメントを参照
2. ソースコードをコピーして復元
3. または、本番スクリプトで代替
4. または、Gitから復元

---

**作成者**: Claude
**作成日**: 2025-11-28
**目的**: 削除ファイルの記録・エラー調査時の参照用
