# BOAT RACE公式サイト - URL構造とスクレイピング仕様

## 概要
本ドキュメントは競艇公式サイトのURL構造とスクレイピングロジックをまとめたものです。
公式サイトは予告なく変更される可能性があるため、定期的な確認とメンテナンスが必要です。

**最終確認日: 2024年10月29日**

---

## ベースURL

```
https://www.boatrace.jp
```

---

## 主要エンドポイント

### 1. レース一覧
**URL:** `/owpc/pc/race/racelist`

**パラメータ:**
- `hd`: 開催日（YYYYMMDD形式）例: `20241029`

**用途:** 指定日に開催されているレースの一覧を取得

**例:**
```
https://www.boatrace.jp/owpc/pc/race/racelist?hd=20241029
```

---

### 2. 出走表（レース詳細）
**URL:** `/owpc/pc/race/racelist`

**パラメータ:**
- `rno`: レース番号（1-12）
- `jcd`: 競艇場コード（01-24）
- `hd`: 開催日（YYYYMMDD形式）

**用途:** 特定レースの出走表（選手情報、モーター・ボート情報など）

**例:**
```
https://www.boatrace.jp/owpc/pc/race/racelist?rno=1&jcd=10&hd=20241029
```

---

### 3. レース結果
**URL:** `/owpc/pc/race/raceresult`

**パラメータ:**
- `rno`: レース番号（1-12）
- `jcd`: 競艇場コード（01-24）
- `hd`: 開催日（YYYYMMDD形式）

**用途:** 確定したレース結果（着順、払戻金）

**例:**
```
https://www.boatrace.jp/owpc/pc/race/raceresult?rno=1&jcd=10&hd=20241026
```

---

### 4. オッズ情報
**URL:** `/owpc/pc/race/oddstf`

**パラメータ:**
- `rno`: レース番号（1-12）
- `jcd`: 競艇場コード（01-24）
- `hd`: 開催日（YYYYMMDD形式）

**用途:** 3連単オッズ情報

**例:**
```
https://www.boatrace.jp/owpc/pc/race/oddstf?rno=1&jcd=10&hd=20241029
```

---

## 競艇場コード一覧

| コード | 競艇場 | コード | 競艇場 |
|--------|--------|--------|--------|
| 01 | 桐生 | 13 | 尼崎 |
| 02 | 戸田 | 14 | 鳴門 |
| 03 | 江戸川 | 15 | 丸亀 |
| 04 | 平和島 | 16 | 児島 |
| 05 | 多摩川 | 17 | 宮島 |
| 06 | 浜名湖 | 18 | 徳山 |
| 07 | 蒲郡 | 19 | 下関 |
| 08 | 常滑 | 20 | 若松 |
| 09 | 津 | 21 | 芦屋 |
| 10 | 三国 | 22 | 福岡 |
| 11 | びわこ | 23 | 唐津 |
| 12 | 住之江 | 24 | 大村 |

---

## HTML構造の特徴

### 出走表のHTML構造
- **形式:** XML形式のHTML（`<?xml version="1.0"...>`で開始）
- **テーブル:** `<table class="is-w495">` で選手情報を格納
- **各行:** `<tbody>` 内の `<tr>` に1選手の情報
- **艇番:** `class="is-boatColor{N}"` で識別（N=1-6）

### 結果ページのHTML構造
- **形式:** XML形式のHTML
- **結果テーブル:** 複数の `<tbody>` 要素（各艇ごとに1つ）
- **着順:** 全角数字（"１", "２", "３"...）
- **艇番:** `class="is-boatColor{N}"` で識別
- **データなし:** `<span>データがありません。</span>` が表示される

---

## よくある変更パターン

### 1. URLパスの変更
**例:**
```
旧: /owpc/pc/race/racelist
新: /owpc/v2/pc/race/racelist
```

**対策:**
- `config/settings.py` で URL を一元管理
- 変更時は設定ファイルのみ更新

### 2. パラメータ名の変更
**例:**
```
旧: jcd（競艇場コード）
新: venue_code
```

**対策:**
- パラメータ構築を関数化
- 設定ファイルでパラメータマッピングを管理

### 3. HTMLクラス名の変更
**例:**
```
旧: class="is-w495"
新: class="race-table-main"
```

**対策:**
- 複数の検索パターンを用意（フォールバック）
- 現在実装:
  - 方法1: 特定クラス名で検索
  - 方法2: 全要素から特徴的な内容で検索

### 4. HTML構造の変更
**例:**
```
旧: <table><tbody><tr>...</tr></tbody></table>
新: <div class="race-info"><div class="racer">...</div></div>
```

**対策:**
- BeautifulSoupの柔軟な検索機能を活用
- 構造に依存しすぎない実装
- データの特徴（艇番、着順など）で判定

---

## メンテナンス方針

### 定期確認項目
1. **URLの動作確認** - 月1回
2. **HTMLクラス名の確認** - 月1回
3. **データ取得の成功率** - 毎日

### エラー検知
- スクレイピング失敗率が20%を超えたら調査
- 新しいエラーメッセージが出現したら調査
- 「データがありません」が連続したら調査

### 変更時の対応手順
1. エラーログから問題箇所を特定
2. 公式サイトで実際のHTMLを確認
3. 該当スクレイパーを修正
4. テスト実行
5. 本番適用

---

## 実装箇所

### URL管理
- **ファイル:** `config/settings.py`
- **変数:** `BOATRACE_BASE_URL`, `BOATRACE_OFFICIAL_URL`

### スクレイパー
- **出走表:** `src/scraper/race_scraper.py`
- **結果:** `src/scraper/result_scraper.py`
- **オッズ:** `src/scraper/odds_scraper.py`

### ベースクラス
- **ファイル:** `src/scraper/base_scraper.py`
- **役割:** 共通のHTTP処理、エラーハンドリング

---

## 参考情報

### User-Agent
```
Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
```

### リクエスト間隔
- **推奨:** 1秒以上
- **設定:** `config/settings.py` の `REQUEST_DELAY`

### タイムアウト
- **デフォルト:** 30秒
- **実装箇所:** `base_scraper.py`

---

## 注意事項

1. **robots.txt の遵守**
   - 公式サイトのrobots.txtを確認
   - アクセス禁止パスは避ける

2. **過度なリクエストの禁止**
   - 短時間に大量アクセスしない
   - リクエスト間隔を守る

3. **データの取り扱い**
   - 取得データは個人利用に限定
   - 再配布・商用利用は禁止

---

## 更新履歴

| 日付 | 内容 | 担当 |
|------|------|------|
| 2024-10-29 | 初版作成 | Claude |

