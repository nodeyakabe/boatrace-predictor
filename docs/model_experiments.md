# モデル実験履歴

このドキュメントは、ボートレース予測モデルの実験履歴を時系列で記録します。

---

## 実験 #001: Stage2ベースラインモデル

**日付**: 2025-11-13

**目的**: 基本特徴量のみを使用したシンプルなモデルの性能を測定

### モデル仕様
- **アルゴリズム**: XGBoost
- **特徴量数**: 30個
- **特徴量リスト**:
  - 基本情報: venue_code, race_number, pit_number, racer_number
  - モーター・ボート: motor_number, boat_number, motor_2rate, boat_2rate
  - 展示情報: tenji_time, tenji_course
  - スタート情報: start_timing, start_course
  - 枠番ダミー: pit_number_1〜6
  - コースダミー: actual_course_1〜6
  - 派生特徴: pit_course_diff

### ハイパーパラメータ
```python
{
    'objective': 'binary:logistic',
    'max_depth': 6,
    'learning_rate': 0.1,
    'n_estimators': 100,
    'random_state': 42
}
```

### 学習データ
- **期間**: 2024-04-01 〜 2024-06-30
- **総レース数**: 2,484レース
- **総エントリー数**: 14,904件（結果あり: 14,724件）
- **Train/Test分割**: 80/20（stratified）

### 結果

#### 学習時の評価
- **Train AUC**: 0.8551
- **Train Log Loss**: 0.4467

#### バックテスト評価
- **Test AUC**: **0.9273** ⭐
- **Test Log Loss**: 0.3883
- **Test Accuracy**: 87.82%
- **レース単位的中率**: **68.60%** (1,704/2,484レース)
- **推定ROI**: **480.19%** (仮想オッズ7倍)

#### 確率帯別的中率
| 確率帯 | レース数 | 的中率 |
|--------|---------|--------|
| 0.0-0.2 | 0 | - |
| 0.2-0.4 | 38 | 42.11% |
| 0.4-0.6 | 219 | 43.38% |
| 0.6-0.8 | 450 | 35.78% |
| **0.8-1.0** | **1,777** | **77.87%** ⭐ |

### 考察
- シンプルな基本特徴量のみで高い的中率を達成
- 0.8以上の高確率帯で77.87%の的中率は非常に信頼できる
- 0.6-0.8の中確率帯で的中率が急落するのは、モデルの不確実性が高いレースを示唆
- **推奨戦略**: 予測確率0.8以上のレースのみに投資

### モデル保存場所
- `models/stage2_baseline_3months.json`
- `models/stage2_baseline_3months.meta.json`

### 関連スクリプト
- 学習: `train_stage2_baseline.py`
- バックテスト: `run_backtest_baseline.py`

---

## 実験 #002: Stage2選手特徴量込みモデル

**日付**: 2025-11-13

**目的**: 選手の過去成績を特徴量として追加することで予測精度が向上するか検証

### モデル仕様
- **アルゴリズム**: XGBoost
- **特徴量数**: 40個（ベースライン30 + 選手特徴10）
- **追加特徴量**:
  - **選手直近成績**:
    - recent_avg_rank_3/5/10（直近N戦の平均順位）
    - recent_win_rate_3/5/10（直近N戦の勝率）
    - total_races（総レース数）
  - **会場別選手成績**:
    - venue_win_rate（会場別勝率）
    - venue_avg_rank（会場別平均順位）
    - venue_races（会場別レース数）

### ハイパーパラメータ
```python
{
    'objective': 'binary:logistic',
    'max_depth': 6,
    'learning_rate': 0.1,
    'n_estimators': 100,
    'random_state': 42
}
```
（ベースラインと同一）

### 学習データ
- **期間**: 2024-04-01 〜 2024-06-30（ベースラインと同一）
- **総レース数**: 2,484レース
- **総エントリー数**: 14,724件
- **Train/Test分割**: 80/20（stratified）

### 結果

#### 学習時の評価
- **Train AUC**: 0.8495
- **Train Log Loss**: 0.4386

#### バックテスト評価
- **Test AUC**: **0.9139** (vs ベースライン: 0.9273)
- **Test Log Loss**: 0.3883
- **Test Accuracy**: 87.01%
- **レース単位的中率**: **65.70%** (1,632/2,484レース)
- **推定ROI**: **459.90%** (仮想オッズ7倍)

#### 確率帯別的中率
| 確率帯 | レース数 | 的中率 |
|--------|---------|--------|
| 0.0-0.2 | 0 | - |
| 0.2-0.4 | 31 | 41.94% |
| 0.4-0.6 | 212 | 43.40% |
| 0.6-0.8 | 462 | 35.50% |
| **0.8-1.0** | **1,779** | **76.62%** |

### 比較結果（ベースライン vs 選手特徴量込み）

| 指標 | ベースライン | 選手特徴量込み | 差分 |
|------|------------|--------------|------|
| AUC | 0.9273 | 0.9139 | **-0.0134** ⚠️ |
| 的中率 | 68.60% | 65.70% | **-2.90%** ⚠️ |
| ROI | 480.19% | 459.90% | **-20.29%** ⚠️ |
| 的中数 | 1,704 | 1,632 | **-72レース** |

### 考察

#### ❌ 予想外の結果
選手特徴量を追加したにもかかわらず、全ての指標でパフォーマンスが低下しました。

#### 原因の仮説

**1. 特徴量の冗長性**
- 選手の実力は既に「展示タイム」「スタートタイミング」などの基本特徴量に反映されている
- 直近3〜10戦の成績では情報が不足している可能性

**2. 過学習の兆候**
- Train AUC: 0.8551 → 0.8495（低下）
- Test AUC: 0.9273 → 0.9139（低下）
- 訓練時点で既にパフォーマンスが低下

**3. 特徴量の質的問題**
- 直近N戦の成績は短期的すぎる（より長期的な指標が必要）
- 会場別成績はサンプル数が不足している可能性
- 交互作用項が不足している（例: venue_code × venue_win_rate）

**4. データ品質**
- racer_featuresの計算ロジックに問題がある可能性は低い（データ漏洩チェック済み）
- 欠損値の処理方法が適切でない可能性

### 次のアクション
- [ ] SHAP値による特徴量重要度の詳細分析
- [ ] より長期的な選手成績（直近30戦、50戦）の検証
- [ ] 交互作用項の追加（venue_code × venue_win_rate など）
- [ ] 特徴量選択（L1正則化、RFE）による不要な特徴量の削除

### 結論
**現時点では、ベースラインモデル（実験#001）を推奨します。**

### モデル保存場所
- `models/stage2_with_racer_features_3months.json`
- `models/stage2_with_racer_features_3months.meta.json`

### 関連スクリプト
- 学習: `train_stage2_with_racer_features.py`
- バックテスト: `run_backtest_with_racer_features.py`

### 詳細レポート
- `BACKTEST_COMPARISON_REPORT.md`

---

## 今後の実験予定

### Phase 1: 特徴量エンジニアリングの改善

#### 実験 #003: 交互作用項の追加（予定）
- actual_course_1 × tenji_time
- actual_course_1 × recent_win_rate
- venue_code × motor_2rate

#### 実験 #004: 展示タイムの会場別正規化（予定）
- 会場ごとに展示タイムを標準化
- 会場間の基準の違いを吸収

#### 実験 #005: スタートタイミングの質的評価（予定）
- フライング、完璧、良好、遅れの4段階に分類
- ワンホットエンコーディング

### Phase 2: より高度な特徴量の追加

#### 実験 #006: モーター性能の推移（予定）
- モーター2連対率の最近3節の推移
- モーター整備後のパフォーマンス変化

#### 実験 #007: 選手の調子指標（予定）
- 直近5戦の順位の標準偏差（安定性）
- 連勝中・連敗中フラグ

#### 実験 #008: 天候データの追加（予定）
- 風速・風向き、気温、波高など

### Phase 3: モデルアーキテクチャの改善

#### 実験 #009: LSTMモデル（予定）
- 選手の過去成績を時系列データとして扱う

#### 実験 #010: アンサンブル学習（予定）
- ベースラインモデルと他モデルのブレンディング

---

## 実験テンプレート

```markdown
## 実験 #XXX: [実験名]

**日付**: YYYY-MM-DD

**目的**: [この実験で検証したいこと]

### モデル仕様
- **アルゴリズム**:
- **特徴量数**:
- **特徴量リスト**:
- **ハイパーパラメータ**:

### 学習データ
- **期間**:
- **総レース数**:
- **総エントリー数**:

### 結果
#### 学習時の評価
- **Train AUC**:
- **Train Log Loss**:

#### バックテスト評価
- **Test AUC**:
- **Test Log Loss**:
- **レース単位的中率**:
- **推定ROI**:

### 考察
[結果の分析]

### 結論
[この実験から得られた知見]

### モデル保存場所
-

### 関連スクリプト
-
```

---

**最終更新**: 2025-11-13
