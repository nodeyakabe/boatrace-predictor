# Phase 2 é€²æ—çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ

ä½œæˆæ—¥: 2025-12-10
ä½œæˆè€…: Claude Sonnet 4.5

---

## ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

Phase 2ï¼ˆæ€§èƒ½æœ€é©åŒ–ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼‰ã®å®Ÿè£…ã‚’é–‹å§‹ã—ã€æœ€å„ªå…ˆã‚¿ã‚¹ã‚¯ã§ã‚ã‚‹ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è»½é‡å®Ÿè£…ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚

### å®Œäº†ã‚¿ã‚¹ã‚¯

âœ… **ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è»½é‡å®Ÿè£…** - Phase 1ã®é‡ã„æŠ½å‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ500ãƒ¬ãƒ¼ã‚¹ã§30åˆ†è¶…ï¼‰ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰åŒ–ã—ã€å³åº§ã«å®Ÿè¡Œå¯èƒ½ãªè»½é‡ç‰ˆã‚’å®Ÿè£…

### é€²è¡Œä¸­ã‚¿ã‚¹ã‚¯

ğŸ”„ Phase 2ã®æ®‹ã‚Šã‚¿ã‚¹ã‚¯ã®æº–å‚™ä¸­

---

## 1. å®Œäº†ã‚¿ã‚¹ã‚¯è©³ç´°

### Task 2.1: ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è»½é‡å®Ÿè£… âœ…

**ç›®çš„**: äºˆæ¸¬ãŒå¤–ã‚Œã‚„ã™ã„æ¡ä»¶ã‚’æ¤œå‡ºã—ã€ã‚¹ã‚³ã‚¢èª¿æ•´ã‚’è¡Œã†

**å®Ÿè£…å†…å®¹**:

#### 1.1 NegativePatternChecker ã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: [src/analysis/negative_pattern_checker.py](../src/analysis/negative_pattern_checker.py)

**4ç¨®é¡ã®ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³**:

| ãƒ‘ã‚¿ãƒ¼ãƒ³ID | åå‰ | æ¡ä»¶ | Severity | ã‚¹ã‚³ã‚¢èª¿æ•´ |
|-----------|------|------|----------|-----------|
| `both_bad` | å±•ç¤ºãƒ»STä¸¡æ–¹ä¸è‰¯ | å±•ç¤ºãƒ»STä¸¡æ–¹ãŒãƒ¯ãƒ¼ã‚¹ãƒˆ2ä»¥å†… | high | 0.85å€ï¼ˆ-15%ï¼‰ |
| `rank_divergence` | å±•ç¤ºãƒ»STé †ä½ä¹–é›¢ | å±•ç¤ºã¨STã®é †ä½å·®â‰¥4ãƒ©ãƒ³ã‚¯ | medium | 0.90å€ï¼ˆ-10%ï¼‰ |
| `st_timing_off` | STã‚¿ã‚¤ãƒŸãƒ³ã‚°å¤§å¹…ãšã‚Œ | STÂ±0.15ç§’ä»¥ä¸Šãšã‚Œ | medium | 0.90å€ï¼ˆ-10%ï¼‰ |
| `ex_worst` | å±•ç¤ºã‚¿ã‚¤ãƒ ãƒ¯ãƒ¼ã‚¹ãƒˆ | å±•ç¤ºã‚¿ã‚¤ãƒ ãƒ¯ãƒ¼ã‚¹ãƒˆ2ä»¥å†… | low | 0.95å€ï¼ˆ-5%ï¼‰ |

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

```python
def check_prediction(
    pit_number, ex_rank, st_rank, st_time, pre_rank
) -> Dict:
    """
    äºˆæ¸¬ã«å¯¾ã™ã‚‹ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯

    Returns:
        {
            'has_negative': bool,
            'matched_patterns': List[str],
            'severity': str,
            'recommended_multiplier': float,
            'warnings': List[str]
        }
    """
```

```python
def apply_negative_adjustments(
    predictions: List[Dict],
    before_ranks: Dict[int, Dict]
) -> List[Dict]:
    """
    äºˆæ¸¬ãƒªã‚¹ãƒˆã«ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³èª¿æ•´ã‚’é©ç”¨
    ã‚¹ã‚³ã‚¢é™é †ã§å†ã‚½ãƒ¼ãƒˆ
    """
```

#### 1.2 race_predictorçµ±åˆ

**å¤‰æ›´ç®‡æ‰€**:

1. **ã‚¤ãƒ³ãƒãƒ¼ãƒˆ** ([race_predictor.py:30](../src/analysis/race_predictor.py#L30))
   ```python
   from .negative_pattern_checker import NegativePatternChecker
   ```

2. **ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–** ([race_predictor.py:265](../src/analysis/race_predictor.py#L265))
   ```python
   self.negative_pattern_checker = NegativePatternChecker()
   ```

3. **ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒã‚§ãƒƒã‚¯é©ç”¨** ([race_predictor.py:1869-1884](../src/analysis/race_predictor.py#L1869-L1884))
   ```python
   if is_feature_enabled('negative_patterns'):
       before_ranks_map = {}
       for pred in predictions:
           pit_num = pred.get('pit_number')
           before_ranks_data = pred.get('before_ranks', {})
           if before_ranks_data:
               before_ranks_map[pit_num] = before_ranks_data

       if before_ranks_map:
           predictions = self.negative_pattern_checker.apply_negative_adjustments(
               predictions,
               before_ranks_map
           )
   ```

#### 1.3 ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: [config/feature_flags.py](../config/feature_flags.py#L20)

```python
'negative_patterns': False,  # ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆPhase 2: è»½é‡å®Ÿè£…ã€åˆæœŸã¯ç„¡åŠ¹ï¼‰
```

**åˆ¶å¾¡æ–¹æ³•**:
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `False`ï¼ˆç„¡åŠ¹ï¼‰
- æœ‰åŠ¹åŒ–: `set_feature_flag('negative_patterns', True)`
- æœ¬ç•ªç’°å¢ƒã§æ®µéšçš„ã«ãƒ†ã‚¹ãƒˆå¯èƒ½

---

## 2. å‹•ä½œç¢ºèªçµæœ

### ãƒ†ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¹ID: 133467

**ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º**:

| è‰‡ç•ª | å…ƒã‚¹ã‚³ã‚¢ | èª¿æ•´å¾Œ | ãƒ‘ã‚¿ãƒ¼ãƒ³ | Severity |
|------|---------|--------|---------|----------|
| è‰‡4 | 56.9 | **48.4** (-8.5) | both_bad, ex_worst | high |
| è‰‡6 | 53.2 | **45.2** (-8.0) | both_bad, ex_worst | high |

**ãƒˆãƒƒãƒ—3äºˆæ¸¬** (ãƒã‚¬ãƒ†ã‚£ãƒ–èª¿æ•´å¾Œ):
1. è‰‡1: ã‚¹ã‚³ã‚¢100.0ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªã—ï¼‰
2. è‰‡3: ã‚¹ã‚³ã‚¢66.6ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªã—ï¼‰
3. è‰‡5: ã‚¹ã‚³ã‚¢63.1ï¼ˆãƒã‚¬ãƒ†ã‚£ãƒ–ãªã—ï¼‰

**ãƒ­ã‚°å‡ºåŠ›**:
```
INFO: è‰‡4: ãƒã‚¬ãƒ†ã‚£ãƒ–èª¿æ•´ 56.9 â†’ 48.4 (high: both_bad, ex_worst)
INFO: è‰‡6: ãƒã‚¬ãƒ†ã‚£ãƒ–èª¿æ•´ 53.2 â†’ 45.2 (high: both_bad, ex_worst)
```

âœ… **æ¤œè¨¼çµæœ**: æ­£å¸¸ã«å‹•ä½œã€ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒé©åˆ‡ã«æ¤œå‡ºãƒ»èª¿æ•´ã•ã‚Œã¦ã„ã‚‹

---

## 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

### Phase 1 vs Phase 2

| é …ç›® | Phase 1ï¼ˆé‡ã„ç‰ˆï¼‰ | Phase 2ï¼ˆè»½é‡ç‰ˆï¼‰ | æ”¹å–„ç‡ |
|------|-----------------|-----------------|--------|
| **å®Ÿè£…æ–¹æ³•** | å®Ÿãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æŠ½å‡º | ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ | - |
| **å‡¦ç†æ™‚é–“** | 500ãƒ¬ãƒ¼ã‚¹ã§30åˆ†è¶… | å³åº§ï¼ˆ<0.1ç§’ï¼‰ | **99%ä»¥ä¸Šå‰Šæ¸›** |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨** | å¤§é‡ã®DBã‚¯ã‚¨ãƒª | è»½é‡ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ï¼‰ | å¤§å¹…å‰Šæ¸› |
| **ä¿å®ˆæ€§** | æŠ½å‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå¿…è¦ | ã‚³ãƒ¼ãƒ‰å†…ã«å®šç¾© | å‘ä¸Š |

---

## 4. æŠ€è¡“ä»•æ§˜

### ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯

1. **ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯é †åº**:
   - BEFOREæƒ…å ±ï¼ˆex_rank, st_rank, st_timeï¼‰ã‚’å–å¾—
   - 4ç¨®é¡ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é †æ¬¡ãƒã‚§ãƒƒã‚¯
   - è¤‡æ•°ãƒãƒƒãƒæ™‚ã¯æœ€ã‚‚é‡ã„ severity ã¨æœ€å° multiplier ã‚’æ¡ç”¨

2. **Severityã®å„ªå…ˆé †ä½**:
   ```
   high > medium > low > none
   ```

3. **ã‚¹ã‚³ã‚¢èª¿æ•´æ–¹æ³•**:
   ```python
   adjusted_score = current_score * min_multiplier
   # ä¾‹: 56.9 * 0.85 = 48.4
   ```

4. **äºˆæ¸¬æƒ…å ±ã®æ›´æ–°**:
   ```python
   pred['negative_pattern_applied'] = True
   pred['negative_patterns'] = ['both_bad', 'ex_worst']
   pred['negative_severity'] = 'high'
   pred['negative_multiplier'] = 0.85
   pred['negative_warnings'] = ["å±•ç¤ºãƒ»STä¸¡æ–¹ä¸è‰¯: ...", "å±•ç¤ºã‚¿ã‚¤ãƒ ãƒ¯ãƒ¼ã‚¹ãƒˆ: ..."]
   pred['score_before_negative'] = 56.9
   pred['total_score'] = 48.4
   ```

---

## 5. æœŸå¾…åŠ¹æœ

### ç²¾åº¦å‘ä¸Šã®ä»®èª¬

**ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ã«ã‚ˆã‚‹åŠ¹æœ**:

1. **èª¤ã£ãŸé«˜è©•ä¾¡ã®æŠ‘åˆ¶**
   - å±•ç¤ºãƒ»STä¸¡æ–¹ãŒæ‚ªã„è‰‡ã®éå¤§è©•ä¾¡ã‚’é˜²æ­¢
   - äºˆæ¸¬é †ä½ã®ç²¾åº¦å‘ä¸Š

2. **ãƒªã‚¹ã‚¯å›é¿**
   - ä¸å®‰å®šãªè‰‡ï¼ˆSTå¤§å¹…ãšã‚Œç­‰ï¼‰ã‚’ä½è©•ä¾¡
   - å …å®Ÿãªäºˆæ¸¬ã®å®Ÿç¾

3. **ROIæ”¹å–„**
   - ä½ç¢ºç‡è‰‡ã¸ã®èª¤ãƒ™ãƒƒãƒˆã‚’å‰Šæ¸›
   - çš„ä¸­ç‡ã®å®‰å®šåŒ–

**æ¤œè¨¼äºˆå®š**:
- 100ãƒ¬ãƒ¼ã‚¹ã§ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
- ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚ã‚Š/ãªã—ã®æ¯”è¼ƒ
- çš„ä¸­ç‡ãƒ»å›åç‡ã®å¤‰åŒ–ã‚’æ¸¬å®š

---

## 6. ä»Šå¾Œã®å±•é–‹

### Phase 2ã®æ®‹ã‚Šã‚¿ã‚¹ã‚¯

#### å„ªå…ˆåº¦: é«˜

**Task 2.2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
- ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æ©Ÿæ§‹ã®å®Ÿè£…
- ç›®æ¨™: 1000ãƒ¬ãƒ¼ã‚¹åˆ†æã‚’60åˆ† â†’ 15åˆ†ã«çŸ­ç¸®

**Task 2.3: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**
- ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ç‡ã®å¯è¦–åŒ–
- çš„ä¸­ç‡ãƒˆãƒ¬ãƒ³ãƒ‰ã®ç›£è¦–
- ç•°å¸¸æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆ

#### å„ªå…ˆåº¦: ä¸­

**Task 2.4: ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨çŠ¶æ³ã®å¯è¦–åŒ–**
- UIã¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³æƒ…å ±è¡¨ç¤º
- ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è­¦å‘Šã®è¡¨ç¤º

---

## 7. ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚µãƒãƒªãƒ¼

### æ–°è¦ä½œæˆ

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œæ•° | æ¦‚è¦ |
|---------|------|------|
| [src/analysis/negative_pattern_checker.py](../src/analysis/negative_pattern_checker.py) | 205 | ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚«ãƒ¼è»½é‡ç‰ˆ |

### ä¿®æ­£

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´è¡Œæ•° | ä¸»ãªå¤‰æ›´å†…å®¹ |
|---------|---------|-------------|
| [src/analysis/race_predictor.py](../src/analysis/race_predictor.py) | +20 | NegativePatternCheckerçµ±åˆ |
| [config/feature_flags.py](../config/feature_flags.py) | +1 | negative_patternsãƒ•ãƒ©ã‚°è¿½åŠ  |

---

## 8. Gitå±¥æ­´

```
Commit: aadbf40
Message: Phase 2é–‹å§‹: ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è»½é‡å®Ÿè£…å®Œäº†
Files: 4 files changed, 605 insertions(+)
Push: âœ… origin/main
```

---

## 9. æ¬¡ã‚¹ãƒ†ãƒƒãƒ—

Phase 2ã®æ®‹ã‚Šã‚¿ã‚¹ã‚¯ã‚’ç¶™ç¶šå®Ÿè£…ã—ã¾ã™ï¼š

1. âœ… ãƒã‚¬ãƒ†ã‚£ãƒ–ãƒ‘ã‚¿ãƒ¼ãƒ³è»½é‡å®Ÿè£…ï¼ˆå®Œäº†ï¼‰
2. â­ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆæ¬¡ï¼‰
3. â­ï¸ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
4. â­ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨çŠ¶æ³ã®å¯è¦–åŒ–

æº–å‚™ãŒã§ããŸã‚‰ã€Œæ¬¡ã®ã‚¿ã‚¹ã‚¯ã«é€²ã‚“ã§ã€ã¨ãŠä¼ãˆãã ã•ã„ã€‚

---

**ä½œæˆæ—¥**: 2025-12-10
**ä½œæˆè€…**: Claude Sonnet 4.5
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 2é€²è¡Œä¸­ï¼ˆ1/4ã‚¿ã‚¹ã‚¯å®Œäº†ï¼‰
