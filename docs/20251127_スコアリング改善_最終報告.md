# スコアリング改善 最終報告書

**作成日**: 2024年11月27日
**作成者**: Claude Code

---

## 1. 改善概要

### 実施内容
展示ST・展示タイムを活用したスコアリング改善を実装

### 成果
- **単勝的中率**: 58.75% → 59.98%（**+1.23%向上**）
- **検証データ**: 2024年1月1日〜11月20日（10,475レース）

---

## 2. 新スコアリング重み配分

### 変更前（旧設定）
```python
SCORING_WEIGHTS_LEGACY = {
    "course": 35,   # コース有利度
    "racer": 35,    # 選手能力
    "motor": 20,    # モーター性能
    "rank": 10,     # 級別
}
```

### 変更後（新設定）
```python
SCORING_WEIGHTS = {
    "course": 20,          # 35→20（-15%）
    "racer": 31,           # 35→31（-4%）
    "motor": 14,           # 20→14（-6%）
    "rank": 10,            # 変更なし
    "exhibition_st": 15,   # 新規追加
    "exhibition_time": 10, # 新規追加
}
```

### 変更理由
| 項目 | 変更 | 理由 |
|------|------|------|
| コース | 35→20 | 旧設定では98%が1号艇予測に。展示データで差別化 |
| モーター | 20→14 | ML分析で影響度2.4%と判明。過大配点を修正 |
| 展示ST | 新規15% | 勝率相関が6倍差。当日の調子を反映 |
| 展示タイム | 新規10% | 勝率相関が3倍差。モーター調子を反映 |

---

## 3. 展示ST・展示タイムの分析結果

### 3.1 展示ST順位別勝率
| 順位 | 勝率 | 備考 |
|------|------|------|
| 1位 | 33.23% | 最高 |
| 2位 | 19.72% | |
| 3位 | 14.42% | |
| 4位 | 11.22% | |
| 5位 | 8.91% | |
| 6位 | 5.44% | 1位の約1/6 |

### 3.2 展示タイム順位別勝率
| 順位 | 勝率 | 備考 |
|------|------|------|
| 1位 | 27.30% | 最高 |
| 2位 | 20.48% | |
| 3位 | 16.42% | |
| 4位 | 13.58% | |
| 5位 | 11.03% | |
| 6位 | 8.64% | 1位の約1/3 |

### 3.3 交絡因子の検証

#### コースとの交絡
1コースの選手は展示ST1位になりやすい（32.94% vs 平均16.67%）

| コース | ST1位率 | 平均ST順位 |
|--------|--------|-----------|
| 1コース | 32.94% | 2.95 |
| 2コース | 15.14% | 3.53 |
| 6コース | 14.90% | 4.03 |

#### 級別との交絡
A1選手は展示ST1位になりやすい（23.58% vs B2選手17.05%）

### 3.4 純粋な効果（交絡を除去）

**同一コース内での展示ST効果**

| コース | ST1位の勝率 | ST2位以下の勝率 | 差分 |
|--------|-----------|--------------|------|
| 1コース | 75.11% | 50.46% | **+24.65%** |
| 2コース | 21.59% | 10.74% | +10.85% |
| 3コース | 19.06% | 8.97% | +10.09% |
| 4コース | 23.63% | 6.12% | +17.51% |
| 5コース | 11.85% | 3.78% | +8.07% |
| 6コース | 7.98% | 1.76% | +6.22% |

**結論**: 交絡因子を除去しても効果は本物。特に1コースで効果大。

---

## 4. バックテスト結果詳細

### 4.1 重み配分パターン比較

| 設定 | 単勝的中率 | ベースライン比 |
|------|-----------|--------------|
| 旧設定（ベースライン） | 58.75% | - |
| **新設定（ST15/ET10）** | **59.98%** | **+1.23%** |
| 調整1（ST15/ET5） | 59.47% | +0.72% |
| 調整2（ST18/ET5） | 59.57% | +0.82% |
| 調整3（ST20/ET0） | 58.81% | +0.06% |
| 調整4（ST25/ET0） | 57.05% | -1.70% |
| 調整5（コース25/ST15） | 59.50% | +0.75% |

### 4.2 グリッドサーチ最適解
```python
{
    'course': 22,
    'racer': 28,
    'motor': 14,
    'rank': 10,
    'exhibition_st': 18,
    'exhibition_time': 8,
}
# 結果: 59.88%（現設定より-0.10%低い）
```

### 4.3 結論
- **現在の設定（ST15%/ET10%）が最適**
- 展示タイムを削減すると精度が下がる
- 展示タイムを完全削除すると大幅に悪化

---

## 5. 実装ファイル一覧

### 設定ファイル
- `config/settings.py` - SCORING_WEIGHTS更新済み

### スコアリングモジュール
- `src/analysis/race_predictor.py` - メイン予測ロジック（既存）
- `src/analysis/extended_scorer.py` - 拡張スコア計算（既存）
- `src/analysis/improved_scorer.py` - 改善版スコアラー（新規）

### 分析スクリプト（temp/）
- `backtest_exhibition_adjustment.py` - 重み調整バックテスト
- `analyze_exhibition_factors.py` - 交絡因子分析
- `verify_improvement.py` - 改善効果検証

### UI
- `ui/components/unified_race_detail.py` - 展示データ表示追加
- `ui/components/improvements_display.py` - 改善機能説明追加

### ドキュメント
- `docs/exhibition_analysis_report.md` - 展示データ分析レポート

---

## 6. 今後の改善案

### 短期（効果見込み: +0.2〜0.5%）
1. **天候×展示ST交互作用**
   - 強風時は展示ST効果が低下（-7.7%）
   - 高波時も効果低下（-9.7%）
   - 条件別に重みを動的調整

2. **コース×展示ST交互作用**
   - 1コースでの効果が特に大きい
   - 4コース（まくり）でも効果大
   - コース別に展示ST重みを変更

### 中期（効果見込み: +0.5〜1.0%）
3. **級別×展示ST補正**
   - A1選手のST1位: 71.09%勝率
   - B2選手のST1位: 34.79%勝率
   - 級別で展示ST効果を調整

4. **展示STの絶対値活用**
   - 現在は順位のみ使用
   - 0.10-0.15秒が最適（24.38%勝率）
   - 0.20秒以上は低い（9.64%勝率）

### 長期（要検証）
5. **機械学習モデルへの統合**
   - 展示ST/タイムを特徴量として追加
   - 非線形な効果を捉える

---

## 7. 重要な知見まとめ

### 展示STについて
1. **効果は本物** - 交絡を除去しても有意な効果あり
2. **1コースで最も重要** - ST1位で+24.65%の勝率差
3. **4コース（まくり）でも重要** - スタートがまくりの成否を決める

### 展示タイムについて
1. **効果はSTより小さい** - 1位-6位差が15.96%（STは44.18%）
2. **削除すると悪化** - 10%→0%で的中率低下
3. **モーター調子の指標** - 当日の状態を反映

### スコアリング全般
1. **コース重視は過大だった** - 35%→20%で改善
2. **モーターも過大評価** - ML分析で影響度2.4%
3. **展示データは即効性高い** - 当日の情報を活用

---

## 8. 参考：スコア計算ロジック

### 展示ST順位スコア
```python
def _calculate_exhibition_st_rank_score(entry, race_entries, max_score=15):
    # 有効な展示STを収集
    valid_sts = [(e['pit_number'], e['exhibition_st'])
                 for e in race_entries if e['exhibition_st'] > 0]

    # ST順でソート（早い順）
    sorted_sts = sorted(valid_sts, key=lambda x: x[1])

    # 順位を特定してスコア計算
    for rank, (pit, st) in enumerate(sorted_sts, 1):
        if pit == entry['pit_number']:
            # 順位スコア: 1位=100%, 6位≈0%
            rank_factor = (len(sorted_sts) + 1 - rank) / len(sorted_sts)
            return max_score * rank_factor
```

### 展示タイム順位スコア
```python
def _calculate_exhibition_time_rank_score(entry, race_entries, max_score=10):
    # 同様のロジック（タイムが早いほど高スコア）
```

---

## 9. 検証用コマンド

### バックテスト実行
```bash
cd c:\Users\User\Desktop\BR\BoatRace_package_20251115_172032
python temp/backtest_exhibition_adjustment.py
```

### 改善効果確認
```bash
python temp/verify_improvement.py
```

### 交絡因子分析
```bash
python temp/analyze_exhibition_factors.py
```

---

**以上**
