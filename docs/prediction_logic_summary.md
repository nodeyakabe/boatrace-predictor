# ボートレース予測システム - 予測ロジックと仕様書

## 1. 予測モデルの概要

### 1.1 基本アプローチ
- **統計ベース + ルールベースのハイブリッドモデル**
- 機械学習は使用せず、ドメイン知識と統計分析を組み合わせた予測
- 5つの要素を数値化してスコアリング

### 1.2 予測対象
- **1着予測**のみ（2着以降も順位付けするが、主目的は1着の的中）
- 信頼度A-Eの5段階で予測の確実性を評価
- 現在の的中率: **約60-64%**（2日間平均61.4%）

## 2. スコアリング要素と重み配分

### 2.1 5つの評価要素（合計100点）

```
1. コーススコア（重み: 40点）
   - 会場別・コース別の勝率データ
   - 歴史的データから算出した統計値

2. 選手スコア（重み: 30点）
   - 選手の総合成績（全国・当地・コース別）
   - 勝率、2連対率、3連対率

3. モータースコア（重み: 15点）
   - モーター2連対率
   - モーター直近成績

4. 決まり手適性スコア（重み: 10点）
   - 選手の得意な決まり手と会場・コースの相性
   - 過去180日間のデータを分析

5. グレード適性スコア（重み: 5点）
   - レースグレード（SG/G1/G2/G3/一般）での成績
   - 過去365日間のデータを分析
```

### 2.2 重み配分の根拠
- **コース40%**: ボートレースは「コースで9割決まる」と言われるほど重要
- **選手30%**: 実力差が顕著に表れる
- **モーター15%**: 機力差が勝敗を分ける
- **決まり手10%**: 会場・コース適性の重要指標
- **グレード5%**: 格上レースでの実力評価

## 3. 会場特性補正

### 3.1 補正の目的
会場ごとのインコース（1号艇）有利度が異なるため、1号艇のスコアを補正

### 3.2 補正係数（歴史的データ13,503レースから算出）

```python
会場分類:
- インが非常に強い（65%以上）: 補正係数 1.10
  例: 大村（65.8%）

- インが強い（55-65%）: 補正係数 1.05
  例: がまかつ（60.8%）、徳山（61.4%）、宮島（60.2%）、
      福岡（55.8%）、住之江（56.4%）、丸亀（56.4%）など

- 標準的（45-55%）: 補正係数 1.00
  例: 戸田（45.5%）、江戸川（47.9%）、鳴門（48.1%）、
      三国（52.9%）など

- インが弱い（45%未満）: 補正係数 0.95
  例: 戸田（45.5%）※境界線上
```

### 3.3 補正の適用
- **1号艇のコーススコアのみ**に適用
- 2-6号艇には補正なし（外枠の有利度は会場差が小さいため）

## 4. ルールベース補正エンジン

### 4.1 法則の種類と効果

基本スコアに対して、以下の法則で確率を補正：

```
1. 選手級別による補正
   - A1級選手の1号艇 → 勝率上昇
   - B2級選手の外枠 → 勝率低下

2. モーター性能による補正
   - 2連対率70%以上の超抜モーター → 勝率上昇
   - 2連対率30%以下の不調モーター → 勝率低下

3. 会場適性による補正
   - 当地勝率が全国勝率より10%以上高い → 勝率上昇
   - 当地勝率が全国勝率より10%以上低い → 勝率低下

4. コース別進入による補正
   - 1コース進入の実績が高い選手 → 1号艇で勝率上昇

5. 決まり手適性による補正
   - 会場の主流決まり手と選手の得意技が一致 → 勝率上昇
```

### 4.2 補正の仕組み
- 基本スコアをsoftmax変換で確率化
- 各法則で確率を±5-15%程度調整
- 調整後の確率を再度スコアに逆変換

## 5. 信頼度判定ロジック

### 5.1 信頼度の基準（2段階判定）

**第1段階: スコアベース判定**
```
A: 75点以上
B: 65-74点
C: 55-64点
D: 45-54点
E: 45点未満
```

**第2段階: データ量による制限**
```
データ充実度スコア（0-100点）を算出:
- 選手全国成績: 0-40点
- 選手コース別成績: 0-25点
- 選手当地成績: 0-15点
- モーター成績: 0-20点

データ充実度による信頼度上限:
- 80点以上 → A可能
- 60点以上 → B可能
- 40点以上 → C可能
- 20点以上 → D可能
- 20点未満 → E固定
```

### 5.2 現在の信頼度分布と的中率（2025-11-17）

```
B: 4.7%（6レース） → 66.7%的中
C: 52.7%（68レース） → 66.2%的中
D: 34.9%（45レース） → 55.6%的中
E: 7.8%（10レース） → 20.0%的中
```

## 6. データソースと統計期間

### 6.1 使用データ
- **期間**: 2024-01-03 ～ 2025-11-19（約2年間）
- **総レース数**: 15,294レース
- **結果データ**: 13,649レース
- **対象会場**: 全24会場

### 6.2 統計計算の期間設定
```
- コース別勝率: 全期間（会場単位で集計）
- 選手成績: 直近レースデータ（期間指定なし）
- モーター成績: 当節のモーター実績
- 決まり手分析: 過去180日間
- グレード適性: 過去365日間
```

## 7. 予測プロセスの流れ

```
1. レース情報取得
   ↓
2. 各艇のデータ収集
   - 選手データ（全国/当地/コース別）
   - モーターデータ
   - 決まり手実績
   - グレード実績
   ↓
3. 基本スコア計算（5要素）
   - コーススコア
   - 選手スコア
   - モータースコア
   - 決まり手スコア
   - グレードスコア
   ↓
4. 会場補正適用（1号艇のみ）
   ↓
5. スコアを0-100に正規化
   ↓
6. ルールベース補正
   - スコア→確率変換
   - 法則適用
   - 確率→スコア逆変換
   ↓
7. 信頼度判定
   ↓
8. 順位付け（スコア降順）
```

## 8. 現在の強みと成功要因

### 8.1 強み
1. **会場特性の正確な把握**
   - 13,503レースという大規模データから統計算出
   - 会場ごとの補正が効果的

2. **信頼度システムの有効性**
   - B/C信頼度で約66%の的中率
   - データ量による制限で過信を防止

3. **多角的な評価**
   - 5つの異なる視点でバランス良く評価
   - 単一要素への過度な依存を回避

4. **ルールベース補正の精度**
   - ドメイン知識を活用した細かい調整
   - A1級選手、超抜モーター等の重要要素を考慮

### 8.2 実績
- **総合的中率**: 61.8%（2日間309レース）
- **信頼度B的中率**: 66.7-78.0%
- **信頼度C的中率**: 65-66%

## 9. 弱点と改善すべき課題

### 9.1 外枠（4-6号艇）予測の弱さ

**現状:**
- 5号艇予測: 0%的中（4回予測）
- 6号艇予測: 0%的中（4回予測）
- 4号艇予測: 100%的中（1回予測のみ）

**問題点:**
- サンプル数が少なすぎる
- 外枠を1着予測する基準が不明確
- 外枠が勝つ条件（荒れレース）の特定が不十分

**必要な改善:**
- 外枠を1着予測する閾値の見直し
- 「荒れやすい条件」の明確化
  - 1号艇の選手・モーターが弱い
  - 外枠に超一流選手・超抜モーター
  - 風・水面条件（現在未考慮）

### 9.2 信頼度Eの的中率が低すぎる

**現状:**
- 信頼度E: 20%的中（2025-11-17）
- 全体の7.8%を占める

**問題点:**
- 予測精度が低すぎて実用性がない
- データ不足レースの扱いが不適切

**必要な改善:**
- 信頼度E自体を減らす（より慎重な予測）
- データ不足時のデフォルト予測ロジック見直し
- 最低でも30-40%の的中率は確保したい

### 9.3 日次変動への対応不足

**現状:**
- 2025-11-17は「異常な日」だった
  - 福岡: +35.9%（実際91.7% vs 歴史的55.8%）
  - 鳴門: +33.7%（実際81.8% vs 歴史的48.1%）
  - 11会場中8会場で±10%以上の偏差

**問題点:**
- 天候、風向、潮の流れなどの当日条件を考慮していない
- 歴史的傾向のみに依存

**必要な改善:**
- 天候データの取り込み
- 風速・風向の影響度モデル化
- 潮の満ち引き（海水会場）の考慮
- 気温・水温の影響

### 9.4 信頼度Bのレース数が少ない

**現状:**
- 信頼度B: 4.7%（6/129レース）
- 的中率は高い（66.7%）が、機会が少ない

**問題点:**
- 高信頼度予測の機会損失
- 実用上、もっと多くの「買い」推奨が欲しい

**必要な改善:**
- 信頼度判定基準のさらなる緩和（慎重に）
- または、信頼度A導入（現在0レース）
- スコアリングロジックの見直しで高スコアを増やす

### 9.5 モーター評価の精度

**現状:**
- モーター重み: 15%
- 2連対率のみで評価

**問題点:**
- 直近成績の重視が不十分
- 節初め vs 節後半での性能変化を考慮していない
- モーター整備の影響を評価できない

**必要な改善:**
- 直近5走の重み付け強化
- 節内での成績推移の分析
- 選手の整備能力との相関分析

### 9.6 展示タイム・展示航走データの未活用

**現状:**
- 展示タイム、展示航走データを全く使用していない

**問題点:**
- 当日のモーター調子、選手の感触を反映できない
- 他の予測サービスが活用している重要データ

**必要な改善:**
- 展示タイムデータの取得と活用
- 展示航走（スタート、ターン）の評価
- 体重変化の考慮

### 9.7 進入予想の未実装

**現状:**
- 枠番=コースと仮定
- 進入隊形の変化を考慮していない

**問題点:**
- 実際には「イン屋」選手が外枠から1コース取りに行くケースあり
- 進入隊形の乱れで予測精度が低下

**必要な改善:**
- 選手の進入傾向データの収集
- 枠なり進入率の算出
- 前付け（イン屋）選手の特定

### 9.8 スタートタイミング評価の不足

**現状:**
- 平均STデータは取得しているが、十分に活用していない

**問題点:**
- スタートの良し悪しが勝敗に直結
- 選手のスタート力を評価不足

**必要な改善:**
- 平均STの重み付け強化
- 会場別のスタート傾向分析
- フライング後の選手評価

### 9.9 同節内の成績推移の未考慮

**現状:**
- 各レース単独で予測
- 節内での調子の波を考慮していない

**問題点:**
- 「勢いに乗っている選手」を見逃す
- 節初めの不調選手に対する評価が甘い

**必要な改善:**
- 節内成績の動的評価
- 連勝中選手へのボーナス
- 連敗中選手へのペナルティ

### 9.10 オッズ情報の未活用

**現状:**
- オッズデータを全く使用していない

**問題点:**
- 市場の知恵（他の予想者の集合知）を活用できていない
- 穴狙いと本命狙いの使い分けができない

**必要な改善:**
- オッズと予測の乖離分析
- 「人気薄だが勝つ可能性が高い」艇の発見
- 期待値（的中率×オッズ）の最適化

## 10. アーキテクチャ上の制約

### 10.1 データベース設計
- SQLiteを使用（シンプルだが、大規模データ処理には限界）
- リアルタイムデータ取得は未実装

### 10.2 処理速度
- 1レース予測: 約3-4秒
- 100レース処理: 約7-8分
- バッチ処理が必要（リアルタイム予測には課題）

### 10.3 データ取得
- 手動でのデータ投入が必要
- 自動スクレイピング未実装

## 11. 今後の発展方向性

### 11.1 短期的改善（1-2週間）
1. 外枠予測基準の見直し
2. 信頼度Eの削減とD基準の厳格化
3. モーター直近成績の重視

### 11.2 中期的改善（1-3ヶ月）
1. 展示データの活用
2. 天候・風向データの取り込み
3. 進入予想機能の実装
4. スタート評価の強化

### 11.3 長期的改善（3ヶ月以上）
1. 機械学習モデルとのアンサンブル
2. リアルタイムデータ取得の自動化
3. オッズ最適化エンジン
4. 季節・時期による変動モデル

## 12. 補足: 使用していない要素

以下のデータは取得可能だが、現在のモデルでは使用していない：

```
1. 天候条件（晴れ/曇り/雨/風速/風向）
2. 水面条件（波の高さ、うねり）
3. 気温・水温
4. 展示タイム
5. 展示航走データ
6. 体重変化
7. オッズ情報
8. 前日・前節成績
9. 節内順位推移
10. 選手コメント分析
```

これらを活用することで、さらなる精度向上が期待できる。

---

## まとめ

**現在の到達点:**
- 統計とルールベースで**的中率60-64%を達成**
- 会場特性、信頼度判定が効果的に機能
- B/C信頼度で実用レベルの精度

**最大の課題:**
1. **外枠予測の弱さ**（5-6号艇で0%）
2. **当日条件の未考慮**（天候、展示等）
3. **信頼度Eの低精度**（20%は使い物にならない）

**改善の方向性:**
- 短期: 既存ロジックのチューニング
- 中期: 展示・天候データの追加
- 長期: 機械学習との融合
