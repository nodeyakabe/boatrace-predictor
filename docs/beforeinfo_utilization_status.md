# 直前情報の活用状況レポート

**作成日**: 2025-12-12
**対象**: BeforeInfoScorer（直前情報スコアリングモジュール）
**目的**: 現在の直前情報活用状況を整理し、改善余地を明確化する

---

## 1. 現在のスコア構成（110点満点）

| 項目 | 配点 | 実装状況 | 詳細 |
|------|------|----------|------|
| 展示タイム | 25点 | ✅ 実装済み | 条件別加点ルール適用済み |
| ST（スタート） | 25点 | ✅ 実装済み | F・L評価、前走ST傾向 |
| 進入隊形 | 20点 | ✅ 実装済み | 枠なり進入・前づけ評価 |
| 前走成績 | 15点 | ✅ 実装済み | 直近3走の着順評価 |
| チルト・風 | 10点 | ✅ 実装済み | チルト角度、基本的な風評価 |
| 部品交換・調整重量 | 5点 | ✅ 実装済み | 新ペラ・プロペラ交換評価 |
| 気象条件スコア | 5点 | ✅ 実装済み | 風速×風向×会場、波高補正 |
| **モーター成績スコア** | **5点** | **✅ 実装済み（2025-12-12）** | **モーター2連率による補正** |

**総配点**: 110点（100点 + 気象5点 + モーター5点）

---

## 2. 気象条件スコアの詳細（2025-12-12実装完了）

### 2.1 実装内容

#### (1) 会場×風向×風速補正（最優先）

```python
from src.analysis.weather_venue_wind_adjuster_v2 import calculate_venue_wind_adjustment

# 暴風時（8m以上）のみ適用
if wind_speed >= 8.0:
    venue_wind_adj = calculate_venue_wind_adjustment(
        course=course,
        venue_code=venue_code,
        wind_speed=wind_speed,
        wind_direction=wind_direction
    )
    score += venue_wind_adj
```

**補正範囲**: -20.0 ~ +20.0点
**パターン数**: 15パターン（10会場×1-2風向）
**対象コース**: 1コースのみ

#### (2) 波高補正（優先）

```python
from src.analysis.wave_height_adjuster import calculate_wave_height_adjustment

# 高波時（10cm以上）適用
wave_adj = calculate_wave_height_adjustment(
    course=course,
    wave_height=wave_height
)
score += wave_adj
```

**補正範囲**: -10.0 ~ +5.0点
**補正区分**: 10-14cm（最大）、15cm以上（やや）
**対象コース**: 1-2コース

#### (3) 気温・水温の基本評価（補助的）

```python
# 気温・水温差が大きい（5℃以上）→ 機力差が出やすい
if temp_diff >= 5.0:
    if course <= 2:
        score += 1.5  # インコース有利

# 水温が低い（15℃未満）→ 出足が悪い
if water_temp < 15.0:
    if course <= 2:
        score -= 1.5  # インコース不利
```

**補正範囲**: -3.0 ~ +3.0点

#### (4) 天候条件の評価（補助的）

```python
# 雨天 → 視界不良、スタート難化
if '雨' in weather_condition:
    if course <= 2:
        score += 1.0  # インコース有利
```

**補正範囲**: -2.0 ~ +2.0点

### 2.2 気象スコアの優先順位

1. **会場×風向×風速**（最優先、極端な影響）
   - 例: 尼崎×西風 +17.7点、三国×東北東 -20.0点

2. **波高**（優先、明確な影響）
   - 例: 10-14cm 1コース-8.0点、2コース+5.0点

3. **気温・水温**（補助的）
   - モーター性能への影響評価

4. **天候**（補助的）
   - 視界・スタート難化の評価

### 2.3 気象スコアの合計範囲

- **最大範囲**: -30.0 ~ +20.0点（補正前）
- **5点満点換算**: -15.0 ~ +10.0点（`score * 0.5`で正規化）
- **WEATHER_SCORE_WEIGHT**: 5.0点

---

## 3. モーター成績スコアの詳細（2025-12-12実装完了）

### 3.1 実装内容

2025年通年データ（802,344エントリー）に基づくモーター2連率の影響分析を実装。

#### モーター2連率による補正

```python
from src.analysis.motor_performance_adjuster import calculate_motor_performance_adjustment

motor_adj = calculate_motor_performance_adjustment(
    course=course,
    motor_second_rate=motor_second_rate
)
```

**補正範囲**: -5.0 ~ +5.0点（コース別に重み付け）

#### コース別の補正係数

| コース | 重み | 最大差分（実データ） | 最大補正スコア |
|--------|------|---------------------|---------------|
| 1コース | 1.0 | +6.8pt | ±4.5点 |
| 2コース | 0.68 | +4.6pt | ±3.1点 |
| 3コース | 0.47 | +3.2pt | ±2.1点 |
| 4コース | 0.49 | +3.3pt | ±2.2点 |
| 5コース | 0.16 | +1.1pt | ±0.7点 |
| 6コース | 0.28 | +1.9pt | ±1.3点 |

### 3.2 モーター2連率区分別の補正（1コース基準）

| モーター2連率 | 補正スコア | 実際の勝率 | 差分 |
|--------------|-----------|-----------|------|
| 0-30%（悪い） | -2.0点 | 53.9% | -2.2pt |
| 30-35%（やや悪い） | 0.0点 | 56.4% | +0.3pt |
| 35-40%（やや良い） | +1.5点 | 58.0% | +1.9pt |
| 40-45%（良い） | +3.5点 | 60.3% | +4.2pt |
| 45%+（非常に良い） | +4.5点 | 61.6% | +5.5pt |

**最大差分**: 良いモーター（40%+）60.6% vs 悪いモーター（0-30%）53.9% = **+6.8pt**

### 3.3 全コースでの影響

モーター2連率は全コースで勝率に影響するが、インコースほど影響が大きい傾向:

| コース | 悪いモーター（0-30%） | 良いモーター（40%+） | 差分 |
|--------|----------------------|---------------------|------|
| 1コース | 53.9% | 60.6% | **+6.8pt** |
| 2コース | 11.7% | 16.3% | **+4.6pt** |
| 3コース | 11.2% | 14.5% | **+3.2pt** |
| 4コース | 8.7% | 12.0% | **+3.3pt** |
| 5コース | 5.7% | 6.7% | **+1.1pt** |
| 6コース | 2.1% | 4.0% | **+1.9pt** |

### 3.4 実装ファイル

- [src/analysis/motor_performance_adjuster.py](../src/analysis/motor_performance_adjuster.py) - モーター成績補正ロジック
- [src/analysis/beforeinfo_scorer.py](../src/analysis/beforeinfo_scorer.py:509-547) - BeforeInfoScorerへの統合
- [scripts/analyze_motor_performance.py](../scripts/analyze_motor_performance.py) - モーター成績分析スクリプト

---

## 4. 各スコア項目の実装状況

### 4.1 展示タイムスコア（25点）

#### 実装内容

- **条件別加点ルール**: 2025-12-10実装完了
- **基本評価**: タイム順位に基づく評価
- **特殊条件**: 会場別・級別・コース別の詳細ルール

**参考資料**:
- [docs/exhibition_time_condition_rules_implementation.md](exhibition_time_condition_rules_implementation.md)

#### 主要ルール

| 条件 | 加点 | 根拠 |
|------|------|------|
| B1級1コース×1位 | +2.0点 | 勝率78.6% (+22.5pt) |
| B1級1コース×2位 | +1.5点 | 勝率66.7% (+10.6pt) |
| A1級4-6コース×1位 | +1.0点 | 1着率向上 |
| 一般戦1コース×5-6位 | -1.0点 | 勝率低下 |

### 4.2 STスコア（25点）

#### 実装内容

- **F・L評価**: フライング・出遅れの評価
- **前走ST傾向**: 直近のST傾向を評価
- **コース別評価**: 1-2コースはST重視

#### 評価基準

- F（フライング）: 大幅減点
- L（出遅れ）: 減点
- 平均ST: コース別に評価

### 4.3 進入隊形スコア（20点）

#### 実装内容

- **枠なり進入**: 通常の進入隊形
- **前づけ**: インコースへの進入変更
- **外枠スタート**: 外枠からのスタート評価

### 4.4 前走成績スコア（15点）

#### 実装内容

- **直近3走の着順**: 1着・2着・3着以下で評価
- **連対率**: 直近の連対傾向を重視
- **級別補正**: A1級は高評価、B2級は低評価

### 4.5 チルト・風スコア（10点）

#### 実装内容

- **チルト角度**: -0.5°～3.0°の範囲で評価
- **風向・風速の基本評価**: 従来ロジック
- **会場特性**: 会場別のチルト傾向

### 4.6 部品交換・調整重量スコア（5点）

#### 実装内容

- **新ペラ**: プロペラ交換の評価
- **部品交換**: その他の部品交換
- **調整重量**: 重量調整の評価

---

## 5. データ充実度と信頼度

### 5.1 データ充実度（data_completeness）

各項目のデータ有無をカウントし、0.0-1.0で評価:

- 展示タイムあり: +1
- STデータあり: +1
- 進入コースあり: +1
- 前走成績あり: +1
- チルトデータあり: +1
- 部品交換データあり: +1
- 気象データあり: +1

**最大**: 7項目 → 100% = 1.0

### 5.2 信頼度（confidence）

直前情報の公開状況と各スコアの分散を考慮:

- **直前情報未公開**: confidence = 0.0
- **直前情報公開**: data_completeness に基づく信頼度

---

## 6. 改善余地と今後の課題

### 6.1 実装済みの改善

✅ **展示タイム条件別加点ルール**: 2025-12-10実装
✅ **気象補正（会場×風向×風速）**: 2025-12-12実装
✅ **気象補正（波高）**: 2025-12-12実装

### 6.2 未実装の改善余地

#### (1) 2-6コースの気象補正

**現状**: 1コースのみ風速×風向補正、1-2コースのみ波高補正

**改善案**:
- 戸田×北風: 2コース41.7%（+28.8pt）→ 2コース補正を追加
- 波高10-14cm: 3-4コースも若干有利 → 補正検討

#### (2) STスコアの詳細化

**現状**: 基本的なF・L評価のみ

**改善案**:
- コース別ST平均の精緻化
- 級別ST傾向の分析
- 会場別ST特性の反映

#### (3) 進入隊形の詳細評価

**現状**: 枠なり・前づけの基本評価

**改善案**:
- 選手別の進入実績データ
- 会場別の進入傾向
- 前づけ成功率の定量化

#### (4) モーター成績の活用

**現状**: 未実装

**改善案**:
- モーター2連率の評価
- モーター勝率の評価
- 展示航走との相関分析

#### (5) 選手のコース別成績

**現状**: 全体の前走成績のみ

**改善案**:
- 選手のコース別勝率
- 選手の会場別成績
- 選手の得意・不得意コース

#### (6) 天候×時刻の複合効果

**現状**: 天候のみの評価

**改善案**:
- ナイター×雨の影響
- 夕方×西日の影響
- 季節×時刻の複合効果

### 6.3 データ品質の向上

#### (1) 展示タイムの精度向上

**現状**: 条件別加点ルール実装済み

**改善案**:
- より細かい条件での分析（会場×グレード×級別など）
- 展示タイム差の評価（1位と2位の差が大きい場合など）

#### (2) 前走成績の詳細化

**現状**: 直近3走の着順のみ

**改善案**:
- 着差の考慮（2着でも大差2着と僅差2着では意味が異なる）
- コース別前走成績
- 会場別前走成績

---

## 7. スコア配分の見直し検討

### 7.1 現在の配分（110点満点）

| 項目 | 配点 | 割合 |
|------|------|------|
| 展示タイム | 25点 | 22.7% |
| ST | 25点 | 22.7% |
| 進入隊形 | 20点 | 18.2% |
| 前走成績 | 15点 | 13.6% |
| チルト・風 | 10点 | 9.1% |
| 部品・重量 | 5点 | 4.5% |
| 気象条件 | 5点 | 4.5% |
| **モーター成績** | **5点** | **4.5%** |

### 7.2 見直し案の検討

#### 案1: 気象条件の重み増加

気象条件（特に暴風・高波時）の影響が大きいことが判明:
- 現在: 5点（4.8%）
- 提案: 10点（8.7%）

→ 他の項目から5点を減らす必要あり

#### 案2: 現状維持

気象条件は「補助的要因」として5点を維持:
- 暴風・高波は稀なケース（暴風264件/17,407レース = 1.5%）
- 通常時は影響が小さい

→ 現在の5点配分が妥当

---

## 8. まとめ

### 8.1 実装完了項目

✅ 展示タイム条件別加点ルール（2025-12-10）
✅ 気象補正（会場×風向×風速）（2025-12-12）
✅ 気象補正（波高）（2025-12-12）
✅ **モーター成績スコア**（2025-12-12）← NEW

### 8.2 現在の活用状況

- **スコア構成**: **110点満点（8項目）**
- **データ充実度**: 各項目のデータ有無を評価（モーター成績含む）
- **信頼度**: 直前情報公開状況を考慮
- **最終統合**: PRE_SCORE * 0.6 + BEFORE_SCORE * 0.4

### 8.3 主要な改善余地

1. **選手のコース別成績** - 未実装（優先度: 高）
2. **2-6コースの気象補正** - データはあるが未実装
3. **STスコアの詳細化** - 基本評価のみ
4. ~~モーター成績の活用~~ - ✅ 実装済み（2025-12-12）

### 8.4 優先度評価

| 改善項目 | 優先度 | 理由 |
|----------|--------|------|
| ~~モーター成績の活用~~ | ~~高~~ | ✅ **実装済み（2025-12-12）** |
| 選手のコース別成績 | 高 | 重要な要素、未実装 |
| 2-6コースの気象補正 | 中 | データあり、影響度中程度 |
| STスコアの詳細化 | 中 | 既に基本実装あり |
| 進入隊形の詳細評価 | 低 | 基本実装で十分 |

**次のステップ**: 選手のコース別成績の分析・実装を検討
