# 期待値予想機能 使い方ガイド

## 📊 概要

期待値予想機能は、**オッズと予測確率から期待値を計算**し、期待値が高いレースを推奨する機能です。

**期待値（Expected Value）** = 的中確率 × オッズ - 1

期待値がプラスのレースに絞って購入することで、長期的な収益性向上を目指します。

---

## 🎯 UI の使い方

### 1. UIで期待値重視レースを確認

```
1. ブラウザで http://localhost:8501 を開く
2. 「レース予想」タブをクリック
3. 「💰 期待値重視」タブを選択
4. フィルター設定:
   - 最小期待値: 5% （デフォルト）
   - 最小信頼度: 50% （デフォルト）
5. 期待値順にレースが表示されます
```

### 表示内容

- **期待値**: 予測確率 × オッズ - 1 で計算
- **Kelly**: Kelly基準による推奨賭け金率（資金の何%を賭けるべきか）
- **オッズ種別**:
  - `実測`: データベースから取得した実際のオッズ
  - `推定`: スコアベースで推定したオッズ

### サマリー統計

- **平均期待値**: 表示されているレースの平均期待値
- **最大期待値**: 最も高い期待値
- **平均オッズ**: 平均オッズ倍率
- **実測オッズ**: 実際に取得したオッズ数 / 総レース数

---

## 🔧 オッズデータの収集

期待値計算には**実際のオッズデータ**が必要です。現在は推定オッズで動作していますが、より正確な期待値を計算するためにオッズを収集します。

### 方法1: テスト収集（1レースのみ）

```bash
python test_odds_fetch.py
```

**実行内容**:
- 今日開催されているレースを検索
- 最初の1レースのオッズを取得
- データベースに保存
- 結果を表示

**期待される出力**:
```
======================================================================
個別レースオッズ取得テスト（DB保存機能付き）
======================================================================

今日の日付: 2025-11-27
今日開催されているレースを検索中...

✅ 今日のレース 5件を発見
  - 会場01 1R (10:30)
  - 会場01 2R (11:00)
  ...

======================================================================
テスト対象: 会場01 1R
======================================================================

[1] 3連単オッズ取得テスト
  会場コード: 01
  レース番号: 1
  日付: 20251127

✅ 取得成功: 120通り

人気上位5つ:
  1-2-3: 10.5倍
  1-2-4: 15.2倍
  ...

[DB保存] race_id=12345 にオッズを保存中...
✅ 120件のオッズを保存しました
データベース確認: 120件のオッズが保存されています

[2] 単勝オッズ取得テスト
✅ 取得成功: 6艇

単勝オッズ:
  1号艇: 2.5倍
  2号艇: 4.0倍
  ...

[DB保存] race_id=12345 に単勝オッズを保存中...
✅ 6艇分のオッズを保存しました

======================================================================
テスト完了
======================================================================
```

### 方法2: 今日の全レース収集

```bash
# 全会場の全レース
python collect_today_odds.py

# 特定会場のみ（例: 桐生）
python collect_today_odds.py --venue 01

# テストモード（1レースのみ）
python collect_today_odds.py --test

# 遅延時間を調整（デフォルト2秒）
python collect_today_odds.py --delay 3.0
```

**注意事項**:
- オッズは**レース開始前に公開**されます
- 公開前のレースは取得できません
- 1日あたり最大 288レース（24会場 × 12レース）
- 取得には30分〜1時間程度かかります
- レート制限対策のため、レース間に2秒の遅延を設定

**推奨運用**:
1. 毎日午前10時頃に1回実行（開催開始前）
2. 午後に1回追加実行（遅れて発売されるレース対応）

---

## 📈 バックテスト

過去のオッズデータを使って、期待値ベース戦略の効果を検証します。

### 基本的な使い方

```bash
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31
```

### パラメータ調整

```bash
# 期待値閾値を10%に設定
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 10

# 信頼度閾値を70%に設定
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-confidence 70

# 両方を組み合わせ
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 10 --min-confidence 70

# 結果をJSONファイルに保存
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --output backtest_result.json
```

### 期待される出力

```
======================================================================
期待値ベース戦略バックテスト
======================================================================

期間: 2024-10-01 〜 2024-10-31
最小期待値: 5.0%
最小信頼度: 50.0%
======================================================================

オッズデータがあるレース: 1,500件

======================================================================
バックテスト結果
======================================================================

総レース数: 1,500件
購入レース数: 150件 (10.0%)
的中数: 30件
的中率: 20.0%

総投資額: ¥15,000
総払戻額: ¥18,750
収支: ¥+3,750
ROI: +25.0%

平均期待値: 12.5%
平均オッズ: 25.0倍
平均信頼度: 65.0%
```

### バックテスト結果の見方

| 指標 | 説明 | 目標値 |
|------|------|--------|
| **購入レース数** | 条件に合致したレース数 | 多すぎず少なすぎず（5-15%程度） |
| **的中率** | 購入レースのうち的中した割合 | 15-30% |
| **ROI** | 投資に対する利益率 | +5%以上 |
| **平均期待値** | 購入レースの平均期待値 | +10%以上 |

### パラメータ最適化

異なる設定値でバックテストを繰り返し、最適なパラメータを見つけます:

```bash
# 期待値閾値を変えて検証
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 0
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 5
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 10
python backtest_expected_value.py --start 2024-10-01 --end 2024-10-31 --min-ev 15
```

---

## 📝 期待値戦略の理論

### 基本概念

**期待値** = 的中確率 × オッズ - 1

例:
- 的中確率: 20%
- オッズ: 6.0倍
- 期待値 = 0.20 × 6.0 - 1 = 0.20 = **+20%**

この場合、100円賭けたら長期的に平均20円の利益が出る計算です。

### Kelly基準

Kelly基準は、最適な賭け金率を計算する数式です:

**Kelly % = (オッズ × 的中確率 - 1) / (オッズ - 1)**

例:
- 的中確率: 20%
- オッズ: 6.0倍
- Kelly % = (6.0 × 0.20 - 1) / (6.0 - 1) = 0.04 = **4%**

資金の4%を賭けるのが理論的に最適です。

### フラクショナルKelly

リスクを抑えるため、Kelly基準の25%（0.25倍）を使用:

- Kelly % = 4%
- フラクショナルKelly (25%) = 4% × 0.25 = **1%**

資金10,000円なら100円を賭けます。

---

## 🚨 注意事項

### オッズデータ収集について

1. **利用規約の遵守**
   - 競艇公式サイトの利用規約を確認してください
   - 過度なアクセスは避けてください
   - 適切な遅延時間（2秒以上）を設定してください

2. **データ品質**
   - 発売前のレースはオッズが取得できません
   - 全120通りの3連単オッズが取得できない場合があります
   - エラーハンドリングを確認してください

3. **ストレージ容量**
   - 1日あたり約35,000件のオッズデータ
   - 1ヶ月で約100万件
   - データベース容量を定期的に確認してください

### 期待値戦略について

1. **市場効率性**
   - オッズは市場の予測を反映しています
   - 予測モデルがオッズより正確である必要があります
   - 優位性が見つからない可能性もあります

2. **リスク管理**
   - Kelly基準を守ってください
   - フラクショナルKelly（25%）を推奨
   - 資金管理を徹底してください

3. **長期的視点**
   - 短期的には負けることもあります
   - 期待値がプラスでも分散があります
   - 十分なサンプル数（100レース以上）で評価してください

---

## 🔄 運用フロー

### 日次運用

```
1. 午前10時: オッズ収集実行
   python collect_today_odds.py

2. UIで期待値重視レースを確認
   http://localhost:8501

3. 高期待値レースを購入

4. 結果を記録（自動）

5. 月末: バックテストで検証
   python backtest_expected_value.py --start 2024-11-01 --end 2024-11-30
```

### 定期的な見直し

- **週次**: ROI確認
- **月次**: パラメータ最適化
- **四半期**: 戦略全体の見直し

---

## 🆘 トラブルシューティング

### Q: オッズが取得できない

**A**: 以下を確認してください:
1. レースが発売されているか
2. ネットワーク接続
3. 競艇公式サイトにアクセス可能か
4. スクレイパーのエラーログ

### Q: 期待値がマイナスばかり

**A**: 以下の可能性があります:
1. 予測モデルの精度不足
2. オッズの精度不足（推定オッズ使用時）
3. 市場効率性が高い
4. 閾値設定を見直す（マイナス値も表示）

### Q: ROIが悪い

**A**: 以下を試してください:
1. 期待値閾値を上げる（5% → 10%）
2. 信頼度閾値を上げる（50% → 70%）
3. 予測モデルの改善
4. より長期間でバックテスト

---

## 📚 参考資料

- [Kelly基準（Wikipedia）](https://ja.wikipedia.org/wiki/%E3%82%B1%E3%83%AA%E3%83%BC%E5%9F%BA%E6%BA%96)
- [期待値の計算方法](https://ja.wikipedia.org/wiki/%E6%9C%9F%E5%BE%85%E5%80%A4)
- `docs/20251127_買い目戦略検討.md` - 買い目戦略の詳細分析

---

## 💡 今後の改善予定

1. **リアルタイムオッズ取得**
   - 締切直前のオッズを取得
   - オッズ変動を追跡

2. **複数レース横断最適化**
   - ポートフォリオ理論の適用
   - 相関を考慮したリスク分散

3. **機械学習モデルの統合**
   - Stage2予測モデルの活用
   - 確率校正の改善

4. **自動購入機能**
   - 高期待値レースの自動検出
   - アラート通知

---

**作成日**: 2025-11-27
**バージョン**: 1.0
