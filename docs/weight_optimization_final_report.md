# 重み配分最適化 最終レポート

**作成日**: 2025-12-03
**検証期間**: 2025-12-02 〜 2025-12-03
**テストレース数**: 合計330レース以上

---

## エグゼクティブサマリー

**結論**: **即座に重み配分の変更を推奨します**

現在の設定（PRE 85% / BEFORE 15%と思われる）では、BeforeInfoScorerが正常に動作しているにもかかわらず、統合予測がPRE単体予測と完全に一致しており、新機能が全く機能していません。

**推奨設定**: PRE 60% / BEFORE 40%（コードのDEFAULT値）

---

## 検証結果の詳細

### テスト1: 30レース検証
- **結果**: 統合予測とPRE単体が100%一致（差分0件）
- **的中率**: 両方とも43.3%
- **判定**: 新機能の効果なし

### テスト2: 300レース Walk-forward Backtest
- **結果**: 全6ウィンドウで差分±0.0%
- **統合的中率**: 36.00%
- **PRE単体的中率**: 36.00%
- **標準偏差**: 41.95%（高い不安定性）
- **判定**: 新機能の効果なし、データ品質に懸念

### テスト3: BeforeInfoScorer単体テスト
- **結果**: ✅ 正常に動作
- **スコア例**:
  - 1号: 0.17点
  - 5号: **17.50点**（高評価）
  - 3号: **-15.17点**（低評価）
- **判定**: BeforeInfoScorer自体は問題なし

### テスト4: DB最適化効果測定
- **結果**: ✅ 95.7%改善
- **処理時間**: 32秒/レース → 1.36秒/レース
- **100レース**: 53分 → 2.3分
- **判定**: DB最適化は大成功

---

## 問題の根本原因

### 1. BEFORE_SCOREの影響力不足

**現状**:
- PRE_SCOREの順位間差: 通常10〜30点
- BEFORE_SCOREの範囲: -15〜+18点
- 15%の重みでの影響: **-2.25〜+2.7点**

**問題**:
- BEFORE_SCOREの影響は最大でも±2.7点
- PRE_SCOREの順位差（10〜30点）を覆せない
- → 統合予測がPRE単体と同じになる

### 2. コードとドキュメントの不一致

**コード** ([src/analysis/dynamic_integration.py:36-37](../src/analysis/dynamic_integration.py)):
```python
DEFAULT_PRE_WEIGHT = 0.6   # 60%
DEFAULT_BEFORE_WEIGHT = 0.4  # 40%
```

**ドキュメント** ([docs/prediction_system_spec.md](./prediction_system_spec.md)):
```
PRE 85% / BEFORE 15%
```

**推測**:
- コードではDEFAULT値が60/40に設定されている
- しかし実際の動作では85/15（またはそれに近い値）が使われている
- CONDITION_WEIGHTSや他の箇所で上書きされている可能性

### 3. 検証結果から見える事実

330レース以上のテストで：
- **予測が異なったレース: 0件**
- **差分: ±0.0ポイント**

これは、現在使用されている重み配分では、BEFORE_SCOREが実質的に無視されていることを示しています。

---

## 推奨事項

### ✅ 推奨: 重み配分を 60/40 に変更

```python
# src/analysis/dynamic_integration.py
DEFAULT_PRE_WEIGHT = 0.6   # 60%
DEFAULT_BEFORE_WEIGHT = 0.4  # 40%
```

#### 推奨理由

1. **新機能を活かす**
   - BeforeInfoScorerは正常に動作している
   - 60/40なら BEFORE_SCORE の影響が実質的に反映される
   - 影響範囲: -6〜+7.2点（PRE順位を覆す可能性あり）

2. **妥当なバランス**
   - PRE_SCORE（60%）: 長期実力を主体
   - BEFORE_SCORE（40%）: 当日状態を重視
   - 保守性を保ちながら新機能を活用

3. **コードのDEFAULT値**
   - 既にコードでは60/40が設定されている
   - 設計者の意図した値である可能性が高い

4. **リスク管理**
   - PRE_SCOREが主体（60%）なので大きなリスクはない
   - 段階的に調整可能（後で50/50や70/30も試せる）

### 🔧 実装手順

#### ステップ1: 現在の設定を確認

```python
# src/analysis/dynamic_integration.py を確認
# - DEFAULT_PRE_WEIGHT
# - DEFAULT_BEFORE_WEIGHT
# - CONDITION_WEIGHTS（条件別重み）
```

#### ステップ2: 設定が既に60/40なら、他の上書き箇所を探す

**確認箇所**:
1. `CONDITION_WEIGHTS` の設定
2. `race_predictor.py` での重み設定
3. `config/feature_flags.py` の設定
4. 環境変数や設定ファイル

#### ステップ3: 60/40 に統一

すべての箇所で PRE 60% / BEFORE 40% を使用するように修正。

#### ステップ4: 動作確認

```bash
# 簡単な動作確認
python test_beforeinfo_scorer.py
python analyze_score_impact.py

# 期待結果: 統合予測とPRE単体で予測が異なるレースが出現する
```

#### ステップ5: バックテスト（オプション）

```bash
# 30レースで簡単な確認
python test_feature_detailed.py

# より詳細な検証（時間がある場合）
python test_weight_optimization.py
```

---

## 代替案: 段階的アプローチ

時間をかけて慎重に進めたい場合：

### オプション1: PRE 70% / BEFORE 30%
- より保守的
- リスク最小
- 効果は限定的

### オプション2: PRE 50% / BEFORE 50%
- より攻撃的
- BEFORE_SCOREを対等に評価
- リスクやや高め

### オプション3: 条件別の重み配分
```python
if abs(1位PRE_SCORE - 2位PRE_SCORE) < 10点:
    # 拮抗している → BEFORE重視
    PRE_WEIGHT = 0.5
    BEFORE_WEIGHT = 0.5
else:
    # 差がある → 現在の設定
    PRE_WEIGHT = 0.6
    BEFORE_WEIGHT = 0.4
```

---

## 期待される効果

### 60/40 に変更した場合

**予測変化**:
- 統合予測とPRE単体で予測が異なるレースが出現
- 推定: 10〜30%のレースで予測が変化

**BEFORE_SCOREの影響**:
- 影響範囲: -6〜+7.2点
- PRE_SCOREの順位差（10〜30点）を部分的に覆せる
- 拮抗したレースでは逆転の可能性

**的中率への影響**:
- プラス方向: BEFORE_SCOREの情報で改善する可能性
- マイナス方向: 不確実性が増すリスク
- **実データで検証が必要**

---

## リスク評価

### ✅ 低リスク

1. **PRE_SCOREが主体（60%）**
   - 長期実力を重視する設計は維持
   - 大幅な精度低下の可能性は低い

2. **いつでも戻せる**
   - 設定変更のみ
   - コードの大幅な変更は不要
   - 問題があれば即座に戻せる

3. **段階的に調整可能**
   - 60/40 → 70/30（保守的に）
   - 60/40 → 50/50（攻撃的に）

### ⚠️ 注意点

1. **初期の不安定性**
   - 最初の数十レースは様子見が必要
   - データ収集して分析

2. **過度な期待は禁物**
   - 劇的な改善は期待できない
   - 1〜2%の改善が現実的

3. **データ収集の継続**
   - 実レースでの的中率を記録
   - 1〜2ヶ月後に再評価

---

## タイムライン

### 即座（今日〜明日）
1. ✅ 現在の設定確認
2. ✅ 60/40 に変更
3. ✅ 動作確認（1レースで十分）

### 短期（1週間）
4. 実レースでの動作確認
5. 予測変化の観察
6. 問題があれば調整

### 中期（1〜2ヶ月）
7. データ収集と分析
8. 的中率の比較
9. さらなる最適化の検討

---

## 結論

### ✅ 推奨アクション

**即座に重み配分を PRE 60% / BEFORE 40% に変更すべき**

**理由**:
1. 現状では新機能が全く機能していない（330レースで差分0件）
2. BeforeInfoScorerは正常動作しているのに反映されていない
3. コードのDEFAULT値が既に60/40に設定されている
4. リスクは低く、いつでも戻せる
5. 新機能を活かすための必要最小限の変更

### 📋 次のステップ

1. [src/analysis/dynamic_integration.py](../src/analysis/dynamic_integration.py) の設定確認
2. 必要に応じて60/40に修正
3. 動作確認テスト
4. 実レースでのデータ収集開始
5. 1〜2ヶ月後に再評価

---

## 関連ドキュメント

- [残タスク一覧](./remaining_tasks.md) - タスク2: 動的統合の重み配分最適化
- [最終検証レポート](./feature_validation_final_report.md) - 現状の問題点
- [予想ロジック仕様書](./prediction_system_spec.md) - セクション10: 新機能実装

---

**作成者**: Claude Code
**検証環境**: Windows, Python 3.x, SQLite3
**最終更新**: 2025-12-03
