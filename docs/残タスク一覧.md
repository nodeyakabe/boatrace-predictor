# 残タスク一覧

更新日: 2025-12-07（v2.0戦略テスト後更新）

---

## 0. 【確定】最終運用戦略（13,413レース検証済み）

### プロジェクトの目的

**本プロジェクトの意義: 以下の条件に合致するレースを継続的に購入し、長期的な収益を確保する**

### 検証データ

- 検証期間: 2025年1月〜12月
- オッズ付きレース数: **13,413レース**
- 統計的に十分なサンプル数で検証済み

---

### 最終運用戦略（Opus分析確定版）

#### 購入対象

| 信頼度 | 方式 | オッズ範囲 | 追加条件 | 件数 | 回収率 | 賭け金 |
|--------|------|------------|----------|------|--------|--------|
| **C** | 従来 | 30-60倍 | 1コースA1級 | 363 | **127.2%** | 500円 |
| **C** | 従来 | 50倍+ | 1コースA級 | 1,101 | **121.0%** | 500円 |
| **D** | 新方式 | 30倍+ | 1コースA級 | 420 | **209.1%** | 300円 |
| **D** | 新方式 | 20倍+ | 1コースA級 | 576 | **178.9%** | 300円 |

#### 購入見送り

| 信頼度 | 理由 |
|--------|------|
| **A** | オッズが低く期待値不足 |
| **B** | サンプル数不足で統計的に不安定 |
| 1コースB級以下 | 回収率が低い |
| オッズ20倍未満 | 期待値不足 |

---

### 購入判定フロー

```
1. 1コース選手の級別確認
   ├─ A1級 → c1_A1条件を適用
   ├─ A2級 → c1_A条件を適用
   └─ B級以下 → 購入見送り

2. 信頼度確認
   ├─ 信頼度A・B → 購入見送り
   ├─ 信頼度C → 従来方式の予測を使用
   └─ 信頼度D → 新方式の予測を使用

3. オッズ範囲確認
   ├─ 範囲内 → 購入対象
   └─ 範囲外 → 見送り
```

---

### 想定月間収支（月80レース購入時）

| 項目 | 信頼度C | 信頼度D | 合計 |
|------|---------|---------|------|
| 月間レース数 | 約50件 | 約30件 | 80件 |
| 投資額 | 25,000円 | 9,000円 | 34,000円 |
| 回収額 | 30,000円 | 17,000円 | 47,000円 |
| **利益** | +5,000円 | +8,000円 | **+13,000円** |

**想定月利: 約38%**

---

### リスク管理

| 項目 | 推奨値 |
|------|--------|
| 1レース賭け金 | 資金の1〜2%（300〜500円） |
| 最大ドローダウン許容 | 資金の30% |
| 連敗想定（95%CI） | 最大100連敗 |

---

### UI「総合」タブの実装

購入対象の判定状態を3段階で表示:

| 状態 | 説明 |
|------|------|
| **対象（事前）** | 事前情報のみで購入条件を満たすレース |
| **候補** | 直前情報次第で対象に入る可能性があるレース |
| **対象（確定）** | 直前情報取得後、最終的に購入対象となったレース |

---

### 関連ドキュメント・スクリプト

- `docs/betting_strategy_analysis.md` - 買い目戦略分析レポート
- `scripts/optimize_betting_strategy.py` - 戦略最適化スクリプト
- `scripts/backtest_strategy.py` - 戦略バックテストスクリプト

---

## 1. 買い目戦略の検討

**詳細**: [betting_strategy_complete_analysis.md](betting_strategy_complete_analysis.md)

### 1-1. 予測ロジックの根本改善

**考え方**: C・Dの穴予測の精度を上げる

**具体策**:
- 展示タイム/スタートタイミングの重み付け強化
- コース別得意パターンの学習
- 荒れやすい条件（ナイター、悪天候等）の特定

**メリット**: 的中率と回収率の両立の可能性

**デメリット**: 開発工数がかかる

**作成ファイル**: `hole_prediction_model_design.md`（設計概要）

### 1-2. 2連単/2連複の導入検討・検証

**考え方**: 3連単より的中率を上げつつ配当を確保

**メリット**:
- 的中回数が増える
- 心理的に楽

**デメリット**: 要分析（まだ未検証）

**実装ファイル**: `bet_target_evaluator.py`

**追加条件**: 信頼度B予想の活用

---

## 3. 統合改善計画（Opus分析済み）

### エグゼクティブサマリー

2つの改善提案（改善点_20251205.txt + 階層的確率モデル_作業計画書.md）を統合分析し、最適な実装計画を策定。

**期待効果:**
- 1着的中率: 41-42% → 44-47%（+2-5pt）
- 3連単的中率: 12.7% → 16-18%（+3.3-5.3pt）
- 回収率: +5-10%

**総工数:** 2-3週間

---

### 必須実装タスク（優先度A）

#### Week 1: 基盤強化

**1-1. コース×進入×会場期待勝率テーブル実装**
- **期待効果**: +1.5-3.0pt（最大効果）
- **工数**: 1-2日
- **実装場所**: `src/analysis/race_predictor.py` - COURSE_RANK_WIN_RATES拡張
- **内容**:
  - 24会場 × 6コース × 4ランク = 576エントリーのルックアップテーブル
  - 会場別・コース別・進入パターン別の勝率をデータベースから集計
  - 例: 三国はイン強い、唐津は5コース差し、丸亀は深イン弱い
- **実装イメージ**:
```python
COURSE_VENUE_WIN_RATES = {
    (venue_code, course, rank): win_rate
}
```

**1-2. 天候強化特徴量実装**
- **期待効果**: +0.7-1.5pt
- **工数**: 0.5日
- **実装場所**: `src/analysis/weather_adjuster.py` 改修
- **内容**:
  - 風向×風速×追い/向かいの複合特徴量
  - 追い風: 1コース激強、向かい風: 差し・まくり決まりやすい
  - 風速6m以上で荒れ率1.8倍対応

**1-3. 既存特徴量有効化確認**
- **期待効果**: +0.3-0.8pt
- **工数**: 0.5日
- **実装場所**: `src/features/feature_transforms.py` と `src/analysis/race_predictor.py`
- **内容**:
  - 展示相対特徴量（exh_rank, exh_diff, exh_zscore）が使用されているか確認
  - ST相対特徴量（st_relative, st_rank）が使用されているか確認
  - 未使用の場合はrace_predictorに統合

**Week 1期待累積効果**: +2.5-5.0pt

---

#### Week 2: 条件付きモデル改修

**2-1. Stage2学習データ改修**
- **期待効果**: 2着予測 35.9% → 45%（+9pt）
- **工数**: 1日
- **実装場所**: `src/ml/conditional_rank_model.py` - `_prepare_second_place_data()`
- **内容**:
  - 1着艇の特徴量を2着候補に正しく伝達
  - 相対特徴量も含めて伝達
```python
# 改修内容
first_features = df[df['rank'] == 1][['race_id'] + feature_cols + relative_feature_cols]
first_features.columns = ['race_id'] + [f'first_place_{c}' for c in feature_cols + relative_feature_cols]
remaining = remaining.merge(first_features, on='race_id')
```

**2-2. Stage3学習データ改修**
- **期待効果**: 3着予測 27.2% → 35%（+8pt）
- **工数**: 1日
- **実装場所**: `src/ml/conditional_rank_model.py` - `_prepare_third_place_data()`
- **内容**:
  - 1着+2着艇の特徴量を3着候補に伝達

**2-3. モデル再学習スクリプト作成・実行**
- **期待効果**: 精度向上の実現
- **工数**: 0.5日
- **実装場所**: `scripts/train_conditional_models.py`（新規）
- **内容**:
  - TimeSeriesSplit(5)でCV
  - early_stopping使用
  - モデル保存: `models/stage2_conditional.joblib`, `models/stage3_conditional.joblib`

**2-4. race_predictor.py統合確認**
- **工数**: 0.5日
- **内容**: hierarchical_predictorの結果がUIに正しく反映されているか確認

**Week 2期待累積効果**: 2着+9pt、3着+8pt

---

#### Week 3: 追加機能と検証

**3-1. モーター直近3走スコア実装**
- **期待効果**: +0.7-1.2pt
- **工数**: 1日
- **実装場所**: `src/analysis/motor_analyzer.py` 改修
- **内容**:
  - 直近3節の平均着順
  - 直近の展示タイム順位の上昇/下降傾向
  - 伸び・出足・行き足の変化（代理指標）

**3-2. 荒れ指数実装**
- **期待効果**: +0.5-1.0pt
- **工数**: 1日
- **実装場所**: `src/analysis/race_predictor.py` または新規モジュール
- **内容**:
  - オッズ分散（低〜中〜高）
  - 1-2コースオッズの開き
  - 3〜6の支持率のバラつき
  - 過去の会場・グレードの荒れ率
  - 荒れやすさスコアによる予測精度低下の防止

**3-3. バックテスト実施**
- **工数**: 0.5日
- **内容**: 改善前後の精度比較レポート作成

**Week 3期待累積効果**: +1.2-2.2pt（追加）

---

### 推奨実装タスク（優先度B）

上記Week 3の内容（モーター直近3走、荒れ指数）

---

### 見送り推奨タスク（優先度C）

| タスク | 理由 | 再検討条件 |
|--------|------|-----------|
| motor/boat embedding | 効果不確実（+0.3-0.5pt）、実装コスト大（1-2日） | Stage2/3精度が45%未満の場合 |
| DBビュー作成 | 現状ボトルネックなし | パフォーマンス問題発生時 |
| テストスイート新規作成 | 機能実装後で十分 | Week 3完了後に検討 |

**理由詳細:**
- **motor/boat embedding**: LightGBMはカテゴリカル変数を直接扱えるため、埋め込みの効果は限定的。motor_second_rate、boat_second_rateで代替可能。

---

### 既存実装の活用（確認済み）

以下は**既に実装済み**で、新規開発不要:
- ✅ 展示相対特徴量（`src/features/feature_transforms.py` - FeatureTransformer）
- ✅ ST相対特徴量（`src/features/feature_transforms.py` - add_st_features()）
- ✅ 三連単確率計算（`src/prediction/trifecta_calculator.py`）
- ✅ 統合予測パイプライン（`src/prediction/hierarchical_predictor.py`）
- ✅ 条件付きモデル基盤（`src/ml/conditional_rank_model.py`）

→ これらは確認・改修のみで対応可能

---

### リスクと対策

| リスク | 発生確率 | 影響 | 対策 |
|--------|---------|------|------|
| 条件付きモデル改修で精度低下 | 中 | 高 | バックテストで事前検証、フォールバック機能維持 |
| 期待勝率テーブルのデータ不足 | 低 | 中 | 全国平均でフォールバック |
| 天候データ欠損 | 低 | 低 | 既存補間ロジック活用 |
| 学習時間増大 | 低 | 低 | 増分学習対応検討 |

---

### 期待される総合効果（定量予測）

| 指標 | 現状 | 目標（保守的） | 目標（楽観的） |
|------|------|----------------|----------------|
| 1着的中率 | 41-42% | 44% | 47% |
| 2着的中率 | 35.9% | 42% | 45% |
| 3着的中率 | 27.2% | 32% | 35% |
| 3連単的中率 | 12.7% | 16% | 18% |
| 3連単的中率（TOP20） | 5.0% | 12% | 15% |
| 回収率改善 | - | +5% | +10% |

---

### 推奨着手順序（詳細）

| Week | Day | タスク | 担当 |
|------|-----|--------|------|
| **Week 1** | 1 | コース×進入×会場期待勝率テーブル設計 | - |
| | 2 | コース×進入×会場期待勝率テーブル実装 | - |
| | 3 | 天候強化特徴量実装 | - |
| | 4 | 既存特徴量有効化確認・修正 | - |
| | 5 | フェーズ1統合テスト | - |
| **Week 2** | 1 | Stage2学習データ改修 | - |
| | 2 | Stage3学習データ改修 | - |
| | 3 | モデル再学習スクリプト作成・実行 | - |
| | 4 | race_predictor.py統合確認 | - |
| | 5 | フェーズ2統合テスト | - |
| **Week 3** | 1 | モーター直近3走スコア実装 | - |
| | 2 | 荒れ指数実装 | - |
| | 3 | バックテスト実施 | - |
| | 4 | 結果分析・調整 | - |
| | 5 | 最終検証・ドキュメント | - |

---

### 関連ドキュメント

- `改善点\改善点_20251205.txt` - 期待値の高い特徴量TOP5
- `改善点\階層的確率モデル_作業計画書.md` - 2着3着予測改善案
- 詳細分析レポート: Opus分析結果（2025-12-05実施）

---

## 4. 直前情報データの拡充と予測への活用（✅ 完了 2025-12-02）

### 完了内容

**データ収集の拡充:**
- ✅ ST（スタートタイミング）の取得実装（フライング対応含む）
- ✅ 展示進入コースの取得実装
- ✅ 調整重量の取得実装
- ✅ 前走成績（進入コース、ST、着順）の取得実装
- ✅ 気象データコード（天候コード、風向コード）の取得実装

**DBスキーマの拡張:**
- ✅ race_detailsテーブルに以下カラムを追加:
  - `exhibition_course` (INTEGER) - 展示進入コース
  - `prev_race_course` (INTEGER) - 前走進入コース
  - `prev_race_st` (REAL) - 前走ST
  - `prev_race_rank` (INTEGER) - 前走着順
  - `adjusted_weight` (REAL) - 調整重量
- ✅ weatherテーブルに以下カラムを追加:
  - `weather_code` (INTEGER) - 天候コード
  - `wind_dir_code` (INTEGER) - 風向コード

**UI統合:**
- ✅ BeforeInfoFetcherからBeforeInfoScraperへ置き換え
- ✅ UI用データ形式変換メソッド（to_ui_format）の実装
- ✅ DB保存処理の更新（race_details & weatherテーブルへ保存）

**関連ドキュメント:**
- [setup_beforeinfo_enhancement.md](setup_beforeinfo_enhancement.md) - 別PC環境構築手順
- `db_migration_add_beforeinfo_columns.py` - DBマイグレーションスクリプト

### 次のステップ（優先度高）

**予測モデルへの組み込み:** ✅ 完了 2025-12-02

1. ✅ BeforeInfoScorerの実装
   - 展示タイムスコア（25点）: ランクベース評価
   - STスコア（25点）: レンジベース評価、フライング対応
   - 進入スコア（20点）: 枠なり偏差検出、コース取り評価
   - 前走スコア（15点）: 前走ST・着順による調子判定
   - チルト/風スコア（10点）: 非線形コース依存評価、風シナジー
   - 部品/重量スコア（5点）: 交換・重量ペナルティ

2. ✅ RacePredictorへの統合
   - 統合式: FINAL_SCORE = PRE_SCORE * 0.6 + BEFORE_SCORE * 0.4
   - データ不足時: PRE_SCORE * 0.8 + BEFORE_SCORE * 0.2に自動調整
   - 信頼度・データ充実度の算出

3. ⚠️ 実運用テスト（保留）
   - 実際の直前情報データを取得・保存してから検証
   - UI統合テスト
   - 予測精度の改善効果測定

### 公式ページのデータ vs 現在の収集状況（更新版）

| 公式ページのデータ | 収集状況 | 対応スクリプト/クラス |
|------------------|---------|---------------------|
| **選手別データ** | | |
| 展示タイム | ✅ 取得済 | BeforeInfoScraper |
| チルト | ✅ 取得済 | BeforeInfoScraper |
| 部品交換 | ✅ 取得済 | BeforeInfoScraper |
| 調整重量 | ✅ 取得済 | BeforeInfoScraper |
| 前走成績 | ✅ 取得済 | BeforeInfoScraper |
| **スタート展示** | | |
| ST（スタートタイミング） | ✅ 取得済 | BeforeInfoScraper |
| 進入コース | ✅ 取得済 | BeforeInfoScraper |
| **水面気象情報** | | |
| 天候 | ✅ 取得済 | BeforeInfoScraper |
| 風向 | ✅ 取得済 | BeforeInfoScraper |
| 風速 | ✅ 取得済 | BeforeInfoScraper |
| 気温 | ✅ 取得済 | BeforeInfoScraper |
| 水温 | ✅ 取得済 | BeforeInfoScraper |
| 波高 | ✅ 取得済 | BeforeInfoScraper |
| 天候コード | ✅ 取得済 | BeforeInfoScraper |
| 風向コード | ✅ 取得済 | BeforeInfoScraper |
| **その他** | | |
| 潮位 | ✅ 取得済 | 収集_潮位データ_最新.py（独立）|

---

## 5. 女子選手の性別判定改善

### 現状の問題
- 現在は名前の末尾（「子」「美」「香」「奈」「恵」「代」）で性別を推定している
- この方法は確実ではない（例：男性で「〇〇美」という名前もありうる）

### 改善案
- 公式サイトの選手データを解析し、女子選手フラグを事前にDBに保存する
- `racers`テーブルに`gender`カラムを追加し、選手マスタとして管理
- 予測時はDBから性別を参照する方式に変更

### 対象ファイル
- `src/database/models.py`（`racers`テーブルに`gender`カラム追加）
- 選手データ解析スクリプト（新規作成）
- `src/analysis/race_predictor.py`（性別取得ロジックをDB参照に変更）

---

## 6. レースタイプ別モデル分割の調整

### 内容
- レースタイプ（一般戦、G3、G2、G1、SG等）に応じたモデルの分割・調整
- 各グレードで異なる特徴量の重み付けや予測ロジックの最適化

### 検討事項
- グレードごとの選手層の違い（SGはA1級が中心）
- 賞金額による選手のモチベーション差
- 節間の疲労度や調整の違い

---

## 7. その他の潜在的な改善点（優先度低）

| 項目 | 現状 | 備考 |
|------|------|------|
| 進入予想 | 未実装 | `config/prediction_improvements.json`で`enabled: false` |
| 潮位補正 | 未実装 | 同上 |
| モーターEWMA | 未実装 | 同上 |
| 確率較正 | 未実装 | 同上 |

---

## 完了済みタスク（2025-11-30）

- ✅ 直前情報取得ボタンのサイドバーフィルター対応
- ✅ 予測エラーメッセージの改善（展示データ未取得時）
- ✅ 1着固定ルールの閾値調整（データ充実度 60→40）
- ✅ 推定勝率計算の修正（相対スコア方式に変更）
- ✅ 法則エンジンの設計修正
  - 選手ランク法則のフィルタリング（A1/A2/B1/B2）
  - 風向法則のフィルタリング
  - 女子法則のフィルタリング
- ✅ StreamlitDuplicateElementKeyエラーの修正
