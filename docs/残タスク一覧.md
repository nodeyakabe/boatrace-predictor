# 残タスク一覧

更新日: 2025-12-01

---

## 0. 直前情報データの拡充と予測への活用（✅ 完了 2025-12-02）

### 完了内容

**データ収集の拡充:**
- ✅ ST（スタートタイミング）の取得実装（フライング対応含む）
- ✅ 展示進入コースの取得実装
- ✅ 調整重量の取得実装
- ✅ 前走成績（進入コース、ST、着順）の取得実装
- ✅ 気象データコード（天候コード、風向コード）の取得実装

**DBスキーマの拡張:**
- ✅ race_detailsテーブルに以下カラムを追加:
  - `exhibition_course` (INTEGER) - 展示進入コース
  - `prev_race_course` (INTEGER) - 前走進入コース
  - `prev_race_st` (REAL) - 前走ST
  - `prev_race_rank` (INTEGER) - 前走着順
  - `adjusted_weight` (REAL) - 調整重量
- ✅ weatherテーブルに以下カラムを追加:
  - `weather_code` (INTEGER) - 天候コード
  - `wind_dir_code` (INTEGER) - 風向コード

**UI統合:**
- ✅ BeforeInfoFetcherからBeforeInfoScraperへ置き換え
- ✅ UI用データ形式変換メソッド（to_ui_format）の実装
- ✅ DB保存処理の更新（race_details & weatherテーブルへ保存）

**関連ドキュメント:**
- [setup_beforeinfo_enhancement.md](setup_beforeinfo_enhancement.md) - 別PC環境構築手順
- `db_migration_add_beforeinfo_columns.py` - DBマイグレーションスクリプト

### 次のステップ（優先度高）

**予測モデルへの組み込み:**
1. `src/analysis/race_predictor.py` にスタート展示データを考慮したスコアリング追加
   - 展示STが良い選手の評価アップ
   - 進入コース変化（枠と異なる進入）の考慮
   - 調整重量による体重差の評価
2. 前走成績データの活用
   - 前走STの良し悪しを評価
   - 前走着順による調子の判定
3. 気象コードデータの活用
   - 天候・風向コードによる会場特性の分析

### 公式ページのデータ vs 現在の収集状況（更新版）

| 公式ページのデータ | 収集状況 | 対応スクリプト/クラス |
|------------------|---------|---------------------|
| **選手別データ** | | |
| 展示タイム | ✅ 取得済 | BeforeInfoScraper |
| チルト | ✅ 取得済 | BeforeInfoScraper |
| 部品交換 | ✅ 取得済 | BeforeInfoScraper |
| 調整重量 | ✅ 取得済 | BeforeInfoScraper |
| 前走成績 | ✅ 取得済 | BeforeInfoScraper |
| **スタート展示** | | |
| ST（スタートタイミング） | ✅ 取得済 | BeforeInfoScraper |
| 進入コース | ✅ 取得済 | BeforeInfoScraper |
| **水面気象情報** | | |
| 天候 | ✅ 取得済 | BeforeInfoScraper |
| 風向 | ✅ 取得済 | BeforeInfoScraper |
| 風速 | ✅ 取得済 | BeforeInfoScraper |
| 気温 | ✅ 取得済 | BeforeInfoScraper |
| 水温 | ✅ 取得済 | BeforeInfoScraper |
| 波高 | ✅ 取得済 | BeforeInfoScraper |
| 天候コード | ✅ 取得済 | BeforeInfoScraper |
| 風向コード | ✅ 取得済 | BeforeInfoScraper |
| **その他** | | |
| 潮位 | ✅ 取得済 | 収集_潮位データ_最新.py（独立）|

---

## 1. 女子選手の性別判定改善

### 現状の問題
- 現在は名前の末尾（「子」「美」「香」「奈」「恵」「代」）で性別を推定している
- この方法は確実ではない（例：男性で「〇〇美」という名前もありうる）

### 改善案
- 公式サイトの選手データを解析し、女子選手フラグを事前にDBに保存する
- `racers`テーブルに`gender`カラムを追加し、選手マスタとして管理
- 予測時はDBから性別を参照する方式に変更

### 対象ファイル
- `src/database/models.py`（`racers`テーブルに`gender`カラム追加）
- 選手データ解析スクリプト（新規作成）
- `src/analysis/race_predictor.py`（性別取得ロジックをDB参照に変更）

---

## 2. レースタイプ別モデル分割の調整

### 内容
- レースタイプ（一般戦、G3、G2、G1、SG等）に応じたモデルの分割・調整
- 各グレードで異なる特徴量の重み付けや予測ロジックの最適化

### 検討事項
- グレードごとの選手層の違い（SGはA1級が中心）
- 賞金額による選手のモチベーション差
- 節間の疲労度や調整の違い

---

## 3. その他の潜在的な改善点（優先度低）

| 項目 | 現状 | 備考 |
|------|------|------|
| 進入予想 | 未実装 | `config/prediction_improvements.json`で`enabled: false` |
| 潮位補正 | 未実装 | 同上 |
| モーターEWMA | 未実装 | 同上 |
| 確率較正 | 未実装 | 同上 |

---

## 完了済みタスク（2025-11-30）

- ✅ 直前情報取得ボタンのサイドバーフィルター対応
- ✅ 予測エラーメッセージの改善（展示データ未取得時）
- ✅ 1着固定ルールの閾値調整（データ充実度 60→40）
- ✅ 推定勝率計算の修正（相対スコア方式に変更）
- ✅ 法則エンジンの設計修正
  - 選手ランク法則のフィルタリング（A1/A2/B1/B2）
  - 風向法則のフィルタリング
  - 女子法則のフィルタリング
- ✅ StreamlitDuplicateElementKeyエラーの修正
