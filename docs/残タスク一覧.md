# 残タスク一覧

更新日: 2025-12-01

---

## 0. 直前情報データの拡充と予測への活用（優先度高）

### 背景
公式サイトの直前情報ページ（beforeinfo）から取得可能なデータが多数あるが、現在のBEFOREINFO_SCRIPTSでは一部しか収集していない。

### 公式ページのデータ vs 現在の収集状況

| 公式ページのデータ | 収集状況 | 対応スクリプト/クラス |
|------------------|---------|---------------------|
| **選手別データ** | | |
| 展示タイム | ✅ 取得済 | 補完_展示タイム_全件_高速化.py |
| チルト | ✅ 取得済 | 補完_展示タイム_全件_高速化.py |
| 部品交換 | ✅ 取得済 | 補完_展示タイム_全件_高速化.py |
| 調整重量 | ❌ 未取得 | BeforeInfoScraperの拡張が必要 |
| 前走成績 | ❌ 未取得 | BeforeInfoScraperの拡張が必要 |
| **スタート展示** | | |
| ST（スタートタイミング） | ❌ 未取得 | **予想に重要** |
| 進入コース | ❌ 未取得 | **予想に重要** |
| **水面気象情報** | | |
| 天候 | ✅ 取得済 | 補完_天候データ_改善版.py |
| 風向 | ✅ 取得済 | 補完_風向データ_改善版.py |
| 風速 | ⚠️ 要確認 | 天候スクリプト内 |
| 気温 | ⚠️ 要確認 | 天候スクリプト内 |
| 水温 | ⚠️ 要確認 | 天候スクリプト内 |
| 波高 | ⚠️ 要確認 | 天候スクリプト内 |
| **その他** | | |
| 潮位 | ✅ 取得済 | 収集_潮位データ_最新.py |

### 改善タスク

#### Step 1: データ収集の拡充
1. `src/scraper/beforeinfo_scraper.py` の拡張
   - ST（スタート展示タイミング）の取得
   - 進入コース（展示での並び順）の取得
   - 調整重量の取得
2. 補完スクリプトの作成または既存スクリプトの拡張

#### Step 2: DBスキーマの対応
- `race_details`テーブルに以下カラムの追加を検討
  - `exhibition_st` (スタート展示ST)
  - `exhibition_course` (スタート展示での進入コース)
  - `adjusted_weight` (調整重量)

#### Step 3: 予測への活用
- `src/analysis/race_predictor.py` にスタート展示データを考慮したスコアリング追加
  - 展示STが良い選手の評価アップ
  - 進入コース変化（枠と異なる進入）の考慮
  - 調整重量による体重差の評価

### 参照ファイル
- `src/scraper/beforeinfo_fetcher.py` - 直前情報パース処理（参考実装あり）
- `src/workflow/missing_data_fetch.py` - BEFOREINFO_SCRIPTS定義
- `補完_展示タイム_全件_高速化.py` - 現在の直前情報補完処理

---

## 1. 女子選手の性別判定改善

### 現状の問題
- 現在は名前の末尾（「子」「美」「香」「奈」「恵」「代」）で性別を推定している
- この方法は確実ではない（例：男性で「〇〇美」という名前もありうる）

### 改善案
- 公式サイトの選手データを解析し、女子選手フラグを事前にDBに保存する
- `racers`テーブルに`gender`カラムを追加し、選手マスタとして管理
- 予測時はDBから性別を参照する方式に変更

### 対象ファイル
- `src/database/models.py`（`racers`テーブルに`gender`カラム追加）
- 選手データ解析スクリプト（新規作成）
- `src/analysis/race_predictor.py`（性別取得ロジックをDB参照に変更）

---

## 2. レースタイプ別モデル分割の調整

### 内容
- レースタイプ（一般戦、G3、G2、G1、SG等）に応じたモデルの分割・調整
- 各グレードで異なる特徴量の重み付けや予測ロジックの最適化

### 検討事項
- グレードごとの選手層の違い（SGはA1級が中心）
- 賞金額による選手のモチベーション差
- 節間の疲労度や調整の違い

---

## 3. その他の潜在的な改善点（優先度低）

| 項目 | 現状 | 備考 |
|------|------|------|
| 進入予想 | 未実装 | `config/prediction_improvements.json`で`enabled: false` |
| 潮位補正 | 未実装 | 同上 |
| モーターEWMA | 未実装 | 同上 |
| 確率較正 | 未実装 | 同上 |

---

## 完了済みタスク（2025-11-30）

- ✅ 直前情報取得ボタンのサイドバーフィルター対応
- ✅ 予測エラーメッセージの改善（展示データ未取得時）
- ✅ 1着固定ルールの閾値調整（データ充実度 60→40）
- ✅ 推定勝率計算の修正（相対スコア方式に変更）
- ✅ 法則エンジンの設計修正
  - 選手ランク法則のフィルタリング（A1/A2/B1/B2）
  - 風向法則のフィルタリング
  - 女子法則のフィルタリング
- ✅ StreamlitDuplicateElementKeyエラーの修正
