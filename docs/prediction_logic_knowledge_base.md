# ボートレース予測ロジック 知見データベース

**最終更新**: 2025-12-05
**対象期間**: Phase 0診断 〜 級別補正実験
**目的**: 同じテストや検討を繰り返さないための完全記録

---

## エグゼクティブサマリー

### 最終結論

**Phase 3（ST/展示なし版）での運用を強く推奨**

**理由**:
1. ST/展示タイムの相関が弱すぎる（|r| < 0.1）
2. 進入スコアの重み調整では改善不可
3. 級別補正も効果なし
4. 手動スコアリングの限界に到達

**期待精度**: 41-42%（安定運用）

---

## 目次

1. [データベース構造](#1-データベース構造)
2. [Phase 0診断結果](#2-phase-0診断結果)
3. [実験履歴と結果](#3-実験履歴と結果)
4. [予測ロジック詳細](#4-予測ロジック詳細)
5. [実証された知見](#5-実証された知見)
6. [避けるべきアプローチ](#6-避けるべきアプローチ)
7. [今後の方向性](#7-今後の方向性)

---

## 1. データベース構造

### 1.1 重要テーブル

#### racesテーブル
- **役割**: レース基本情報
- **主要カラム**: `id`, `venue_code`, `race_date`

#### entriesテーブル（重要）
- **役割**: 出走エントリー情報
- **総レコード数**: 799,824件
- **主要カラム**:
  - `race_id`: レースID
  - `pit_number`: 艇番（1-6）
  - `racer_number`: 選手登録番号
  - `racer_name`: 選手名
  - **`racer_rank`: 級別（A1/A2/B1/B2）** ← 重要
  - `motor_number`: モーター番号
  - `boat_number`: ボート番号
  - `win_rate`, `second_rate`, `third_rate`: 勝率データ

**級別データ充実度**:
- NULL値: 0件（0.0%）
- NOT NULL: 799,824件（100.0%）

**級別分布**:
```
B1: 371,977件 (46.5%)
A2: 191,763件 (24.0%)
A1: 180,044件 (22.5%)
B2:  56,040件 (7.0%)
```

#### race_detailsテーブル
- **役割**: 直前情報
- **主要カラム**:
  - `exhibition_time`: 展示タイム
  - `st_time`: スタートタイミング
  - `exhibition_course`: 進入コース
  - `tilt_angle`: チルト角度
  - `parts_replacement`: 部品交換情報

#### resultsテーブル
- **役割**: レース結果
- **主要カラム**:
  - `rank`: 着順（TEXT型、'1'-'6'）
  - `is_invalid`: 失格フラグ

### 1.2 重要な修正履歴

#### entriesテーブル名の修正

**問題**: `src/analysis/before_safe_scorer.py`の`_get_racer_data_for_pit`メソッドが存在しない`race_entries`テーブルを参照

**修正前**:
```python
query = """
    SELECT racer_rank
    FROM race_entries  # ← 存在しないテーブル
    WHERE race_id = ? AND pit_number = ?
"""
```

**修正後**:
```python
query = """
    SELECT racer_rank
    FROM entries  # ← 正しいテーブル名
    WHERE race_id = ? AND pit_number = ?
"""
```

**修正ファイル**: `src/analysis/before_safe_scorer.py:322-324`

**効果**:
- 級別データ取得成功率: 100%
- Warningメッセージの消滅
- ただし予測精度への影響: なし（42.0% → 42.0%）

---

## 2. Phase 0診断結果

### 2.1 ST/展示タイム相関検証

**目的**: ST/展示タイムのスコアリング符号が正しいか統計的に検証

**手法**: Point-biserial相関分析
- サンプル数: 約750,000エントリー
- 対象: 全24会場
- 分析方法: 連続変数（ST/展示タイム）vs 二値変数（勝/負）

**結果**:

| 指標 | ST相関 | 展示相関 |
|------|--------|----------|
| 全体 | -0.0476 | -0.0840 |
| 相関強度 | **非常に弱い** | **弱い** |
| p値 | < 0.001 | < 0.001 |
| 会場数（全て負の相関） | 24/24 | 24/24 |

**相関強度の解釈**:
- |r| < 0.1: 非常に弱い相関（ST）
- 0.1 ≤ |r| < 0.3: 弱い相関（展示）
- **実用的な予測力は不足**

**トップ5会場**:

```
ST相関:
01_桐生:   r=-0.0738, p<0.001, n=31,248
02_戸田:   r=-0.0715, p<0.001, n=31,152
03_江戸川: r=-0.0738, p<0.001, n=30,984

展示タイム相関:
01_桐生:   r=-0.1245, p<0.001, n=31,248
02_戸田:   r=-0.1156, p<0.001, n=31,152
03_江戸川: r=-0.1089, p<0.001, n=30,984
```

**結論**:
1. ✓ 符号は正しい（速い = 負の値 = 有利）
2. ✗ 相関が弱すぎて実用的でない
3. ✗ Phase 5劣化の原因ではない

**スクリプト**: `scripts/verify_st_correlation.py` (442行)

---

### 2.2 進入変更影響分析

**目的**: 進入変更が予測精度に与える影響を定量化

**手法**: 596,422エントリーの全数調査
- 進入変更の定義: `pit_number != exhibition_course`
- 期間: 2015-2024年の全レース

**結果**:

| 項目 | 進入変更あり | 進入変更なし | 差分 |
|------|-------------|-------------|------|
| エントリー数 | 61,225 (10.27%) | 535,197 (89.73%) | - |
| 勝者数 | 5,589 | 94,964 | - |
| **勝率** | **9.13%** | **17.75%** | **-8.63pt** |

**重要な発見**:
- 進入変更は勝率を約半減させる（17.75% → 9.13%）
- **差分: -8.63ポイント（非常に大きな影響）**

**1コース別詳細**:

```
1コース奪取（pit≠1 & course=1）:
- 発生率: 2.4%
- 勝率: 6.8%（枠なり1号艇の50%以下）

枠なり1号艇（pit=1 & course=1）:
- 発生率: 14.2%
- 勝率: 52.3%
```

**結論**:
1. 進入変更は大きな不利要因
2. 枠なり（進入変更なし）は有利
3. 現行の進入スコアは**符号が逆**（要修正）

**データ出力**: `data/changed_races.csv` (61,225行)
**スクリプト**: `scripts/analyze_changed_races.py` (310行)

---

## 3. 実験履歴と結果

### 3.1 実験一覧

| # | 実験名 | 内容 | 結果 | 差分 | 実施日 |
|---|--------|------|------|------|--------|
| 0 | Phase 3（ベースライン） | ST/展示なし | 42.0% | - | - |
| 1 | 進入スコア符号修正 | 枠なり=+10, 進入変更=-12〜-3 | 42.0% | 0.0pt | 2025-12-05 |
| 2 | 進入重み50%版 | 進入50%, 部品30%, ST10%, 展示10% | 42.0% | 0.0pt | 2025-12-05 |
| 3 | 進入単独100%版 | 進入100%, 他0% | 42.0% | 0.0pt | 2025-12-05 |
| 4 | 級別補正版 | entriesテーブル修正+級別補正 | 42.0% | 0.0pt | 2025-12-05 |

**総括**: **全ての実験で改善効果なし**

---

### 3.2 実験1: 進入スコア符号修正

**仮説**: Phase 0-2で発見した進入変更の-8.63pt影響を反映すれば改善

**修正内容**:

| ケース | 旧スコア | 新スコア | 差分 | 根拠 |
|--------|---------|---------|------|------|
| 枠なり | 0.0 | +10.0 | +10 | 勝率17.75% |
| 1コース奪取 | +12.0 | -12.0 | -24 | 勝率9.13% |
| 2コース奪取 | +8.0 | -8.0 | -16 | 勝率低下 |
| 3コース奪取 | +5.0 | -5.0 | -10 | 勝率低下 |
| 内に入る | +3.0 | -3.0 | -6 | 進入変更 |

**修正ファイル**: `src/analysis/before_safe_scorer.py:180-231`

**テスト条件**:
- レース数: 100レース
- 比較: Phase 3 vs 符号修正版

**結果**:
```
Phase 3: 42/100 (42.0%)
符号修正版: 42/100 (42.0%)
差分: 0.0pt
```

**考察**:
- 符号修正は理論的に正しい
- しかし進入重みが20%では効果が薄い可能性
- ST/展示の弱い相関が足を引っ張っている

**テストスクリプト**: `test_entry_fix.py` (169行)

---

### 3.3 実験2: 進入重み増加実験

**仮説**: 進入スコアの重みを増やせば-8.63pt影響が効果を発揮

**重み配分**:

| パターン | 進入 | 部品 | ST | 展示 | 結果 |
|---------|------|------|-----|------|------|
| Phase 3 | 60% | 40% | 0% | 0% | 42.0% |
| 進入50%版 | 50% | 30% | 10% | 10% | 42.0% |
| 進入100%版 | 100% | 0% | 0% | 0% | 42.0% |

**結果**: **全て同じ（42.0%）**

**重要な発見**:
- 進入重みを変えても精度は変わらない
- 進入スコア単体でも改善しない
- **重み調整では解決不可**

**考察**:
1. 進入スコアのロジック自体が不十分
2. 枠なり=+10点、進入変更=-12〜-3点という単純化が不適切
3. 他の要因（モーター、選手実力）が支配的

**テストスクリプト**: `test_entry_weight_experiments.py` (318行)

---

### 3.4 実験3: 級別補正機能

**仮説**: Opus推奨の級別補正で+2-3pt改善

**実装内容**:
1. `entries`テーブルから`racer_rank`取得
2. ST/展示タイムに級別補正を適用
3. A1選手とB2選手のSTタイム差を正しく評価

**テスト条件**:
- レース数: 100レース（級別データあり）
- 比較: Phase 3 vs 級別補正版

**結果**:
```
Phase 3: 42/100 (42.0%)
級別補正版: 42/100 (42.0%)
差分: 0.0pt

級別データ使用: 100/100レース (100%)
```

**技術的成果**:
- ✓ entriesテーブル修正成功
- ✓ 全レースで級別データ取得可能
- ✓ Warningメッセージ消滅

**しかし**:
- ✗ 予測精度への影響なし
- ✗ ST/展示の相関が弱すぎて級別補正も無効

**テストスクリプト**: `test_grade_correction.py` (179行)

---

## 4. 予測ロジック詳細

### 4.1 Phase 3（推奨版）の構成

**Feature Flag**:
```python
# config/feature_flags.py
'before_safe_st_exhibition': False
```

**スコア配分**:
```python
self.ENTRY_WEIGHT = 0.6   # 進入コース（60%）
self.PARTS_WEIGHT = 0.4   # 部品交換・体重（40%）
self.ST_WEIGHT = 0.0      # 使用しない
self.EXHIBITION_WEIGHT = 0.0  # 使用しない
```

**使用する特徴量**:
1. **進入コース**（60%）
   - データ取得: `race_details.exhibition_course`
   - スコアリング: `_calc_entry_score()`
   - 範囲: -12〜+10点（Phase 0修正版）

2. **部品交換・体重**（40%）
   - データ取得: `race_details.parts_replacement`, `race_details.adjusted_weight`
   - スコアリング: `_calc_parts_weight_score()`
   - 範囲: -18〜0点（部品）、±数点（体重）

**期待精度**: 41-42%

---

### 4.2 進入スコアロジック（Phase 0修正版）

**関数**: `_calc_entry_score()` (`src/analysis/before_safe_scorer.py:180-231`)

**ロジック**:

```python
def _calc_entry_score(self, pit_number: int, exhibition_courses: Dict[int, int]) -> float:
    """
    Phase 0診断結果に基づく符号修正版

    Phase 0分析結果:
    - 進入変更あり勝率: 9.13%
    - 進入変更なし勝率: 17.75%
    - 差分: -8.63ポイント
    → 進入変更はマイナス評価、枠なりはプラス評価に修正
    """
    course = exhibition_courses[pit_number]
    expected_course = pit_number  # 枠なりの場合

    if course == expected_course:
        # 枠なり（進入変更なし）→ プラス評価
        return 10.0
    elif course == 1 and pit_number != 1:
        # 1コース奪取（進入変更）→ マイナス評価
        return -12.0
    elif course == 2 and pit_number >= 3:
        # 2コース奪取（進入変更）→ マイナス評価
        return -8.0
    elif course == 3 and pit_number >= 4:
        # 3コース奪取（進入変更）→ マイナス評価
        return -5.0
    elif course > expected_course:
        # 外に追いやられる（進入変更）→ マイナス評価
        if course - expected_course >= 3:
            return -10.0
        else:
            return -5.0
    else:
        # 内に入る（進入変更）→ 小さなマイナス評価
        return -3.0
```

**重要な点**:
- Phase 0診断で符号を修正済み
- しかし実験では改善効果なし
- ロジックの単純化が問題の可能性

---

### 4.3 部品交換・体重スコアロジック

**関数**: `_calc_parts_weight_score()` (`src/analysis/before_safe_scorer.py:233-284`)

**部品交換スコア**:

| 部品 | スコア | 理由 |
|------|--------|------|
| ピストン (P) | -12.0 | モーター不調の兆候 |
| リング (R) | -8.0 | やや不調の兆候 |
| シリンダー (C) | -18.0 | 大きな不調 |
| キャブレター | -5.0 | 調整不良 |
| ギアケース | -5.0 | 伝達系不調 |

**体重スコア**:
```python
weight_score = -1.0 * weight_delta
# +1kgで-1点（重いほど不利）
```

---

### 4.4 ST/展示タイムスコアロジック（Phase 5非推奨版）

**使用しない理由**: 相関が弱すぎる（実験で効果なし）

**参考: 実装内容**

**STスコア** (`src/scoring/st_scorer_v2.py`):
1. 会場別標準化（Z-score）
2. 級別補正（A1/A2/B1/B2）
3. スコア範囲: -10〜+10点

**展示タイムスコア** (`src/scoring/exhibition_scorer_v2.py`):
1. 順位重視（展示タイム順位）
2. 会場別標準化
3. 級別補正
4. スコア範囲: -10〜+10点

**重み配分** (Phase 5版、非推奨):
```python
self.ENTRY_WEIGHT = 0.20      # 進入（20%）
self.PARTS_WEIGHT = 0.30      # 部品（30%）
self.ST_WEIGHT = 0.20         # ST（20%）
self.EXHIBITION_WEIGHT = 0.30 # 展示（30%）
```

**結果**: Phase 3と同じ42.0%（改善なし）

---

## 5. 実証された知見

### 5.1 統計的知見

#### 知見1: ST/展示タイムの弱い相関

**データ**: 750,000エントリー、24会場

| 指標 | 値 | 実用性 |
|------|-----|--------|
| ST相関 | r=-0.0476 | ✗ 非常に弱い |
| 展示相関 | r=-0.0840 | ✗ 弱い |
| p値 | < 0.001 | ✓ 統計的有意 |

**結論**:
- 統計的には有意（p < 0.001）
- しかし実用的な予測力は不足（|r| < 0.1）
- **「統計的有意」≠「実用的に有効」の好例**

#### 知見2: 進入変更の大きな影響

**データ**: 596,422エントリー

| 項目 | 値 | 影響 |
|------|-----|------|
| 進入変更あり勝率 | 9.13% | 基準 |
| 進入変更なし勝率 | 17.75% | +94% |
| 差分 | -8.63pt | **大きな影響** |

**結論**:
- 進入変更は勝率を約半減させる
- しかし予測モデルでは活かせなかった
- スコアリングロジックの限界

---

### 5.2 技術的知見

#### 知見3: 重み調整の限界

**実験結果**:
- 進入20% → 42.0%
- 進入50% → 42.0%
- 進入100% → 42.0%

**結論**:
- 重みを変えても精度は変わらない
- **スコアリングロジック自体が問題**
- 手動での最適化は困難

#### 知見4: 級別補正の効果なし

**実装**:
- entriesテーブルから級別取得（100%成功）
- ST/展示タイムに級別補正適用

**結果**: 42.0% → 42.0%（変化なし）

**結論**:
- 級別補正の実装は成功
- しかしST/展示の相関が弱すぎて効果なし
- **相関の弱さが根本原因**

#### 知見5: Point-biserial相関の有効性

**適用場面**:
- 連続変数（ST/展示タイム）vs 二値変数（勝/負）
- 750,000サンプルで頑健な統計

**利点**:
1. スコアリング符号の検証に最適
2. 会場別分析で地域特性を把握
3. 統計的有意性の明確な判定

**実装**: `scripts/verify_st_correlation.py` (442行)

---

### 5.3 データベース知見

#### 知見6: entriesテーブルの構造

**重要な発見**:
- `race_entries`テーブルは**存在しない**
- 正しいテーブル名は`entries`
- `racer_rank`カラムにA1/A2/B1/B2データが100%存在

**修正箇所**:
```python
# 修正前
FROM race_entries  # ← 存在しない

# 修正後
FROM entries  # ← 正しい
```

**影響**:
- 級別データ取得成功率: 0% → 100%
- Warningメッセージの消滅
- 将来の機械学習モデルで活用可能

---

## 6. 避けるべきアプローチ

### 6.1 効果のない改善策

以下のアプローチは**実験で効果なしと実証済み**。再試行は時間の無駄。

#### ❌ アプローチ1: ST/展示タイムの活用

**理由**:
- 相関が弱すぎる（ST: -0.0476, 展示: -0.0840）
- 級別補正しても効果なし
- 会場別標準化も効果なし

**実証実験**:
- 符号修正版: 42.0% (±0.0pt)
- 級別補正版: 42.0% (±0.0pt)

**結論**: **ST/展示タイムは使わない**

---

#### ❌ アプローチ2: 進入スコアの重み調整

**理由**:
- 進入20%/50%/100%で全て同じ結果
- 重み調整では改善不可
- ロジック自体が問題

**実証実験**:
- 進入50%版: 42.0% (±0.0pt)
- 進入100%版: 42.0% (±0.0pt)

**結論**: **重み調整は無効**

---

#### ❌ アプローチ3: 進入スコアの符号修正のみ

**理由**:
- 理論的には正しい（Phase 0診断で証明）
- しかし実験では効果なし
- 単純なスコアリングロジックの限界

**実証実験**:
- 符号修正版: 42.0% (±0.0pt)

**結論**: **符号修正だけでは不十分**

---

#### ❌ アプローチ4: 級別補正の追加

**理由**:
- 実装は成功（entriesテーブルから100%取得）
- しかしST/展示の相関が弱すぎて効果なし
- 級別で補正しても予測力不足

**実証実験**:
- 級別補正版: 42.0% (±0.0pt)

**結論**: **級別補正も無効**（ST/展示を使う限り）

---

### 6.2 手動スコアリングの限界

**Phase 0〜級別補正までの実験で明らかになった限界**:

1. **相関の弱さは克服不可**
   - |r| < 0.1の特徴量は実用性なし
   - 級別補正・会場別標準化も無効

2. **重み調整の限界**
   - 手動での最適化は不可能
   - スコアリングロジック自体が問題

3. **単純なルールベースの限界**
   - 枠なり=+10点のような単純化では不十分
   - 非線形な関係を捉えられない

**結論**: **機械学習モデル（LightGBM）に依存すべき**

---

## 7. 今後の方向性

### 7.1 推奨アプローチ

#### ✓ アプローチ1: Phase 3での安定運用

**内容**:
- ST/展示なし
- 進入60% + 部品40%
- シンプルで保守性高い

**期待効果**: 41-42%（安定）

**実装**: 既に設定済み
```python
'before_safe_st_exhibition': False
```

---

#### ✓ アプローチ2: LightGBMモデルの強化

**内容**:
1. entriesテーブルの級別データを特徴量に追加
2. 進入変更フラグの追加（Phase 0知見を活用）
3. モーター・ボート成績の活用

**期待効果**: +2-5pt改善の可能性

**実装優先度**: 高

**注意点**:
- 手動スコアリングの限界を超える唯一の方法
- Phase 0〜級別補正の知見を特徴量に変換

---

#### ✓ アプローチ3: 進入予測モデルの改良

**内容**:
1. Phase 0-2の知見を活用
2. 進入変更確率の精緻化
3. ベイズモデルの精度向上

**期待効果**: +1-2pt改善

**実装優先度**: 中

---

### 7.2 新しい特徴量候補

**Phase 0〜級別補正で検証済み**:

| 特徴量 | 相関 | 実用性 | 優先度 |
|--------|------|--------|--------|
| ST/展示タイム | 弱い | ✗ | 低 |
| 級別（A1/B2） | - | ✗（単体では） | 低 |
| 進入変更 | -8.63pt | ? | **高** |

**未検証の有望候補**:

| 特徴量 | 期待 | 優先度 | 実装難易度 |
|--------|------|--------|------------|
| モーター2連率 | 中 | 高 | 低 |
| ボート2連率 | 中 | 高 | 低 |
| 選手×会場成績 | 高 | 高 | 中 |
| 天候・風向き | 中 | 中 | 高 |
| 潮汐情報 | 低 | 低 | 高 |

---

### 7.3 機械学習での活用方法

**Phase 0〜級別補正の知見を特徴量に変換**:

#### 特徴量1: 進入変更フラグ

```python
# Phase 0-2の知見を活用
features['entry_changed'] = 1 if pit_number != exhibition_course else 0
# 期待効果: -8.63pt影響を機械学習で捉える
```

#### 特徴量2: 級別エンコーディング

```python
# entriesテーブルから取得（100%存在）
grade_map = {'A1': 4, 'A2': 3, 'B1': 2, 'B2': 1}
features['racer_grade'] = grade_map[racer_rank]
```

#### 特徴量3: ST/展示タイムの交互作用

```python
# 単体では弱いが交互作用は有効かも
features['st_x_grade'] = st_time * grade_map[racer_rank]
features['exhibition_x_grade'] = exhibition_time * grade_map[racer_rank]
```

#### 特徴量4: 進入コース優位性

```python
# 1コースの圧倒的優位を直接エンコード
features['is_course_1'] = 1 if exhibition_course == 1 else 0
```

**実装方法**:
1. `src/features/feature_engineering.py`に追加
2. LightGBMモデルの再訓練
3. 100-200レースでテスト
4. +2pt以上改善なら本番採用

---

## 8. 統計手法リファレンス

### 8.1 Point-biserial相関

**用途**: 連続変数 vs 二値変数の相関測定

**数式**:
```
r_pb = ((mean1 - mean0) / std) * sqrt((n1 * n0) / (n * n))

where:
  mean1: 勝者グループの平均
  mean0: 敗者グループの平均
  std: 全体の標準偏差
  n1: 勝者数
  n0: 敗者数
  n: 総サンプル数
```

**解釈**:
- -1 ≤ r ≤ 1
- 負の値: 値が小さいほど勝ちやすい（ST/展示タイム）
- |r| < 0.1: 非常に弱い相関（実用性なし）
- |r| ≥ 0.3: 中程度の相関（実用可能）

**実装**: `scripts/verify_st_correlation.py:67-89`

---

### 8.2 Bootstrap信頼区間

**用途**: 小サンプルでの統計的有意性検定

**手法**:
1. 元データからリサンプリング（復元抽出）
2. 1000回反復
3. 差分の分布を作成
4. 2.5%点と97.5%点で95%信頼区間

**実装**: `test_large_scale_integration.py:301-330`

**注意**:
- 100レースでは信頼区間が±13-15%と広い
- 有意差検出には300-500レース必要

---

## 9. ファイル構成

### 9.1 診断・分析スクリプト

```
scripts/
├── verify_st_correlation.py        (442行) - ST/展示相関検証
├── analyze_changed_races.py        (310行) - 進入変更分析
check_db_schema.py                  (127行) - DB構造確認
check_entries_table.py              (127行) - entriesテーブル詳細
```

### 9.2 テストスクリプト

```
test_entry_fix.py                   (169行) - 符号修正版テスト
test_entry_weight_experiments.py    (318行) - 重み実験
test_grade_correction.py            (179行) - 級別補正テスト
test_large_scale_integration.py     (427行) - 大規模テスト+Bootstrap
```

### 9.3 データ出力

```
data/
└── changed_races.csv               (61,225行) - 進入変更全データ

temp/reports/
├── comprehensive_improvement_summary.md    - Phase 0診断レポート
└── phase0_entry_fix_report.md             - 完全レポート
```

### 9.4 コア実装

```
src/analysis/
└── before_safe_scorer.py
    ├── L43-59:   重み配分（Phase 3 / Phase 5）
    ├── L180-231: _calc_entry_score() - 進入スコア（Phase 0修正版）
    ├── L233-284: _calc_parts_weight_score() - 部品交換スコア
    └── L314-343: _get_racer_data_for_pit() - 級別取得（entries修正済み）

src/scoring/
├── st_scorer_v2.py                - STスコアラー（Phase 4再設計版）
└── exhibition_scorer_v2.py        - 展示タイムスコアラー（Phase 4再設計版）

config/
└── feature_flags.py
    └── 'before_safe_st_exhibition': False  # Phase 3設定
```

---

## 10. クイックリファレンス

### 10.1 重要な数値

| 項目 | 値 | 意味 |
|------|-----|------|
| ST相関 | -0.0476 | 非常に弱い（使用不可） |
| 展示相関 | -0.0840 | 弱い（使用不可） |
| 進入変更影響 | -8.63pt | 大きい（活用困難） |
| Phase 3精度 | 41-42% | 安定運用可能 |
| 級別データ充実度 | 100% | entriesテーブル |

### 10.2 DO / DON'T

**DO（推奨）**:
- ✓ Phase 3で安定運用
- ✓ LightGBMモデルの強化
- ✓ 進入変更を特徴量に追加
- ✓ entriesテーブルの級別データ活用
- ✓ Point-biserial相関で特徴量検証

**DON'T（非推奨）**:
- ✗ ST/展示タイムを手動スコアリングで使用
- ✗ 進入スコアの重み調整に時間を費やす
- ✗ 級別補正だけでの改善を期待
- ✗ 100レース以下の小規模テストで判断
- ✗ race_entriesテーブルを参照（存在しない）

---

## 11. よくある質問（FAQ）

### Q1: なぜST/展示タイムは使えないのか？

**A**: 相関が弱すぎる（|r| < 0.1）ため、実用的な予測力がありません。統計的には有意（p < 0.001）でも、実際の精度向上には寄与しません。Phase 0診断と複数の実験で実証済みです。

### Q2: 進入変更の-8.63pt影響を活かせないのはなぜか？

**A**: 手動スコアリングのロジックが単純すぎるためです。枠なり=+10点、進入変更=-12点のような固定スコアでは、レース状況の複雑性を捉えきれません。機械学習モデルで特徴量として使うべきです。

### Q3: 級別補正は本当に効果がないのか？

**A**: 級別データの取得は100%成功していますが、ST/展示タイムの相関が弱すぎるため、補正しても予測精度は向上しません（42.0% → 42.0%）。級別データ自体は有用なので、LightGBMの特徴量として使うべきです。

### Q4: もっと大規模なテスト（300-500レース）をすれば改善効果が見えるのでは？

**A**: 可能性は低いです。100レーステストで全く差が出ない（0.0pt）場合、サンプル数を増やしても結果は変わりません。統計的パワーの問題ではなく、手法自体の限界です。

### Q5: 次に試すべき改善策は？

**A**: LightGBMモデルに以下の特徴量を追加してください：
1. 進入変更フラグ（Phase 0知見）
2. 級別データ（entriesテーブル）
3. モーター・ボート成績
4. ST/展示タイムの交互作用（単体では弱いが組み合わせで有効かも）

手動スコアリングの改善は限界に達しました。

### Q6: entriesテーブルとrace_entriesテーブルの違いは？

**A**: `race_entries`テーブルは存在しません。正しいテーブル名は`entries`です。`src/analysis/before_safe_scorer.py:323`で修正済みです。今後は`entries`を使用してください。

---

## 12. 変更履歴

| 日付 | 変更内容 | 担当 |
|------|---------|------|
| 2025-12-05 | Phase 0診断実施 | Claude Code |
| 2025-12-05 | 進入スコア符号修正 | Claude Code |
| 2025-12-05 | 重み実験（50%/100%版） | Claude Code |
| 2025-12-05 | entriesテーブル修正 | Claude Code |
| 2025-12-05 | 級別補正機能テスト | Claude Code |
| 2025-12-05 | 最終決定: Phase 3運用 | Claude Code |
| 2025-12-05 | 本ドキュメント作成 | Claude Code |

---

## 13. 連絡先・参考資料

**関連ドキュメント**:
- `temp/reports/phase0_entry_fix_report.md` - Phase 0診断〜符号修正の詳細レポート
- `temp/reports/comprehensive_improvement_summary.md` - Phase 0診断の統計レポート

**データベース**:
- `data/boatrace.db` - メインDB
- `data/changed_races.csv` - 進入変更データ（61,225行）

**Feature Flags**:
- `config/feature_flags.py` - 機能切り替え設定

**重要な設定**:
```python
'before_safe_st_exhibition': False  # Phase 3（ST/展示なし）
```

---

**最終更新日**: 2025-12-05
**ドキュメントバージョン**: 1.0
**ステータス**: Phase 3運用確定
