# 競艇予測システム 技術仕様書

**作成日**: 2024年11月27日
**目的**: 外部AIによる改善点分析用

---

## 1. 現在の的中率

| 指標 | 的中率 | 備考 |
|------|--------|------|
| 単勝 | 58.75% | 1着予想が的中 |
| 複勝 | 84.81% | 1着予想が3着内 |
| 2連単 | 23.25% | 1-2着の順番が的中 |
| 3連単 | 8.52% | 1-2-3着の順番が的中 |
| 3連複 | 21.62% | 1-2-3着の組み合わせが的中 |

**回収率**: 約75-76%（控除率25%を考慮すると損益分岐点）

---

## 2. 予測ロジック概要

### 2.1 スコア計算の流れ

```
入力: 6艇のレースデータ
  ↓
[基本スコア計算] 合計100点
  ├─ コーススコア (35点)
  ├─ 選手スコア (35点)
  ├─ モータースコア (20点)
  └─ 級別スコア (10点)
  ↓
[拡張スコア計算] 合計20点（正規化後）
  ├─ 平均ST (10点)
  ├─ 展示タイム (10点)
  ├─ 級別 (10点)
  ├─ 直近成績 (8点)
  ├─ 会場別成績 (8点)
  └─ その他7要素 (32点)
  ↓
[補正処理]
  ├─ 天候補正 (±5点)
  └─ 潮位補正 (±5点)
  ↓
総合スコア (0-100点)
  ↓
スコア順に順位予想
```

### 2.2 基本スコアの配点

```python
SCORING_WEIGHTS = {
    "course": 35,   # コース有利度（1コース=55%, 6コース=5%）
    "racer": 35,    # 選手勝率（全国勝率×0.6 + 当地勝率×0.4）
    "motor": 20,    # モーター2連対率
    "rank": 10,     # 級別（A1=100, A2=70, B1=40, B2=10）
}
```

---

## 3. 使用データ

### 3.1 出走表データ (entries)

| カラム | 説明 | 的中率への影響 |
|--------|------|---------------|
| pit_number | 枠番(1-6) | ★★★★★ 最重要 |
| racer_rank | 級別(A1/A2/B1/B2) | ★★★★ |
| win_rate | 選手勝率 | ★★★★ |
| local_win_rate | 当地勝率 | ★★★ |
| motor_second_rate | モーター2連対率 | ★★★ |
| avg_st | 平均ST | ★★★★★ 最重要 |
| f_count | フライング回数 | ★★ |
| l_count | 出遅れ回数 | ★ |

### 3.2 展示データ (race_details)

| カラム | 説明 | 的中率への影響 |
|--------|------|---------------|
| exhibition_time | 展示タイム | ★★★★★ 最重要 |
| tilt_angle | チルト角度 | ★ |
| st_time | 当日ST | ★★★★ (予測時は未確定) |

### 3.3 気象データ (race_conditions)

| カラム | 説明 | 1コース勝率への影響 |
|--------|------|-------------------|
| wind_speed | 風速(m/s) | 6m+で-6.3% |
| wave_height | 波高(cm) | 8cm+で-6.3% |

---

## 4. 統計分析結果

### 4.1 コース別勝率（全国平均）

| コース | 勝率 | 2着率 | 3着率 |
|--------|------|-------|-------|
| 1コース | 55% | 17% | 10% |
| 2コース | 14% | 20% | 17% |
| 3コース | 12% | 17% | 17% |
| 4コース | 10% | 17% | 16% |
| 5コース | 6% | 14% | 17% |
| 6コース | 3% | 15% | 17% |

### 4.2 平均ST別勝率（最重要指標）

| 平均ST | 勝率 | 倍率 |
|--------|------|------|
| 0.00-0.12秒 | 26.76% | 3.0倍 |
| 0.12-0.15秒 | 23.30% | 2.6倍 |
| 0.15-0.18秒 | 18.14% | 2.0倍 |
| 0.18-0.20秒 | 12.50% | 1.4倍 |
| 0.20秒以上 | 8.95% | 1.0倍 |

**発見**: STが速い選手は遅い選手の約3倍の勝率

### 4.3 展示タイム順位別勝率（最重要指標）

| 展示順位 | 勝率 | 倍率 |
|----------|------|------|
| 1位 | 27.33% | 3.1倍 |
| 2位 | 20.47% | 2.3倍 |
| 3位 | 16.48% | 1.9倍 |
| 4位 | 13.70% | 1.5倍 |
| 5位 | 11.17% | 1.3倍 |
| 6位 | 8.89% | 1.0倍 |

**発見**: 展示1位は6位の約3倍の勝率

### 4.4 級別×コース勝率

| 級別 | 1コース | 2コース | 3コース | 4コース |
|------|---------|---------|---------|---------|
| A1 | 71.1% | 18.5% | 16.8% | 14.0% |
| A2 | 60.9% | 16.2% | 15.4% | 12.0% |
| B1 | 44.7% | 10.2% | 9.1% | 7.9% |
| B2 | 33.2% | 8.7% | 6.7% | 4.4% |

**発見**: 1コースA1は71.1%、1コースB2は33.2%（38ポイント差）

### 4.5 レース番号別1コース勝率

| レース番号 | 1コース勝率 | 特徴 |
|-----------|------------|------|
| 1R | 61.6% | 新人戦多い |
| 2R-3R | 53-54% | **荒れやすい** |
| 4R-9R | 55-57% | 標準 |
| 10R | 60.1% | メイン手前 |
| 11R | 67.4% | 準メイン |
| 12R | 70.2% | **最も堅い** |

### 4.6 気象条件別1コース勝率

| 条件 | 1コース勝率 |
|------|------------|
| 弱風(0-2m) | 60.0% |
| 中風(3-5m) | 57.8% |
| 強風(6m+) | 53.7% |
| 静水(0-3cm) | 59.4% |
| 高波(8cm+) | 53.1% |

### 4.7 会場別1コース勝率

**堅い会場（60%以上）**:
- 徳山(18): 67.1%
- 大村(24): 66.2%
- 宮島(17): 62.4%

**荒れ会場（50%以下）**:
- 戸田(02): 45.4%
- 平和島(04): 46.2%
- 江戸川(03): 49.5%

---

## 5. 機械学習分析結果

### 5.1 特徴量の影響度（ロジスティック回帰）

| 特徴量 | 影響度 | 方向性 |
|--------|--------|--------|
| course | 49.8% | ↑勝率上昇 |
| venue_in1 | 18.3% | ↓逆効果 |
| racer | 8.1% | ↑勝率上昇 |
| rank | 6.4% | ↑勝率上昇 |
| exhibition | 6.4% | ↑勝率上昇 |
| st | 5.3% | ↑勝率上昇 |
| motor | 2.4% | ↑勝率上昇 |
| fl_penalty | 1.8% | ↑勝率上昇 |
| tilt | 1.5% | ↑勝率上昇 |

**発見**:
- コースが圧倒的に重要（約50%）
- 会場別1コース勝率を予測に使うと逆効果
- チルトは影響微小

### 5.2 ニューラルネットワーク結果

- 訓練精度: 86.82%
- テスト精度: 86.93%
- 単勝的中率: 61.29%（ベースラインと同等）

**結論**: 深層学習でも大幅な改善は見られない

---

## 6. 試した改善策とその効果

| 改善策 | 単勝的中率 | 効果 |
|--------|-----------|------|
| ベースライン | 58.75% | - |
| ST相対評価追加(8%) | 58.86% | +0.11% |
| 動的配点（会場別） | 57.32% | **-1.43%** |
| レース番号調整 | 58.78% | +0.03% |
| 気象条件調整 | 58.76% | +0.01% |
| NNモデル | 61.29% | +0.00%* |

*テストデータのベースラインが異なる

**結論**: 大幅な改善は困難。予測精度の天井（約58-59%）に近い可能性

---

## 7. 現在のシステムの問題点

### 7.1 的中率の限界
- 単勝58.75%が上限に近い
- 配点変更、ML、加点減点いずれも+0.1%程度の改善

### 7.2 使用していないデータ
- **当日の展示ST**（予測時は過去の平均STを使用）
- **進入コース予測**（枠なり前提）
- **オッズ情報**（期待値計算に未使用）

### 7.3 回収率の問題
- 75-76%で控除率とほぼ同等
- 利益を出すには期待値ベースの買い方が必要

---

## 8. 改善の可能性がある方向性

1. **当日の展示STをリアルタイム取得**
   - 過去ST→当日STで精度向上の余地

2. **進入コース予測**
   - 前付け選手の考慮
   - 枠なり崩れの予測

3. **期待値ベースの買い目選択**
   - オッズとの組み合わせ
   - 過小評価された穴馬狙い

4. **レース選別**
   - 予測しやすいレースのみに賭ける
   - 堅い会場の12Rに特化など

---

## 9. ファイル構成

```
src/analysis/
├── race_predictor.py      # メイン予測エンジン
├── extended_scorer.py     # 拡張スコア計算
├── racer_analyzer.py      # 選手分析
├── motor_analyzer.py      # モーター分析
├── weather_adjuster.py    # 天候補正
└── tide_adjuster.py       # 潮位補正

config/
└── settings.py            # 重み設定・会場特性

data/
└── boatrace.db            # SQLiteデータベース
```

---

**質問例**:
- この予測システムで的中率を60%以上に上げる方法は？
- 回収率を100%以上にするにはどうすればよいか？
- 使用していないデータで有効なものは何か？
