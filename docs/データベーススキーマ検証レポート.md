# データベーススキーマ検証レポート

**作成日**: 2025-11-28
**目的**: カラム名の齟齬を完全に解消

## 実施内容

### 1. データベーススキーマの確認

全テーブルのスキーマを抽出し、正式なカラム名を確認しました。

#### 主要テーブルの正式カラム名

**racesテーブル**:
```sql
- id (PRIMARY KEY)
- venue_code
- race_date  ← 正式カラム名（"date"ではない）
- race_number
- race_time
- race_grade
- race_distance
- race_status
```

**race_detailsテーブル**:
```sql
- id (PRIMARY KEY)
- race_id
- pit_number  ← 正式カラム名（"waku"ではない）
- exhibition_time
- tilt_angle
- parts_replacement
- actual_course
- st_time
- chikusen_time
- isshu_time
- mawariashi_time
```

**entriesテーブル**:
```sql
- id (PRIMARY KEY)
- race_id
- pit_number  ← 正式カラム名
- racer_number
- racer_name
- ...
```

### 2. 検出された問題と修正

#### 問題1: `races.date` vs `races.race_date`

**影響ファイル**:
- ❌ `fetch_original_tenji_daily.py` (Line 55)

**修正内容**:
```python
# 修正前
WHERE venue_code = ? AND date = ? AND race_number = ?

# 修正後
WHERE venue_code = ? AND race_date = ? AND race_number = ?
```

**ステータス**: ✅ 修正完了

---

#### 問題2: `race_details.waku` vs `race_details.pit_number`

**影響ファイル**:
1. ❌ `fetch_original_tenji_daily.py` (Line 67, 77, 89)
2. ❌ `fetch_original_tenji_optimized.py` (Line 81, 91, 102)

**修正内容**:
```python
# 修正前
WHERE race_id = ? AND waku = ?
INSERT INTO race_details (race_id, waku, ...)

# 修正後
WHERE race_id = ? AND pit_number = ?
INSERT INTO race_details (race_id, pit_number, ...)
```

**ステータス**: ✅ 全て修正完了

---

#### 問題3: 変数名としての`waku`（修正不要）

以下のファイルでは`waku`を**変数名**として使用しているだけで、データベースカラムではありません:

- ✅ `src/analysis/venue_analyzer.py` - ループ変数として使用
- ✅ `setup_test_data.py` - ループ変数として使用
- ✅ `fetch_upcoming_races.py` - HTMLパース時の変数名
- ✅ `src/scraper/beforeinfo_fetcher.py` - HTMLクラス名検索

**ステータス**: 問題なし（修正不要）

---

### 3. 検証結果サマリー

| カテゴリ | 件数 | ステータス |
|---------|------|----------|
| データベースカラム名の齟齬 | 7箇所 | ✅ 全て修正完了 |
| 変数名としての使用 | 13箇所 | ✅ 問題なし |
| SQL date()関数の使用 | 11箇所 | ✅ 問題なし |

---

### 4. 修正済みファイル一覧

1. ✅ `fetch_original_tenji_daily.py`
   - Line 55: `date` → `race_date`
   - Line 67: `waku` → `pit_number`
   - Line 77: `waku` → `pit_number`
   - Line 89: `waku` → `pit_number`

2. ✅ `fetch_original_tenji_optimized.py`
   - Line 81: `waku` → `pit_number`
   - Line 91: `waku` → `pit_number`
   - Line 102: `waku` → `pit_number`

---

### 5. 今後の予防策

#### 推奨事項

1. **スキーマ定義ファイルの作成**
   - 全テーブルの正式カラム名を文書化
   - コード内にコメントとして参照情報を記載

2. **型ヒントの活用**
   ```python
   from typing import TypedDict

   class RaceRecord(TypedDict):
       venue_code: str
       race_date: str  # 正式カラム名を明示
       race_number: int
   ```

3. **定数定義の活用**
   ```python
   # config/db_columns.py
   class RaceColumns:
       VENUE_CODE = 'venue_code'
       RACE_DATE = 'race_date'  # ハードコード防止
       RACE_NUMBER = 'race_number'
   ```

4. **SQLクエリのテンプレート化**
   ```python
   # 正式カラム名を使ったクエリテンプレート
   RACE_SELECT_QUERY = '''
       SELECT id FROM races
       WHERE venue_code = ? AND race_date = ? AND race_number = ?
   '''
   ```

---

## 結論

✅ **データベースカラム名の齟齬は完全に解消されました**

- 全7箇所の誤ったカラム名参照を修正
- スキーマ検証により、他に問題がないことを確認
- 今後の予防策として定数定義とドキュメント化を推奨

---

## 検証コマンド

データベーススキーマの再確認方法:
```bash
python -c "import sqlite3; conn = sqlite3.connect('data/boatrace.db'); cursor = conn.cursor(); cursor.execute(\"SELECT sql FROM sqlite_master WHERE type='table' AND name='races'\"); print(cursor.fetchone()[0]); conn.close()"
```

カラム名の検索方法:
```bash
# 誤った"date"カラムの参照を検索
grep -r "WHERE.*date\s*=" *.py

# 誤った"waku"カラムの参照を検索
grep -r "WHERE.*waku\s*=" *.py
```
