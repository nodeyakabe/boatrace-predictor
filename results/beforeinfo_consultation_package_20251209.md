# ボートレース予測における直前情報（BEFORE）統合の課題

**相談内容**: 予測モデルへの直前情報統合がすべて失敗しており、根本的な問題の特定と解決策を求めています。

---

## 1. 背景と目的

### システム概要
- **目的**: ボートレースの着順を予測し、舟券を自動購入
- **現在の予測精度**: 1着的中率 56.00%（PRE_SCORE単体）
- **課題**: 直前情報（展示航走データ）を統合すると必ず精度が悪化する

### PRE_SCORE（事前予測）とは
選手の過去実績、会場適性、モーター性能、コース別勝率など、レース前に確定している情報から算出したスコア。

### BEFORE_SCORE（直前情報）とは
レース当日の展示航走（練習走行）で得られる情報から算出したスコア：
- 展示タイム（周回速度）
- スタートタイミング
- チルト角度（モーター調整）
- 部品交換情報
- 進入コース

---

## 2. データの基礎分析結果

### BEFORE_SCOREと実際の着順の相関（100レース分析）

**着順別のBEFOREスコア平均:**
```
1着: 25.59点
2着: 19.56点 (差分: -6.04点)
3着: 16.71点
4着: 14.12点
5着: 12.00点
6着: 10.03点 (1着との差: -15.56点)
```

**BEFORE順位での実際の1着的中率:**
```
BEFORE 1位 → 1着になる確率: 34.6%
BEFORE 2位 → 1着になる確率: 25.7%
BEFORE 3位 → 1着になる確率: 19.6%
BEFORE 6位 → 1着になる確率: 2.0%
```

**BEFORE順位での実際の平均着順:**
```
BEFORE 1位 → 平均着順: 2.66位
BEFORE 2位 → 平均着順: 3.05位
BEFORE 6位 → 平均着順: 4.42位
```

**重要な発見:**
1. BEFOREスコアと実際の着順には強い正の相関がある
2. BEFORE 1位の34.6%的中率は、PRE_SCORE単体（56%）と比べると低いが、それでも高い
3. 1着と2着の差（-6.04点）が、1着と6着の差（-15.56点）に比べて小さい
4. BEFORE 1位の3着以内率は68.7%と高い

---

## 3. 試行した統合方式と結果

すべての統合で**200レース**を検証。ベースライン（BEFORE無効）と比較。

### 方式1: 正規化統合

**手法:**
```
PRE_SCOREとBEFORE_SCOREを0-100に正規化
最終スコア = 正規化PRE × 0.6 + 正規化BEFORE × 0.4
```

**結果:**
- 1着的中率: 56.00% → **55.50%** (-0.5%)
- 3着以内的中率: 77.00% → 79.50% (+2.5%)

**考察:**
- 正規化により絶対的なスコア差が失われる
- PRE_SCOREで「圧倒的本命」だったケースが相対化されてしまう

---

### 方式2: 階層的予測（ボーナス方式）

**手法:**
```
BEFORE順位に応じてPRE_SCOREにボーナスを加算
BEFORE 1位: PRE_SCORE × 1.10 (+10%)
BEFORE 2位: PRE_SCORE × 1.05 (+5%)
その他: PRE_SCORE × 1.00 (変更なし)
```

**結果:**
- 1着的中率: 56.00% → **55.50%** (-0.5%)
- 3着以内的中率: 77.50% → 79.50% (+2.0%)

**考察:**
- PRE 1位とBEFORE 1位が異なる場合、順位逆転が発生
- BEFORE 1位が実際の1着でない確率（65.4%）が高く、誤った調整になる

---

### 方式3: 状態フラグ調整

**手法:**
```
直前情報を5つのフラグで評価し、PRE_SCOREを調整：

1. F/Lフラグ（フライング/出遅れ）: PRE_SCORE × 0.7 (-30%)
2. まくり狙いフラグ（高チルト+まくり適性選手）: PRE_SCORE × 1.2 (+20%)
3. 展示タイム好調フラグ（レース内1-2位）: PRE_SCORE × 1.1 (+10%)
4. 部品交換フラグ: PRE_SCORE × 0.9 (-10%)
5. 進入変化リスクフラグ: 信頼度 × 0.5 (-50%)
```

**結果:**
- 1着的中率: 56.00% → **52.35%** (-3.65%) ⚠️ **最悪の結果**
- 3着以内的中率: 77.00% → 78.24% (+1.24%)

**考察:**
- 進入変化リスクフラグがほぼ全艇でTrueになってしまった（データ欠損が原因）
- 複数フラグの乗算で過剰な調整が発生

---

## 4. 一貫したパターンと疑問

### すべての統合方式で同じ結果

| 統合方式 | 1着的中率 | 3着以内的中率 |
|---------|-----------|--------------|
| BEFORE無効（ベースライン） | **56.00%** | 77.00% |
| 正規化統合 | 55.50% (-0.5%) | 79.50% (+2.5%) |
| 階層的予測 | 55.50% (-0.5%) | 79.50% (+2.0%) |
| 状態フラグ | 52.35% (-3.65%) | 78.24% (+1.24%) |

**一貫したパターン:**
- ✅ 3着以内的中率は必ず向上（+1.2%〜+2.5%）
- ❌ 1着的中率は必ず悪化（-0.5%〜-3.65%）

---

## 5. 仮説と疑問点

### 仮説1: BEFOREは「1着 vs 2着」の識別が苦手
- BEFORE 1位と2位の差はわずか+6.04点
- BEFORE 1位の65.4%は1着にならない
- PRE_SCOREの微妙な順位付けを乱している可能性

### 仮説2: PRE_SCOREとBEFORE_SCOREが相関している
- 強い艇はPREでもBEFOREでも上位になる
- 統合しても新しい情報が加わらない
- BEFOREの誤差がPREの精度を下げるだけ

**未検証:** PRE順位とBEFORE順位の相関係数を計算していない

### 仮説3: 展示航走と本番は別物
専門家の意見:
> 「スタートタイミングはメンタルや運の要素が大きく、展示の情報は本番にほぼ影響しない。フライング/出遅れだけを考慮すればいい。」
> 「展示でコースを変えた選手が本番でまた違うコースを走ることもよくある。」

**示唆:** 展示は「練習」であり、本番とは戦略が異なる可能性

### 仮説4: データ品質の問題
- 展示航走の進入コース（`exhibition_course`）がほぼ全てNULL
- 進入変化の検出が不可能
- 状態フラグ方式が誤判定を起こした原因

---

## 6. なぜ3着以内的中率は向上するのか？

**観測された事実:**
- BEFOREを統合すると、3着以内的中率は必ず向上する
- しかし、1着的中率は必ず悪化する

**考えられる理由:**
1. BEFOREは「上位グループ vs 下位グループ」の識別には有効
2. BEFORE上位の艇は3着以内に入りやすい（BEFORE 1位の3着以内率68.7%）
3. 1着予測で失敗しても、2-3着を的中させている

**疑問:**
- この現象をどう解釈すべきか？
- 3着以内予測と1着予測で別のアプローチを取るべきか？

---

## 7. 現在のBEFOREスコア配点

```
配点（合計100点）:
- 展示タイム: 25点
- スタートタイミング: 25点
- 進入隊形: 20点
- 前レース結果: 15点
- チルト角度/風: 10点
- 部品交換/体重: 5点
```

**専門家の指摘:**
- スタートタイミングの25点は過大評価の可能性
- フライング/出遅れだけを考慮すべき（0/1のフラグ）

**未検証:** 各要素の実際の予測力を個別に測定していない

---

## 8. 相談したい質問

### 質問1: 根本原因の特定
なぜBEFORE統合は必ず1着的中率を悪化させるのか？
- 仮説1-4のどれが主要因だと考えられるか？
- 他に考慮すべき要因はあるか？

### 質問2: 次に検証すべきこと
優先的に検証すべき分析は何か？
- A) PRE順位とBEFORE順位の相関分析
- B) BEFORE各要素の個別の予測力測定
- C) 展示タイムと本番着順の相関分析
- D) PRE拮抗レース（1位と2位の差が小さい）での検証
- E) その他

### 質問3: 統合方式の改善
試していない統合アプローチはあるか？
- 現在の失敗パターンを避けつつ、BEFOREを活用する方法
- 条件付き統合（特定の状況でのみBEFOREを使用）の妥当性

### 質問4: 3着以内的中率の向上をどう活用するか
- 1着予測: BEFORE無効
- 3着以内予測: BEFORE統合
という二本立てアプローチは妥当か？

### 質問5: データ品質の改善
- `exhibition_course`データの欠損は致命的か？
- データ収集を改善すれば状況は変わるか？

---

## 9. 補足情報

### ボートレースの特性
- 6艇で競争（1着確率は理論上16.7%）
- インコース（1号艇）が圧倒的に有利（1着率約50%）
- スタートタイミングが重要（フライングスタート方式）
- 進入隊形の変化が結果に大きく影響

### 予測モデルの目的
- **主目的**: 1着を的中させる（単勝・2連単・3連単の1着選択）
- **副次的**: 3着以内を的中させる（3連複・3連単の相手選択）
- ROI（投資収益率）の最大化

### 現状の成果
- PRE_SCORE単体で56%の1着的中率（非常に高い）
- BEFORE統合による改善を期待したが、すべて失敗

---

## 10. 添付データサマリー

### 検証に使用したデータ
- **期間**: 2025年1月〜12月
- **レース数**: 200レース（直前情報あり）
- **総艇数**: 1200艇（200レース × 6艇）

### データ品質
- `exhibition_time`（展示タイム）: ✅ 存在
- `st_time`（スタートタイミング）: ✅ 存在
- `tilt_angle`（チルト角度）: ✅ 存在
- `parts_replacement`（部品交換）: ✅ 存在
- `exhibition_course`（展示進入コース）: ❌ ほぼ全てNULL
- `actual_course`（本番進入コース）: ✅ 存在

---

## 11. 期待するアドバイス

1. **根本原因の診断**
   - 失敗の主要因は何か？
   - 見落としている視点はないか？

2. **次のアクションプラン**
   - 優先的に検証すべき仮説
   - 試すべき新しいアプローチ

3. **統合の可能性**
   - BEFOREを活用する余地はあるか？
   - それとも諦めるべきか？

4. **機械学習的な視点**
   - 特徴量エンジニアリングの改善余地
   - アンサンブル手法の適用可能性
   - 過学習や情報量の観点からの評価

5. **ドメイン知識の活用**
   - ボートレースという競技の特性から見た示唆
   - 展示航走と本番の関係性の解釈

---

**質問の優先順位:**
1. なぜ1着的中率が必ず悪化するのか？（根本原因）
2. 次に何を検証すべきか？（アクションプラン）
3. BEFOREを活用する余地はあるか？（可能性の評価）

どんな小さな気づきでも歓迎します。よろしくお願いします。
