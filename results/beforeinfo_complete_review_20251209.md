# 直前情報（BEFORE）活用の完全レビュー

**作成日**: 2025-12-09
**目的**: これまでの検証結果を全て整理し、根本から再検討する

---

## エグゼクティブサマリー

**結論**: 3つの異なるアプローチで直前情報（BEFORE）を予測に統合したが、**すべて1着的中率が悪化**した。

| 方式 | 1着的中率 | 3着以内的中率 | 結果 |
|------|-----------|--------------|------|
| **BEFORE無効（ベースライン）** | **56.00%** | 77.00% | - |
| 正規化統合 | 55.50% (-0.5%) | 79.50% (+2.5%) | ❌ 失敗 |
| 階層的予測 | 55.50% (-0.5%) | 79.50% (+2.0%) | ❌ 失敗 |
| 状態フラグ調整 | 52.35% (-3.65%) | 78.24% (+1.24%) | ❌ 失敗 |

**共通パターン**:
- ✅ **3着以内的中率は向上**（上位グループ識別に有効）
- ❌ **1着的中率は必ず悪化**（1着予測には逆効果）

---

## 1. 利用可能なBEFOREデータ

### データベーススキーマ（race_details テーブル）

```sql
-- 直前情報カラム
exhibition_time     REAL,    -- 展示タイム（秒）
st_time            REAL,    -- スタートタイミング（秒）
exhibition_course  INTEGER, -- 展示航走での進入コース
tilt_angle         REAL,    -- チルト角度（度）
parts_replacement  TEXT,    -- 部品交換情報
actual_course      INTEGER  -- 本番の進入コース
```

### データ収集状況

**検証対象**: 2025年1月〜12月のレース
- **直前情報付きレース**: 200レース
- **exhibition_time**: ✅ 存在（展示タイムデータあり）
- **st_time**: ✅ 存在（STデータあり）
- **exhibition_course**: ⚠️ ほぼ全てNone（収集されていない）
- **tilt_angle**: ✅ 存在（チルトデータあり）
- **parts_replacement**: ✅ 存在（部品交換データあり）
- **actual_course**: ✅ 存在（本番進入コースあり）

### データ品質の問題

1. **exhibition_course（展示航走コース）がほぼ全てNone**
   - 進入変化の検出が困難
   - 進入変化リスクフラグが全艇でTrueになる誤判定発生

2. **STデータの信頼性**
   - ユーザー指摘: 「STはメンタルや運の要素が大きく、展示は本番にほぼ影響しない」
   - F/Lだけを考慮すべき

---

## 2. BEFOREスコアの基礎分析

### BEFOREスコアと実際の着順の相関（100レース検証）

**出典**: [results/beforeinfo_comprehensive_analysis_20251209.txt](results/beforeinfo_comprehensive_analysis_20251209.txt)

```
【着順別のBEFOREスコア平均】
1着: 25.59点
2着: 19.56点 (差分: -6.04点)
3着: 16.71点
4着: 14.12点
5着: 12.00点
6着: 10.03点 (差分: -15.56点 vs 1着)

【BEFORE順位での1着的中率】
BEFORE 1位 → 実際の1着: 34.6%（非常に高い！）
BEFORE 2位 → 実際の1着: 25.7%
BEFORE 3位 → 実際の1着: 19.6%
BEFORE 4位 → 実際の1着: 14.5%
BEFORE 5位 → 実際の1着: 3.6%
BEFORE 6位 → 実際の1着: 2.0%

【BEFORE順位での平均着順】
BEFORE 1位 → 平均着順: 2.66位
BEFORE 2位 → 平均着順: 3.05位
BEFORE 3位 → 平均着順: 3.38位
BEFORE 4位 → 平均着順: 3.76位
BEFORE 5位 → 平均着順: 4.09位
BEFORE 6位 → 平均着順: 4.42位
```

### 重要な発見

1. **BEFOREは強い正の相関を持つ**
   - 1着と6着で15.56点の差（統計的に有意）
   - BEFORE 1位の34.6%的中率は、PRE単体と同等レベル

2. **BEFOREの強み: 極端な識別**
   - BEFORE 1位 vs 6位 → 明確に識別可能
   - BEFORE 1位 vs 2位 → 差が小さい（-6.04点のみ）

3. **BEFOREの弱み: 微妙な差の識別**
   - 2着〜4着の識別が困難
   - 1着と2着を分離する能力が低い

---

## 3. ユーザーの洞察

### ユーザーからの重要な指摘

1. **STの重要度について**
   - 「STはメンタルや運の要素もあるし、展示の情報は本番にほぼ影響しない」
   - 「F/Lだけ考慮したらいい」
   - **示唆**: 現在のST配点（25点）は過大評価の可能性

2. **進入変化リスクについて**
   - 「進入が変わってしまうと多くの条件や加算が無意味になる」
   - 「進入が変わるレースに関しては信頼度を大きく落としていい」
   - 「展示でコースを変えた選手が本番でまた違うコースを走ることもよくある」
   - **示唆**: 進入変化は予測精度を大きく低下させる要因

3. **複合的な使い方の要望**
   - 「1号艇の選手にF/Lがある → スタートが遅くなる傾向 → まくられやすくなる」
   - 「チルト角度をあげている → まくりの成功しやすい潮位、場 → まくり成功率アップ」
   - **示唆**: 単純なスコア統合ではなく、状況に応じた複雑な使い方を期待

---

## 4. 試行した統合方式の詳細

### 方式1: 正規化統合（失敗）

**出典**: [results/normalized_integration_validation_20251208.txt](results/normalized_integration_validation_20251208.txt)

**アプローチ**:
```python
# PRE_SCOREとBEFORE_SCOREを0-100に正規化
normalized_pre = (PRE_SCORE - min) / (max - min) * 100
normalized_before = (BEFORE_SCORE - min) / (max - min) * 100

# 加重平均（PRE 60%, BEFORE 40%）
final_score = normalized_pre * 0.6 + normalized_before * 0.4
```

**結果**:
- 1着的中率: 56.00% → **55.50%** (-0.5%悪化)
- 3着以内的中率: 77.00% → 79.50% (+2.5%向上)

**失敗理由**:
1. **正規化によって絶対的な自信が失われた**
   - PRE_SCOREの「圧倒的な本命」（90点 vs 60点）が正規化で縮まる
   - 正規化後は相対的な順位しか反映されない

2. **BEFOREの弱点（1位と2位の差が小さい）がそのまま影響**
   - BEFORE 1位と2位の差はわずか+6.04点
   - 正規化すると、この差がさらに縮小

---

### 方式2: 階層的予測（失敗）

**出典**: [results/hierarchical_prediction_implementation_20251209.md](results/hierarchical_prediction_implementation_20251209.md)

**アプローチ**:
```python
# BEFORE順位に応じてPRE_SCOREにボーナス
if before_rank == 1:
    final_score = PRE_SCORE * 1.10  # +10%
elif before_rank == 2:
    final_score = PRE_SCORE * 1.05  # +5%
else:
    final_score = PRE_SCORE  # ボーナスなし
```

**結果**:
- 1着的中率: 56.00% → **55.50%** (-0.5%悪化)
- 3着以内的中率: 77.50% → 79.50% (+2.0%向上)

**失敗理由**:
1. **PRE_SCOREとBEFORE_SCOREは相関している**
   - PRE 1位とBEFORE 1位が重複することが多い
   - ボーナスが「強い者をさらに強く」してしまう

2. **BEFORE 1位が実際の1着でない場合（65.4%）のペナルティが大きい**
   - PRE 1位がBEFORE 2位の場合、逆転される
   - PRE_SCOREの順位付けが乱れる

---

### 方式3: 状態フラグ調整（失敗）

**出典**: [results/flag_adjustment_validation_20251209.txt](results/flag_adjustment_validation_20251209.txt)

**アプローチ**:
```python
# 5つのフラグで状態変化を判定し、PRE_SCOREを調整
score_multiplier = 1.0

if has_fl:  # F/Lフラグ
    score_multiplier *= 0.7  # -30%

if makuri_setup:  # まくり狙いフラグ
    score_multiplier *= 1.2  # +20%

if exhibition_good:  # 展示タイム好調フラグ
    score_multiplier *= 1.1  # +10%

if parts_replaced:  # 部品交換フラグ
    score_multiplier *= 0.9  # -10%

# 進入変化リスクフラグは信頼度を調整
if entry_risk:
    confidence_multiplier *= 0.5  # -50%

final_score = PRE_SCORE * score_multiplier
```

**各フラグの判定ロジック**:

1. **F/Lフラグ**: ST < 0.01 or ST >= 1.0
2. **まくり狙いフラグ**: tilt >= 0.5 AND 選手まくり率 >= 30%
3. **進入変化リスクフラグ**: exhibition_course != pit_number
4. **展示タイム好調フラグ**: 展示タイムがレース内1-2位
5. **部品交換フラグ**: プロペラ/電気/ギヤケース交換

**結果**:
- 1着的中率: 56.00% → **52.35%** (-3.65%悪化) ⚠️ **最悪**
- 3着以内的中率: 77.00% → 78.24% (+1.24%向上)

**失敗理由**:
1. **進入変化リスクフラグの誤判定**
   - exhibition_courseがほぼ全てNone
   - 全艇でentry_risk = Trueになり、全艇の信頼度が-50%
   - 結果として、予測がランダムに近づいた

2. **フラグの複合効果による過剰調整**
   - 複数のフラグが同時にTrueになる場合、乗算で効果が増幅
   - 例: F/L + 部品交換 → 0.7 × 0.9 = 0.63（-37%）

3. **状態フラグの方向性が不明確**
   - 「展示タイム好調」が必ずしも本番1着に繋がらない
   - BEFOREデータの「その日の状態」は予測できていない

---

## 5. 根本的な問題の分析

### なぜBEFORE統合は必ず失敗するのか？

#### 仮説1: PRE_SCOREとBEFORE_SCOREの相関による干渉

**検証が必要なデータ**:
- PRE_SCORE 1位とBEFORE_SCORE 1位の一致率
- PRE_SCORE上位3位とBEFORE_SCORE上位3位の重複度

**可能性**:
- PRE_SCOREとBEFORE_SCOREが高い相関を持つ場合、統合しても新しい情報が加わらない
- むしろ、BEFOREの誤差がPREの精度を下げる

#### 仮説2: BEFOREは「1着 vs それ以外」の識別には強いが「1着 vs 2着」の識別には弱い

**データが示す事実**:
```
BEFORE 1位 → 1着率: 34.6%
BEFORE 1位 → 2着率: 推定 20-25%
BEFORE 1位 → 3着以内率: 68.7%

BEFORE 1位と2位の差: わずか+6.04点
```

**示唆**:
- BEFOREは「上位グループ vs 下位グループ」の識別には有効
- しかし「1着 vs 2着」の微妙な差を識別できない
- PRE_SCOREに統合すると、この弱点がPRE_SCOREの1着識別能力を低下させる

#### 仮説3: 展示と本番の条件が異なる

**ユーザー指摘**:
- 「STはメンタルや運の要素もあるし、展示の情報は本番にほぼ影響しない」
- 「展示でコースを変えた選手が本番でまた違うコースを走ることもよくある」

**示唆**:
- 展示航走は「練習」であり、本番とは異なる
- 選手は本番で展示と違う戦略を取る
- 展示データは本番の状態を正確に反映していない

#### 仮説4: BEFOREデータの収集不足

**データ品質の問題**:
- exhibition_courseがほぼ全てNone
- 進入変化の検出が不可能

**示唆**:
- 現在のBEFOREデータでは、ユーザーが期待する「複雑な使い方」が実現不可能
- データ収集の改善が必要

---

## 6. 3着以内的中率が向上する理由

### 共通パターン

すべての統合方式で、**3着以内的中率は向上**している：

| 方式 | 3着以内的中率 | 向上幅 |
|------|--------------|--------|
| BEFORE無効 | 77.00% | - |
| 正規化統合 | 79.50% | +2.5% |
| 階層的予測 | 79.50% | +2.0% |
| 状態フラグ | 78.24% | +1.24% |

### 理由

1. **BEFOREは上位グループ識別に有効**
   - BEFORE 1位の3着以内率: 68.7%
   - BEFORE上位3位の多くが実際の3着以内に入る

2. **1着予測の失敗が2-3着予測の成功を補う**
   - PRE 1位 + BEFORE 2位 → 統合で順位が変動
   - 実際の1着を外すが、2-3着を的中させる

3. **相対的な順位付けには有効**
   - 「上位グループ vs 下位グループ」の識別
   - 絶対的な1着予測ではなく、相対的な順位付け

---

## 7. PRE_SCOREの現状分析

### PRE_SCORE単体の性能

**検証結果**:
- 1着的中率: **56.00%**（200レース）
- 3着以内的中率: 77.00%

**PRE_SCOREの構成**（推定）:
- 選手レーティング
- 会場適性
- モーター性能
- コース別勝率
- 気象条件
- 過去の対戦成績
- etc.

### PRE_SCOREの強み

1. **過去データの統計的パターン**
   - 膨大なレース履歴から学習
   - 選手の実力、会場の特性、コースの有利不利など

2. **安定性**
   - 展示航走のような「その日限りの変動」に影響されない
   - 長期的な傾向を反映

3. **56%の的中率は非常に高い**
   - ランダム予測（16.7%）の3倍以上
   - BEFOREなしでもすでに高精度

---

## 8. 今後の方向性

### 現状の結論

**BEFORE統合はすべて失敗**した理由：
1. PRE_SCOREの1着識別能力（56%）は既に高い
2. BEFOREは1着と2着の識別が苦手（差が小さい）
3. BEFOREを統合すると、PRE_SCOREの精度が低下する
4. 3着以内的中率は向上するが、1着的中率は必ず悪化する

### 選択肢1: BEFORE統合を諦める

**メリット**:
- PRE_SCOREの高い精度（56%）を維持
- シンプルな予測モデルを保つ

**デメリット**:
- 直前情報を活用できない
- ユーザーの期待（複雑な使い方）に応えられない

### 選択肢2: 3着以内予測に特化する

**アプローチ**:
- 1着予測: BEFORE無効（PRE_SCORE単体）
- 3着以内予測: BEFORE統合（正規化統合など）
- 用途に応じて使い分け

**メリット**:
- 1着的中率を維持（56%）
- 3着以内的中率を向上（79.5%）
- 購入戦略に応じて選択可能

**デメリット**:
- 予測モデルが2系統必要
- 実装の複雑化

### 選択肢3: データ収集の改善

**問題点**:
- exhibition_courseがほぼ全てNone
- 進入変化の検出が不可能

**改善案**:
1. スクレイピングの修正
   - 展示航走の進入コースを正しく取得
   - 他の欠損データも補完

2. データ検証
   - 収集したデータの品質チェック
   - 欠損率、異常値の確認

**メリット**:
- より精度の高い進入変化検出
- ユーザーの期待する「複雑な使い方」が可能に

**デメリット**:
- データ収集の修正に時間がかかる
- 過去データの再収集が必要

### 選択肢4: BEFOREの使い方を根本から変える

**現在の失敗パターン**:
- PRE_SCOREに統合 → 1着的中率悪化

**新しいアプローチ**:

#### 4-1. フィルタリング専用に使う

```python
# BEFOREで「購入すべきでないレース」を除外
if before_risk_flags > threshold:
    skip_race()  # 購入見送り
else:
    use_pre_score_only()  # PRE_SCOREで予測
```

**メリット**:
- PRE_SCOREの精度を維持
- リスクの高いレースを回避

**検証が必要**:
- どのフラグがリスク指標として有効か
- フィルタリングによるROI改善効果

#### 4-2. 特定の状況でのみ使う

```python
# 例: PRE_SCOREが拮抗している場合のみBEFOREを参照
if abs(PRE_SCORE[1] - PRE_SCORE[2]) < 5:
    # 1位と2位が接戦 → BEFOREで判断
    use_before_score()
else:
    # PRE_SCOREが明確 → BEFOREは無視
    use_pre_score_only()
```

**メリット**:
- PRE_SCOREの強みを活かす
- BEFOREは「判断が難しい場合」のみ

**検証が必要**:
- 拮抗レースの定義（閾値）
- 拮抗レースでのBEFORE有効性

#### 4-3. BEFOREを「追加情報」として提示

```python
# PRE_SCOREで予測は行うが、BEFOREを参考情報として表示
prediction = {
    'rank': pre_score_ranking,
    'before_info': {
        'before_rank': before_ranking,
        'flags': {
            'has_fl': True,
            'entry_risk': False,
            ...
        }
    }
}
```

**メリット**:
- ユーザーが自分で判断できる
- 予測精度は下げない

**デメリット**:
- 自動化のメリットが減る

---

## 9. 未検証の仮説

### 検証すべき仮説

#### 仮説A: PRE_SCOREとBEFORE_SCOREの相関度

**検証方法**:
1. 各レースでPRE_SCORE順位とBEFORE_SCORE順位を比較
2. 順位相関係数（Spearman）を計算
3. PRE 1位とBEFORE 1位の一致率を算出

**期待される発見**:
- 相関が高ければ、統合しても新情報が少ない
- 相関が低ければ、統合方法の問題

#### 仮説B: BEFOREの配点が不適切

**現在の配点**:
```python
exhibition_time: 25点
st_time: 25点
entry_formation: 20点
previous_race: 15点
tilt_wind: 10点
parts_weight: 5点
```

**ユーザー指摘**:
- STは25点も必要ない（メンタル・運の要素が大きい）
- F/Lだけ考慮すべき

**検証方法**:
1. ST配点を下げる（25点 → 10点）
2. F/Lフラグのみを高配点（15点）
3. 再検証

#### 仮説C: 展示タイムの予測力

**検証方法**:
1. 展示タイム順位と実際の着順の相関を調査
2. 展示タイム1位の本番1着率を計算

**期待される発見**:
- 展示タイムが本番と相関するか
- 展示タイムの配点（25点）が適切か

#### 仮説D: 進入変化の影響

**検証方法**:
1. exhibition_courseデータを収集
2. 進入一致レース vs 進入変化レースの的中率比較

**期待される発見**:
- 進入変化がどれだけ予測精度を下げるか
- 進入変化レースを除外すべきか

---

## 10. 推奨される次のステップ

### 優先度1: データ検証と収集改善

**タスク**:
1. exhibition_courseが取得できない原因を調査
2. スクレイピングの修正
3. 過去データの再収集

**理由**:
- 進入変化の検出が現状不可能
- 状態フラグ方式が正しく機能しない

### 優先度2: PRE_SCOREとBEFORE_SCOREの相関分析

**タスク**:
1. 各レースでPRE順位とBEFORE順位を比較
2. 順位相関係数を計算
3. PRE 1位 = BEFORE 1位のレース数をカウント

**理由**:
- 統合失敗の根本原因を特定
- 相関が高ければ、統合の意味がない

### 優先度3: BEFORE配点の見直し

**タスク**:
1. STの配点を下げる（25点 → 5-10点）
2. F/Lフラグを高配点（15-20点）
3. 展示タイムの有効性を検証

**理由**:
- ユーザー指摘を反映
- 現在の配点が不適切な可能性

### 優先度4: フィルタリング方式の検証

**タスク**:
1. BEFOREで「購入すべきでないレース」を定義
2. フィルタリング後の的中率・ROIを計算
3. フィルタリング基準の最適化

**理由**:
- 統合ではなく、フィルタリングの方が有効な可能性
- PRE_SCOREの精度を維持しつつ、BEFOREを活用

---

## 11. 技術的な学び

### 統合の難しさ

1. **高精度モデルへの統合は難しい**
   - PRE_SCOREは既に56%の的中率（非常に高い）
   - 新しい情報を加えると、むしろ精度が下がる

2. **正規化の罠**
   - 絶対的な自信が失われる
   - 相対的な順位しか反映されない

3. **乗算ボーナスの罠**
   - 相関が高いと、強者をさらに強くするだけ
   - 順位逆転が起きて精度低下

4. **フラグ方式の罠**
   - データ品質が悪いと誤判定が多発
   - 複合フラグで過剰調整

### 予測モデルの設計原則

1. **シンプルなモデルの方が良い**
   - PRE_SCORE単体が最も高精度
   - 複雑な統合は必ずしも改善しない

2. **新しい情報は慎重に統合**
   - 相関を確認
   - 段階的な導入

3. **データ品質が最も重要**
   - exhibition_courseが取れないと、進入変化検出不可
   - データ収集の改善が最優先

---

## 12. まとめ

### 実施した検証

1. ✅ BEFOREスコアの基礎分析（100レース）
2. ✅ 正規化統合の実装と検証（200レース）
3. ✅ 階層的予測の実装と検証（200レース）
4. ✅ 状態フラグ調整の実装と検証（200レース）

### 得られた知見

1. **BEFOREは上位グループ識別に有効**
   - 3着以内的中率は必ず向上（+1.2%〜+2.5%）

2. **BEFOREは1着予測には逆効果**
   - 1着的中率は必ず悪化（-0.5%〜-3.65%）

3. **PRE_SCOREは既に高精度**
   - 56%の的中率は非常に高い
   - BEFOREなしでも十分な性能

4. **データ品質の問題**
   - exhibition_courseがほぼ全てNone
   - 進入変化の検出が不可能

### 推奨事項

1. **短期（今すぐ）**:
   - BEFORE統合を無効化（既に実施済み）
   - PRE_SCORE単体で運用継続

2. **中期（1-2週間）**:
   - データ収集の改善（exhibition_course）
   - PRE vs BEFORE 相関分析
   - BEFORE配点の見直し

3. **長期（1ヶ月〜）**:
   - フィルタリング方式の検証
   - 3着以内予測専用モデルの検討
   - 進入変化の影響分析

---

**関連ファイル**:
- [beforeinfo_comprehensive_analysis_20251209.txt](beforeinfo_comprehensive_analysis_20251209.txt) - 基礎分析
- [normalized_integration_validation_20251208.txt](normalized_integration_validation_20251208.txt) - 正規化統合検証
- [hierarchical_prediction_validation_20251209.txt](hierarchical_prediction_validation_20251209.txt) - 階層的予測検証
- [flag_adjustment_validation_20251209.txt](flag_adjustment_validation_20251209.txt) - 状態フラグ調整検証
- [beforeinfo_essential_usage_findings_20251209.md](beforeinfo_essential_usage_findings_20251209.md) - 本質的な使い方の調査
