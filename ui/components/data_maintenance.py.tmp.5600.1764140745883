"""
ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹UI

ãƒ‡ãƒ¼ã‚¿å–å¾—ä½œæ¥­ã‚’ä¸€å…ƒåŒ–ã—ã¦åˆ†ã‹ã‚Šã‚„ã™ãã™ã‚‹
- ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡º
- éå»ãƒ‡ãƒ¼ã‚¿ã®å†å–å¾—
- ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºã®å®šæœŸåé›†
"""
import streamlit as st
import subprocess
import os
import sys
from datetime import datetime, timedelta
import sqlite3
from typing import List, Dict, Tuple

PROJECT_ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), '../..'))
sys.path.insert(0, PROJECT_ROOT)

from config.settings import DATABASE_PATH


def render_data_maintenance():
    """ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹UIã®ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°"""
    st.header("ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹")

    st.markdown("""
    ãƒ‡ãƒ¼ã‚¿å–å¾—ä½œæ¥­ã‚’ä¸€å…ƒç®¡ç†ã—ã¾ã™ã€‚ã‚¿ãƒ–ã§ä½œæ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    """)

    tab1, tab2, tab3 = st.tabs([
        "ğŸ” ä¸è¶³ãƒ‡ãƒ¼ã‚¿æ¤œå‡ºãƒ»å–å¾—",
        "ğŸ¯ ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤º",
        "ğŸ“¥ ä¸€æ‹¬å–å¾—"
    ])

    with tab1:
        _render_missing_data_detector()

    with tab2:
        _render_original_tenji()

    with tab3:
        _render_bulk_collector()


def _render_recent_data_status():
    """ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’è¡¨ç¤º"""
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    today = datetime.now().date()
    data_status = []

    for i in range(7):
        target_date = today - timedelta(days=i)
        date_str = target_date.strftime('%Y-%m-%d')

        # ãƒ¬ãƒ¼ã‚¹æ•°
        cursor.execute("SELECT COUNT(*) FROM races WHERE race_date = ?", (date_str,))
        race_count = cursor.fetchone()[0]

        # çµæœãƒ‡ãƒ¼ã‚¿æ•°
        cursor.execute("""
            SELECT COUNT(*) FROM results r
            JOIN races ra ON r.race_id = ra.id
            WHERE ra.race_date = ?
        """, (date_str,))
        result_count = cursor.fetchone()[0]

        # ãƒ¬ãƒ¼ã‚¹è©³ç´°æ•°
        cursor.execute("""
            SELECT COUNT(*) FROM race_details rd
            JOIN races ra ON rd.race_id = ra.id
            WHERE ra.race_date = ?
        """, (date_str,))
        detail_count = cursor.fetchone()[0]

        # ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºæ•°
        tenji_count = 0
        try:
            cursor.execute("""
                SELECT COUNT(*) FROM original_exhibition oe
                JOIN races ra ON oe.race_id = ra.id
                WHERE ra.race_date = ?
            """, (date_str,))
            tenji_count = cursor.fetchone()[0]
        except Exception:
            pass

        # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
        if race_count == 0:
            status = "âšª æœªå–å¾—"
        elif result_count < race_count * 5:
            status = "ğŸŸ¡ çµæœä¸è¶³"
        elif detail_count < race_count * 5:
            status = "ğŸŸ¡ è©³ç´°ä¸è¶³"
        elif tenji_count == 0:
            status = "ğŸŸ  å±•ç¤ºãªã—"
        else:
            status = "ğŸŸ¢ å®Œäº†"

        data_status.append({
            'æ—¥ä»˜': date_str,
            'æ›œæ—¥': ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'][target_date.weekday()],
            'ãƒ¬ãƒ¼ã‚¹': race_count,
            'çµæœ': result_count,
            'è©³ç´°': detail_count,
            'å±•ç¤º': tenji_count,
            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': status
        })

    conn.close()

    import pandas as pd
    df = pd.DataFrame(data_status)
    st.dataframe(df, use_container_width=True, hide_index=True)


def _render_missing_data_detector():
    """ä¸è¶³ãƒ‡ãƒ¼ã‚¿æ¤œå‡ºãƒ»å–å¾—"""
    st.subheader("ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã®æ¤œå‡ºã¨å–å¾—")

    # ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚µãƒãƒªãƒ¼
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    col1, col2, col3, col4 = st.columns(4)

    with col1:
        cursor.execute("SELECT MIN(race_date), MAX(race_date) FROM races")
        result = cursor.fetchone()
        if result[0]:
            st.metric("ãƒ‡ãƒ¼ã‚¿æœŸé–“", f"{result[0][:10]}")
            st.caption(f"ï½ {result[1][:10]}")
        else:
            st.metric("ãƒ‡ãƒ¼ã‚¿æœŸé–“", "ãªã—")

    with col2:
        cursor.execute("SELECT COUNT(*) FROM races")
        total_races = cursor.fetchone()[0]
        st.metric("ç·ãƒ¬ãƒ¼ã‚¹æ•°", f"{total_races:,}")

    with col3:
        cursor.execute("SELECT COUNT(DISTINCT race_date) FROM races")
        total_days = cursor.fetchone()[0]
        st.metric("ãƒ‡ãƒ¼ã‚¿æ—¥æ•°", f"{total_days:,}æ—¥")

    with col4:
        try:
            cursor.execute("SELECT COUNT(*) FROM original_exhibition")
            tenji_count = cursor.fetchone()[0]
        except:
            tenji_count = 0
        st.metric("ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤º", f"{tenji_count:,}")

    conn.close()

    st.markdown("---")

    # ç›´è¿‘7æ—¥é–“ã®çŠ¶æ³
    st.markdown("**ç›´è¿‘7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿çŠ¶æ³**")
    _render_recent_data_status()

    st.markdown("---")
    st.markdown("**æœŸé–“æŒ‡å®šã§ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºãƒ»å–å¾—**")

    # æœŸé–“é¸æŠ
    col1, col2 = st.columns(2)

    with col1:
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯30æ—¥å‰ã‹ã‚‰
        default_start = datetime.now().date() - timedelta(days=30)
        start_date = st.date_input(
            "é–‹å§‹æ—¥",
            value=default_start,
            key="missing_start_date"
        )

    with col2:
        end_date = st.date_input(
            "çµ‚äº†æ—¥",
            value=datetime.now().date(),
            key="missing_end_date"
        )

    # æ¤œå‡ºã‚¿ã‚¤ãƒ—
    check_types = st.multiselect(
        "æ¤œå‡ºå¯¾è±¡",
        ["ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±", "çµæœãƒ‡ãƒ¼ã‚¿", "ãƒ¬ãƒ¼ã‚¹è©³ç´°", "æ±ºã¾ã‚Šæ‰‹", "å¤©å€™", "é¢¨å‘"],
        default=["ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±", "çµæœãƒ‡ãƒ¼ã‚¿", "ãƒ¬ãƒ¼ã‚¹è©³ç´°"]
    )

    if st.button("ğŸ” ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º", type="primary"):
        with st.spinner("ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºä¸­..."):
            missing_dates = _detect_missing_data(start_date, end_date, check_types)
            st.session_state['missing_dates'] = missing_dates
            st.session_state['missing_check_types'] = check_types

    # æ¤œå‡ºçµæœã®è¡¨ç¤º
    if 'missing_dates' in st.session_state and st.session_state['missing_dates']:
        missing_dates = st.session_state['missing_dates']

        st.markdown("---")
        st.warning(f"âš ï¸ {len(missing_dates)}ä»¶ã®ä¸è¶³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ")

        # è©³ç´°è¡¨ç¤º
        with st.expander("ä¸è¶³ãƒ‡ãƒ¼ã‚¿è©³ç´°", expanded=True):
            import pandas as pd
            df = pd.DataFrame(missing_dates)
            st.dataframe(df, use_container_width=True, hide_index=True)

        # å–å¾—ãƒœã‚¿ãƒ³
        if st.button("ğŸ“¥ ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—", type="primary"):
            _fetch_missing_data(missing_dates, st.session_state.get('missing_check_types', []))

    elif 'missing_dates' in st.session_state:
        st.success("âœ… ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ï¼")


def _detect_missing_data(start_date, end_date, check_types: List[str]) -> List[Dict]:
    """ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º"""
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    missing = []
    current_date = start_date

    while current_date <= end_date:
        date_str = current_date.strftime('%Y-%m-%d')

        # æ›œæ—¥åˆ¤å®šï¼ˆãƒ¬ãƒ¼ã‚¹é–‹å‚¬æ—¥ã‹ã©ã†ã‹ï¼‰
        # ãƒœãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹ã¯ã»ã¼æ¯æ—¥é–‹å‚¬

        # ãƒ¬ãƒ¼ã‚¹æ•°ã‚’å–å¾—
        cursor.execute("""
            SELECT COUNT(*) FROM races WHERE race_date = ?
        """, (date_str,))
        race_count = cursor.fetchone()[0]

        issues = []

        if "ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±" in check_types:
            if race_count == 0:
                issues.append("ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãªã—")

        if "çµæœãƒ‡ãƒ¼ã‚¿" in check_types and race_count > 0:
            cursor.execute("""
                SELECT COUNT(*) FROM results r
                JOIN races ra ON r.race_id = ra.id
                WHERE ra.race_date = ?
            """, (date_str,))
            result_count = cursor.fetchone()[0]
            expected = race_count * 6  # 6è‰‡
            if result_count < expected * 0.8:
                issues.append(f"çµæœä¸è¶³({result_count}/{expected})")

        if "ãƒ¬ãƒ¼ã‚¹è©³ç´°" in check_types and race_count > 0:
            cursor.execute("""
                SELECT COUNT(*) FROM race_details rd
                JOIN races ra ON rd.race_id = ra.id
                WHERE ra.race_date = ?
            """, (date_str,))
            detail_count = cursor.fetchone()[0]
            expected = race_count * 6
            if detail_count < expected * 0.8:
                issues.append(f"è©³ç´°ä¸è¶³({detail_count}/{expected})")

        if "æ±ºã¾ã‚Šæ‰‹" in check_types and race_count > 0:
            cursor.execute("""
                SELECT COUNT(*) FROM results r
                JOIN races ra ON r.race_id = ra.id
                WHERE ra.race_date = ? AND r.kimarite IS NOT NULL
            """, (date_str,))
            kimarite_count = cursor.fetchone()[0]
            if kimarite_count < race_count * 0.8:
                issues.append(f"æ±ºã¾ã‚Šæ‰‹ä¸è¶³({kimarite_count}/{race_count})")

        if "å¤©å€™" in check_types and race_count > 0:
            cursor.execute("""
                SELECT COUNT(*) FROM race_conditions rc
                JOIN races ra ON rc.race_id = ra.id
                WHERE ra.race_date = ? AND rc.wind_speed IS NOT NULL
            """, (date_str,))
            weather_count = cursor.fetchone()[0]
            if weather_count < race_count * 0.5:
                issues.append(f"å¤©å€™ä¸è¶³({weather_count}/{race_count})")

        if "é¢¨å‘" in check_types and race_count > 0:
            cursor.execute("""
                SELECT COUNT(*) FROM race_conditions rc
                JOIN races ra ON rc.race_id = ra.id
                WHERE ra.race_date = ? AND rc.wind_direction IS NOT NULL
            """, (date_str,))
            wind_count = cursor.fetchone()[0]
            if wind_count < race_count * 0.5:
                issues.append(f"é¢¨å‘ä¸è¶³({wind_count}/{race_count})")

        if issues:
            missing.append({
                'æ—¥ä»˜': date_str,
                'ãƒ¬ãƒ¼ã‚¹æ•°': race_count,
                'å•é¡Œ': ', '.join(issues)
            })

        current_date += timedelta(days=1)

    conn.close()
    return missing


def _fetch_missing_data(missing_dates: List[Dict], check_types: List[str]):
    """ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
    progress_bar = st.progress(0)
    status_text = st.empty()
    log_placeholder = st.empty()
    logs = []

    def add_log(msg):
        logs.append(f"{datetime.now().strftime('%H:%M:%S')} - {msg}")
        log_placeholder.text_area("å®Ÿè¡Œãƒ­ã‚°", "\n".join(logs[-15:]), height=250)

    total = len(missing_dates)

    for idx, item in enumerate(missing_dates):
        date_str = item['æ—¥ä»˜']
        issues = item['å•é¡Œ']

        status_text.text(f"å‡¦ç†ä¸­: {date_str} ({idx+1}/{total})")
        add_log(f"--- {date_str} ã®å‡¦ç†é–‹å§‹ ---")

        try:
            # ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±å–å¾—
            if "ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãªã—" in issues or "ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±" in check_types:
                add_log("  ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ã‚’å–å¾—ä¸­...")
                from src.scraper.bulk_scraper import BulkScraper
                scraper = BulkScraper()

                venue_codes = [f"{i:02d}" for i in range(1, 25)]
                date_formatted = date_str.replace('-', '')

                result = scraper.fetch_multiple_venues(
                    venue_codes=venue_codes,
                    race_date=date_formatted,
                    race_count=12
                )

                total_races = sum(len(races) for races in result.values())
                add_log(f"  âœ… {total_races}ãƒ¬ãƒ¼ã‚¹å–å¾—")

            # è£œå®Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
            scripts_to_run = []

            if "çµæœä¸è¶³" in issues or "ãƒ¬ãƒ¼ã‚¹è©³ç´°" in check_types:
                scripts_to_run.append(("è£œå®Œ_ãƒ¬ãƒ¼ã‚¹è©³ç´°ãƒ‡ãƒ¼ã‚¿_æ”¹å–„ç‰ˆv4.py", "ãƒ¬ãƒ¼ã‚¹è©³ç´°"))

            if "æ±ºã¾ã‚Šæ‰‹ä¸è¶³" in issues or "æ±ºã¾ã‚Šæ‰‹" in check_types:
                scripts_to_run.append(("è£œå®Œ_æ±ºã¾ã‚Šæ‰‹ãƒ‡ãƒ¼ã‚¿_æ”¹å–„ç‰ˆ.py", "æ±ºã¾ã‚Šæ‰‹"))

            if "å¤©å€™ä¸è¶³" in issues or "å¤©å€™" in check_types:
                scripts_to_run.append(("è£œå®Œ_å¤©å€™ãƒ‡ãƒ¼ã‚¿_æ”¹å–„ç‰ˆ.py", "å¤©å€™"))

            if "é¢¨å‘ä¸è¶³" in issues or "é¢¨å‘" in check_types:
                scripts_to_run.append(("è£œå®Œ_é¢¨å‘ãƒ‡ãƒ¼ã‚¿_æ”¹å–„ç‰ˆ.py", "é¢¨å‘"))

            for script_name, label in scripts_to_run:
                script_path = os.path.join(PROJECT_ROOT, script_name)
                if os.path.exists(script_path):
                    add_log(f"  {label}ãƒ‡ãƒ¼ã‚¿ã‚’è£œå®Œä¸­...")
                    try:
                        result = subprocess.run(
                            [sys.executable, script_path],
                            capture_output=True,
                            text=True,
                            cwd=PROJECT_ROOT,
                            timeout=300,
                            encoding='utf-8'
                        )
                        if result.returncode == 0:
                            add_log(f"  âœ… {label}å®Œäº†")
                        else:
                            add_log(f"  âš ï¸ {label}è­¦å‘Šã‚ã‚Š")
                    except subprocess.TimeoutExpired:
                        add_log(f"  â±ï¸ {label}ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ")
                    except Exception as e:
                        add_log(f"  âŒ {label}ã‚¨ãƒ©ãƒ¼: {str(e)[:50]}")

        except Exception as e:
            add_log(f"  âŒ ã‚¨ãƒ©ãƒ¼: {str(e)[:80]}")

        progress_bar.progress((idx + 1) / total)

    status_text.text("âœ… å‡¦ç†å®Œäº†ï¼")
    add_log("="*40)
    add_log("å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ")

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
    if 'missing_dates' in st.session_state:
        del st.session_state['missing_dates']

    st.success("âœ… ä¸è¶³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    st.button("ğŸ”„ ãƒ‡ãƒ¼ã‚¿çŠ¶æ³ã‚’æ›´æ–°", on_click=st.rerun)


def _render_original_tenji():
    """ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿åé›†"""
    st.subheader("ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿åé›†")

    st.markdown("""
    **æ¯æ—¥å®Ÿè¡ŒãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿:**
    - ç›´ç·šã‚¿ã‚¤ãƒ ï¼ˆchikusen_timeï¼‰
    - 1å‘¨ã‚¿ã‚¤ãƒ ï¼ˆisshu_timeï¼‰
    - å›ã‚Šè¶³ã‚¿ã‚¤ãƒ ï¼ˆmawariashi_timeï¼‰

    âš ï¸ **æ³¨æ„**: ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿ã¯é™ã‚‰ã‚ŒãŸæœŸé–“ã®ã¿å…¬é–‹ã•ã‚Œã¾ã™ã€‚éå»ãƒ‡ãƒ¼ã‚¿ã¯å–å¾—ã§ãã¾ã›ã‚“ã€‚
    """)

    # ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³
    st.markdown("---")
    col1, col2 = st.columns(2)

    with col1:
        if st.button("ğŸ“… ä»Šæ—¥", key="tenji_today", type="primary", use_container_width=True):
            _run_tenji_collection(0)

    with col2:
        if st.button("ğŸ“… æ˜¨æ—¥", key="tenji_yesterday", use_container_width=True):
            _run_tenji_collection(-1)

    st.caption("â€» ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿ã¯ä»Šæ—¥ã¨æ˜¨æ—¥ã®ã¿å–å¾—å¯èƒ½ã§ã™")

    # åé›†çŠ¶æ³
    st.markdown("---")
    st.subheader("åé›†çŠ¶æ³")

    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    # ç›´è¿‘7æ—¥é–“ã®å±•ç¤ºãƒ‡ãƒ¼ã‚¿æ•°
    today = datetime.now().date()
    tenji_status = []

    for i in range(7):
        target_date = today - timedelta(days=i)
        date_str = target_date.strftime('%Y-%m-%d')

        count = 0
        try:
            cursor.execute("""
                SELECT COUNT(*) FROM original_exhibition oe
                JOIN races ra ON oe.race_id = ra.id
                WHERE ra.race_date = ?
            """, (date_str,))
            count = cursor.fetchone()[0]
        except Exception:
            pass

        status = "ğŸŸ¢ åé›†æ¸ˆ" if count > 0 else "ğŸ”´ æœªåé›†"
        tenji_status.append({
            'æ—¥ä»˜': date_str,
            'æ›œæ—¥': ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'][target_date.weekday()],
            'ä»¶æ•°': count,
            'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': status
        })

    conn.close()

    import pandas as pd
    df = pd.DataFrame(tenji_status)
    st.dataframe(df, use_container_width=True, hide_index=True)


def _run_tenji_collection(days_offset: int):
    """ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºåé›†ã‚’å®Ÿè¡Œ"""
    target_date = datetime.now().date() + timedelta(days=days_offset)

    with st.spinner(f"ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­... ({target_date})"):
        try:
            script_path = os.path.join(PROJECT_ROOT, 'åé›†_ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤º_æ‰‹å‹•å®Ÿè¡Œ.py')

            if not os.path.exists(script_path):
                st.error(f"ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {script_path}")
                return

            result = subprocess.run(
                [sys.executable, script_path, str(days_offset)],
                capture_output=True,
                text=True,
                timeout=600,
                cwd=PROJECT_ROOT,
                encoding='utf-8'
            )

            if result.returncode == 0:
                st.success(f"âœ… {target_date} ã®ã‚ªãƒªã‚¸ãƒŠãƒ«å±•ç¤ºãƒ‡ãƒ¼ã‚¿åé›†å®Œäº†ï¼")
                with st.expander("è©³ç´°ãƒ­ã‚°"):
                    st.code(result.stdout)
            else:
                st.error("âŒ åé›†ã«å¤±æ•—ã—ã¾ã—ãŸ")
                st.code(result.stderr)

        except subprocess.TimeoutExpired:
            st.error("âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10åˆ†çµŒéï¼‰")
        except Exception as e:
            st.error(f"âŒ ã‚¨ãƒ©ãƒ¼: {e}")


def _render_bulk_collector():
    """ä¸€æ‹¬å–å¾—ï¼ˆå¾“æ¥æ©Ÿèƒ½ï¼‰"""
    st.subheader("éå»ãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬å–å¾—")

    st.markdown("""
    æœ€çµ‚ä¿å­˜æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®å…¨ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ã—ã¾ã™ã€‚

    **å–å¾—ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿:**
    - ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ãƒ»çµæœ
    - æ±ºã¾ã‚Šæ‰‹ãƒ‡ãƒ¼ã‚¿
    - ãƒ¬ãƒ¼ã‚¹è©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼ˆå±•ç¤ºã‚¿ã‚¤ãƒ ã€ãƒ¢ãƒ¼ã‚¿ãƒ¼ãƒ»ãƒœãƒ¼ãƒˆï¼‰
    - å¤©å€™ãƒ‡ãƒ¼ã‚¿
    - é¢¨å‘ãƒ‡ãƒ¼ã‚¿
    """)

    # æœ€çµ‚ä¿å­˜æ—¥ã‚’å–å¾—
    conn = sqlite3.connect(DATABASE_PATH)
    cursor = conn.cursor()

    cursor.execute("SELECT MAX(race_date) FROM races")
    result = cursor.fetchone()

    if result and result[0]:
        last_saved_date = datetime.strptime(result[0], '%Y-%m-%d')
        start_date = last_saved_date + timedelta(days=1)
    else:
        start_date = datetime(2024, 1, 1)
        last_saved_date = None

    end_date = datetime.now()
    conn.close()

    # å¯¾è±¡æœŸé–“è¡¨ç¤º
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("æœ€çµ‚ä¿å­˜æ—¥", last_saved_date.strftime('%Y-%m-%d') if last_saved_date else "ãªã—")
    with col2:
        st.metric("å–å¾—é–‹å§‹æ—¥", start_date.strftime('%Y-%m-%d'))
    with col3:
        target_days = (end_date - start_date).days + 1
        st.metric("å¯¾è±¡æ—¥æ•°", f"{target_days}æ—¥" if target_days > 0 else "0æ—¥")

    if target_days <= 0:
        st.success("âœ… ãƒ‡ãƒ¼ã‚¿ã¯æœ€æ–°ã§ã™ï¼")
        return

    st.warning(f"ğŸ“Š {target_days}æ—¥åˆ† Ã— å…¨24ä¼šå ´ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™")

    # å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    st.markdown("---")

    tasks = {
        "ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ±ãƒ»çµæœ": True,
        "æ±ºã¾ã‚Šæ‰‹ãƒ‡ãƒ¼ã‚¿": True,
        "ãƒ¬ãƒ¼ã‚¹è©³ç´°ãƒ‡ãƒ¼ã‚¿": True,
        "å¤©å€™ãƒ‡ãƒ¼ã‚¿": True,
        "é¢¨å‘ãƒ‡ãƒ¼ã‚¿": True,
    }

    selected_tasks = []
    for task_name, default in tasks.items():
        if st.checkbox(task_name, value=default, key=f"bulk_{task_name}"):
            selected_tasks.append(task_name)

    if st.button("ğŸš€ ä¸€æ‹¬å–å¾—é–‹å§‹", type="primary", use_container_width=True):
        if not selected_tasks:
            st.error("å–å¾—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„")
            return

        # å¾“æ¥ã®bulk_data_collectorã®å‡¦ç†ã‚’å‘¼ã³å‡ºã—
        from ui.components.bulk_data_collector import render_bulk_data_collector
        render_bulk_data_collector(None, None)
