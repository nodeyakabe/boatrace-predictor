# UI起動ガイド

## 概要

競艇予想システムのStreamlit UIです。予測精度改善機能が統合されています。

**メインファイル**: [ui/app.py](ui/app.py)

**注意**: 旧バージョン（app_v2.py など）は [ui/_archive/](ui/_archive/) に移動されました。

---

## 起動方法

### 方法1: バッチファイルで起動（推奨）

```cmd
start_ui.bat
```

ダブルクリックで実行可能です。

### 方法2: コマンドラインから起動

```cmd
python -m streamlit run ui/app.py
```

**注意**: `streamlit`コマンドが認識されない場合は、上記のように`python -m streamlit`を使用してください。

---

## アクセス方法

UIが起動したら、以下のURLにブラウザでアクセスしてください：

- **ローカル**: http://localhost:8501
- **ネットワーク**: http://192.168.0.14:8501

---

## 改善機能の確認方法

### 1. レース詳細画面で確認

```
[レース予想] タブ
  ↓
[レース一覧・推奨] を選択
  ↓
レースを選択
  ↓
[🎯 AI予測] タブ
  ↓
下にスクロール
  ↓
「⚙️ 適用された改善機能」セクション
```

ここで以下を確認できます：
- 🔧 Laplace平滑化の効果（展開式）
- 🔒 1着固定ルールの判定（展開式）

### 2. 設定・管理画面で確認

```
[設定・管理] タブ
  ↓
[予測精度改善] を選択
  ↓
全改善機能の状態を確認
```

ここで以下を確認できます：
- 10項目の改善機能の詳細説明
- 各機能の有効/無効状態
- パラメータ設定値（alpha値、閾値など）
- 効果の説明

---

## タブ構成

### 📊 データ参照
- レース結果
- 会場分析
- 選手分析
- 統計情報

### 🔮 レース予想
- レース一覧・推奨
- レース詳細分析（**改善機能表示あり**）
- 購入履歴
- バックテスト

### 🔧 データ準備
- ワークフロー自動化
- オッズ自動取得
- 高度なモデル学習
- モデルベンチマーク
- 自動データ収集
- 手動データ収集
- モデル学習
- データ品質

### ⚙️ 設定・管理
- **予測精度改善**（NEW！）
- システム設定
- データ管理
- 法則管理
- システム監視

---

## 改善機能の詳細

### 即効性の高い改善（1-4）

1. **Laplace平滑化（alpha=2.0）**
   - 外枠（4-6号艇）のゼロ化問題を解決
   - 状態: ✅ 有効

2. **1着固定ルール（閾値0.55）**
   - 高勝率1号艇を1着確定とマーク
   - 状態: ✅ 有効

3. **信頼度Eフィルタ**
   - 低信頼度予測を除外
   - 状態: ✅ 有効

4. **評価指標の追加**
   - Brier Score、Log Loss、ECE、信頼度別的中率
   - 状態: ✅ 実装済み

### 中長期的な改善（5-10）

5. **進入予想（前付け傾向）**
   - 選手の進入変化傾向を分析
   - 状態: ✅ 実装済み

6. **潮位補正ロジック**
   - 8会場の潮位影響を補正
   - 状態: ✅ 有効

7. **DBインデックス最適化**
   - クエリパフォーマンス向上
   - 状態: ✅ 完了（12個のインデックス追加）

8. **モーター指数加重移動平均（EWMA）**
   - 直近のレース結果に重みを付けて評価
   - 状態: ❌ 無効（デフォルト）

9. **展示データ自動取得**
   - スクレイピングテンプレート
   - 状態: 🔧 骨格実装済み（実装要）

10. **確率較正（Calibration）**
    - 予測確率を実際の頻度に合わせて調整
    - 状態: ❌ 無効（デフォルト）

---

## 設定の変更方法

改善機能の設定を変更する場合は、以下のファイルを編集してください：

```
config/prediction_improvements.json
```

### 例: Laplace平滑化のalpha値を変更

```json
{
  "laplace_smoothing": {
    "enabled": true,
    "alpha": 3.0  // 2.0 → 3.0 に変更
  }
}
```

### 例: モーターEWMAを有効化

```json
{
  "motor_ewma": {
    "enabled": true,  // false → true に変更
    "alpha": 0.3
  }
}
```

設定変更後は、新しい予測を生成してください：
```cmd
python generate_one_date.py 2025-11-XX
```

---

## トラブルシューティング

### UIが起動しない

1. Streamlitがインストールされているか確認
   ```cmd
   pip list | findstr streamlit
   ```

2. インストールされていない場合はインストール
   ```cmd
   pip install streamlit
   ```

### 改善機能が表示されない

1. 最新の予測を生成
   ```cmd
   python generate_one_date.py 2025-11-19
   ```

2. 設定ファイルが存在するか確認
   ```cmd
   type config\prediction_improvements.json
   ```

### ポートが使用中のエラー

別のポートで起動してください：
```cmd
streamlit run ui/app.py --server.port 8502
```

---

## 関連ドキュメント

- [improvements_summary.md](docs/improvements_summary.md) - 改善機能の詳細
- [ui_improvements_guide.md](docs/ui_improvements_guide.md) - UI改善機能ガイド
- [改善点_1125.txt](改善点_1125.txt) - 元の改善提案

---

## サポート

問題が発生した場合は、以下をご確認ください：
1. プロジェクトルートにいるか確認
2. 必要なパッケージがインストールされているか確認
3. データベースが存在するか確認（`data/boatrace.db`）

それでも解決しない場合は、エラーメッセージを確認してください。
