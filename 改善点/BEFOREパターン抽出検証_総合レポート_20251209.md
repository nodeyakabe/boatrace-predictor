# BEFOREパターン抽出・検証 総合レポート

**作成日：2025年12月9日**

---

## 実施した作業の全体像

### アプローチの転換

**従来の失敗アプローチ（4手法すべて失敗）**:
- BEFORE情報をPRE予測に統合する試み
- 結果: 1着的中率の悪化または効果なし（55.5% → 51.85% ~ 55.50%）

**新しい成功アプローチ（パターン/プリセット方式）**:
- BEFORE情報を条件付きボーナスとして活用
- PRE予測を汚染せず、特定条件下でのみスコアを乗算調整
- コースプリセット方式と同様の実装

---

## フェーズ1: 法則性の抽出（完了）

### スクリプト
[scripts/extract_before_patterns.py](../scripts/extract_before_patterns.py)

### 分析対象
- 2025年データ200レース（直前情報あり）
- 展示タイム、ST、PRE順位の組み合わせ

### 抽出された主要パターン（18パターン）

| パターン | 該当数 | 1着数 | 1着率 | 効果 | 推奨ボーナス |
|---------|--------|-------|-------|------|--------------|
| PRE1位 & 展示1位 & ST1位 | 14 | 12 | 85.71% | +69.05% | x1.414 |
| PRE1位 & ST1位 | 47 | 40 | 85.11% | +68.44% | x1.411 |
| PRE1位 & 展示1-3位 & ST1-3位 | 87 | 62 | 71.26% | +54.60% | x1.328 |
| PRE1位 & ST1-3位 | 123 | 84 | 68.29% | +51.63% | x1.310 |
| PRE1位 & 展示1位 | 56 | 36 | 64.29% | +47.62% | x1.286 |
| PRE1位 & 展示1-3位 | 132 | 81 | 61.36% | +44.70% | x1.268 |
| 展示1位 & ST1位 | 33 | 17 | 51.52% | +34.85% | x1.209 |

**選定基準**: 1着率20%以上、または効果+5%以上

**出力ファイル**: [results/before_patterns_extraction_20251209.txt](../results/before_patterns_extraction_20251209.txt)

---

## フェーズ2: バックテスト検証（完了）

### スクリプト
[scripts/validate_before_patterns.py](../scripts/validate_before_patterns.py)

### 検証手法
1. 200レースで各パターンを個別にバックテスト
2. PRE単独（ベースライン55.5%）との比較
3. パターン適用時と非適用時の的中率を測定

### 検証結果

**ベースライン（PRE単独）**: **55.50%** (111/200)

#### 採用推奨パターン（4パターン）

| # | パターン | 全体的中率 | 改善度 | 該当レース数 | 該当時的中率 | 判定 |
|---|----------|------------|--------|--------------|--------------|------|
| 1 | **PRE1位 & ST1位** | **55.50%** | ±0.00% | 49 | **81.63%** | ✅ 採用推奨 |
| 2 | **PRE1位 & 展示1位** | **55.50%** | ±0.00% | 58 | **62.07%** | ✅ 採用推奨 |
| 3 | **PRE1位 & 展示1-3位 & ST1-3位** | **55.50%** | ±0.00% | 88 | **70.45%** | ✅ 採用推奨 |
| 4 | **PRE1位 & ST1-3位** | **55.50%** | ±0.00% | 124 | **67.74%** | ✅ 採用推奨 |

#### 不採用パターン（1パターン）

| # | パターン | 全体的中率 | 改善度 | 該当レース数 | 該当時的中率 | 判定 |
|---|----------|------------|--------|--------------|--------------|------|
| 5 | 展示1位のみ | 53.50% | **-2.00%** | 197 | 53.30% | ❌ 不採用 |

### 重要な発見

1. **ベースライン維持**: 4つのパターンすべてが55.5%を維持
2. **該当時の高的中率**: パターン条件を満たすレースで大幅向上
   - 最高: PRE1位 & ST1位で**81.63%**
   - 全て60%以上の高精度
3. **適用範囲**: 全体の24.5% ~ 62.0%のレースで適用可能

**出力ファイル**: [results/before_patterns_validation_20251209.txt](../results/before_patterns_validation_20251209.txt)

---

## フェーズ3: 実装（次ステップ）

### 推奨実装パターン

以下の4パターンを [src/analysis/race_predictor.py](../src/analysis/race_predictor.py) に実装することを推奨します。

```python
# パターン定義
BEFORE_PATTERNS = [
    {
        'name': 'pre1_st1',
        'description': 'PRE1位 & ST1位',
        'multiplier': 1.411,
        'condition': lambda pre_rank, ex_rank, st_rank: pre_rank == 1 and st_rank == 1,
    },
    {
        'name': 'pre1_ex1',
        'description': 'PRE1位 & 展示1位',
        'multiplier': 1.286,
        'condition': lambda pre_rank, ex_rank, st_rank: pre_rank == 1 and ex_rank == 1,
    },
    {
        'name': 'pre1_ex1_3_st1_3',
        'description': 'PRE1位 & 展示1-3位 & ST1-3位',
        'multiplier': 1.328,
        'condition': lambda pre_rank, ex_rank, st_rank: pre_rank == 1 and ex_rank <= 3 and st_rank <= 3,
    },
    {
        'name': 'pre1_st1_3',
        'description': 'PRE1位 & ST1-3位',
        'multiplier': 1.310,
        'condition': lambda pre_rank, ex_rank, st_rank: pre_rank == 1 and st_rank <= 3,
    },
]
```

### 実装手順

1. `RacePredictor.predict_race()` メソッド内でBEFORE情報を取得
2. 展示タイム・ST順位を計算
3. 各艇にパターン条件をチェック
4. 該当する場合、`total_score` に乗算
5. 再ソートして最終予測を返す

### 期待効果

- **1着的中率**: 55.5% 維持
- **条件該当時的中率**: 60% ~ 82%
- **購入戦略への活用**: 条件該当レースで購入額を増やすなどの戦略が可能

---

## 追加作業: 拡張プリセットの抽出（実行中）

ユーザーリクエストに基づき、1着以外のパターンも追加抽出中。

### A. 2着・3着予測プリセット（実行中）

**スクリプト**: [scripts/extract_2nd_3rd_presets.py](../scripts/extract_2nd_3rd_presets.py)

**目的**:
- 2着率が高いパターンの抽出
- 3着率が高いパターンの抽出
- 3着以内率が高いパターンの抽出
- 三連単・三連複の購入戦略に活用

**検証パターン例**:
- 【2着】: PRE2位 & 展示1-3位、PRE2-3位 & ST1-2位
- 【3着】: PRE3-4位 & 展示1-3位、アウトコース(4-6枠) & 展示1-2位
- 【3着以内】: PRE1-3位 & 展示1-3位、展示1-3位 & ST1-3位

**出力ファイル（予定）**: [results/2nd_3rd_presets_extraction_20251209.txt](../results/2nd_3rd_presets_extraction_20251209.txt)

---

### B. 環境要因プリセット（実行中）

**スクリプト**: [scripts/extract_environmental_presets.py](../scripts/extract_environmental_presets.py)

**目的**:
- 風向×展示タイムの組み合わせパターン
- 波高×STの組み合わせパターン
- 潮位×会場（今後データ収集が必要）

**検証パターン例**:
- 【風向】: 追い風 & 展示1位、向かい風 & ST1位、横風 & コース2-3
- 【波高】: 荒れた水面(≥2m) & 展示1位、穏やかな水面(≤0.5m) & ST1位

**出力ファイル（予定）**: [results/environmental_presets_extraction_20251209.txt](../results/environmental_presets_extraction_20251209.txt)

---

## 残りの作業項目

### 短期（今週中）

1. **拡張プリセット抽出の完了確認**
   - 2着・3着予測プリセットの結果確認
   - 環境要因プリセットの結果確認

2. **推奨パターンの選定**
   - 2着・3着で20%以上または効果+5%以上のパターン
   - 環境要因で20%以上または効果+5%以上のパターン

3. **バックテスト検証（必要に応じて）**
   - 効果が高いパターンのみ個別検証
   - 55.5%ベースライン維持を確認

### 中期（来週以降）

4. **フェーズ3実装**
   - `race_predictor.py` へのパターン実装
   - 機能フラグの追加（`config/feature_flags.py`）
   - 統合バックテストの実施

5. **複合条件の深掘り**
   - ユーザーリクエスト: 「展示×ST」の複合条件をさらに探索
   - 会場特性との組み合わせ
   - モーター性能との組み合わせ

6. **購入戦略への統合**
   - 条件該当時の購入額調整ロジック
   - ROI最適化
   - リスク管理

---

## 技術的な学び

### 成功要因

1. **PRE予測の保護**
   - 強力なシグナル（55.5%）を汚染しない
   - 乗算による微調整のみ

2. **ドメイン知識の活用**
   - ST順位の疑似相関を理解
   - 展示走行の目的を考慮
   - PRE順位との組み合わせを重視

3. **段階的検証**
   - フェーズ1: 法則性抽出（18パターン）
   - フェーズ2: 個別バックテスト（5パターン → 4採用）
   - フェーズ3: 実装（次ステップ）

### 課題と今後の改善

1. **データ品質**
   - 展示タイム・STは本番と異なる目的
   - より本番に近い指標の探索が必要

2. **サンプルサイズ**
   - 200レースで検証（少ない）
   - 1000レース以上での再検証を推奨

3. **過学習リスク**
   - パターン条件の調整に注意
   - クロスバリデーション実施を検討

---

## まとめ

### 達成したこと

- ✅ 直前情報から18パターンを抽出
- ✅ バックテストで4パターンを採用推奨（55.5%維持）
- ✅ 該当時的中率60% ~ 82%の高精度パターンを発見
- ✅ 拡張プリセット（2着・3着、環境要因）の抽出を開始

### 次のアクション

1. 拡張プリセット抽出の完了待ち
2. 推奨パターンの最終選定
3. `race_predictor.py` への実装
4. 統合バックテストで効果を確認

### 期待される成果

- **1着的中率**: 55.5%維持
- **該当時的中率**: 最大81.63%
- **購入戦略**: 条件該当レースでの投資判断向上
- **三連単・三連複**: 2着・3着予測の精度向上による払戻金増加

---

**作成者**: Claude (Sonnet 4.5)
**プロジェクト**: BoatRace予測システム
**ベースライン**: PRE単独55.5%（1着的中率）
