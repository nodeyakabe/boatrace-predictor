# 直前情報（BEFORE）の活用方法 - 再整理

**作成日：2025年12月9日**

---

## 前提：判明した事実

### BEFORE情報の特性

1. **1着予測には不向き**
   - 1着的中率: 34.6%（PRE 55.5%に対して大幅に劣る）
   - PRE 1位とBEFORE 1位の一致率: わずか37.0%

2. **上位グループ識別には一定の力がある**
   - 3着以内的中率: 68.7%（悪くはない）
   - ゲーティング方式で3着以内的中率が79.5% → 81.0%に+1.5%改善

3. **データの本質的限界**
   - 展示走行は「タイミング合わせ」「モーター確認」が目的
   - ST順位の高相関(0.322)は疑似相関（強い選手→良いST、であってST→勝利ではない）
   - 本番とは異なる目的・走り方なので、数値を直接予測に使うのは困難

---

## 活用方針の転換

### ❌ これまでの失敗アプローチ

**「BEFORE情報でPRE予測を改善する」**
- 4つの統合手法が全て失敗
- 弱いシグナル(34.6%)を強いシグナル(55.5%)に混ぜると必ず悪化

### ✅ 新しい活用の方向性

**「BEFORE情報を独立した判断材料として使う」**
- PRE予測を汚染せず、別の目的で活用
- BEFORE固有の価値を引き出す

---

## 具体的な活用方法（優先順位順）

### 【優先度A】即座に実装可能で効果が期待できる施策

#### 1. ネガティブスクリーニング（除外フィルタ）

**コンセプト**:
- BEFORE情報で「明らかに勝てない艇」を購入候補から除外
- PRE上位でも、BEFORE最下位なら購入しない

**実装方法**:
```python
# PRE 1位を購入するかどうかの判定
pre_1st = predictions[0]
before_rank = pre_1st['before_rank']

# BEFORE 5位・6位なら購入見送り
if before_rank >= 5:
    skip_purchase = True
```

**期待効果**:
- 「PRE高評価だが実は不調」の艇を回避
- 的中率は変わらないが、不的中時の損失を減らせる

**検証方法**:
- 2025年データでBEFORE 5-6位のPRE 1位艇の勝率を測定
- 勝率が40%未満なら効果あり

---

#### 2. 3着以内予測への特化

**コンセプト**:
- 1着予測はPRE単独
- 3着以内予測にBEFOREを活用
- 三連単・三連複の購入戦略に利用

**実装方法**:
```python
# PRE 1位: 1着候補（BEFORE不使用）
pre_1st = predictions[0]['pit_number']

# BEFORE上位3艇: 2-3着候補
before_top3 = sorted(before_scores.items(), key=lambda x: x[1], reverse=True)[:3]
candidate_pits = [pit for pit, score in before_top3]

# 三連単購入目
# 1着: pre_1st
# 2-3着: candidate_pits から選ぶ
```

**期待効果**:
- 3着以内的中率を79.5% → 81.0%以上に改善（ゲーティング方式で確認済み）
- 三連単・三連複の的中率向上

**検証方法**:
- PRE 1位 + BEFORE上位2艇の三連単的中率を測定
- 他の組み合わせと比較

---

#### 3. 信頼度スコアとしての活用

**コンセプト**:
- PRE予測とBEFORE予測の一致度を「信頼度」として使用
- 一致度が高いレースのみ購入

**実装方法**:
```python
# PRE上位3艇
pre_top3 = set([pred['pit_number'] for pred in predictions[:3]])

# BEFORE上位3艇
before_ranking = sorted(before_scores.items(), key=lambda x: x[1], reverse=True)
before_top3 = set([pit for pit, score in before_ranking[:3]])

# 重複数でスコア化
overlap = len(pre_top3 & before_top3)
confidence = overlap / 3.0  # 0.0 ~ 1.0

# 信頼度が高い（overlap >= 2）レースのみ購入
if confidence >= 0.67:
    purchase = True
```

**期待効果**:
- 低信頼度レースを回避することで的中率向上
- 購入レース数は減るが、ROI改善の可能性

**検証方法**:
- overlap別（0, 1, 2, 3）の1着的中率を測定
- overlap >= 2のグループが55.5%以上なら効果あり

---

### 【優先度B】効果は未知だが試す価値がある施策

#### 4. オッズ歪み検出への活用

**コンセプト**:
- BEFORE情報は一般投票者も見ている
- BEFORE 1位のオッズが過剰に低い場合、避ける
- BEFORE下位だがオッズが低い艇は「隠れ本命」の可能性

**実装方法**:
```python
# BEFORE 1位の艇
before_1st_pit = before_ranking[0][0]
before_1st_odds = get_odds(race_id, before_1st_pit)

# オッズが2.0倍未満なら過剰人気と判断
if before_1st_odds < 2.0:
    # PRE 1位と異なる場合は、BEFORE 1位を避ける
    if before_1st_pit != pre_1st_pit:
        avoid_before_1st = True
```

**期待効果**:
- 「展示だけ良い艇」を回避
- オッズと実力のギャップを突く

**検証方法**:
- BEFORE 1位でオッズ2.0倍未満の艇の勝率
- 3.0倍以上の艇との比較

---

#### 5. モーター性能の補正

**コンセプト**:
- 展示タイムは「モーター確認」が目的
- 展示タイムが異常に悪い → モーター不調の可能性
- PRE高評価でも、モーター不調なら減点

**実装方法**:
```python
# 展示タイムがレース内最下位（6位）
if exhibition_time_rank == 6:
    # PRE_SCOREから10点減点
    adjusted_score = pre_score - 10
```

**期待効果**:
- モーター不調の検出
- PRE_SCOREの機械的評価を補正

**検証方法**:
- 展示タイム6位の艇の勝率測定
- 他の順位と比較して有意差があるか

---

### 【優先度C】長期的な改善策

#### 6. BEFORE情報の収集・計算方法の見直し

**現状の問題**:
- 展示タイムやSTを「絶対値」として扱っている
- 「本気で走っているか」の判定がない

**改善案**:
- **前日展示 vs 直前展示の比較**
  - 前日より直前の方がタイムが良い → 調子上向き
  - 前日より直前の方がタイムが悪い → 不調

- **期待値からの乖離**
  - 選手の過去平均展示タイムと比較
  - 異常に遅い → わざと遅く走っている可能性

- **ST意図の推定**
  - わざとフライング気味に → 本番で攻める意図
  - 大幅出遅れ → 様子見、流している

**実装難易度**: 高（データ収集・前処理が必要）

---

#### 7. 部品交換情報の精緻化

**現状の問題**:
- 部品交換フラグが0/1の単純なフラグ
- どの部品を交換したか、交換後の性能がどう変わったかが不明

**改善案**:
- **交換部品の種別を記録**
  - プロペラ交換 → 大きな影響
  - ギア交換 → 中程度の影響
  - その他部品 → 小さな影響

- **交換後のテスト走行結果を収集**
  - 交換後の展示タイムが改善 → 良い交換
  - 交換後も変わらず → 効果なし

**実装難易度**: 高（データソース拡充が必要）

---

#### 8. 前走結果との統合

**現状の問題**:
- BEFORE情報が「その日のレース」のみの情報
- 前日・前走のパフォーマンスとの比較がない

**改善案**:
- **展示タイムのトレンド分析**
  - 直近5レースの展示タイム推移
  - 右肩上がり → 調子良い
  - 右肩下がり → 不調

- **ST安定性の評価**
  - 直近5レースのST標準偏差
  - 安定している選手 → 信頼できる
  - バラつきが大きい → リスク高い

**実装難易度**: 中（データは既にある、集計ロジックが必要）

---

## 優先的に実装すべき施策の選定

### 即座に着手（今週中）

1. **ネガティブスクリーニング（BEFORE 5-6位除外）**
   - 実装: 1-2時間
   - 検証: 30分
   - 効果: 中（損失削減）

2. **3着以内予測への特化**
   - 実装: 2-3時間
   - 検証: 1時間
   - 効果: 中（+1.5%は確認済み）

3. **信頼度スコアの導入**
   - 実装: 1-2時間
   - 検証: 30分
   - 効果: 不明（要検証）

### 来週以降に検討

4. **オッズ歪み検出**
   - 要検証（オッズデータの取得状況次第）

5. **モーター性能補正**
   - 要検証（効果が不明）

### 中長期的な課題

6. **BEFORE情報の収集・計算方法見直し**
7. **部品交換情報の精緻化**
8. **前走結果との統合**

---

## 検証方法の標準化

全ての新施策は以下の手順で検証：

1. **仮説の明確化**
   - 何を改善したいか（的中率 or ROI or 損失削減）
   - なぜ効果があると考えるか

2. **バックテスト**
   - 2025年データ200レース以上
   - ベースライン（PRE単独）との比較

3. **評価指標**
   - 1着的中率
   - 3着以内的中率
   - 期待値・ROI（オッズ考慮）
   - 最大ドローダウン

4. **統計的有意性**
   - p値 < 0.05
   - 95%信頼区間

5. **実装判定**
   - 1着的中率が55.5%以上、または
   - ROIが1.0以上（収支プラス）

---

## まとめ

### 基本方針

**「BEFORE情報は1着予測の主役ではなく、脇役として活用」**

- PRE予測を汚染しない
- BEFORE固有の価値（上位グループ識別、ネガティブ判定）を引き出す
- オッズ・購入戦略との組み合わせで真価を発揮

### 次のアクション

1. **ネガティブスクリーニング**の実装と検証（最優先）
2. **3着以内予測への特化**の実装と検証
3. **信頼度スコア**の実装と検証
4. 結果を見て、PRE単独 vs BEFORE活用の総合比較

### 期待される成果

- **1着的中率**: 55.5%を維持または微増
- **3着以内的中率**: 81%以上
- **ROI**: 購入レース選別により改善（目標: 1.05以上）
- **最大ドローダウン**: ネガティブスクリーニングで削減

---

**次回検討事項**:
- ネガティブスクリーニングの閾値（5位 or 6位のみ？4位も？）
- 3着以内予測の購入目組み合わせ（三連単 vs 三連複）
- 信頼度スコアの閾値（overlap 2以上？1以上？）

**作成者**: Claude (Sonnet 4.5)
