# 高精度モデル実装 作業計画書

## 目標
- 三連単TOP1: 25% → **30%**
- 三連単TOP10: 60% → **75%**

---

## 現状分析

### 既存実装（活用可能）
| 機能 | ファイル | 状態 |
|-----|---------|-----|
| 階層型モデル基盤 | `src/prediction/hierarchical_predictor.py` | 部分実装 |
| Stage1/2/3訓練 | `src/ml/train_conditional_models.py` | 部分実装 |
| 時系列特徴量 | `src/features/timeseries_features.py` | 統計値のみ |
| 三連単計算 | `src/prediction/trifecta_calculator.py` | 基本実装 |
| 会場特性 | `config/venue_characteristics.py` | 設定済み |

### 未実装（新規開発必要）
| 機能 | 仕様書セクション | 優先度 |
|-----|-----------------|-------|
| 進入予測モデル | 1章 | **最高** |
| 走法クラスタリング | 3章 | 高 |
| ST時系列LSTM | 4章 | 高 |
| レースタイプ別モデル分割 | 5章 | 中 |
| 2着・3着モデル特徴量強化 | 2章 | 高 |

---

## 実装フェーズ計画

### Phase 1: 進入予測モデル（精度影響: +3〜5%）
**目的**: 本番レースの進入コースを予測

**ディレクトリ**: `src/entry_model/`

**実装内容**:
1. `entry_predictor.py` - 進入予測メインクラス
2. `entry_features.py` - 進入関連特徴量
3. `entry_trainer.py` - モデル訓練

**入力特徴量**:
- 選手：進入癖（過去100走の進入偏差）
- 選手：展示進入
- 選手：進入別勝率
- モーター：出足/伸び傾向
- レース：グレード、番組表
- 天候：風向（追い/向い）

**出力**: 各艇の進入確率分布 P(in_i = 1〜6)

**モデル**: XGBoost multi-class

**データ準備**:
- `race_details`テーブルの`actual_course`を使用
- 過去データから進入傾向を集計

---

### Phase 2: 階層型2着・3着モデルの強化（精度影響: +2〜3%）
**目的**: 条件付き確率モデルの精度向上

**ディレクトリ**: `src/second_model/`, `src/third_model/`

**Stage2（2着モデル）強化**:
```
入力特徴量:
- 残り5艇の情報
- 1着艇のコース
- 1着艇の走法タイプ（Phase 3で追加）
- 2着率の高い"差し屋"判定
- インの外の艇の相対ST
- 4カド攻めの成功率
- 1着艇の膨れ率
```

**Stage3（3着モデル）強化**:
```
入力特徴量:
- 残り4艇の情報
- 混戦時の余り目パターン
- 伸び足の強弱
- モーター伸び指数
- 2着艇の斜行率
```

---

### Phase 3: 走法クラスタリング（精度影響: +2〜4%）
**目的**: 選手の走法パターンを自動分類

**ディレクトリ**: `src/style_cluster/`

**実装内容**:
1. `style_clustering.py` - クラスタリングメイン
2. `style_features.py` - 走法特徴量抽出
3. `style_embedding.py` - 選手embedding生成

**走法クラス（8種類）**:
1. まくり特化（攻め手）
2. まくり差し
3. 差し屋
4. 逃げ屋
5. 外マイ型
6. 2着拾い型
7. スタート爆発型
8. 調整型（気象依存）

**アルゴリズム**: KMeans / HDBSCAN

**効果**: Stage2・Stage3に強く効く

---

### Phase 4: ST時系列モデル（精度影響: +1〜2%）
**目的**: STの揺らぎパターンを捉える

**ディレクトリ**: `src/st_sequence/`

**実装内容**:
1. `st_lstm_model.py` - LSTM/GRUモデル
2. `st_sequence_features.py` - シーケンス特徴量
3. `st_trainer.py` - 訓練スクリプト

**仕様**:
- 入力: 直近30走のSTシーケンス
- 出力: 128次元embedding
- モデル: LSTM / GRU / Transformer

**追加ライブラリ**: PyTorch（TensorFlowでも可）

---

### Phase 5: レースタイプ別モデル分割（精度影響: +2〜4%）
**目的**: 水面特性に応じた専用モデル

**ディレクトリ**: `src/race_type_model/`

**モデル分割案（8〜12モデル）**:

| タイプ | 対象会場 | 特徴 |
|-------|---------|-----|
| イン水面 | 大村/徳山/芦屋 | 1着モデル最重要 |
| センター水面 | 平和島/多摩川 | 4カド攻め重視 |
| 差し水面 | 若松 | 2着モデルが重要 |
| 荒れ水面 | 戸田/江戸川 | モーター×ST×展示重視 |
| 静水面 | 下関/蒲郡 | 安定傾向 |
| 潮位影響大 | 住之江/尼崎 | 潮汐データ重視 |

**実装**:
1. `race_type_classifier.py` - レースタイプ分類
2. `type_specific_models.py` - タイプ別モデル管理
3. `model_selector.py` - モデル選択ロジック

---

### Phase 6: 三連単確率チェーン生成エンジン改善
**目的**: 全720通りの確率計算を正確に

**ディレクトリ**: `src/tricast_engine/`

**計算式**:
```
P(三連単 A-B-C) = P(1着=A) × P(2着=B | 1着=A) × P(3着=C | 1着=A, 2着=B)
```

**実装内容**:
1. `probability_chain.py` - 確率チェーン計算
2. `tricast_generator.py` - 三連単生成
3. `top_n_selector.py` - TOP10抽出

**改善点**:
- 進入予測結果の反映
- 走法クラスタの反映
- ST embedding の反映

---

### Phase 7: バックテスト強化・評価
**目的**: 精度改善の検証

**評価指標**:
- 三連単TOP1的中率
- 三連単TOP10的中率
- リフト値（市場との差）
- 平均オッズ
- ROI（回収率）
- カバレッジ（60%以上推奨）

**テストデータ**: 過去3年（約3万レース）

---

## ディレクトリ構造（最終形）

```
src/
├── entry_model/           # Phase 1: 進入予測
│   ├── __init__.py
│   ├── entry_predictor.py
│   ├── entry_features.py
│   └── entry_trainer.py
├── winner_model/          # 既存: 1着モデル
├── second_model/          # Phase 2: 2着条件付きモデル
│   ├── __init__.py
│   ├── second_predictor.py
│   └── second_features.py
├── third_model/           # Phase 2: 3着条件付きモデル
│   ├── __init__.py
│   ├── third_predictor.py
│   └── third_features.py
├── style_cluster/         # Phase 3: 走法クラスタリング
│   ├── __init__.py
│   ├── style_clustering.py
│   ├── style_features.py
│   └── style_embedding.py
├── st_sequence/           # Phase 4: ST LSTMモデル
│   ├── __init__.py
│   ├── st_lstm_model.py
│   ├── st_sequence_features.py
│   └── st_trainer.py
├── race_type_model/       # Phase 5: レースタイプ別モデル
│   ├── __init__.py
│   ├── race_type_classifier.py
│   ├── type_specific_models.py
│   └── model_selector.py
├── tricast_engine/        # Phase 6: 三連単確率チェーン
│   ├── __init__.py
│   ├── probability_chain.py
│   ├── tricast_generator.py
│   └── top_n_selector.py
└── utils/                 # 共通ユーティリティ
```

---

## 想定スケジュール

| Phase | 内容 | 依存関係 |
|-------|-----|---------|
| 1 | 進入予測モデル | なし（最優先） |
| 2 | 階層型2着・3着強化 | Phase 1完了後 |
| 3 | 走法クラスタリング | なし（並行可能） |
| 4 | ST時系列モデル | なし（並行可能） |
| 5 | レースタイプ別分割 | Phase 1,2完了後 |
| 6 | 三連単チェーン改善 | Phase 1-5完了後 |
| 7 | バックテスト・評価 | 全Phase完了後 |

**並行実施可能**: Phase 3, 4 は Phase 1, 2 と並行して進められる

---

## 期待される精度改善

| モデル段階 | TOP1 | TOP10 |
|----------|------|-------|
| 現状（単純スコア＋XGBoost） | 20〜25% | 55〜60% |
| Phase 1完了後 | 25〜28% | 60〜65% |
| Phase 2完了後 | 27〜30% | 65〜70% |
| Phase 3-4完了後 | 28〜31% | 68〜73% |
| 全Phase完了後 | **28〜33%** | **70〜78%** |

---

## 必要な追加ライブラリ

```
# Phase 4のLSTM用
torch>=2.0.0  # または tensorflow>=2.12.0

# Phase 3のクラスタリング用
hdbscan>=0.8.33
```

---

## 実装上の注意点

1. **データの一貫性**: 訓練データと推論データで同じ特徴量処理を行う
2. **リーケージ防止**: 未来の情報が訓練に混入しないよう注意
3. **モデルの保存**: 各Phaseのモデルは`models/`配下に保存
4. **ログ記録**: 訓練ログ、評価結果を記録
5. **段階的検証**: 各Phase完了ごとにバックテストで効果測定

---

## 次のアクション

1. Phase 1（進入予測モデル）の実装を開始
2. データベースから進入コース履歴データを確認
3. 進入特徴量の設計・実装
4. XGBoost multi-classモデルの構築

作業開始の承認をお願いします。
