# BEFORE統合検証結果まとめ

**作成日：2025年12月9日**

## 目的

直前情報（BEFORE）を事前予測（PRE）に統合することで、1着的中率を向上させる。

## 検証した4つの統合手法

### 1. 状態フラグ調整方式（State Flag Method）

**コンセプト**: BEFORE情報から選手の状態（好調/不調）を判定し、PRE_SCOREに±調整を加える

**実装場所**: `config/feature_flags.py` - `beforeinfo_flag_adjustment`

**結果**:
- **1着的中率: -3.65%の悪化** (55.5% → 51.85%)
- BEFOREの判定精度が低く、逆にノイズとして機能

**失敗原因**:
- BEFORE情報自体の予測力が低い（1着的中率34.6%）
- 状態判定基準が不明確で誤判定が多い

---

### 2. 階層的予測方式（Hierarchical Prediction）

**コンセプト**:
1. まずBEFOREで上位グループ（1-3位候補）を絞り込む
2. その中でPREスコアが最も高い艇を選ぶ

**実装場所**: `config/feature_flags.py` - `hierarchical_before_prediction`

**結果**:
- **1着的中率: -0.5%の悪化**
- BEFOREによる絞り込みが正確でなく、真の1着候補を除外してしまう

**失敗原因**:
- BEFOREは「上位グループ識別」に強い（3着以内68.7%）が、「1着識別」には弱い
- 階層的アプローチがシグナルのミスマッチを増幅

---

### 3. 正規化統合方式（Normalized Integration）

**コンセプト**:
- PRE_SCOREとBEFORE_SCOREを正規化（0-100点）して加重平均
- 重み: PRE 70% + BEFORE 30%

**実装場所**: `config/feature_flags.py` - `normalized_before_integration`

**結果**:
- **1着的中率: -0.5%の悪化**
- 30%のBEFOREウェイトでも予測を悪化させる

**失敗原因**:
- BEFORE_SCOREの絶対的な予測力不足
- 単純な加重平均では、弱いシグナル（BEFORE）が強いシグナル（PRE）を汚染

---

### 4. ゲーティング方式（Gated Integration）★最新

**コンセプト**:
- PRE 1位-2位の得点差が小さい「拮抗レース」のみBEFOREを使用
- 拮抗時にBEFORE上位艇にボーナス（1位+5%, 2位+2%）
- 非拮抗時はPRE単独

**実装場所**:
- `config/feature_flags.py` - `gated_before_integration`
- `src/analysis/race_predictor.py` - lines 1559-1624

**テスト閾値**: 3.0点、5.0点、7.0点、10.0点

**結果（2025年データ200レース）**:

| 閾値 | 拮抗率 | 1着的中率 | 差分(vs PRE) | 3着以内的中率 | 差分(vs PRE) |
|------|--------|-----------|--------------|---------------|--------------|
| ベースライン（PRE単独） | - | **55.50%** (111/200) | - | **79.50%** (159/200) | - |
| 3.0点 | 18.0% | 55.50% | **±0.00%** | 81.00% | +1.50% |
| 5.0点 | 18.0% | 55.50% | **±0.00%** | 81.00% | +1.50% |
| 7.0点 | 18.0% | 55.50% | **±0.00%** | 81.00% | +1.50% |
| 10.0点 | 18.0% | 55.50% | **±0.00%** | 81.00% | +1.50% |

**拮抗レースのみの分析（閾値5.0点）**:
- 拮抗レース数: 36レース（全体の18.0%）
- **拮抗レース1着的中率: 33.33%** ← PRE単独55.50%より**22.17%悪化**
- 拮抗レース3着以内的中率: 80.56%

**失敗原因**:
- **致命的な仮説の誤り**: 「拮抗レースでBEFOREが役立つ」は間違い
- 拮抗レースこそBEFORE情報の予測精度が最も低い（33.33%）
- ボーナス倍率が控えめすぎて効果ゼロ、または逆効果

---

## 4手法の失敗まとめ

| 手法 | 1着的中率の変化 | 判定 |
|------|----------------|------|
| ① 状態フラグ調整 | **-3.65%** | 大幅悪化 |
| ② 階層的予測 | **-0.50%** | 悪化 |
| ③ 正規化統合 | **-0.50%** | 悪化 |
| ④ ゲーティング | **±0.00%** | 効果なし |

---

## 根本原因の分析

### 1. PRE vs BEFORE の相関分析結果

**分析スクリプト**: `scripts/analyze_pre_before_correlation.py`

**結果**:
- **スピアマン順位相関係数: 0.315（弱い相関）**
- PRE 1位 = BEFORE 1位の一致率: **37.0%**
- 上位3艇の重複率: **59.3%**

**解釈**:
- 相関が弱い = 補完的な情報源の可能性
- しかし実際は、BEFORE情報の予測力不足が原因

### 2. BEFORE各要素の個別予測力測定

**分析スクリプト**: `scripts/analyze_before_element_correlation.py`

**結果（相関係数の絶対値順）**:

| 順位 | 要素 | 相関係数 | 解釈 | 上位群1着率 | 下位群1着率 | 差分 |
|------|------|----------|------|-------------|-------------|------|
| 1 | **ST順位（レース内）** | **0.322** | 強い相関 | 31.8% | 6.9% | +24.9% |
| 2 | ST絶対値 | 0.190 | 中程度 | 22.3% | 10.7% | +11.6% |
| 3 | 展示タイム順位 | 0.177 | 中程度 | 22.6% | 9.8% | +12.9% |
| 4 | 展示タイム絶対値 | 0.070 | 弱い | 18.8% | 15.1% | +3.7% |
| 5 | F/Lフラグ | 0.025 | ほぼなし | 20.0% | 16.9% | +3.1% |
| 6 | チルト角度 | 0.013 | ほぼなし | 17.0% | - | - |

**重要な発見**:
- **ST順位の高相関は「疑似相関」（ユーザー指摘）**
  - 真の因果: 強い選手 → 良いコース → 良いST → 勝利
  - 誤った解釈: 良いST → 勝利
  - スタート展示は「タイミング合わせ」「モーター確認」が目的で本気ではない
  - ST順位自体は勝敗の直接的な予測因子ではない

- **展示タイム順位も同様の問題**
  - 展示走行は本番と異なる目的で行われる
  - 数値から本番着順を予測するのは本質的に困難

### 3. シグナルのミスマッチ

| 指標 | PRE_SCORE | BEFORE_SCORE |
|------|-----------|--------------|
| **得意領域** | 1着 vs 2着の識別 | 上位グループ vs 下位グループ |
| **1着的中率** | **55.5%** | 34.6% |
| **3着以内的中率** | 79.5% | **68.7%** |
| **信頼性** | 高い | 低い |

**結論**:
- PREは「1着識別」に強い
- BEFOREは「上位グループ識別」にやや使えるが、1着識別には弱い
- 統合すると、PREの強みがBEFOREの弱さに引きずられる

---

## データ品質の問題

### BEFORE情報の本質的限界

1. **展示タイム・ST**:
   - 目的: タイミング合わせ、モーター機力確認
   - 本番とは異なる走り方
   - 本気のパフォーマンスではない

2. **チルト角度**:
   - 相関係数0.013でほぼ無意味
   - 選手の好みや戦略の反映で、着順との直接関係なし

3. **F/L（フライング・出遅れ）**:
   - 相関係数0.025で弱い
   - 現在の配点0点は妥当

---

## 推奨事項

### ❌ 実施すべきでないこと

1. **BEFORE情報の1着予測への統合**
   - 4つの手法全てが失敗
   - さらなる統合手法の開発は時間の無駄

2. **ST順位の配点強化**
   - 相関係数が高くても疑似相関
   - データに騙されない（ドメイン知識優先）

3. **展示タイム絶対値の重視**
   - 相関係数0.070と低い
   - レース内順位の方がまだマシ

### ✅ 実施を検討すべきこと

#### 短期的（即座に実施可能）

1. **PRE_SCORE単独の精度向上に集中**
   - PRE各要素の配点最適化
   - 機械学習モデル（LightGBM）のハイパーパラメータチューニング
   - 特徴量エンジニアリング

2. **BEFORE情報の別用途活用**
   - **3着以内予測**: 81.0% vs 79.5%で+1.5%改善
   - **ネガティブスクリーニング**: BEFORE 6位を購入候補から除外
   - **信頼度スコア**: PRE予測の信頼度を測る補助指標として使用

3. **オッズベース戦略への切り替え**
   - 的中率ではなく期待値・ROIを最大化
   - BEFORE情報はオッズ歪みの検出に使える可能性

#### 中長期的（要検討・要リソース）

1. **新しい情報源の探索**
   - 天候・水面・風向などの環境要因
   - レース直前のオッズ変動パターン
   - 選手のSNS・インタビューからのセンチメント分析

2. **BEFORE情報の収集・計算方法の見直し**
   - 現在の展示タイム・STが「本気」かどうかの判定
   - 部品交換情報の精緻化
   - 前走レース結果との統合

3. **統計的有意性の検証強化**
   - サンプルサイズを200→1000レース以上に拡大
   - クロスバリデーションの実施
   - 過学習の検出

---

## 技術的な学び

### 成功パターン

- **ドメイン知識 > 統計的相関**
  - ST順位の相関0.322を「疑似相関」と見抜いたユーザー指摘が正しかった
  - データだけでは真の因果を見抜けない

- **ベースライン比較の重要性**
  - PRE単独55.5%という強力なベースラインの存在
  - 改善には確実な証拠が必要

### 失敗パターン

- **弱いシグナルは統合で改善しない**
  - BEFORE 34.6% → PRE 55.5%への統合は必ず悪化
  - 「補完的」と「弱い」は別概念

- **仮説の検証不足**
  - 「拮抗レースでBEFOREが役立つ」を先に検証すべきだった
  - 実装→検証ではなく、仮説検証→実装の順序

---

## 関連ファイル

### 実装ファイル

- `config/feature_flags.py` - 機能フラグ設定
- `src/analysis/race_predictor.py` - 予測ロジック（lines 1559-1624: ゲーティング方式）
- `src/analysis/beforeinfo_scorer.py` - BEFORE情報スコアリング

### 検証スクリプト

- `scripts/validate_flag_adjustment.py` - 状態フラグ調整方式の検証
- `scripts/validate_hierarchical_prediction.py` - 階層的予測方式の検証
- `scripts/validate_normalized_integration.py` - 正規化統合方式の検証
- `scripts/validate_gated_integration.py` - ゲーティング方式の検証

### 分析スクリプト

- `scripts/analyze_pre_before_correlation.py` - PRE vs BEFORE相関分析
- `scripts/analyze_before_element_correlation.py` - BEFORE各要素の個別予測力測定

### 結果ファイル

- `results/flag_adjustment_validation_20251209.txt`
- `results/hierarchical_prediction_validation_20251209.txt`
- `results/normalized_integration_validation_20251208.txt`
- `results/gated_integration_validation_20251209.txt`
- `results/pre_before_correlation_20251209.txt`
- `results/before_element_correlation_20251209.txt`

---

## 結論

**BEFORE情報の1着予測への統合は、現時点では推奨しない。**

4つの異なるアプローチ全てが失敗に終わり、根本原因として以下が判明：

1. BEFORE情報自体の予測力不足（1着的中率34.6%）
2. PRE（55.5%）とのシグナルミスマッチ
3. 展示走行データの本質的限界（本番とは異なる目的）
4. 疑似相関の罠（ST順位など）

今後は**PRE単独の精度向上**と**BEFORE情報の別用途活用**（3着以内予測、ネガティブスクリーニング）に注力すべき。

---

**作成者**: Claude (Sonnet 4.5)
**検証期間**: 2025年12月8日-9日
**検証データ**: 2025年レース200件（直前情報あり）
