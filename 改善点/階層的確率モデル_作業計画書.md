# 階層的（条件付き）確率モデル 作業計画書

作成日: 2025-11-30
目的: 2着・3着予測精度の改善による3連単的中率向上

---

## 1. 現状分析

### 1.1 現在の精度（2025-11-29データ）
| 項目 | 全レース | TOP20 |
|------|----------|-------|
| 1位的中率 | 56.3% | 70.0% |
| 3連単的中率 | 12.7% | 5.0% |
| 3連複的中率 | 20.6% | 10.0% |

### 1.2 問題の根本原因
- **予測2位の的中率: 35.9%** （1位56.3%と比べて低い）
- **予測3位の的中率: 27.2%**
- 1位と2位のスコア差15.7点のうち、**コーススコア差が10.2点（65%）**
- → 2位以降の予測で「コース以外の要素」での差別化ができていない

### 1.3 既存資産の確認

#### DBテーブル（利用可能）
- `races`: 132,622件
- `results`: 774,684件（学習に十分）
- `race_details`: 786,880件（exhibition_time: 625,150件）
- `entries`: 792,252件
- `exhibition_data`: 861件（直前情報、今後増加予定）

#### 既存実装（活用可能）
| ファイル | 説明 | 活用度 |
|----------|------|--------|
| `src/ml/conditional_rank_model.py` | 条件付き着順モデル（Stage1/2/3基盤あり） | **高** |
| `src/training/stage2_trainer.py` | LightGBM/XGBoost学習パイプライン | **高** |
| `src/prediction/stage2_predictor.py` | 推論パイプライン | **高** |
| `src/features/optimized_features.py` | 特徴量生成（直近成績等） | **中** |
| `src/ml/entry_course_predictor.py` | 進入コース予測 | **中** |
| `models/stage2_*.json` | 24会場別モデル等 | **中** |

#### 既存ビュー
- `race_details_extended`
- `racer_performance_summary`
- `venue_statistics_view`

---

## 2. 改善案との差分分析

### 2.1 既に存在するもの（改修で対応）
| 改善案の項目 | 既存ファイル | 必要な作業 |
|-------------|-------------|-----------|
| Stage1（1着予測） | `conditional_rank_model.py` | 維持（そのまま使用） |
| Stage2（2着条件付き） | `conditional_rank_model.py` | ロジック改修（winner情報追加） |
| Stage3（3着条件付き） | `conditional_rank_model.py` | ロジック改修（winner+2nd情報追加） |
| LightGBM/XGBoost学習 | `stage2_trainer.py` | パラメータ調整のみ |
| 進入予測 | `entry_course_predictor.py` | 特徴量追加 |
| 直近成績特徴量 | `optimized_features.py` | 拡張 |

### 2.2 新規作成が必要なもの
| 改善案の項目 | 作成ファイル | 優先度 |
|-------------|-------------|--------|
| 展示相対特徴量（exh_rank, exh_diff, exh_zscore） | `src/features/feature_transforms.py` | **高** |
| ST相対特徴量（st_relative, st_rank） | `src/features/feature_transforms.py` | **高** |
| motor_id/boat_id embedding | `src/features/embeddings.py` | 中 |
| 場×気象交互作用 | `src/features/interaction_features.py`（拡張） | 中 |
| 統合推論パイプライン | `src/prediction/integrated_predictor.py` | **高** |
| 三連単確率計算 | `src/prediction/trifecta_calculator.py` | **高** |
| DB View（racer_recent_stats） | `src/database/views.sql` | 中 |
| テストスイート | `tests/test_*.py` | 中 |

---

## 3. 作業計画（フェーズ別）

### Phase 1: 特徴量拡張（優先度: 高）
**目標**: 2着・3着予測に必要な相対評価特徴量を追加

#### タスク1.1: 展示相対特徴量の実装
- ファイル: `src/features/feature_transforms.py`（新規）
- 内容:
  - `add_exhibition_features(rd_df)`: exh_rank, exh_diff, exh_zscore
  - `add_st_features(rd_df)`: st_relative, st_rank
- 依存: `race_details`テーブル

#### タスク1.2: DBビューの作成
- ファイル: `src/database/views.sql`（新規）
- 内容:
  - `racer_recent_stats`: 直近5走の平均順位、ST標準偏差
  - `exhibition_relative`: レース内相対展示タイム

#### タスク1.3: エンコーダの実装
- ファイル: `src/features/embeddings.py`（新規）
- 内容:
  - `encode_motor_boat(df)`: motor_id_enc, boat_id_enc
  - エンコーダ保存: `models/encoders/`

---

### Phase 2: 条件付きモデルの改修（優先度: 高）
**目標**: Stage2/3モデルに「勝者情報」を正しく伝達

#### タスク2.1: Stage2学習データ生成の改修
- ファイル: `src/ml/conditional_rank_model.py`
- 改修内容:
  - `_prepare_second_place_data()`: winner特徴量を各候補に付加
  - 学習データSQL: winner != candidateの5艇を抽出

#### タスク2.2: Stage3学習データ生成の改修
- ファイル: `src/ml/conditional_rank_model.py`
- 改修内容:
  - `_prepare_third_place_data()`: winner + 2nd特徴量を各候補に付加
  - 学習データSQL: winner, 2nd != candidateの4艇を抽出

#### タスク2.3: 学習スクリプトの作成
- ファイル: `src/ml/train_conditional_models.py`（新規）
- 内容:
  - TimeSeriesSplit(5)でCV
  - early_stopping使用
  - モデル保存: `models/stage2_conditional.joblib`, `models/stage3_conditional.joblib`

---

### Phase 3: 推論パイプラインの実装（優先度: 高）
**目標**: 三連単確率を正確に計算する推論システム

#### タスク3.1: 三連単確率計算の実装
- ファイル: `src/prediction/trifecta_calculator.py`（新規）
- 内容:
  ```python
  def calculate_trifecta_probs(features_list):
      # P(1=i) * P(2=j|1=i) * P(3=k|1=i,2=j)
      # 全120通りの確率を計算
  ```

#### タスク3.2: IntegratedPredictorの改修
- ファイル: `src/prediction/integrated_predictor.py`（新規 or 改修）
- 内容:
  - Stage1 → Stage2 → Stage3のチェーン実行
  - 確率の正規化（sum = 1.0の検証）
  - EV計算（オッズ連携）

---

### Phase 4: 既存システムとの統合（優先度: 中）
**目標**: UI・予想生成フローへの組み込み

#### タスク4.1: race_predictor.pyへの統合
- ファイル: `src/analysis/race_predictor.py`
- 改修内容:
  - `predict_race()`に条件付きモデル呼び出しを追加
  - フォールバック: モデルがない場合は従来ロジック

#### タスク4.2: UIへの反映
- ファイル: `ui/components/unified_race_list.py`
- 改修内容:
  - 三連単確率の表示
  - 信頼度計算の改善

---

### Phase 5: テスト・検証（優先度: 中）
**目標**: 品質保証とバックテスト

#### タスク5.1: ユニットテストの作成
- `tests/test_feature_transforms.py`
- `tests/test_conditional_models.py`
- `tests/test_trifecta_calculator.py`

#### タスク5.2: バックテスト
- 過去1ヶ月のデータで精度検証
- 改善前後の比較レポート

---

## 4. ファイル構成（最終形）

```
src/
├── features/
│   ├── feature_transforms.py      ★ 新規
│   ├── embeddings.py              ★ 新規
│   ├── optimized_features.py      改修
│   └── interaction_features.py    改修
├── ml/
│   ├── conditional_rank_model.py  改修
│   ├── train_conditional_models.py ★ 新規
│   └── ...
├── prediction/
│   ├── integrated_predictor.py    ★ 新規/改修
│   ├── trifecta_calculator.py     ★ 新規
│   └── stage2_predictor.py        改修
├── database/
│   └── views.sql                  ★ 新規
└── analysis/
    └── race_predictor.py          改修

models/
├── encoders/
│   ├── motor_encoder.joblib       ★ 新規
│   └── boat_encoder.joblib        ★ 新規
├── stage2_conditional.joblib      ★ 新規
├── stage3_conditional.joblib      ★ 新規
└── ...

tests/
├── test_feature_transforms.py     ★ 新規
├── test_conditional_models.py     ★ 新規
└── test_trifecta_calculator.py    ★ 新規
```

---

## 5. 実装優先順位

| 順位 | タスク | 理由 |
|------|--------|------|
| 1 | Phase 1（特徴量拡張） | 全ての改善の基盤 |
| 2 | Phase 2（条件付きモデル改修） | 2着3着予測精度の直接改善 |
| 3 | Phase 3（推論パイプライン） | 三連単確率計算の実装 |
| 4 | Phase 4（統合） | 実運用への反映 |
| 5 | Phase 5（テスト） | 品質保証 |

---

## 6. 期待される改善効果

| 指標 | 現状 | 目標 |
|------|------|------|
| 予測2位の的中率 | 35.9% | 45%以上 |
| 予測3位の的中率 | 27.2% | 35%以上 |
| 3連単的中率（全体） | 12.7% | 18%以上 |
| 3連単的中率（TOP20） | 5.0% | 15%以上 |

---

## 7. 次のアクション

1. **Phase 1 タスク1.1**から開始
   - `src/features/feature_transforms.py`の実装
   - 展示タイム相対評価特徴量の追加

2. 実装完了後、11月データで効果検証

---

## 付録: 数学的背景

### 三連単確率のチェーンルール
```
P(i-j-k) = P(1着=i) × P(2着=j | 1着=i) × P(3着=k | 1着=i, 2着=j)
```

### 期待値計算
```
EV(i-j-k) = P(i-j-k) × Odds(i-j-k) - 1
```

### Kelly基準
```
f* = (p × b - q) / b
where:
  p = 予測確率
  b = オッズ - 1
  q = 1 - p
  f* = 推奨賭け金割合
```
