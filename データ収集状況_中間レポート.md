# データ収集状況 中間レポート

生成日時: 2025-11-01

## 現在の作業状況

### 実行中のプロセス

1. **V5修正版（継続実行中）**
   - 対象期間: 2023-11-01 ～ 2025-10-31 (2年間、731日)
   - 現在処理中: 2025年1月のデータ
   - ログ: `v5_fixed_output.log`

2. **風向データ全件補完（バックグラウンド実行中）**
   - 対象: 風向がNULLの全weatherレコード
   - スクリプト: `補完_風向データ_全件_自動.py`
   - 推定完了時間: 数時間後

## データ収集状況

### 既存データ統計

- **総レース数**: 29,282レース
- **総日数**: 683日
- **データ期間**: 2022-11-02 ～ 2025-10-31

### データ項目別の状況

| データ項目 | 取得状況 | 備考 |
|------------|---------|------|
| **レース結果** | ✅ 100% | 着順、オッズ、払戻金 |
| **進入コース** | ✅ 100% | 実際の進入コース |
| **STタイム** | ✅ 81.7% | スタートタイミング |
| **気温** | ✅ 100% | 天候情報 |
| **風速** | ✅ 100% | 天候情報 |
| **水温** | ✅ 100% | 天候情報 |
| **波高** | ✅ 100% | 天候情報 |
| **風向** | ⚠️ 60%→補完中 | 全件補完スクリプト実行中 |
| **展示タイム** | ⚠️ 1.7% | 事前情報ページでのみ取得可能 |
| **チルト角度** | ⚠️ 1.7% | 事前情報ページでのみ取得可能 |
| **部品交換** | ⚠️ 1.7% | 事前情報ページでのみ取得可能 |

## 重要な発見

### 1. 展示タイム・チルト・部品交換について

**結論**: 過去データでは収集が困難

**理由**:
- これらのデータは「事前情報ページ」でのみ提供される
- 事前情報ページは**レース開催の直前までしかアクセスできない**
- 過去のレースでは事前情報ページが存在しないため、収集不可能

**今後の対応策**:
1. **現在のデータで予測モデルを構築** - 展示タイムなしでも高精度な予測は可能
2. **今後のレースからリアルタイム収集** - レース開催日の前日～当日に収集

### 2. 風向データについて

**状況**: 取得コードは正しく動作しているが、DBに保存されていなかった

**原因**: V5実行時に風向修正版のコードが適用されていなかった可能性

**対応**: 風向データ全件補完スクリプトを実行中（自動修復）

**期待される結果**: 数時間後には全データに風向が追加される

## 実施した修正

### 1. result_scraper.pyの風向抽出修正

**修正内容** (903-920行目):
```python
# 子要素の<p>タグから風向クラスを取得
wind_direction_elem = weather_elem.find(class_='is-windDirection')
if wind_direction_elem:
    wind_image = wind_direction_elem.find('p')
    if wind_image:
        classes = wind_image.get('class', [])
        for cls in classes:
            if cls.startswith('is-wind') and len(cls) > 7:
                wind_num = cls.replace('is-wind', '')
                wind_deg = int(wind_num) * 22.5  # 16方位
                weather_data['wind_direction'] = self._degree_to_direction(wind_deg)
```

**テスト結果**: 正常に動作（「北西」を取得できることを確認）

### 2. data_manager.pyの展示タイム保存修正

**修正内容** (save_race_details, 521-570行目):
```python
# INSERT OR REPLACE → INSERT ... ON CONFLICT ... DO UPDATE
INSERT INTO race_details (...) VALUES (...)
ON CONFLICT(race_id, pit_number) DO UPDATE SET
    exhibition_time = COALESCE(excluded.exhibition_time, race_details.exhibition_time),
    tilt_angle = COALESCE(excluded.tilt_angle, race_details.tilt_angle),
    ...
```

**効果**: 既存データを上書きせず、NULL値のみ更新

## 次のステップ

### 短期（今後数時間）

1. ✅ 風向データ全件補完の完了を待つ
2. ⏳ V5のデータ収集完了を待つ（2023-2025年）
3. ⏳ 完了後、データ品質を最終確認

### 中期（今後数日）

1. 展示タイムなしで予測モデルを構築開始
2. データの整合性チェック実行
3. 必要に応じて欠損データの補完

### 長期（今後数週間～数ヶ月）

1. 今後のレースで展示タイム・チルト・部品交換をリアルタイム収集
2. データが蓄積したら展示タイム込みのモデルに更新
3. 予測精度の比較・改善

## 結論

**現状**: データ収集は順調に進行中。風向データは補完スクリプトにより自動修復中。

**次回確認時刻**: 30分後（風向補完の進捗確認）、1時間後（データ品質再確認）

**推奨**: V5と風向補完を継続実行させ、完了を待つ。展示タイムは過去データでは収集できないため、現在のデータでモデル構築を進める。
