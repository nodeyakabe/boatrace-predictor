# 潮位データ取得 - 最終報告

## 重要な発見

### ❌ 気象庁RDMDBデータの提供期間の問題

テスト実行の結果、**2015年のデータが気象庁RDMDBで提供されていない**ことが判明しました。

```
テスト結果（2015年11月）:
  全観測点で 404 Not Found
  → 気象庁RDMDBは2015年のデータを提供していない
```

---

## 📊 現状のまとめ

### データベース内の潮位データ
| テーブル | レコード数 | データ期間 |
|---------|-----------|-----------|
| rdmdb_tide | 6,475,040 | **2022-11-01 ～ 2025-09-30** |
| race_tide_data | 7,844 | 2022-11-03 ～ 2025-10-31 |

### 対象期間のレース
| 期間 | レース数 | 潮位データ | 状況 |
|------|---------|-----------|------|
| 2015-2021 | 59,081 | 0 (0.0%) | ❌ RDMDBデータなし |
| 2022以降 | 72,665 | 7,844 (一部) | ✅ データあり |

---

## 🔍 気象庁データの調査結果

### NEAR-GOOS RDMDB
- **URL**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/genbo/
- **提供期間**: 2022年11月以降のみ
- **過去データ**: アーカイブなし

### 気象庁潮位表（代替データ源）
- **URL**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/suisan/
- **提供データ**: 満潮・干潮の時刻と潮位（日次）
- **提供期間**: 過去データあり
- **データ形式**: テキストファイル（月別）

---

## 💡 解決策の提案

### オプション1: 気象庁潮位表データを使用（推奨）

#### メリット
- 2015-2021年のデータが取得可能
- 満潮・干潮の時刻と潮位が取得できる
- レース予想には十分な情報

#### デメリット
- 30秒/1分値のような高頻度データではない
- 1日4回程度（満潮2回、干潮2回）のデータのみ

#### 実装方法
既存の `tide_scraper.py` を活用可能

```python
# 既存スクレイパーの活用
from src.scraper.tide_scraper import TideScraper

scraper = TideScraper()
tide_data = scraper.get_tide_data(venue_code='22', target_date='2015-11-08')
# → [{'time': '03:45', 'type': '満潮', 'level': 352.0}, ...]
```

### オプション2: 2022年以降のデータのみ使用

#### メリット
- すでにデータあり（6,475,040レコード）
- 高頻度データ（30秒/1分値）

#### デメリット
- 2015-2021年のデータは使用不可
- 機械学習の訓練データが減少

---

## 📋 推奨アクション

### 🎯 推奨: 気象庁潮位表を使用

2015-2021年のデータには **気象庁潮位表** を使用することを推奨します。

#### ステップ1: 潮位表データ取得スクリプトの作成
```bash
# 新スクリプト: fetch_tide_suisan.py
# 気象庁潮位表から満潮・干潮データを取得
```

#### ステップ2: レースへの紐付け
```bash
# レース時刻に最も近い満潮・干潮データを使用
# または、満潮・干潮時刻から潮位を推定
```

#### データ量の推定
```
2015-2021年: 約2,555日
1日あたり: 満潮2回 + 干潮2回 = 4レコード
観測点: 7観測点

総レコード数 = 2,555日 × 4レコード/日 × 7観測点
             = 約71,540レコード

データベース増加量 = 約3-5MB（RDMDBの約1/1000）
```

---

## 🔧 作成済みスクリプトの状況

### ✅ 正常動作確認済み
1. [analyze_tide_data.py](analyze_tide_data.py) - 欠損分析
2. [link_tide_to_races.py](link_tide_to_races.py) - レース紐付け

### ⚠️ データソース変更が必要
3. [fetch_historical_tide_data.py](fetch_historical_tide_data.py) - RDMDB用（2015年データなし）
4. [fetch_tide_for_races_only.py](fetch_tide_for_races_only.py) - RDMDB用（2015年データなし）

### 📝 新規作成が必要
5. **fetch_tide_suisan.py** - 気象庁潮位表用（満潮・干潮データ）

---

## 📊 データ比較

| データソース | 期間 | 頻度 | レコード数 | 容量 |
|-------------|------|------|-----------|------|
| **RDMDB** | 2022年11月～ | 30秒/1分 | 約647万 | 約10GB |
| **潮位表** | 過去全期間 | 1日4回 | 約7万 | **約5MB** |

---

## 次のステップ

### オプションA: 潮位表データを取得（推奨）
```bash
# 新スクリプトの作成が必要
# 既存の tide_scraper.py を参考に実装
```

### オプションB: 2022年以降のデータのみ使用
```bash
# 追加作業なし
# 2015-2021年のデータは潮位なしで分析
```

---

## まとめ

### 判明した事実
1. ❌ 気象庁RDMDBは2015-2021年のデータを提供していない
2. ✅ 2022年11月以降のRDMDBデータは取得済み（6,475,040レコード）
3. ✅ 気象庁潮位表で2015-2021年のデータ取得は可能（満潮・干潮のみ）

### 作成済みスクリプト
- データベース分析ツール
- レース紐付けツール
- RDMDB用データ取得ツール（2022年以降用）

### 今後の対応
**気象庁潮位表からのデータ取得スクリプトを作成**することを推奨します。
- データ量: 約7万レコード（約5MB）
- 実装工数: 約1-2時間
- 既存の `tide_scraper.py` が活用可能

---

## 参考リンク

### 気象庁 潮位観測資料
- **潮位表**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/suisan/
- **RDMDB**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/genbo/
- **潮位観測情報**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/gaikyo/index.php

### 既存の実装
- [tide_scraper.py](src/scraper/tide_scraper.py) - 潮位表データ取得（実装済み）
- [rdmdb_tide_parser.py](src/scraper/rdmdb_tide_parser.py) - RDMDBパーサー（実装済み）
