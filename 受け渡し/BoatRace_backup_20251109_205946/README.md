# ボートレース予想システム

競艇の過去データを収集・分析し、レース予想を行うための統合システムです。

## 主要機能

### データ収集
- レーススケジュール収集 - 各会場の開催スケジュールを自動取得
- レース結果収集 - 過去のレース結果を一括取得
- レース詳細データ収集 - 出走表、展示タイム、モーター情報など
- 決まり手データ収集 - 各レースの決まり手情報
- 天候データ収集 - 気象情報（気温、水温、風向、風速、波高）
- 潮位データ収集 - RDMDB（気象庁）から潮位情報を取得

### データ分析
- 会場特性分析 - 各会場のコース別勝率、選手級別傾向
- 予想ロジック - スコアリング方式による勝艇予想
- バックテスト機能 - 過去データで予想精度を検証
- ルール管理 - 会場別・選手別の攻略ルール設定

### UIシステム（Streamlit）
- データ収集状況の確認
- レース予想の実行
- バックテスト実行
- 会場特性の可視化
- データエクスポート
- ルール管理

## セットアップ

### 必要環境
- Python 3.8以上
- pip（パッケージ管理）

### インストール手順

1. **仮想環境の作成（推奨）**
```bash
python -m venv venv
venv\Scriptsctivate
```

2. **依存パッケージのインストール**
```bash
pip install requests beautifulsoup4 pandas streamlit
```

3. **UIアプリの起動**
```bash
streamlit run ui/app.py
```

ブラウザで http://localhost:8501 にアクセス

## 使い方

### 1. データ収集
UI経由で「データ収集」タブを選択し、期間・会場を指定して収集開始

### 2. レース予想
「レース予想」タブで日付・会場・レース番号を指定

### 3. バックテスト実行
「バックテスト」タブで期間・会場を指定して精度検証

## バックテスト機能

過去のレースデータを使って予想ロジックの精度を検証する機能。

### 予想ロジック（スコアリング方式）

各艇のスコアを以下の要素で計算:

1. **コース別基礎点** - 1コース:50点、2コース:20点、3コース:15点
2. **選手級別** - A1:30点、A2:20点、B1:10点、B2:5点
3. **選手勝率** × 3点
4. **モーター2連率** × 0.3点
5. **展示タイム** - 直進6.5秒以下:10点、6.7秒以下:5点

最もスコアの高い艇を1着予想とする。

### 評価指標
- 単勝的中率: 1着予想が的中した割合
- 複勝的中率: 1着予想が3着以内に入った割合
- 会場別的中率: 各会場での的中率

### コマンドライン使用例
```bash
python backtest_prediction.py 2024-01-01 2024-01-31
python backtest_prediction.py 2024-01-01 2024-01-31 --venue 01
```

## 主要スクリプト

### データ収集系
- core/fetchers/schedule_fetcher.py - スケジュール収集
- core/fetchers/results_fetcher.py - 結果収集
- core/fetchers/race_detail_fetcher.py - レース詳細収集
- core/fetchers/kimarite_fetcher.py - 決まり手収集
- core/fetchers/weather_fetcher.py - 天候データ収集
- core/fetchers/tide_fetcher.py - 潮位データ収集

### 分析系
- backtest_prediction.py - 予想精度検証

### ユーティリティ系
- backup_project.py - プロジェクトバックアップ
- delete_scripts.py - 不要ファイル削除

## トラブルシューティング

### データベースロック
症状: sqlite3.OperationalError: database is locked
解決策: 並列処理の同時接続数を制限、バッチ処理を使用

### HTMLパースエラー
症状: 特定の会場・日付でデータが取得できない
解決策: 会場別の特殊処理を追加、エラーハンドリング強化

### UI起動エラー
```bash
pip install -r requirements.txt
streamlit run ui/app.py --server.port 8502
```

## 開発履歴と教訓

詳細は CLEANUP_REPORT.md を参照。

### 開発ベストプラクティス

1. バックアップ重要 - 大規模変更前に必ずバックアップ
2. 段階的テスト - 少量データでテスト → 全データ処理
3. ログ充実 - デバッグ時にHTML保存、詳細ログ出力
4. エラーハンドリング - try-exceptで例外をキャッチ、処理継続
5. バッチ処理 - 大量データは分割処理
6. トランザクション最適化 - コミット頻度を調整
7. 並列処理の制限 - セマフォで同時接続数を制限

## ライセンス

個人利用のみ。商用利用禁止。

## 更新履歴

- 2025-11-02: プロジェクト整理、バックテスト機能追加、README作成
