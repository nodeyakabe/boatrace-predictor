# 潮位データ取得 - 状況報告

## 実施日時
2025-11-10

---

## 調査結果サマリー

### ❌ 重大な問題が判明

**2015-2021年の潮位データは気象庁の公開データでは取得できません。**

---

## 詳細調査結果

### 1. 気象庁 NEAR-GOOS RDMDB
**URL**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/genbo/

**調査結果**:
- ✅ データ形式: 30秒/1分間隔の高頻度データ
- ❌ 提供期間: **2022年11月以降のみ**
- ❌ 過去データ: アーカイブなし

**テスト結果**:
```
2015年11月のデータをリクエスト
→ 全観測点で 404 Not Found
→ 2015年のデータは提供されていない
```

### 2. 気象庁 潮位表（潮汐表）
**URL**: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/suisan/

**調査結果**:
- ✅ Webページには「2011-2026年のデータ提供」と記載あり
- ❌ 実際のアクセステスト: **エラー「地点、年の設定に誤りがあります」**
- ❌ テキストファイルURL: **404 Not Found**
- ❌ Webインターフェース: **パラメータエラー**

**テスト結果 (複数の方法を試行)**:
```
方法1: テキストファイル直接アクセス
  https://www.data.jma.go.jp/kaiyou/db/tide/suisan/txt/2015/TK201511.txt
  → 404 Not Found

方法2: Webインターフェース (2024年データ)
  https://www.data.jma.go.jp/kaiyou/db/tide/suisan/suisan.php?stn=61&yy=2024&mm=10&dd=1&rg=7
  → エラーページ: "地点、年の設定に誤りがあります"

方法3: Webインターフェース (2015年データ)
  同上
  → エラーページ: "地点、年の設定に誤りがあります"
```

**結論**: Webページの説明と実際の提供状況が異なる。現時点では2015年のデータ取得不可。

---

## 現在のデータベース状況

### rdmdb_tideテーブル
| 項目 | 値 |
|------|-----|
| レコード数 | 6,475,040 |
| データ期間 | 2022-11-01 ～ 2025-09-30 |
| 観測点 | 7観測点 |
| データ品質 | ✅ 良好 |

### race_tide_dataテーブル (レースへの紐付け)
| 項目 | 値 |
|------|-----|
| レコード数 | 7,844 |
| 紐付け期間 | 2022-11-03 ～ 2025-10-31 |
| 紐付け率 | 約11% (2022年以降のレース) |

### レース数と潮位データの対応状況
| 期間 | レース数 (海水場のみ) | 潮位データあり | カバー率 |
|------|---------------------|---------------|---------|
| **2015-2021** | **59,081** | **0 (0.0%)** | **❌ 0%** |
| 2022-2025 | 72,665 | 7,844 (10.8%) | ⚠️ 11% |

---

## 問題点の整理

### 問題1: 2015-2021年の潮位データが存在しない
- **影響**: 59,081レース (全体の45%) で潮位特徴量が使用できない
- **原因**: 気象庁の公開データが2022年11月以降のみ
- **解決策**: ❌ 現時点では解決不可

### 問題2: 2022年以降も紐付け率が低い (11%)
- **影響**: データはあるのに活用できていない
- **原因**: 紐付けスクリプトの実行が不完全？
- **解決策**: ✅ link_tide_to_races.py を再実行で改善可能

---

## 対応オプション

### オプションA: 潮位なしで分析を進める（推奨）
#### メリット
- すぐに開始できる
- 他の特徴量（天気、風、選手データ等）で十分な精度が期待できる

#### デメリット
- 潮位の影響を考慮できない
- 一部会場（特に海水場）で精度が劣る可能性

#### 実施内容
```bash
# 2022年以降のデータで紐付けを完了させる
python link_tide_to_races.py --start 2022-11-01 --end 2025-10-31

# 潮位なしで機械学習を実施
# → feature_engineering.py で tide_* 特徴量を除外
```

### オプションB: 有料データサービスを利用
#### メリット
- 過去データが入手できる可能性
- 高品質なデータ

#### デメリット
- コストがかかる
- データ利用規約の確認が必要
- 入手までに時間がかかる

#### 候補サービス
1. 海上保安庁 海洋情報部
2. 民間気象データサービス（ウェザーニューズ等）
3. 研究機関のデータアーカイブ

### オプションC: 潮汐予測モデルで推定
#### メリット
- コストゼロ
- 過去データも推定可能

#### デメリット
- 実測値ではなく推定値
- 天文潮位のみ（気圧・風の影響は考慮されない）
- 実装に時間がかかる

#### 実施内容
```python
# PyTidesなどのライブラリを使用
# 各会場の座標と基準点情報から潮位を推定
```

---

## 推奨アクション

### ステップ1: 2022年以降のデータを完全に活用
```bash
# 既存データの紐付けを完了させる
python link_tide_to_races.py --start 2022-11-01 --end 2025-10-31

# 結果確認
python analyze_tide_data.py
```

**期待される結果**:
- 2022年以降のレース: 約7万レースに潮位データが紐付く
- 紐付け率: 11% → 95%以上に改善

### ステップ2: 潮位なしで機械学習を開始
- 2015-2021年: 潮位特徴量なし
- 2022年以降: 潮位特徴量あり

**特徴量エンジニアリング**:
```python
# tide_* 特徴量を欠損値として扱う
# または、潮位データの有無を別の特徴量として追加
df['has_tide_data'] = df['tide_level'].notna()
```

### ステップ3: (オプション) 潮汐予測モデルの検討
必要に応じて、後から潮汐予測モデルで2015-2021年の潮位を推定することも可能

---

## まとめ

### 判明した事実
1. ❌ 気象庁RDMDBは2022年11月以降のみ
2. ❌ 気象庁潮位表も現時点では2015年データが取得不可
3. ✅ 2022年以降のデータ (6,475,040レコード) は取得済み
4. ⚠️ 紐付け率が低い (11%) → 改善の余地あり

### 作成済みスクリプト
- ✅ analyze_tide_data.py - データ状況分析
- ✅ link_tide_to_races.py - レース紐付け
- ✅ fetch_tide_for_races_only.py - RDMDB最適化版 (2022年以降用)
- ❌ fetch_tide_suisan.py - 潮位表取得 (データ提供されず、使用不可)

### 推奨される進め方
1. **2022年以降のデータ紐付けを完了** (約10-20分)
2. **潮位なしで機械学習を開始** (すぐに開始可能)
3. **必要に応じて潮汐予測モデルを検討** (後から実装可能)

---

## 次のステップ

### 即座に実行可能
```bash
# 2022年以降のデータ紐付け
python link_tide_to_races.py --start 2022-11-01 --end 2025-10-31

# 結果確認
python analyze_tide_data.py
```

### 機械学習の準備
```bash
# 特徴量エンジニアリング実行 (潮位の有無を考慮)
python feature_engineering.py

# モデル学習開始
python train_model.py
```

---

## 参考情報

### 気象庁データソース
- RDMDB: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/genbo/
- 潮位表: https://www.data.jma.go.jp/gmd/kaiyou/db/tide/suisan/

### データ状況
- **利用可能**: 2022年11月～2025年9月 (約3年分)
- **利用不可**: 2015年～2021年 (約7年分)
- **全レース**: 131,746レース
- **潮位データあり**: 7,844レース (6%)
- **潮位データなし**: 123,902レース (94%)

---

## 結論

**2015-2021年の潮位データは気象庁の公開データでは取得できません。**

しかし、これは**プロジェクトの進行を妨げるものではありません**。

- ✅ 2022年以降のデータは十分に活用可能
- ✅ 潮位以外の特徴量で高精度な予測が期待できる
- ✅ 必要に応じて後から潮汐予測モデルで補完可能

**推奨**: 現在のデータで機械学習を進め、精度を評価してから潮位データの必要性を判断する。
