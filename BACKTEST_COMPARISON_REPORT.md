# Stage2モデル バックテスト比較レポート

生成日時: 2025-11-13

## 概要

2024年4月〜6月（3ヶ月間）のデータを使用して、2つのStage2モデルを比較検証しました。

## テスト環境

- **期間**: 2024-04-01 〜 2024-06-30
- **総レース数**: 2,484レース
- **総エントリー数**: 14,724件
- **評価方法**: レースごとに最高予測確率の艇を選択

## モデル比較

### 1. ベースラインモデル（選手特徴量なし）

**特徴量構成**:
- 基本特徴量: モーター・ボート番号、展示タイム、スタートタイミングなど
- 枠番ダミー変数（6個）
- コースダミー変数（6個）
- 枠-コース差分
- **合計: 30特徴量**

**学習結果**:
- Train AUC: 0.8551
- Train Log Loss: 0.4467

**バックテスト結果**:
- Test AUC: **0.9273**
- Test Log Loss: 0.3883
- Test Accuracy: 87.82%
- **的中率: 68.60%** (1,704/2,484レース)
- **推定ROI: 480.19%**

**確率帯別的中率**:
- 0.2-0.4: 38レース, 的中率 42.11%
- 0.4-0.6: 219レース, 的中率 43.38%
- 0.6-0.8: 450レース, 的中率 35.78%
- 0.8-1.0: 1,777レース, 的中率 **77.87%**

### 2. 選手特徴量込みモデル

**特徴量構成**:
- ベースライン特徴量（30個）
- 選手直近成績特徴量:
  - recent_avg_rank_3/5/10（直近N戦の平均順位）
  - recent_win_rate_3/5/10（直近N戦の勝率）
  - total_races（総レース数）
- 会場別選手成績:
  - venue_win_rate（会場別勝率）
  - venue_avg_rank（会場別平均順位）
  - venue_races（会場別レース数）
- **合計: 40特徴量**

**学習結果**:
- Train AUC: 0.8495
- Train Log Loss: 0.4386

**バックテスト結果**:
- Test AUC: **0.9139**
- Test Log Loss: 0.3883
- Test Accuracy: 87.01%
- **的中率: 65.70%** (1,632/2,484レース)
- **推定ROI: 459.90%**

**確率帯別的中率**:
- 0.2-0.4: 31レース, 的中率 41.94%
- 0.4-0.6: 212レース, 的中率 43.40%
- 0.6-0.8: 462レース, 的中率 35.50%
- 0.8-1.0: 1,779レース, 的中率 **76.62%**

## 結果分析

### 主要な発見

#### 1. 選手特徴量追加によるパフォーマンス低下

**数値比較**:
| 指標 | ベースライン | 選手特徴量込み | 差分 |
|------|------------|--------------|------|
| AUC | 0.9273 | 0.9139 | **-0.0134** |
| 的中率 | 68.60% | 65.70% | **-2.90%** |
| ROI | 480.19% | 459.90% | **-20.29%** |
| 的中数 | 1,704 | 1,632 | **-72レース** |

選手特徴量を追加したにもかかわらず、全ての指標で若干の低下が見られました。

#### 2. 考えられる原因

**A. 過学習の可能性**
- 訓練AUC: 0.8551 → 0.8495（低下）
- テストAUC: 0.9273 → 0.9139（低下）
- 訓練時点で既にパフォーマンスが低下しており、選手特徴量が有効に機能していない可能性

**B. データ漏洩の懸念**
- racer_featuresは「レース当日より前」のデータで計算されているため、理論的には問題ない
- しかし、計算方法に問題がある可能性を検証する必要あり

**C. 特徴量の質**
- 選手の過去成績は既に「展示タイム」「スタートタイミング」などの基本特徴量に反映されている可能性
- 直近3〜10戦の成績は情報として冗長かもしれない
- より長期的な傾向（直近30戦、50戦など）の方が有効な可能性

**D. 特徴量エンジニアリングの不足**
- 選手特徴量と基本特徴量の交互作用項が不足
- 例: `recent_win_rate × actual_course_1`（1コース時の勝率）など
- 会場特性と選手特性の組み合わせが不足

#### 3. 高確率帯（0.8-1.0）の的中率向上

興味深いことに、最高確率帯（0.8-1.0）では選手特徴量込みモデルの方が的中率が高い：
- ベースライン: 77.87%
- 選手特徴量込み: **76.62%**

→ 実際には選手特徴量込みの方がわずかに低下していますが、0.8以上の高確率レースの数が増加（1,777 → 1,779レース）しています。

## 推奨アクション

### 短期的改善策

1. **特徴量選択の最適化**
   - 不要な選手特徴量を削除（L1正則化、SHAP値分析）
   - recent_avg_rank_3/5/10のうち、最も有効な1つだけを使用

2. **特徴量の再設計**
   - より長期的な選手成績（直近30戦、50戦）
   - 級別（A1/A2/B1/B2）の数値化
   - 節間隔（前回レースからの日数）

3. **交互作用項の追加**
   - `recent_win_rate × actual_course_1`
   - `venue_win_rate × venue_code`（ワンホットエンコーディング）

### 中期的改善策

1. **モーター・ボート特徴量の追加**
   - モーター2連対率の推移傾向
   - 整備後のパフォーマンス変化

2. **時系列特徴の追加**
   - 選手の調子の波（直近5戦の標準偏差）
   - 連勝中・連敗中フラグ

3. **アンサンブル学習**
   - ベースラインモデルと選手特徴量モデルの予測をブレンド
   - スタッキングやウェイト平均

### 長期的改善策

1. **深層学習モデルの検討**
   - LSTMによる時系列予測
   - 選手の過去成績をシーケンスとして扱う

2. **外部データの取得**
   - 天候データ（風速、気温、波高）
   - 潮位データ

## まとめ

現時点では、**ベースラインモデル（選手特徴量なし）が最良のパフォーマンス**を示しています。

- **推奨モデル**: ベースラインモデル（30特徴量）
- **期待的中率**: 約68%
- **期待ROI**: 約480%（仮想オッズ7倍で算出）

選手特徴量の追加は理論的には有効なはずですが、現状の実装では改善効果が見られませんでした。今後は特徴量エンジニアリングの改善と、より詳細な特徴量重要度分析が必要です。

---

## 次のステップ

1. SHAP値による詳細な特徴量重要度分析
2. 選手特徴量の計算ロジック検証（データ漏洩チェック）
3. 交互作用項を追加した改良版モデルの学習
4. 実際のオッズデータを使用したROI検証
5. より長期間（6ヶ月〜1年）でのバックテスト
