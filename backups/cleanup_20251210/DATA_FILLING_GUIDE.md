# データ補充実行ガイド

## 概要

このガイドは、ボートレースデータベースの不足データを補充するための実行手順をまとめたものです。

## 作成したスクリプト

### 1. fill_missing_data_v4_ultra.py (推奨)

**最高速版** - バッチDB更新とWALモードによる高速処理

- 処理速度: **1.5-2.0レース/秒**
- 並列度: 30ワーカー
- バッチサイズ: 200件
- レート制限: 30 req/sec

### 2. fill_missing_data_v3_fast.py

**高速版** - バッチDB更新による高速処理

- 処理速度: 1.0-1.5レース/秒
- 並列度: 20ワーカー
- バッチサイズ: 100件
- レート制限: 20 req/sec

### 3. fill_missing_data_v2.py

**基本版** - シンプルで安定した実装

- 処理速度: 0.5-0.8レース/秒
- 並列度: 8ワーカー
- レート制限: 12 req/sec

## 現在のデータ不足状況（2025-11-14時点）

| データタイプ | 不足数 | 推定時間(V4) |
|------------|-------|------------|
| race_details | 約25,000レース | 4-5時間 |
| results | 約10,700レース | 2時間 |
| payouts | 約36,500レース | 6時間 |

**総推定時間: 約12-13時間**

## 実行手順

### ステップ1: 現在のデータ状況を確認

```bash
python check_all_data_completeness.py
```

### ステップ2: race_details補充（最優先）

2022年を中心に不足データが集中しているため、まず2022年から処理：

```bash
# 2022年のrace_details補充（推奨: V4 Ultra）
python -u fill_missing_data_v4_ultra.py \
  --start 2022-01-01 \
  --end 2022-12-31 \
  --type details \
  --workers 30 \
  --rps 30 \
  --batch-size 200
```

**推定時間:** 約4-5時間

### ステップ3: 全期間のresults補充

```bash
# 全期間のresults補充
python -u fill_missing_data_v4_ultra.py \
  --start 2016-01-01 \
  --end 2025-11-12 \
  --type results \
  --workers 30 \
  --rps 30 \
  --batch-size 200
```

**推定時間:** 約2時間

### ステップ4: 全期間のpayouts補充

```bash
# 全期間のpayouts補充
python -u fill_missing_data_v4_ultra.py \
  --start 2016-01-01 \
  --end 2025-11-12 \
  --type payouts \
  --workers 30 \
  --rps 30 \
  --batch-size 200
```

**推定時間:** 約6時間

### ステップ5: 最終確認

```bash
# データ完全性チェック
python check_all_data_completeness.py
```

## コマンドラインオプション

### 基本オプション

| オプション | 説明 | デフォルト | 例 |
|----------|------|----------|-----|
| `--start` | 開始日（必須） | - | `2022-01-01` |
| `--end` | 終了日（必須） | - | `2022-12-31` |
| `--type` | データタイプ | `all` | `details`, `results`, `payouts` |
| `--limit` | 処理数上限 | なし | `1000` |

### パフォーマンスオプション

| オプション | 説明 | V4推奨値 | V3推奨値 | V2推奨値 |
|----------|------|---------|---------|---------|
| `--workers` | 並列処理数 | 30 | 20 | 8 |
| `--rps` | リクエスト/秒 | 30 | 20 | 12 |
| `--batch-size` | DBバッチサイズ | 200 | 100 | - |

## テスト実行（推奨）

本格的な実行の前に、小規模テストで動作確認：

```bash
# 50レース限定でテスト
python -u fill_missing_data_v4_ultra.py \
  --start 2022-01-01 \
  --end 2022-01-10 \
  --type details \
  --workers 10 \
  --rps 10 \
  --limit 50
```

## バックグラウンド実行（長時間処理用）

Windowsの場合、長時間処理はバックグラウンドで実行推奨：

```powershell
# PowerShellでバックグラウンド実行
Start-Process python -ArgumentList "-u", "fill_missing_data_v4_ultra.py", `
  "--start", "2022-01-01", `
  "--end", "2022-12-31", `
  "--type", "details", `
  "--workers", "30", `
  "--rps", "30", `
  "--batch-size", "200" `
  -NoNewWindow -RedirectStandardOutput "log_details.txt"
```

## 進捗確認

スクリプトは100レースごとに進捗を表示：

```
[OK] 100/25000 (0.4%) | 会場07 2022-01-03 5R | 1.8レース/秒 | 残り3.8時間
```

## トラブルシューティング

### 処理が遅い場合

1. **workers数を減らす**: サーバー負荷が高い可能性
   ```bash
   --workers 15  # 30 → 15に減らす
   ```

2. **rps（レート制限）を減らす**: 接続エラーが多発する場合
   ```bash
   --rps 15  # 30 → 15に減らす
   ```

3. **V3やV2にダウングレード**: より安定した動作が必要な場合

### エラーが多発する場合

- ネットワーク接続を確認
- サーバーのレート制限に引っかかっている可能性
  - `--rps`を減らす（例: 10）
  - `--workers`を減らす（例: 10）

### データベースロックエラー

- 他のプロセスがDBにアクセスしていないか確認
- バッチサイズを減らす: `--batch-size 50`

## パフォーマンス比較

| バージョン | 速度 | 特徴 | 推奨用途 |
|----------|------|------|---------|
| V4 Ultra | 1.5-2.0レース/秒 | 最高速、WAL | 本番（大量データ）|
| V3 Fast | 1.0-1.5レース/秒 | 高速、バッチ | 本番（中量データ）|
| V2 | 0.5-0.8レース/秒 | 安定 | テスト・少量データ |

## 推定完了時間（V4 Ultra使用時）

現在の不足データ（約72,000レース）を1.7レース/秒で処理した場合：

- **race_details (25,000)**: 約4.1時間
- **results (10,700)**: 約1.7時間
- **payouts (36,500)**: 約6.0時間
- **合計**: 約11.8時間

## 注意事項

1. **サーバー負荷**: 高速処理はサーバーに負荷をかけるため、適切なレート制限を守ること
2. **長時間実行**: 処理中にPCをスリープさせないこと
3. **ディスク容量**: 十分な空き容量があることを確認
4. **バックアップ**: 実行前にデータベースのバックアップを推奨

## 関連スクリプト

- `check_all_data_completeness.py`: データ完全性チェック
- `analyze_missing_data.py`: 不足データの詳細分析
- `fix_st_times_optimized.py`: ST時間データ専用補充（参考）

## 作成日

2025-11-14

## 変更履歴

- 2025-11-14: 初版作成
  - V2, V3, V4の3バージョンを作成
  - V4で2.8倍の高速化を達成
