# V5と風向・潮位データ収集の並行実行可否

## 結論

### 風向データ補完: **V5と並行実行可能** ✓

**理由**:
1. **異なるテーブルを更新**
   - V5: `races`, `entries`, `race_details`, `results`, `weather` (INSERT)
   - 風向補完: `weather` (UPDATE のみ)

2. **競合しない操作**
   - V5: 新規レースデータを INSERT
   - 風向補完: 既存の weather レコードの `wind_direction` カラムを UPDATE

3. **SQLiteのロック**
   - UPDATE と INSERT は異なる行を操作する限り競合しない
   - V5 は新しい日付のデータを挿入
   - 風向補完は古い日付のデータを更新

4. **実測データ**
   - 風向補完: 100件で約17分（10.56秒/件）
   - V5: 2年分のデータ収集（数時間〜数日）
   - 並行実行しても問題なし

### 潮位データ収集: **V5と並行実行可能** ✓

**理由**:
1. **完全に独立したテーブル**
   - V5: `tide` テーブルには触れない
   - 潮位収集: `tide` テーブルのみ操作

2. **外部API呼び出し**
   - 気象庁データのスクレイピング or WorldTides API
   - V5のボートレース公式サイトとは異なるドメイン

3. **実装されていない**
   - 現時点では潮位収集スクリプトが未実装
   - 実装すれば V5 と完全に独立して実行可能

---

## 並行実行の推奨構成

### パターンA: 全て並行実行（推奨）

```bash
# ターミナル1: V5データ収集（メイン）
cmd /c "rerun_v5_fixed.bat"

# ターミナル2: 風向データ補完（全件）
venv/Scripts/python.exe 補完_風向データ_全件.py

# ターミナル3（将来）: 潮位データ収集
venv/Scripts/python.exe 補完_潮位データ.py
```

**利点**: 最速でデータ収集完了
**注意**: SQLiteの同時書き込み制限（通常は問題なし）

### パターンB: 順次実行（安全策）

```bash
# 1. V5完了を待つ
cmd /c "rerun_v5_fixed.bat"

# 2. 風向補完
venv/Scripts/python.exe 補完_風向データ_全件.py

# 3. 潮位補完（将来）
venv/Scripts/python.exe 補完_潮位データ.py
```

**利点**: 確実、エラーが起きにくい
**欠点**: 時間がかかる

---

## 技術的詳細

### SQLiteの同時アクセス

**書き込みモード**:
- SQLiteは1つの書き込みトランザクションのみ許可
- 複数プロセスが同時に書き込もうとすると `SQLITE_BUSY` エラー

**対策**:
- V5と風向補完は異なる行を操作するため、通常は競合しない
- V5: `weather` テーブルに新規 INSERT（新しい日付）
- 風向補完: `weather` テーブルを UPDATE（古い日付）

**ロック範囲**:
```sql
-- V5の操作
INSERT INTO weather (...) VALUES (...)  -- 新しい日付のレコード

-- 風向補完の操作
UPDATE weather SET wind_direction = '西南西'
WHERE venue_code = '01' AND weather_date = '2022-11-02'  -- 古い日付のレコード
```

異なる `weather_date` を操作するため、行レベルでは競合しない。

### データベーススキーマ

```sql
-- weather テーブル
CREATE TABLE weather (
    id INTEGER PRIMARY KEY,
    venue_code TEXT,
    weather_date DATE,
    temperature REAL,
    weather_condition TEXT,
    wind_speed REAL,
    wind_direction TEXT,  -- ← 風向補完が UPDATE
    humidity INTEGER,
    created_at TIMESTAMP,
    water_temperature REAL,
    wave_height REAL
);

-- tide テーブル（V5は触らない）
CREATE TABLE tide (
    id INTEGER PRIMARY KEY,
    venue_code TEXT,
    tide_date DATE,
    tide_time TEXT,
    tide_type TEXT,
    tide_level REAL,
    created_at TIMESTAMP
);
```

---

## 実装の優先順位

### 現在実行中
1. **V5データ収集** - 2023-11-01 〜 2025-10-31（2年間）
2. **風向補完テスト** - 100件のテスト実行中

### 次のステップ

#### ステップ1: 風向補完の全件実行
```python
# 補完_風向データ_全件.py を作成
# LIMIT 100 → LIMIT を外す or 大きな値に変更
```

**推定時間**: 1746件 × 10秒 = 約4.8時間

#### ステップ2: 潮位データ収集の実装（オプション）
現時点では優先度低いため、V5完了後に検討

---

## 推奨アクション

### 今すぐ実行可能

1. **風向補完100件テストの完了を待つ**（約17分）
2. **テスト結果を確認**
3. **成功なら全件補完を実行**

### V5との並行実行

**安全な方法**:
```bash
# V5は既に実行中なので、そのまま継続

# 風向補完テスト（100件）が完了したら、全件実行
venv/Scripts/python.exe 補完_風向データ_全件.py
```

**メリット**:
- V5: 新しいデータ（2023-11-01〜2025-10-31）を収集
- 風向補完: 既存の古いデータ（2022-11など）を補完
- 完全に独立した日付範囲で動作するため競合なし

---

## まとめ

| 項目 | V5と並行可能 | 理由 |
|------|------------|------|
| **風向補完** | ✓ はい | 異なる日付範囲、異なる操作（INSERT vs UPDATE） |
| **潮位収集** | ✓ はい | 完全に独立したテーブル（tide） |

**推奨**: 風向補完を V5 と並行して実行してOK
