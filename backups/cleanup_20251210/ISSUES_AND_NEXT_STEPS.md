# 課題と次のステップ

**作成日**: 2025年10月29日
**現在の状況**: データ取得中（7場/24場完了、約29%）

---

## 📊 今日の実装結果サマリー

### ✅ 完了した実装（6/7項目が正常動作）

1. **チルト角度の完全取得** ✅
   - 改善前: 1艇のみ
   - 改善後: 6艇すべて
   - 問題: 各艇のデータが別々のtbodyに格納されていた
   - 解決: 全tbodyをループ処理

2. **部品交換情報の取得** ✅ NEW
   - 6艇すべて取得成功
   - データ: R（交換済み）など
   - 場所: beforeinfoページ、セル[8]

3. **展示タイムの取得** ✅
   - 既存機能、6艇すべて正常動作

4. **STタイムの取得** ⚠️ NEW（部分的に成功）
   - 取得: 5艇/6艇
   - 問題: 6艇目が取得できない（後述）
   - 場所: raceresultページ

5. **払戻金データの取得** ✅ NEW
   - 7種類すべて取得成功
   - 3連単、3連複、2連単、2連複、拡連複、単勝、複勝
   - 金額と人気も取得

6. **決まり手の取得** ✅ NEW
   - 正常動作
   - データ: 逃げ、差し、まくり、まくり差し等

7. **実際の進入コースの取得** ✅
   - 既存機能、6艇すべて正常動作

---

## ⚠️ 現在の課題

### 優先度: 高

#### 1. **STタイムが5艇しか取得できない問題**

**現象**:
```
テスト対象: 下関 10/28 5R
取得成功: 5艇/6艇
```

**考えられる原因**:
1. HTMLページに実際に5艇分しかデータがない
   - フライング（F）で失格した艇がいる
   - 欠場した艇がいる
   - スタート展示を行わなかった艇がいる

2. HTML構造の解析ミス
   - 6艇目のデータが特殊な構造になっている
   - 取得ロジックが6艇目を見落としている

**調査方法**:
```python
# beforeinfo_debug.htmlを確認
# table1_boatImage1TimeInner クラスの出現回数を確認
# → 実際に6個あるかチェック
```

**対応方針**:
- 明日、実際のHTMLページを複数レース分確認
- 6艇分のデータが常に存在するかを検証
- 存在しない場合は「Noneでも問題なし」と判断
- 存在する場合はロジックを修正

**影響**:
- 予測精度への影響: 小（STタイムは参考程度）
- システムへの影響: なし（5/6艇でも動作可能）

---

### 優先度: 中

#### 2. **データ取得スクリプトへの新機能統合**

**現状**:
- `fetch_3months_with_details_tonight.py` は実行中
- 新しく実装した機能（払戻金、決まり手、STタイム）は含まれていない

**必要な作業**:
1. 現在のデータ取得を完了させる（残り17場）
2. 新機能を統合した新しいスクリプトを作成
3. 必要に応じて追加データ取得を実行

**スケジュール案**:
- 現在の取得: 今晩完了予定（8〜10時間）
- 新スクリプト作成: 明日
- 追加データ取得: 明日の晩（必要に応じて）

---

## 📝 明日の実装予定

### 優先度順

#### 1. **スタートタイミング詳細（F/L情報）の取得** 🔥
- 実装難易度: 低
- 取得元: raceresultページ（STタイムと同じテーブル）
- データ: F（フライング）、L（レイト/出遅れ）
- 所要時間: 1時間
- 用途: スタート力の正確な評価

#### 2. **STタイム6艇目問題の調査と解決** 🔥
- 実装難易度: 低〜中
- 所要時間: 1〜2時間
- 複数レースで検証が必要

#### 3. **オッズ情報の取得** 🟡
- 実装難易度: 中
- 取得元: 別ページ（odds3t等）へのアクセスが必要
- データ: 締切直前の3連単、3連複、2連単等のオッズ
- 所要時間: 2〜3時間
- 用途: 人気と実力のギャップ分析、期待値計算

#### 4. **直近成績・節間成績の取得** 🟡
- 実装難易度: 中
- 取得元: racelistページ（詳細エリア）
- データ: 直近の着順履歴、今節での成績
- 所要時間: 2〜3時間
- 用途: 調子の良し悪しを判断

#### 5. **データベーススキーマの拡張**
- 新しいデータを保存するためのテーブル設計
- 払戻金テーブル（payouts）
- 決まり手の追加（resultsテーブルに列追加）
- STタイムの追加（race_detailsテーブルに既に列あり）

#### 6. **統合データ取得スクリプトの作成**
- すべての新機能を含むスクリプト
- エラーハンドリングの強化
- 進捗状況の詳細表示

---

## 🔄 データ取得の今後の方針

### オプション1: 増分取得（推奨）
- 現在の取得が完了した後
- 新機能で取得できるデータのみを追加取得
- 対象: 既に取得済みのレース（約26,000レース）
- メリット: 時間の節約、既存データを活かせる

### オプション2: 全データ再取得
- すべてのデータを最初から取り直す
- メリット: データの整合性が保証される
- デメリット: 再度8〜10時間かかる

### 推奨: オプション1（増分取得）
理由:
- 展示タイム、チルト、部品交換、進入コースは既に取得済み
- 追加が必要なのは払戻金、決まり手、STタイムのみ
- レース結果ページに1回アクセスすれば3つとも取得可能

---

## 🗄️ データベース設計の変更が必要な項目

### 1. 払戻金テーブル（新規作成）

```sql
CREATE TABLE payouts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    race_id INTEGER NOT NULL,
    bet_type TEXT NOT NULL,        -- 'trifecta', 'trio', 'exacta', etc.
    combination TEXT,               -- '1-3-2', '1=2=3', etc. (単複勝はNULL)
    pit_number INTEGER,             -- 単勝・複勝用
    amount INTEGER NOT NULL,        -- 払戻金額（円）
    popularity INTEGER,             -- 人気
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (race_id) REFERENCES races(id),
    UNIQUE(race_id, bet_type, combination, pit_number)
);
```

### 2. resultsテーブルへの列追加

```sql
ALTER TABLE results ADD COLUMN kimarite TEXT;  -- 決まり手
```

### 3. race_detailsテーブル
- `st_time` 列は既に存在（実装済み）
- 変更不要

---

## 📈 予測モデルへの影響（期待効果）

### 追加データの活用方法

#### 1. **チルト角度** → モーター調整の評価
- 攻めのチルト（プラス）vs 守りのチルト（マイナス）
- 選手の戦略分析

#### 2. **部品交換** → モーター不調の検出
- 交換直後は不安定な可能性
- 連続交換は機力の低さを示唆

#### 3. **払戻金データ** → 期待値計算
- 人気と実力の乖離を検出
- 高配当レースの特徴分析

#### 4. **決まり手** → 戦法の傾向分析
- 選手の得意な戦法
- コース別の決まり手傾向
- スタート力との相関

#### 5. **STタイム** → スタート力の評価
- 展示タイムとの組み合わせで総合評価
- スタートが得意な選手の識別

---

## 🐛 既知の問題（優先度: 低）

### 1. **XMLParsedAsHTMLWarning**
- 現象: 大量の警告メッセージ
- 影響: なし（動作に問題なし）
- 対策: 必要に応じて警告を抑制
  ```python
  warnings.filterwarnings("ignore", category=XMLParsedAsHTMLWarning)
  ```

### 2. **UnicodeEncodeError (cp932)**
- 現象: コンソール出力時の文字化け
- 影響: 表示のみ（処理は正常）
- 対策: チェックマーク等の特殊文字を使わない

### 3. **チルトの取得が不完全だった理由**
- 問題: 各艇のtbodyが別々に存在することを想定していなかった
- 解決済み: 全tbodyをループ処理するよう修正

---

## 💡 将来の改善案（優先度: 低）

### 1. **リトライ機能の実装**
- ネットワークエラー時の自動リトライ
- 指数バックオフ戦略

### 2. **並列処理の導入**
- 複数の競艇場を同時に取得
- 取得時間の短縮（要注意: サーバー負荷）

### 3. **キャッシュ機能**
- 一度取得したページをキャッシュ
- 再実行時の高速化

### 4. **エラーログの詳細化**
- 失敗したレースの情報を記録
- 後で再取得できるようにする

---

## 📊 現在のデータ取得状況

**実行中**: `fetch_3months_with_details_tonight.py`

- **期間**: 2024年10月1日〜12月31日
- **進捗**: 7場/24場完了（約29%）
- **取得済みレース**: 455レース
- **推定残り時間**: 6〜7時間

**取得中のデータ**:
- ✅ 出走表（選手情報、モーター、ボート）
- ✅ レース結果
- ✅ 天気情報
- ✅ 展示タイム（6艇）
- ✅ チルト角度（6艇）✨NEW
- ✅ 部品交換（6艇）✨NEW
- ✅ 実際の進入コース（6艇）

**未取得のデータ**（明日以降に追加取得予定）:
- ❌ 払戻金（7種類）
- ❌ 決まり手
- ❌ STタイム

---

## 🎯 最終ゴール

### フェーズ2: データ収集の完成（今週中）
- [x] チルト角度の完全取得
- [x] 部品交換情報の取得
- [x] 払戻金データの取得
- [x] 決まり手の取得
- [ ] STタイムの完全取得（6艇）
- [ ] スタートタイミング詳細（F/L）
- [ ] オッズ情報の取得
- [ ] 直近成績の取得

### フェーズ3: データ分析・予測モデル（来週〜）
- [ ] データの可視化
- [ ] 基本統計量の算出
- [ ] 特徴量エンジニアリング
- [ ] 機械学習モデルの構築
- [ ] 予測精度の評価

---

## 📞 確認事項

### ユーザーへの質問

1. **STタイム6艇目問題について**
   - 5/6艇の取得で問題ないか？
   - それとも完璧に6艇取得できるまで修正するか？

2. **データ取得の方針**
   - 現在の取得完了後、増分取得で追加データを取るか？
   - それとも全データを再取得するか？

3. **優先順位**
   - オッズ情報は必要か？（別ページアクセスが必要で時間がかかる）
   - 直近成績は必要か？（実装難易度が中程度）

4. **データ分析フェーズへの移行タイミング**
   - データ収集を完璧にしてから分析に移るか？
   - 現在のデータで分析を開始するか？

---

**次回セッション時の優先タスク**:
1. STタイム6艇目問題の調査
2. スタートタイミング詳細（F/L）の実装
3. データベーススキーマの拡張
4. 統合データ取得スクリプトの作成

**最終更新**: 2025年10月29日 23:50
