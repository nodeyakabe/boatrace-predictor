# 競艇予測システム 仕様書

**バージョン**: 1.0
**作成日**: 2025年11月3日
**目的**: 他AIへの説明・改善提案受領用

---

## システム概要

### 目的
全国24競艇場のレースデータを統計分析・機械学習により解析し、期待値プラスの買い目を自動推奨するシステム

### 最重要目標
**「1週間購入し続けたら回収率130%を達成」**
個別レースの的中率ではなく、長期的な投資回収率（ROI）の最大化を目指す

### 技術スタック
- **言語**: Python 3.8+
- **UI**: Streamlit
- **DB**: SQLite
- **ML**: XGBoost, LightGBM
- **スクレイピング**: BeautifulSoup4, requests
- **データ処理**: pandas, numpy

---

## アーキテクチャ

```
BoatRace/
├── src/
│   ├── scraper/        # データ収集（17ファイル）
│   ├── database/       # SQLite管理（5ファイル）
│   ├── analysis/       # 統計分析（19ファイル）
│   ├── ml/             # 機械学習（5ファイル）
│   ├── betting/        # Kelly基準戦略（1ファイル）
│   └── utils/          # ユーティリティ（6ファイル）
├── ui/                 # Streamlit UI（8ファイル）
├── data/               # SQLiteデータベース
└── config/             # 設定ファイル
```

**総コード行数**: 約26,000行
**総ファイル数**: 140+ファイル

---

## 機能構成

### 1. データ収集機能

#### 収集データ
- レース基本情報（日程・会場・グレード）
- 出走表（選手情報・級別・勝率）
- モーター/ボート情報（2連率・3連率）
- レース結果（着順・決まり手）
- 展示タイム・STタイム・チルト角度
- 天候データ（気温・風速・風向・波高・水温）
- 潮位データ（満潮・干潮・潮位変動）
- オッズ情報（三連単）
- 払戻金データ（7種類の舟券）

#### 収集方法
- **スクレイピング**: BOATRACE公式サイト（https://www.boatrace.jp/）
- **外部API**: RDMDB（気象庁）潮位データ
- **並列処理**: ProcessPoolExecutor（10並列）
- **エラー処理**: リトライ機能、フォールバック機構

#### データベース設計
```sql
-- 主要テーブル
races          -- レース基本情報
entries        -- 出走表（選手・モーター・ボート）
results        -- レース結果（着順・決まり手）
race_details   -- レース詳細（展示タイム・ST・チルト）
weather        -- 天候データ
payouts        -- 払戻金
rdmdb_tide     -- 潮位データ（30秒間隔）
venue_rules    -- 競艇場ルール
racer_rules    -- 選手ルール
```

---

### 2. データ分析機能

#### 統計分析
- **会場分析**: コース別勝率、決まり手分布、インコース有利度
- **選手分析**: 級別成績、当地相性、直近成績
- **モーター分析**: 2連率・3連率、部品交換履歴
- **決まり手分析**: コース別決まり手確率
- **時間帯分析**: 午前/午後/ナイターの傾向
- **天候・潮位相関**: 風速・潮位と着順の関係

#### 特徴量エンジニアリング
**Phase 1**: 基本特徴量（実装済み）
- コース別基礎点（1コース:50点、2コース:20点...）
- 選手級別スコア（A1:30点、A2:20点...）
- 選手勝率 × 3
- モーター2連率 × 0.3
- 展示タイム評価（6.5秒以下:10点、6.7秒以下:5点）

**Phase 2**: 相関特徴量（実装済み）
- 決まり手適性スコア
- グレード適性スコア
- 会場別過去成績

**Phase 3.3**: 高度な特徴量（未実装）
- 直近N戦の平均着順
- 当地相性スコア
- 天候・水面条件との相関

---

### 3. 機械学習機能

#### Stage1: レース選別モデル（実装済み）
**目的**: 購入すべきレースを選別
**モデル**: XGBoost（バイナリ分類）
**評価指標**: AUC, F1スコア
**出力**: buy_score（0-1）

#### Stage2: 着順予測モデル（部分実装）
**目的**: 各艇の着順を予測
**モデル**: XGBoost（マルチクラス分類）
**評価指標**: Log Loss, 的中率
**出力**: 各艇の1着確率

#### 確率校正（実装済み）
**手法**: Platt Scaling / Isotonic Regression
**目的**: 予測確率の信頼性向上
**評価**: Brier Score, Log Loss

#### SHAP説明可能性（未実装）
**目的**: 予測根拠の可視化
**状態**: ライブラリ未インストール

---

### 4. ベッティング戦略

#### Kelly基準戦略（実装済み）
**アルゴリズム**: Kelly Criterion
**式**: `f* = (p * odds - 1) / (odds - 1)`

**パラメータ**:
- Kelly分数: 0.25（保守的設定）
- 最小期待値: 1.0
- 最小buy_score: 0.5

**出力**:
- 推奨賭け金
- 期待値
- エッジ（優位性）
- ROI予測

#### ポートフォリオ最適化（基本実装）
- 複数レースへの資金配分
- リスク分散
- 最大ドローダウン制限

---

### 5. UI機能（Streamlit）

#### タブ構成
1. **ホーム**: 本日のおすすめレース一覧
2. **リアルタイム予想**: 今日の開催レース予想
3. **場攻略**: 会場別統計分析
4. **選手**: 選手情報・成績分析
5. **モデル学習**: ML モデルの学習・評価
6. **バックテスト**: 予想ロジックの検証
7. **設定・データ管理**: 各種設定とデータ収集

#### 主要機能
- 会場選択（24場ボタン）
- 日付選択（カレンダー）
- リアルタイム予想表示
- Kelly基準による購入推奨
- 統計グラフ表示（plotly）
- データエクスポート（CSV/Excel/JSON）

---

## 現在の実装状況

### 完成している機能 ✅
- データ収集（レース・選手・天候・潮位）
- データベース管理
- 基本統計分析
- Stage1 レース選別モデル
- 確率校正機能
- Kelly基準戦略
- バックテスト機能
- Streamlit UI（基本）

### 未実装・未完成の機能 ⚠️
- **Stage2 モデル学習機能**（`ui/components/model_training.py:299`）
- **モデル評価タブ**（`ui/components/model_training.py:339`）
- **予想シミュレーション**（`ui/components/model_training.py:356`）
- **Phase 3.3 特徴量生成**（`src/analysis/feature_generator.py:137`）
- **オッズAPI実装**（モックオッズで動作中）
- **購入実績記録機能**（未実装）

---

## 既知の問題点

### 修正済み（2025-11-03）✅
1. SQL構文エラー（12箇所）
2. SQLインジェクション脆弱性（2ファイル）
3. モジュールインポートエラー（1箇所）

### 残存する問題

#### 優先度: 高
- モジュール重複設計（`analysis/` ⇔ `analyzer/`）
- スクレイパー乱立（17ファイル、バージョン管理曖昧）
- 例外処理不足（多数のファイルで `except: pass`）

#### 優先度: 中
- Windowsパス依存（`venv/Scripts/python.exe`）
- SessionState管理不足
- ハードコーディング値
- 型ヒント不足

#### 優先度: 低
- テストコード不足
- ドキュメント不足
- パフォーマンス最適化

---

## データフロー

```
[公式サイト] → [スクレイパー] → [SQLite DB] → [分析エンジン]
                                      ↓
                              [特徴量生成]
                                      ↓
                              [MLモデル予測]
                                      ↓
                              [Kelly戦略]
                                      ↓
                              [Streamlit UI] → [ユーザー]
```

---

## 性能指標

### データ取得
- **速度**: 10並列で約0.3タスク/秒
- **エラー率**: 0.1%未満
- **取得期間**: 2022-11-01 ～ 2025-10-31（約3年）

### データベース
- **サイズ**: 約86MB（潮位データ追加後200MB見込み）
- **レース数**: 約29,462件
- **エントリー数**: 約176,772件（6艇 × 29,462レース）

### 予測精度（目標）
- **的中率**: 80%以上
- **回収率**: 130%
- **ROI**: +30%

---

## 運用方針

### データ更新
- **過去データ**: 一度取得すれば更新不要
- **当日データ**: 競艇実施時のみ取得
- **頻度**: 不定期（毎日〜月1回）

### 自動化レベル
- レース抽出: 自動
- 買い目提示: 自動
- 購入判断: **手動**（完全自動化は目指さない）

### プラットフォーム
- **メイン**: Windows PC（ローカル）
- **スマホ**: 低優先度（将来検討）

---

## 改善提案を求める項目

### 1. アーキテクチャ設計
- モジュール重複の解消方法
- スクレイパーの統合戦略
- ディレクトリ構造の最適化

### 2. 機械学習モデル
- Stage2実装の最適アプローチ
- 特徴量エンジニアリングの改善
- モデル評価指標の追加

### 3. ベッティング戦略
- Kelly基準の最適化
- リスク管理の強化
- ポートフォリオ最適化

### 4. パフォーマンス
- データベースクエリ最適化
- 並列処理の改善
- キャッシング戦略

### 5. コード品質
- 例外処理のベストプラクティス
- テスト戦略
- ドキュメント整備

### 6. UI/UX
- ユーザビリティ向上
- レスポンシブデザイン
- データ可視化の改善

---

## 参考資料

- [CODE_ANALYSIS_REPORT.md](CODE_ANALYSIS_REPORT.md) - 全エラー解析
- [FIXES_APPLIED.md](FIXES_APPLIED.md) - 修正内容
- [HANDOVER.md](HANDOVER.md) - 開発引継ぎ資料
- [REMAINING_TASKS.md](REMAINING_TASKS.md) - 残タスク
- [boatrace_predictor_spec.md](boatrace_predictor_spec.md) - 初期仕様書

---

## 質問テンプレート

このシステムについて、以下の観点で改善提案をお願いします:

1. **設計面**: モジュール構成・アーキテクチャの改善点
2. **実装面**: 未実装機能の実装優先順位と方法
3. **性能面**: パフォーマンス向上のアプローチ
4. **保守面**: コード品質・テスト・ドキュメント
5. **機能面**: 追加すべき機能・削除すべき機能
6. **その他**: 見落としている重要な観点

---

**作成者**: Claude
**用途**: 他AIへの説明・改善提案受領
**最終更新**: 2025年11月3日
