# お昼離席中の作業プラン

**作成日**: 2024-10-30
**目的**: 離席中に止まらず自動で作業を進める

---

## 現状確認

### 実装完了
- ✅ selectolax移行（8-10倍高速化）
- ✅ リスク軽減策（User-Agent、ランダム待機、429監視）
- ✅ 4並列処理スクリプト

### 問題
- 並列処理スクリプトが出力を出さない（ProcessPoolExecutorの初期化問題？）
- 動作確認が必要

---

## 提案: 3段階のフォールバックプラン

### プランA: シンプル並列版（推奨）
**内容**:
- ProcessPoolExecutorを使わないシンプルな並列実装
- ThreadPoolExecutorまたは逐次処理で確実に動作
- selectolax使用で高速化

**所要時間**:
- 2並列: 5.9時間
- 1並列: 11.8時間

**メリット**:
- 確実に動作する
- デバッグ不要
- 離席中に完了する可能性が高い

**実装**: 今すぐ作成可能（10分）

---

### プランB: 既存スクリプトの修正
**内容**:
- fetch_parallel_v2.pyのデバッグ
- ProcessPoolExecutorの問題を修正
- 4並列で3時間完了

**所要時間**: 3.0時間（修正成功の場合）

**リスク**:
- デバッグに時間がかかる可能性
- 離席中にエラーで止まる可能性

---

### プランC: 安全策（selectolax単体）
**内容**:
- 並列処理なし
- selectolax + リスク軽減策のみ
- 確実に動作

**所要時間**: 11.8時間

**メリット**:
- リスクゼロ
- 確実に動作
- 離席中に完了（半日）

---

## 推奨プラン

### 最優先: プランA（シンプル並列版）

**理由**:
1. 確実に動作する
2. 適度な高速化（2並列で5.9時間）
3. リスクが低い
4. 離席中に完了する

**実装内容**:
```python
# シンプルな2並列実装
# - Thread 1: 競艇場01-12を処理
# - Thread 2: 競艇場13-24を処理
# - selectolax使用で高速化
# - エラーハンドリング強化
```

**実行コマンド**:
```bash
"venv\Scripts\python.exe" fetch_simple_parallel.py --start 2024-10-01 --end 2024-10-31 --workers 2
```

---

## 離席中の作業フロー

### ステップ1: シンプル並列版を実装（今すぐ）
- fetch_simple_parallel.py作成
- 2並列、selectolax使用
- エラーハンドリング強化

### ステップ2: テスト実行（1レース）
- 動作確認
- エラーがないことを確認

### ステップ3: バックグラウンドで実行
```bash
"venv\Scripts\python.exe" fetch_simple_parallel.py --start 2024-10-01 --end 2024-10-31 --workers 2 &
```

### ステップ4: 監視スクリプト作成
- 進捗を自動記録
- エラーを検知して自動リトライ
- ログファイルに記録

---

## 離席中のチェックポイント

### 30分後
- 進捗確認（何レース完了したか）
- エラーチェック
- 429エラーが出ていないか

### 1時間後
- 速度確認（何レース/分）
- 残り時間の再計算
- 問題があればフォールバック

### 2時間後
- 半分完了しているはず
- 順調なら継続
- 問題があれば1並列版に切り替え

---

## フォールバックシナリオ

### シナリオ1: 429エラー発生
**対応**:
- 自動で30分待機
- 並列数を1に減らして再開

### シナリオ2: その他のエラー
**対応**:
- エラー内容をログ記録
- 1並列版に自動切り替え
- 継続実行

### シナリオ3: 速度が遅い
**対応**:
- 2並列 → 3並列に増やす
- ただし429エラーに注意

---

## 戻ってきた時の確認事項

### チェック1: 進捗確認
```bash
# DBのレコード数を確認
sqlite3 data/boatrace.db "SELECT COUNT(*) FROM races WHERE race_date LIKE '202410%'"
```

### チェック2: ログ確認
```bash
# エラーログを確認
cat fetch_log.txt | grep ERROR
```

### チェック3: 残り時間計算
- 完了レース数から残り時間を計算
- 追加対応が必要か判断

---

## 次のアクション

**今すぐやること**:
1. ✅ この計画をレビュー
2. シンプル並列版を実装（10分）
3. テスト実行（2分）
4. バックグラウンドで実行開始
5. 監視スクリプト作成（5分）
6. 離席

**合計**: 約20分で準備完了

---

**質問**: この方向で進めて良いですか？
