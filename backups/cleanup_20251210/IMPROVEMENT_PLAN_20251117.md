# 競艇予測システム改善計画 2025-11-17

## 現状分析
- システム規模: 約140ファイル、26,000行
- データセット: 131,746レース（2015年11月〜2025年10月）
- 既存構造: XGBoost/LightGBM + アンサンブル + 特徴量エンジニアリング
- **核心的課題**: 1着予測のみで2着・3着の条件付きモデルが不足

---

## Phase 1: 基盤整備とデータ検証（推定期間: 7日）

### 1.1 データ品質検証と前処理パイプライン強化
- **目的**: 既存データの品質確認と前処理の統一化
- **実装内容**:
  - データ整合性チェック機能
  - 欠損値処理の統一化
  - 異常値検出と処理
- **新規ファイル**:
  - `src/validation/data_quality_checker.py`
  - `src/preprocessing/data_cleaner.py`
- **修正ファイル**:
  - `src/ml/dataset_builder.py`
- **テスト方法**:
  - 既存データセットに対して品質チェックを実行
  - 前後でモデル精度の変化を確認
- **期待効果**: データ品質向上によるベースライン精度の1-2%改善

### 1.2 進入コース予測データセット準備
- **目的**: 枠番と実際のコース取りのズレを予測するためのデータ準備
- **実装内容**:
  - 進入コース履歴データの集計
  - 選手別の進入傾向分析
  - コース取り成功率の算出
- **新規ファイル**:
  - `src/features/course_entry_features.py`
- **修正ファイル**:
  - `src/database/views.py`（進入データビューの追加）
- **テスト方法**:
  - 過去レースでの進入予測精度を検証
  - 枠番≠実コースの頻度分析
- **期待効果**: 実コース予測精度70%以上の達成

### 1.3 特徴量エンジニアリング基盤の拡張
- **目的**: 交互作用特徴量生成のための基盤整備
- **実装内容**:
  - 自動特徴量生成パイプライン
  - 交互作用特徴量テンプレート
  - 特徴量重要度の自動計算
- **新規ファイル**:
  - `src/features/interaction_features.py`
  - `src/features/feature_importance.py`
- **修正ファイル**:
  - `src/features/optimized_features.py`
- **テスト方法**:
  - 生成された特徴量の相関分析
  - SHAP値による重要度検証
- **期待効果**: 特徴量数を30%増加、有効特徴量の特定

---

## Phase 2: コアモデル改善（推定期間: 14日）

### 2.1 条件付き着順予測モデルの実装 ⭐ 最重要
- **目的**: 1着→2着→3着の段階的予測モデル構築
- **実装内容**:
  - 1着予測モデル（既存の改良）
  - 2着予測モデル（1着が確定した条件下）
  - 3着予測モデル（1着・2着が確定した条件下）
- **新規ファイル**:
  - `src/ml/conditional_rank_model.py`
  - `src/ml/model_stage2_place.py`
  - `src/ml/model_stage3_place.py`
- **修正ファイル**:
  - `src/ml/model_trainer.py`
  - `src/prediction/probability_integrator.py`
- **テスト方法**:
  - 各段階での予測精度測定
  - 三連単的中率のバックテスト
  - 条件付き確率の妥当性検証
- **期待効果**: 三連単精度2-3倍改善、期待値の正確性向上

### 2.2 進入コース予測モデルの実装
- **目的**: 実際のコース取りを高精度で予測
- **実装内容**:
  - XGBoostベースの進入予測モデル
  - 選手×枠番×会場の相性モデル
  - 動的な進入確率調整
- **新規ファイル**:
  - `src/ml/entry_course_predictor.py`
  - `src/prediction/course_adjustment.py`
- **修正ファイル**:
  - `src/prediction/integrated_predictor.py`
- **テスト方法**:
  - 実コース予測精度の測定
  - オッズとのズレ検証
- **期待効果**: コース予測精度75%以上、高EV機会の発見

### 2.3 交互作用特徴量の本格導入
- **目的**: 場×気象×潮×コースの複雑な関係性をモデル化
- **実装内容**:
  - 風速×枠番、風向×コース等の交互作用
  - 潮位×モーター性能の相関
  - 波高×体重の影響度
- **新規ファイル**:
  - `src/features/weather_interaction.py`
  - `src/features/venue_specific_features.py`
- **修正ファイル**:
  - `src/ml/dataset_builder.py`
  - `src/features/timeseries_features.py`
- **テスト方法**:
  - 天候依存性の高い会場での精度検証
  - 特徴量重要度の分析
- **期待効果**: AUC +0.02〜0.05改善

### 2.4 アンサンブル戦略の高度化
- **目的**: 複数モデルの効果的な統合
- **実装内容**:
  - XGBoost + LightGBM + CatBoostの統合
  - 動的重み付けメカニズム
  - 確信度ベースの投票システム
- **新規ファイル**:
  - `src/ml/advanced_ensemble.py`
  - `src/ml/catboost_trainer.py`
- **修正ファイル**:
  - `src/ml/ensemble_predictor.py`
  - `src/training/stage2_trainer.py`
- **テスト方法**:
  - 個別モデルvs統合モデルの性能比較
  - クロスバリデーション
- **期待効果**: 予測の安定性向上、外れ値予測の削減

---

## Phase 3: 高度な最適化（推定期間: 10日）

### 3.1 モーター/ボートEmbedding実装
- **目的**: 機材固有の特性を学習
- **実装内容**:
  - モーターIDのベクトル化
  - ボートIDのベクトル化
  - 時系列での性能変化追跡
- **新規ファイル**:
  - `src/features/equipment_embedding.py`
  - `src/ml/embedding_model.py`
- **修正ファイル**:
  - `src/features/racer_features.py`
- **テスト方法**:
  - Embedding空間の可視化
  - モーター性能予測の精度検証
- **期待効果**: モーター固有特性の捕捉、予測精度向上

### 3.2 スタッキングモデルの実装
- **目的**: 多層モデル構造による精度向上
- **実装内容**:
  - Layer1: 基本予測モデル群
  - Layer2: メタ学習器
  - 最終統合層
- **新規ファイル**:
  - `src/ml/stacking_model.py`
  - `src/ml/meta_learner.py`
- **修正ファイル**:
  - `src/prediction/integrated_predictor.py`
- **テスト方法**:
  - 各層の貢献度分析
  - 過学習の検証
- **期待効果**: 最終精度の3-5%改善

### 3.3 リスク調整とオッズ整合性
- **目的**: 実際の投資収益性の最大化
- **実装内容**:
  - オッズ逆算確率との整合性チェック
  - 買い目間の相関考慮
  - リスク調整期待値計算
- **新規ファイル**:
  - `src/betting/risk_adjuster.py`
  - `src/betting/odds_calibration.py`
- **修正ファイル**:
  - `src/betting/kelly_strategy.py`
  - `src/betting/bet_generator.py`
- **テスト方法**:
  - シミュレーションによる収益性検証
  - ドローダウンの分析
- **期待効果**: 回収率の安定化、リスク管理の向上

### 3.4 リアルタイム予測システムの強化
- **目的**: 本番環境での安定稼働
- **実装内容**:
  - 予測パイプラインの最適化
  - エラーハンドリング強化
  - 予測結果のモニタリング
- **新規ファイル**:
  - `src/monitoring/prediction_monitor.py`
  - `src/utils/error_handler.py`
- **修正ファイル**:
  - `src/prediction/realtime_system.py`
- **テスト方法**:
  - 負荷テスト
  - 異常系テスト
- **期待効果**: システム稼働率99%以上

---

## リスクと対策

### データリーケージのリスク
- **リスク**: 未来情報の混入による過大評価
- **対策**:
  - 時系列分割の徹底
  - 特徴量生成時の時点管理
  - バックテストでの厳密な検証

### 過学習のリスク
- **リスク**: 訓練データへの過適合
- **対策**:
  - クロスバリデーション
  - 正則化パラメータの調整
  - アーリーストッピング

### 既存システムへの影響
- **リスク**: 本番環境でのデグレード
- **対策**:
  - 段階的なデプロイ
  - A/Bテスト
  - ロールバック計画

### 計算リソースの制約
- **リスク**: 学習・予測時間の増大
- **対策**:
  - 特徴量の事前計算とキャッシング
  - モデルの軽量化
  - 並列処理の活用

---

## 成功指標

### Phase 1完了時点
- データ品質スコア: 95%以上
- 進入コース予測精度: 70%以上
- 特徴量数: 既存比130%

### Phase 2完了時点
- 三連単的中率: 既存比2倍以上
- AUC: 0.85以上（主要会場）
- 条件付きモデルの精度: 各段階で65%以上

### Phase 3完了時点
- 回収率: 110%以上（シミュレーション）
- システム稼働率: 99%以上
- 予測時間: 1レース1秒以内

---

## 実装スケジュール

### Week 1: 即座に着手すべきタスク
1. データ品質検証（Phase 1.1）
2. 進入コースデータ準備（Phase 1.2）

### Week 2-3: 中期タスク
1. 条件付き着順モデル（Phase 2.1）⭐最重要
2. 進入コース予測モデル（Phase 2.2）
3. 交互作用特徴量（Phase 2.3）

### Week 4: 後期タスク
1. スタッキング実装（Phase 3.2）
2. リスク調整（Phase 3.3）
3. システム統合テスト

---

## 技術的留意点

### モデル実装
- XGBoost/LightGBMの最新版使用
- GPUサポートの活用（可能な場合）
- ハイパーパラメータのOptunaチューニング

### データ処理
- SQLiteの制約を考慮したクエリ最適化
- メモリ効率的なバッチ処理
- 特徴量の段階的生成

### コード品質
- 単体テストの実装
- ドキュメンテーション
- 型ヒントの活用

---

## 最終目標

この計画により、既存システムを段階的に改善し、
**「的中率AI」から「安定的に130%回収を実現する投資AI」への進化**を実現する。

---

作成日: 2025-11-17
策定者: Claude AI (Opus + Sonnet)
