# 今晩の3ヶ月データ取得 - 実行ガイド

生成日時: 2025-10-29 17:50

## 準備完了状況

### データ取得テスト結果 ✅
- **複数競艇場テスト**: 5競艇場中3競艇場で成功（桐生、住之江、大村）
- **現在のDB状態**: 822件のデータ（5競艇場、8日分）
- **データ取得ロジック**: `/resultlist`エンドポイント使用で過去データ取得可能

### 実装済みファイル ✅
1. **`src/scraper/safe_historical_scraper.py`** - 安全モード対応スクレイパー
2. **`fetch_3months_tonight.py`** - 今晩実行用スクリプト
3. **`SAFE_SCRAPING_GUIDELINES.md`** - 安全ガイドライン

---

## 実行方法

### 1. コマンド

```bash
"venv\Scripts\python.exe" fetch_3months_tonight.py
```

### 2. 実行前確認

実行すると以下の確認メッセージが表示されます：

```
======================================================================
【今晩用】3ヶ月分データ取得
期間: 2024年10月1日 〜 2024年12月31日
対象: 全24競艇場
安全モード: ON（待機時間長め）
======================================================================

対象日数: 92日
推定所要時間: 約6〜8時間

開始時刻: 2025-10-29 XX:XX:XX

準備ができたらEnterキーを押してください...
```

Enterキーを押すと取得が開始されます。

---

## 取得スペック

### 対象期間
- **開始日**: 2024年10月1日
- **終了日**: 2024年12月31日
- **日数**: 92日

### 対象競艇場
全24競艇場（桐生、戸田、江戸川、平和島、多摩川、浜名湖、蒲郡、常滑、津、三国、びわこ、住之江、尼崎、鳴門、丸亀、児島、宮島、徳山、下関、若松、芦屋、福岡、唐津、大村）

### 安全設定
- **レース間待機**: 1秒
- **日付間待機**: 3秒
- **ランダム待機**: 0〜0.5秒
- **エラー率監視**: 10%超で自動一時停止
- **連続エラー対応**: 3回連続で30秒待機

---

## 推定データ容量

### 3ヶ月分（全24競艇場）
- **推定データ量**: 約40〜50MB
- **推定レコード数**: 約26,000件
- **ディスク空き容量**: 1GB以上推奨

### 現在のDB状態
- データ: 822件 = 約0.8MB
- 1年分見積もり: 約155MB

---

## 実行時間の見積もり

### 最適ケース（6時間）
```
92日 × 24競艇場 = 2,208日分
1日あたり10秒（1s待機）= 約6時間
```

### 安全ケース（8時間）
```
エラー処理、再試行込みで約8時間
```

### 推奨実行時間帯
- **深夜2時〜5時**: サーバー負荷が低い
- **平日**: 週末より混雑が少ない

---

## 進行状況の確認方法

### 1. リアルタイム表示
コンソールに以下の形式で進捗が表示されます：

```
[1/24] 桐生(01) 処理中...
桐生: 成功 92日 / 失敗 0日

[2/24] 戸田(02) 処理中...
...
```

### 2. データベース確認
別のターミナルで以下を実行：

```bash
"venv\Scripts\python.exe" monitoring_report.py
```

リアルタイムでDB内のデータ件数を確認できます。

---

## エラーハンドリング

### 自動対応
1. **エラー率10%超**: 10分間自動待機
2. **連続3回エラー**: 30秒待機
3. **HTTPエラー**: 自動リトライ（最大3回）

### 手動対応が必要な場合
以下のような表示が出た場合：

```
エラー率が高い - 実行を一時停止
10分間待機します...
```

→ 自動で再開されるので、そのまま待機してください

### 中断と再開
- **Ctrl+C**: 安全に中断可能
- **再開**: 同じコマンドで実行すると、既に取得済みのデータはスキップされます

---

## 完了後の確認

### 1. 最終レポート
実行完了時に以下が表示されます：

```
======================================================================
【最終レポート】
======================================================================
終了時刻: 2025-10-30 XX:XX:XX
成功: XXX日
失敗: XXX日
成功率: XX.X%
======================================================================

【データベース統計】
結果データ: XX,XXX件
競艇場数: 24場
日数: 92日

取得完了！
```

### 2. データ整合性チェック
```bash
"venv\Scripts\python.exe" monitoring_report.py
```

不完全なデータ（72件未満）があれば警告が表示されます。

---

## トラブルシューティング

### 問題: 「アクセス拒否」が頻発
**対策**:
- `src/scraper/safe_historical_scraper.py`の待機時間を増やす
- `self.race_wait = 1.0` → `2.0`
- `self.day_wait = 3.0` → `5.0`

### 問題: エラー率が高い
**対策**:
- 深夜時間帯に実行
- 翌日に残りを取得

### 問題: データが保存されていない
**対策**:
- `data/boatrace.db`のファイルサイズを確認
- `monitoring_report.py`でデータ件数を確認

---

## 次のステップ

### 3ヶ月取得後
1. **データ確認**: `monitoring_report.py`で完全性をチェック
2. **UI確認**: Streamlitで統計サマリーが正しく表示されるか確認
3. **残り9ヶ月**: 必要に応じて残りの期間を取得

### 1年分完了後
- 選手分析機能の統合（RacerAnalyzer）
- オッズ予測モデルの訓練
- UIの拡張（選手分析タブ）

---

## 注意事項

### ✅ やってOK
- 深夜に実行
- 途中で進捗確認
- エラー時に様子を見る

### ⚠️ 注意
- 日中の実行は避ける
- エラー率が高い場合は中断を検討
- 連続で何度も再実行しない

### ❌ やってはダメ
- 待機時間を0にする
- エラーを無視して強制継続
- 複数プロセスで同時実行

---

## まとめ

### 準備状況
- ✅ スクリプト準備完了
- ✅ 安全機能実装済み
- ✅ テスト成功（3競艇場）
- ✅ エラーハンドリング実装済み

### 実行タイミング
**推奨**: 今晩の深夜2〜5時

### 推定完了時刻
開始時刻 + 6〜8時間

例: 深夜2時開始 → 朝8〜10時完了

---

## 実行コマンド（再掲）

```bash
"venv\Scripts\python.exe" fetch_3months_tonight.py
```

**準備完了！実行してください！**
