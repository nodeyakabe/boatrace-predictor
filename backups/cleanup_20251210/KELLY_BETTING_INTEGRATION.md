# Kelly基準投資戦略 統合ガイド

## 概要

Kelly基準（Kelly Criterion）を使用した最適な賭け金配分システムをリアルタイム予想タブに統合しました。

このシステムは、期待値がプラスの買い目のみを選定し、資金に対して最適な賭け金を自動計算します。

---

## 実装内容

### 1. 新規追加ファイル

#### `src/betting/kelly_strategy.py`
Kelly基準の投資戦略を実装したコアモジュール

**主要クラス:**
- `KellyBettingStrategy`: Kelly基準での賭け金計算と買い目選定
- `ExpectedValueCalculator`: 期待値・エッジ・ROIの計算ユーティリティ

**主要機能:**
```python
# 期待値計算
ev = pred_prob × odds - 1.0

# Kelly formula
kelly_f = (b × p - q) / b
where:
  b = odds - 1 (純利益倍率)
  p = pred_prob (勝率)
  q = 1 - p (負率)

# Fractional Kelly (リスク調整)
adjusted_kelly_f = kelly_f × 0.25  # 1/4 Kelly推奨
```

#### `ui/pages/betting_recommendation.py`
購入推奨を表示するUIモジュール

**表示内容:**
- レース選別スコア（予想しやすさ）
- 推奨購入数と総賭け金
- 各買い目の詳細（期待値、Kelly分数、推奨額）
- 信頼度による色分け（High/Medium/Low）
- 期待値分析（損益分岐点、エッジ、ROI信頼区間）
- 結果シミュレーション
- 過去実績の統計表示

---

### 2. UI統合 (`ui/app.py` - Tab 2: リアルタイム予想)

#### 変更点

**Before:**
```python
prediction = race_predictor.predict_race(race_id)
# 単純な1-2-3着予想のみ表示
```

**After:**
```python
predictions_list = race_predictor.predict_race_by_key(date, venue, race_num)
# 詳細な予想 + Kelly基準の購入推奨を表示
```

#### 追加機能

1. **三連単組み合わせ確率の計算**
   - 上位6艇から組み合わせを生成（最大120通り）
   - 各艇のスコアを使用して確率を計算
   - 上位10組み合わせを抽出し正規化

2. **モックオッズの生成**
   - 予測確率から逆算（市場効率80%と仮定）
   - 実際のオッズAPIと置き換え可能な設計

3. **レース選別スコア**
   - 信頼度（confidence）をbuy_scoreとして使用
   - Stage1モデルと統合する準備完了

4. **資金設定**
   - ユーザーが資金を入力（1,000〜100,000円）
   - Kelly基準で最適配分を自動計算

5. **購入推奨の表示**
   - `render_betting_recommendations()`で詳細表示
   - 期待値、推奨額、信頼度を視覚的に提示

---

## 使用方法

### 基本的な流れ

1. **リアルタイム予想タブを開く**
   - 会場とレース番号を選択

2. **予想を確認**
   - 1-2-3着予想と信頼度を確認
   - 信頼度が高いほど予想しやすいレース

3. **資金を入力**
   - 購入に使える資金を入力（例: 10,000円）

4. **購入推奨を確認**
   - Kelly基準で計算された推奨買い目リストを確認
   - 各買い目の期待値、推奨額、信頼度をチェック

5. **購入戦略を決定**
   - 期待値がプラスの買い目のみ表示
   - 信頼度に応じて購入を判断（High/Medium/Low）

---

## Kelly基準のパラメータ

### デフォルト設定

```python
KellyBettingStrategy(
    bankroll=10000,          # 資金（円）
    kelly_fraction=0.25,     # Kelly分数（1/4 Kelly）
    min_ev=0.05,            # 最小期待値（5%以上）
    max_bet_ratio=0.2       # 最大賭け金比率（資金の20%）
)
```

### パラメータ調整（UI上で可能）

- **Kelly分数**: 0.1〜0.5（リスク許容度）
  - 0.25 = 1/4 Kelly（推奨、安全）
  - 0.5 = 1/2 Kelly（アグレッシブ）

- **最小期待値**: 0〜20%
  - 5%以上が推奨（期待値が低い買い目を除外）

- **最大購入数**: 1〜10点
  - リスク分散のため3〜5点推奨

---

## 信頼度の判定基準

### 買い目ごとの信頼度

```python
if ev > 0.15 and buy_score > 0.7:
    confidence = "High"      # 🟢 高信頼度
elif ev > 0.08 and buy_score > 0.5:
    confidence = "Medium"    # 🟡 中信頼度
else:
    confidence = "Low"       # 🔴 低信頼度
```

### レース選別スコア

```python
if buy_score > 0.7:
    "✅ 予想しやすいレース"
elif buy_score > 0.5:
    "⚠️ 通常のレース"
else:
    "❌ 予想困難なレース"
```

---

## 期待値の計算方法

### 基本公式

```
期待値 (EV) = pred_prob × odds - 1.0
```

**例:**
- 予測確率: 15%
- オッズ: 8.5倍
- 期待値 = 0.15 × 8.5 - 1.0 = 0.275 = **+27.5%**

### エッジ（優位性）

```
エッジ = (pred_prob - implied_prob) / implied_prob × 100
```

**例:**
- 予測確率: 15%
- オッズ: 8.5倍 → 市場確率 = 11.8%
- エッジ = (0.15 - 0.118) / 0.118 × 100 = **+27.1%**

---

## 今後の改善予定

### 短期（1〜2週間）

1. **実際のオッズAPI連携**
   - モックオッズを実際のオッズデータに置き換え
   - リアルタイムでオッズを取得

2. **Stage1レース選別モデルの統合**
   - `src/ml/race_selector.py`の予測を使用
   - buy_scoreを信頼度ベースから予測ベースに変更

3. **確率校正（Calibration）**
   - Platt ScalingまたはIsotonic Regression
   - 予測確率の精度向上

### 中期（3〜4週間）

1. **購入実績の記録と分析**
   - データベースに購入履歴を保存
   - ROI、勝率、最大ドローダウンを追跡

2. **バックテスト機能**
   - 過去データで戦略を検証
   - パラメータの最適化

3. **リスク管理の強化**
   - 資金推移のグラフ表示
   - シャープレシオの計算

### 長期（5〜6週間）

1. **ポートフォリオ最適化の高度化**
   - 相関を考慮した配分
   - シミュレーション（モンテカルロ法）

2. **自動購入システム**
   - API経由での自動購入（要検討）
   - アラート機能（高期待値レース通知）

---

## トラブルシューティング

### 期待値がプラスの買い目がない場合

```
⚠️ 期待値がプラスの買い目がありません。このレースは見送りを推奨します。
```

**原因:**
- 予測確率が低すぎる
- オッズが低すぎる
- min_evの閾値が高すぎる

**対策:**
1. min_evを下げる（例: 5% → 3%）
2. レースを変更する
3. データの質を確認

### 推奨賭け金が0円になる場合

**原因:**
- Kelly分数が小さすぎる
- 期待値が低い
- 資金が少ない

**対策:**
1. Kelly分数を上げる（例: 0.1 → 0.25）
2. 資金を増やす
3. 期待値の高い買い目を選ぶ

---

## 参考資料

### Kelly Criterion

- [Wikipedia - Kelly Criterion](https://en.wikipedia.org/wiki/Kelly_criterion)
- 最適な賭け金比率を計算する数学的公式
- 長期的な資金成長を最大化

### 期待値投資

- 期待値がプラス（EV > 0）の場合のみ投資
- 回収率110〜130%を目指す

### リスク管理

- Fractional Kelly（1/4 Kelly）でリスク削減
- 最大賭け金比率の制限（資金の20%）
- ポートフォリオ分散

---

## まとめ

Kelly基準の投資戦略を統合することで、以下のメリットを実現しました:

✅ **科学的な賭け金配分**: 期待値に基づいた最適配分
✅ **リスク管理**: Fractional Kellyでリスクを抑制
✅ **視覚的な判断支援**: 信頼度、期待値、エッジを明示
✅ **拡張性**: Stage1モデル、実際のオッズAPIと統合可能

このシステムを活用することで、感覚的な投資から**データドリブンな投資戦略**へと進化できます。

---

**作成日**: 2025-11-02
**バージョン**: 1.0
**次のステップ**: Stage1レース選別モデルの統合 → 実際のオッズAPI連携
