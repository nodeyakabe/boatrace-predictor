# プロジェクト全体レビュー - 2025年11月18日

**レビュー実施日**: 2025年11月18日
**対象**: BoatRace予測システム全体

---

## 📊 現在のプロジェクト状況

### データベース統計
- **総レース数**: 131,898レース
- **race_details数**: 630,471件
- **オリジナル展示データ**: 951件
- **最新データ日付**: 2025-11-17

### データ収集カバー率
- **レース基本データ**: 2016年〜2025-11-17（約10年分）
- **race_details**: ほぼ完全（130K以上）
- **オリジナル展示**: 極めて少ない（951件 = 全体の0.15%）← **改善の余地大**

---

## ✅ 本日完了した作業（オリジナル展示関連）

### 1. データ利用可能期間の調査・確認
- ドキュメントを調査し、「昨日と今日のみ」という制約を確認
- [docs/オリジナル展示データ利用可能期間_調査報告.md](オリジナル展示データ利用可能期間_調査報告.md)作成

### 2. UI連携向けスクリプトの改善
- [収集_オリジナル展示_日付指定.py](../収集_オリジナル展示_日付指定.py)
  - 日付検証機能を追加（2日前以前の警告）
  - ドキュメント文字列に制約を明記

### 3. ドキュメントの強化
- [オリジナル展示収集_UI連携ガイド.md](../オリジナル展示収集_UI連携ガイド.md)
  - 冒頭に⚠️警告セクション追加
  - データ利用可能期間を明記
  - UI推奨実装方法を記載
  - エラーハンドリング例を追加

---

## 🔴 発見された問題点

### 1. オリジナル展示データの極端な不足
**現状**:
- 総レース数: 131,898
- オリジナル展示データ: 951件（0.72%）

**原因**:
- データは「昨日と今日」のみ公開される
- 日次自動収集が未設定
- 過去のデータは遡って取得不可

**影響**:
- 機械学習モデルの特徴量として使用できない
- 予測精度向上の機会損失

### 2. 日次自動収集の未設定
**現状**:
- [DAILY_COLLECTION_SETUP.md](../DAILY_COLLECTION_SETUP.md)に設定方法は記載されている
- しかし実際にタスクスケジューラは設定されていない可能性

**影響**:
- 毎日のデータ収集漏れ
- オリジナル展示データの蓄積ができない

### 3. スクリプトの重複・整理不足
**データ収集スクリプト（6個）**:
- `収集_オリジナル展示_最新.py` - 昨日と今日
- `収集_オリジナル展示_手動実行.py` - 相対日付（-1, 0, +1）
- `収集_オリジナル展示_日付指定.py` - 絶対日付（YYYY-MM-DD）← **UI向け推奨**
- `収集_潮位データ_最新.py`
- `収集_2020年潮位データ.py`
- `収集_RDMDB潮位データ_改善版.py`

**補完スクリプト（13個）**:
- `補完_race_details_INSERT対応.py` - シングルスレッド版
- `補完_race_details_INSERT対応_高速版.py` - 並列版（6スレッド）← **推奨**
- `補完_風向データ.py`、`補完_風向データ_全件.py`、`補完_風向データ_全件_自動.py`
- `補完_展示タイム_全件_自動.py`、`補完_展示タイム_全件_高速化.py`、`補完_展示タイム_並列.py`
- `補完_払戻金データ.py`
- `補完_決まり手データ_改善版.py`
- `補完_風向データ_改善版.py`
- `補完_天候データ_改善版.py`
- `補完_レース詳細データ_改善版v4.py`

**問題**:
- 同じ目的のスクリプトが複数存在（改善版、全件、並列など）
- どれを使うべきか不明確
- 古いバージョンも残っている

### 4. ドキュメントの重複・整理不足
**MDファイル（100個以上）**:
- 作業サマリーが複数存在（SESSION_REPORT.md, PROGRESS_REPORT.md, など）
- 古いドキュメントと新しいドキュメントが混在
- 最新の状態を反映していない可能性

---

## 🎯 優先度別の改善提案

### 🔴 最優先（今週中）

#### 1. オリジナル展示の日次自動収集セットアップ
**タスク**:
- タスクスケジューラの設定（毎日20:00実行）
- 設定確認と動作テスト
- ログファイルの確認体制

**期待効果**:
- 今後のオリジナル展示データを100%蓄積
- 1年後には約3,650レース分のデータ蓄積

**実施方法**:
- [DAILY_COLLECTION_SETUP.md](../DAILY_COLLECTION_SETUP.md)の手順に従う
- PowerShellスクリプトで自動設定

#### 2. プロジェクトクリーンアップ
**タスク**:
- 使用しない古いスクリプトを `archive/` に移動
- 推奨スクリプトのREADMEへの明記
- ドキュメントの整理（最新のみ残す）

**期待効果**:
- プロジェクトの見通し向上
- 新規メンバーの理解容易化
- メンテナンス負荷削減

#### 3. モデルバイアスの根本的修正
**タスク**:
- [train_conditional_model.py](../train_conditional_model.py)を修正
- `pit_number`を特徴量に追加
- 過去6ヶ月〜1年のデータで再学習
- バックテスト実行

**期待効果**:
- 艇番バイアスの根本的解決
- ROI改善（目標130%以上）
- 事後補正が不要になる

### 🟡 高優先（今月中）

#### 4. 統合データ収集スクリプトの作成
**タスク**:
- `収集_統合版_UI対応.py`を新規作成
- racesテーブル作成 → race_details作成 → オリジナル展示収集を自動化
- UI連携を前提とした戻り値設計

**期待効果**:
- ワンコマンドで全データ収集
- UI実装の簡易化

#### 5. データ品質レポート自動生成
**タスク**:
- `check_data_quality.py`を作成
- 各テーブルのカバー率を自動計算
- 欠損データを特定・レポート

**期待効果**:
- データ品質の可視化
- 補完作業の優先度付け

#### 6. バックテストの継続実行
**タスク**:
- 補正前後のROI比較
- 艇番特徴量追加後のROI測定
- 長期的なパフォーマンス追跡

**期待効果**:
- モデル改善効果の定量化
- 実戦投入の可否判断

### 🟢 中優先（2ヶ月以内）

#### 7. 会場別モデルの構築
**タスク**:
- 各会場専用のモデルを学習
- または会場IDを特徴量に追加

**期待効果**:
- 会場別の差異（1号艇有利度など）を反映
- 予測精度向上

#### 8. Streamlit UIの強化
**タスク**:
- オリジナル展示データ収集UIの追加
- データ品質ダッシュボードの追加
- リアルタイム予測UIの改善（補正前後比較表示）

**期待効果**:
- 非エンジニアでもデータ収集可能
- データ状況の可視化

#### 9. 自動予測システムの構築
**タスク**:
- 締め切り前に自動的にオッズ取得
- 推奨ベットの通知（メール/Slack）
- 購入履歴の自動記録

**期待効果**:
- 運用の完全自動化
- 収益機会の最大化

### ⚪ 低優先（3ヶ月以降）

#### 10. 特徴量エンジニアリングの高度化
**タスク**:
- 交互作用項の追加（展示タイム × 艇番など）
- 時系列特徴量（直近N戦の傾向）
- エンベディング手法の検討

#### 11. アンサンブルモデルの構築
**タスク**:
- 複数モデルの組み合わせ
- スタッキング・ブレンディング

#### 12. リアルタイムデータパイプラインの構築
**タスク**:
- Apache Airflowなどのワークフロー管理ツール導入
- データ収集〜予測〜ベットまでの自動化

---

## 📋 残タスク一覧

### データ収集関連
- [ ] オリジナル展示の日次自動収集セットアップ
- [ ] タスクスケジューラ設定の確認
- [ ] ログ確認体制の構築
- [ ] 統合データ収集スクリプト作成
- [ ] データ品質レポート自動生成

### モデル改善関連
- [ ] 艇番特徴量の追加（最優先）
- [ ] モデル再学習（6ヶ月〜1年のデータ）
- [ ] バックテスト再実行
- [ ] 会場別モデルの検討

### プロジェクト管理関連
- [ ] 古いスクリプトの整理（archive/へ移動）
- [ ] 推奨スクリプトのREADME明記
- [ ] ドキュメントの整理（最新のみ残す）
- [ ] 依存関係図の作成

### UI関連
- [ ] オリジナル展示収集UIの追加
- [ ] データ品質ダッシュボード
- [ ] リアルタイム予測UIの改善

### 自動化関連
- [ ] 自動予測システムの構築
- [ ] 通知機能の実装
- [ ] 購入履歴の自動記録

---

## 🎓 技術的知見

### 今回の作業で得られた知見

#### 1. オリジナル展示データの制約
- 「昨日と今日」のみ利用可能
- 日次自動収集が必須
- 約9/24会場のみ公開

#### 2. UI連携のベストプラクティス
- 日付選択を制限（昨日・今日のみ）
- 警告メッセージの表示
- 明確なエラーハンドリング

#### 3. モデルバイアスの検出と対処
- 艇番バイアスの発見（1号艇-25%, 5号艇+11%）
- 短期対応: 事後確率補正
- 中期対応: 特徴量追加と再学習

### プロジェクト全体の技術的課題

#### 1. データ蓄積の遅れ
- オリジナル展示: 951件（0.72%）
- 原因: 日次自動収集未設定
- 解決: タスクスケジューラ設定

#### 2. スクリプト整理の必要性
- 同じ目的のスクリプトが複数
- 古いバージョンが残っている
- 解決: archive/への移動、README明記

#### 3. ドキュメント整理の必要性
- 100個以上のMDファイル
- 古い情報と新しい情報が混在
- 解決: 最新のみ残す、archive/へ移動

---

## 🚀 今後の開発ロードマップ

### Week 1（今週）
1. オリジナル展示の日次自動収集セットアップ
2. モデル再学習（艇番特徴量追加）
3. バックテスト再実行

### Week 2-4（今月）
1. プロジェクトクリーンアップ
2. 統合データ収集スクリプト作成
3. データ品質レポート自動生成
4. Streamlit UIの強化（オリジナル展示収集）

### Month 2（来月）
1. 会場別モデルの構築
2. 特徴量エンジニアリングの高度化
3. 自動予測システムの構築

### Month 3-（3ヶ月以降）
1. アンサンブルモデルの構築
2. リアルタイムデータパイプライン
3. 実戦データ収集と検証

---

## 📊 KPI（重要指標）

### データ品質KPI
- **オリジナル展示カバー率**: 現在0.72% → 目標100%（今後収集分）
- **race_detailsカバー率**: 現在≈100% → 維持
- **ST時間カバー率**: 約70% → 維持

### モデル性能KPI
- **AUC**: 現在不明 → 目標0.75以上
- **ROI**: 現在100%（補正なし） → 目標130%以上（艇番特徴量追加後）
- **Top1的中率**: 現在2.9% → 目標3%以上（期待値0.83%を大きく上回る）

### 運用効率KPI
- **データ収集自動化率**: 現在≈50% → 目標100%
- **予測自動化率**: 現在0% → 目標100%
- **ドキュメント整理率**: 現在≈20% → 目標90%

---

## ⚠️ リスクと対策

### Risk 1: オリジナル展示データ蓄積の遅れ
**リスク**: 日次自動収集が設定されないままだと、今後もデータが蓄積されない
**対策**: 今週中に必ずタスクスケジューラを設定・確認

### Risk 2: モデル再学習の失敗
**リスク**: 艇番特徴量を追加しても精度が向上しない可能性
**対策**: 段階的に検証（小規模データで試す → バックテスト → 本番）

### Risk 3: プロジェクト複雑化
**リスク**: スクリプト・ドキュメントが増え続けて管理不能に
**対策**: 定期的なクリーンアップ、推奨スクリプトの明記

---

## 📚 関連ドキュメント

### 本日作成
- [docs/オリジナル展示データ利用可能期間_調査報告.md](オリジナル展示データ利用可能期間_調査報告.md)
- [docs/プロジェクト全体レビュー_20251118.md](プロジェクト全体レビュー_20251118.md)（本ドキュメント）

### 重要な既存ドキュメント
- [README.md](../README.md) - プロジェクト概要
- [COMPREHENSIVE_DATA_COLLECTION_README.md](../COMPREHENSIVE_DATA_COLLECTION_README.md) - データ収集システム
- [DAILY_COLLECTION_SETUP.md](../DAILY_COLLECTION_SETUP.md) - 日次収集セットアップ
- [オリジナル展示収集_UI連携ガイド.md](../オリジナル展示収集_UI連携ガイド.md) - UI連携ガイド
- [docs/work_summary_20251118.md](work_summary_20251118.md) - 本日の作業サマリー
- [docs/model_bias_analysis_20251118.md](model_bias_analysis_20251118.md) - モデルバイアス分析

---

## ✅ 結論

### プロジェクトの現状評価
- **データ基盤**: 良好（131K+ レース）
- **オリジナル展示**: 不足（0.72%） ← **早急な改善必要**
- **モデル**: バイアスあり（艇番特徴量なし） ← **再学習必要**
- **プロジェクト整理**: 不足（スクリプト・ドキュメント重複） ← **整理必要**

### 最優先タスク（今週中）
1. オリジナル展示の日次自動収集セットアップ ← **データ蓄積の開始**
2. モデル再学習（艇番特徴量追加） ← **バイアス解消**
3. プロジェクトクリーンアップ ← **可視性向上**

### 期待される成果（1ヶ月後）
- オリジナル展示データ: 約300レース分蓄積開始
- モデルROI: 130%以上達成
- プロジェクト構造: 明確化・整理完了

---

**作成日**: 2025年11月18日
**作成者**: Claude Code
**次回更新**: 1週間後（進捗確認時）
