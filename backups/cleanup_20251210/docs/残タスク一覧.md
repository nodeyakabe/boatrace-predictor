# 残タスク一覧

**更新日**: 2025-12-08（戦略A実装完了）

---

## 0. 【確定】最終運用戦略A（バランス型）✅

### プロジェクトの目的

**長期的な安定収益の確保: 年間+30万円以上の黒字を目指す**

### 検証データ

- **検証期間**: 2025年全期間（1月〜12月）
- **検証レース数**: 16,979レース
- **払戻データ**: payoutsテーブルの実際の払戻金額を使用
- **バックテスト結果**: 年間ROI 298.9%, 収支 **+380,070円**

---

### 戦略A: バランス型（2025年実績）

#### 3層構造アプローチ

| 層 | 目的 | ROI | 収支 | 購入/年 | 的中/年 |
|----|------|-----|------|---------|---------|
| **Tier 1** | 超高配当狙い | 468.5% | **+268,620円** | 243 | 7 |
| **Tier 2** | 中高配当狙い | 318.9% | **+104,400円** | 159 | 10 |
| **Tier 3** | 堅実狙い | 110.0% | **+7,050円** | 235 | 35 |
| **合計** | バランス型 | **298.9%** | **+380,070円** | 637 | 52 |

#### 購入対象条件（全8条件）

**Tier 1: 超高配当狙い**

| 信頼度 | 級別 | オッズ範囲 | 実測ROI | 収支 | 賭け金 |
|--------|------|------------|---------|------|--------|
| D | B1 | 200-300倍 | **746.7%** | +124,170円 | 300円 |
| D | A1 | 100-150倍 | 383.6% | +51,900円 | 300円 |
| D | A1 | 200-300倍 | 384.7% | +51,240円 | 300円 |
| C | B1 | 150-200倍 | 337.4% | +41,310円 | 300円 |

**Tier 2: 中高配当狙い**

| 信頼度 | 級別 | オッズ範囲 | 実測ROI | 収支 | 賭け金 |
|--------|------|------------|---------|------|--------|
| D | A2 | 30-40倍 | 251.4% | +33,150円 | 300円 |
| D | A1 | 40-50倍 | 488.9% | +51,330円 | 300円 |
| D | A1 | 20-25倍 | 258.1% | +19,920円 | 300円 |

**Tier 3: 堅実狙い**

| 信頼度 | 級別 | オッズ範囲 | 実測ROI | 収支 | 賭け金 |
|--------|------|------------|---------|------|--------|
| D | B1 | 5-10倍 | 110.0% | +7,050円 | 300円 |

**実装状況**: ✅ `src/betting/bet_target_evaluator.py` に実装済み（2025-12-08更新）

#### 購入見送り条件

| 条件 | 理由 |
|------|------|
| 信頼度A, B | サンプル不足・安定性低 |
| B2級 | 回収率低い |
| イン強会場×B1（広範囲） | ROI 60.9%で期待未達 |
| 信頼度C（中低配当） | ROI 70-85%で期待未達 |

---

### 購入判定フロー（更新版）

```
1. 信頼度確認
   ├─ 信頼度A・B → 購入見送り
   ├─ 信頼度C → 超高配当（150倍以上）のみ
   └─ 信頼度D → 全3層を適用

2. 1コース選手の級別確認
   ├─ A1級 → Tier 1, 2, 3すべて適用可能
   ├─ A2級 → Tier 2（中高配当）のみ
   ├─ B1級 → Tier 1（超高配当）またはTier 3（堅実）
   └─ B2級 → 購入見送り

3. オッズ範囲確認（精密設定）
   ├─ 範囲内 → 購入対象
   └─ 範囲外 → 見送り
```

---

### 実績と目標

#### 2025年バックテスト実績

| 項目 | 値 |
|------|-----|
| 年間購入 | 637レース（月53レース） |
| 年間的中 | 52回（月4.3回） |
| 的中率 | 8.2% |
| 年間投資 | 191,100円（月15,925円） |
| 年間払戻 | 571,170円（月47,598円） |
| **年間収支** | **+380,070円（月+31,672円）** |
| **ROI** | **298.9%** |

#### 目標達成度

| 目標 | 実績 | 達成率 |
|------|------|--------|
| 年間収支 +300,000円 | +380,070円 | ✅ 127% |
| ROI 150%以上 | 298.9% | ✅ 199% |
| 月間的中 5-10回 | 4.3回 | ⚠️ 86% |

---

### UI「総合」タブの実装

購入対象の判定状態を3段階で表示:

| 状態 | 説明 |
|------|------|
| **対象（事前）** | 事前情報のみで購入条件を満たすレース |
| **候補** | 直前情報次第で対象に入る可能性があるレース |
| **対象（確定）** | 直前情報取得後、最終的に購入対象となったレース |

---

## 1. 買い目システム改善（✅ 実装済み、❓ バックテスト未実行）

**詳細**: [betting_system_improvement_plan.md](betting_system_improvement_plan.md)
**実装状況**: [betting_implementation_status.md](betting_implementation_status.md)

### 1-1. 実装済みモジュール（✅ 完了 2025-12-08確認）

| モジュール | ファイル | 状態 |
|-----------|---------|------|
| 設定管理 | `src/betting/config.py` | ✅ 完了 |
| フィルタエンジン | `src/betting/filter_engine.py` | ✅ 完了 |
| EV計算 | `src/betting/ev_calculator.py` | ✅ 完了 |
| 買い目選択 | `src/betting/bet_selector.py` | ✅ 完了 |
| Kelly計算 | `src/betting/kelly_calculator.py` | ✅ 完了 |
| 戦略エンジン | `src/betting/strategy_engine.py` | ✅ 完了 |
| ログ管理 | `src/betting/bet_logger.py` | ✅ 完了 |
| 旧ロジック保管 | `src/betting/legacy/` | ✅ 完了 |

### 1-2. Phase別実装状況

#### Phase A: 低リスク改善

| 項目 | 実装 | バックテスト | 優先度 |
|------|-----|-------------|--------|
| ⑤ 除外条件明文化 | ✅ 完了 | ❓ 未実行 | 🔴 最優先 |
| ③ Edge計算導入 | ✅ 完了 | ❓ 未実行 | 🔴 最優先 |

**バックテストスクリプト**:
- `scripts/backtest_v2_edge_test.py`
- `scripts/backtest_all_modes.py`

**成功条件**: ROI 120%以上維持（最低115%）

#### Phase B: 中リスク改善

| 項目 | 実装 | バックテスト | 優先度 |
|------|-----|-------------|--------|
| ① 状況別オッズレンジ | ✅ 完了 | ❓ 未実行 | ⚠️ Phase A後 |
| ④ 動的資金配分 | ✅ 完了 | ❓ 未実行 | ⚠️ Phase A後 |

**バックテストスクリプト**:
- `scripts/backtest_v2_venue_test.py`

**成功条件**: ROI 125%以上達成

#### Phase C: 高リスク改善

| 項目 | 実装 | バックテスト | 優先度 |
|------|-----|-------------|--------|
| ② 簡易Kelly導入 | ✅ 完了 | ❓ 未実行 | ⚠️ Phase B後 |

**成功条件**: ROI 130%以上 + ドローダウン50%以下

### 1-3. 中穴レース条件調査（✅ 完了 2025-12-08、❌ 実装見送り）

**調査目的**: 月間2-3件の的中を10件以上に増やすため、中穴が出やすい条件を探索

**調査方法**: Opus AIで2025年1-7月データ（8,310レース）を多角的分析

**調査結果サマリー**:
- 信頼度D × イン強会場（大村/下関/徳山）× B1級: **ROI +120.6%** (Opus分析)
- 実装後のバックテスト: **ROI 0.7%** (実測値)
- 的中レース9件、平均配当9.6倍（本命レベル）

**不一致の原因**:
1. Opus分析の計算方法が不明（156レース vs 実測118レース）
2. 実際の的中配当が本命レベルで中穴ではない
3. この条件では収益性が見込めない

**結論**: **実装見送り** - 既存のC,D条件（A1級中心）の方が安定性・収益性が高い

**詳細**: [docs/opus_upset_analysis_20251208.md](opus_upset_analysis_20251208.md)

---

### 1-4. 次のアクション（🔴 最優先）

#### Step 1: Phase Aバックテスト実行

```bash
# Edge計算のバックテスト
python scripts/backtest_v2_edge_test.py

# 全モード比較
python scripts/backtest_all_modes.py
```

#### Step 2: 結果分析

- baselineとの比較
- ROI、的中率、最大ドローダウン確認
- Phase A採用可否判定

#### Step 3: 実運用への段階的導入

- ROI維持確認できたら`STRATEGY_MODE = 'edge_test'`に変更
- 1週間並行運用でログ収集

---

## 2. データベース最適化（✅ 完了 2025-12-08）

### 2-1. 攻略パターンDB構築（✅ 完了）

**実装ファイル**: `src/database/attack_patterns.py`

**新規テーブル**:
- ✅ `venue_attack_patterns` - 会場攻略パターン
- ✅ `racer_attack_patterns` - 選手攻略パターン
- ✅ `venue_racer_patterns` - 会場×選手クロスパターン

**インデックス追加**:
- ✅ `idx_venue_racer_venue` - 会場コード検索用
- ✅ `idx_venue_racer_racer` - 選手番号検索用
- ✅ `idx_racer_patterns_rank` - ランク絞り込み用
- ✅ `idx_venue_patterns_upset` - 荒れ率ソート用

**パターンデータ構築**:
```python
from src.database.attack_patterns import AttackPatternDB
db = AttackPatternDB()
db.build_all_patterns()  # 全パターン構築
```

### 2-2. 活用可能性（💡 検討中）

攻略パターンDBをフィルタエンジンに統合:
- 荒れやすい会場での除外条件強化
- 選手の会場相性によるスコア補正
- 会場×選手パターンによる期待値調整

---

## 3. 予測精度改善計画（Opus分析済み）

**詳細**: セクション「3. 統合改善計画」参照

### 必須実装タスク（優先度A）

#### Week 1: 基盤強化

**1-1. コース×進入×会場期待勝率テーブル実装**
- **期待効果**: +1.5-3.0pt（最大効果）
- **工数**: 1-2日
- **実装場所**: `src/analysis/race_predictor.py` - COURSE_RANK_WIN_RATES拡張
- **内容**:
  - 24会場 × 6コース × 4ランク = 576エントリーのルックアップテーブル
  - 会場別・コース別・進入パターン別の勝率をデータベースから集計
  - 例: 三国はイン強い、唐津は5コース差し、丸亀は深イン弱い

**1-2. 天候強化特徴量実装**
- **期待効果**: +0.7-1.5pt
- **工数**: 0.5日
- **実装場所**: `src/analysis/weather_adjuster.py` 改修
- **内容**:
  - 風向×風速×追い/向かいの複合特徴量
  - 追い風: 1コース激強、向かい風: 差し・まくり決まりやすい
  - 風速6m以上で荒れ率1.8倍対応

**1-3. 既存特徴量有効化確認**
- **期待効果**: +0.3-0.8pt
- **工数**: 0.5日
- **実装場所**: `src/features/feature_transforms.py` と `src/analysis/race_predictor.py`
- **内容**:
  - 展示相対特徴量（exh_rank, exh_diff, exh_zscore）が使用されているか確認
  - ST相対特徴量（st_relative, st_rank）が使用されているか確認
  - 未使用の場合はrace_predictorに統合

**Week 1期待累積効果**: +2.5-5.0pt

---

#### Week 2: 条件付きモデル改修

**2-1. Stage2学習データ改修**
- **期待効果**: 2着予測 35.9% → 45%（+9pt）
- **工数**: 1日
- **実装場所**: `src/ml/conditional_rank_model.py` - `_prepare_second_place_data()`
- **内容**:
  - 1着艇の特徴量を2着候補に正しく伝達
  - 相対特徴量も含めて伝達

**2-2. Stage3学習データ改修**
- **期待効果**: 3着予測 27.2% → 35%（+8pt）
- **工数**: 1日
- **実装場所**: `src/ml/conditional_rank_model.py` - `_prepare_third_place_data()`
- **内容**:
  - 1着+2着艇の特徴量を3着候補に伝達

**2-3. モデル再学習スクリプト作成・実行**
- **期待効果**: 精度向上の実現
- **工数**: 0.5日
- **実装場所**: `scripts/train_conditional_models.py`（新規）
- **内容**:
  - TimeSeriesSplit(5)でCV
  - early_stopping使用
  - モデル保存: `models/stage2_conditional.joblib`, `models/stage3_conditional.joblib`

**2-4. race_predictor.py統合確認**
- **工数**: 0.5日
- **内容**: hierarchical_predictorの結果がUIに正しく反映されているか確認

**Week 2期待累積効果**: 2着+9pt、3着+8pt

---

#### Week 3: 追加機能と検証

**3-1. モーター直近3走スコア実装**
- **期待効果**: +0.7-1.2pt
- **工数**: 1日
- **実装場所**: `src/analysis/motor_analyzer.py` 改修
- **内容**:
  - 直近3節の平均着順
  - 直近の展示タイム順位の上昇/下降傾向
  - 伸び・出足・行き足の変化（代理指標）

**3-2. 荒れ指数実装**
- **期待効果**: +0.5-1.0pt
- **工数**: 1日
- **実装場所**: `src/analysis/race_predictor.py` または新規モジュール
- **内容**:
  - オッズ分散（低〜中〜高）
  - 1-2コースオッズの開き
  - 3〜6の支持率のバラつき
  - 過去の会場・グレードの荒れ率
  - 荒れやすさスコアによる予測精度低下の防止

**3-3. バックテスト実施**
- **工数**: 0.5日
- **内容**: 改善前後の精度比較レポート作成

**Week 3期待累積効果**: +1.2-2.2pt（追加）

---

### 推奨実装タスク（優先度B）

上記Week 3の内容（モーター直近3走、荒れ指数）

---

### 見送り推奨タスク（優先度C）

| タスク | 理由 | 再検討条件 |
|--------|------|-----------|
| motor/boat embedding | 効果不確実（+0.3-0.5pt）、実装コスト大（1-2日） | Stage2/3精度が45%未満の場合 |
| DBビュー作成 | 現状ボトルネックなし | パフォーマンス問題発生時 |
| テストスイート新規作成 | 機能実装後で十分 | Week 3完了後に検討 |

**理由詳細:**
- **motor/boat embedding**: LightGBMはカテゴリカル変数を直接扱えるため、埋め込みの効果は限定的。motor_second_rate、boat_second_rateで代替可能。

---

### 既存実装の活用（確認済み）

以下は**既に実装済み**で、新規開発不要:
- ✅ 展示相対特徴量（`src/features/feature_transforms.py` - FeatureTransformer）
- ✅ ST相対特徴量（`src/features/feature_transforms.py` - add_st_features()）
- ✅ 三連単確率計算（`src/prediction/trifecta_calculator.py`）
- ✅ 統合予測パイプライン（`src/prediction/hierarchical_predictor.py`）
- ✅ 条件付きモデル基盤（`src/ml/conditional_rank_model.py`）

→ これらは確認・改修のみで対応可能

---

### リスクと対策

| リスク | 発生確率 | 影響 | 対策 |
|--------|---------|------|------|
| 条件付きモデル改修で精度低下 | 中 | 高 | バックテストで事前検証、フォールバック機能維持 |
| 期待勝率テーブルのデータ不足 | 低 | 中 | 全国平均でフォールバック |
| 天候データ欠損 | 低 | 低 | 既存補間ロジック活用 |
| 学習時間増大 | 低 | 低 | 増分学習対応検討 |

---

### 期待される総合効果（定量予測）

| 指標 | 現状 | 目標（保守的） | 目標（楽観的） |
|------|------|----------------|----------------|
| 1着的中率 | 41-42% | 44% | 47% |
| 2着的中率 | 35.9% | 42% | 45% |
| 3着的中率 | 27.2% | 32% | 35% |
| 3連単的中率 | 12.7% | 16% | 18% |
| 3連単的中率（TOP20） | 5.0% | 12% | 15% |
| 回収率改善 | - | +5% | +10% |

---

### 推奨着手順序（詳細）

| Week | Day | タスク | 担当 |
|------|-----|--------|------|
| **Week 1** | 1 | コース×進入×会場期待勝率テーブル設計 | - |
| | 2 | コース×進入×会場期待勝率テーブル実装 | - |
| | 3 | 天候強化特徴量実装 | - |
| | 4 | 既存特徴量有効化確認・修正 | - |
| | 5 | フェーズ1統合テスト | - |
| **Week 2** | 1 | Stage2学習データ改修 | - |
| | 2 | Stage3学習データ改修 | - |
| | 3 | モデル再学習スクリプト作成・実行 | - |
| | 4 | race_predictor.py統合確認 | - |
| | 5 | フェーズ2統合テスト | - |
| **Week 3** | 1 | モーター直近3走スコア実装 | - |
| | 2 | 荒れ指数実装 | - |
| | 3 | バックテスト実施 | - |
| | 4 | 結果分析・調整 | - |
| | 5 | 最終検証・ドキュメント | - |

---

### 関連ドキュメント

- `改善点\改善点_20251205.txt` - 期待値の高い特徴量TOP5
- `改善点\階層的確率モデル_作業計画書.md` - 2着3着予測改善案
- 詳細分析レポート: Opus分析結果（2025-12-05実施）

---

## 4. 直前情報データの拡充と予測への活用（✅ 完了 2025-12-02）

### 完了内容

**データ収集の拡充:**
- ✅ ST（スタートタイミング）の取得実装（フライング対応含む）
- ✅ 展示進入コースの取得実装
- ✅ 調整重量の取得実装
- ✅ 前走成績（進入コース、ST、着順）の取得実装
- ✅ 気象データコード（天候コード、風向コード）の取得実装

**DBスキーマの拡張:**
- ✅ race_detailsテーブルに以下カラムを追加:
  - `exhibition_course` (INTEGER) - 展示進入コース
  - `prev_race_course` (INTEGER) - 前走進入コース
  - `prev_race_st` (REAL) - 前走ST
  - `prev_race_rank` (INTEGER) - 前走着順
  - `adjusted_weight` (REAL) - 調整重量
- ✅ weatherテーブルに以下カラムを追加:
  - `weather_code` (INTEGER) - 天候コード
  - `wind_dir_code` (INTEGER) - 風向コード

**UI統合:**
- ✅ BeforeInfoFetcherからBeforeInfoScraperへ置き換え
- ✅ UI用データ形式変換メソッド（to_ui_format）の実装
- ✅ DB保存処理の更新（race_details & weatherテーブルへ保存）

**関連ドキュメント:**
- [setup_beforeinfo_enhancement.md](setup_beforeinfo_enhancement.md) - 別PC環境構築手順
- `db_migration_add_beforeinfo_columns.py` - DBマイグレーションスクリプト

### 次のステップ（優先度高）

**予測モデルへの組み込み:** ✅ 完了 2025-12-02

1. ✅ BeforeInfoScorerの実装
   - 展示タイムスコア（25点）: ランクベース評価
   - STスコア（25点）: レンジベース評価、フライング対応
   - 進入スコア（20点）: 枠なり偏差検出、コース取り評価
   - 前走スコア（15点）: 前走ST・着順による調子判定
   - チルト/風スコア（10点）: 非線形コース依存評価、風シナジー
   - 部品/重量スコア（5点）: 交換・重量ペナルティ

2. ✅ RacePredictorへの統合
   - 統合式: FINAL_SCORE = PRE_SCORE * 0.6 + BEFORE_SCORE * 0.4
   - データ不足時: PRE_SCORE * 0.8 + BEFORE_SCORE * 0.2に自動調整
   - 信頼度・データ充実度の算出

3. ⚠️ 実運用テスト（保留）
   - 実際の直前情報データを取得・保存してから検証
   - UI統合テスト
   - 予測精度の改善効果測定

### 公式ページのデータ vs 現在の収集状況（更新版）

| 公式ページのデータ | 収集状況 | 対応スクリプト/クラス |
|------------------|---------|---------------------|
| **選手別データ** | | |
| 展示タイム | ✅ 取得済 | BeforeInfoScraper |
| チルト | ✅ 取得済 | BeforeInfoScraper |
| 部品交換 | ✅ 取得済 | BeforeInfoScraper |
| 調整重量 | ✅ 取得済 | BeforeInfoScraper |
| 前走成績 | ✅ 取得済 | BeforeInfoScraper |
| **スタート展示** | | |
| ST（スタートタイミング） | ✅ 取得済 | BeforeInfoScraper |
| 進入コース | ✅ 取得済 | BeforeInfoScraper |
| **水面気象情報** | | |
| 天候 | ✅ 取得済 | BeforeInfoScraper |
| 風向 | ✅ 取得済 | BeforeInfoScraper |
| 風速 | ✅ 取得済 | BeforeInfoScraper |
| 気温 | ✅ 取得済 | BeforeInfoScraper |
| 水温 | ✅ 取得済 | BeforeInfoScraper |
| 波高 | ✅ 取得済 | BeforeInfoScraper |
| 天候コード | ✅ 取得済 | BeforeInfoScraper |
| 風向コード | ✅ 取得済 | BeforeInfoScraper |
| **その他** | | |
| 潮位 | ✅ 取得済 | 収集_潮位データ_最新.py（独立）|

---

## 5. 女子選手の性別判定改善

### 現状の問題
- 現在は名前の末尾（「子」「美」「香」「奈」「恵」「代」）で性別を推定している
- この方法は確実ではない（例：男性で「〇〇美」という名前もありうる）

### 改善案
- 公式サイトの選手データを解析し、女子選手フラグを事前にDBに保存する
- `racers`テーブルに`gender`カラムを追加し、選手マスタとして管理
- 予測時はDBから性別を参照する方式に変更

### 対象ファイル
- `src/database/models.py`（`racers`テーブルに`gender`カラム追加）
- 選手データ解析スクリプト（新規作成）
- `src/analysis/race_predictor.py`（性別取得ロジックをDB参照に変更）

---

## 6. レースタイプ別モデル分割の調整

### 内容
- レースタイプ（一般戦、G3、G2、G1、SG等）に応じたモデルの分割・調整
- 各グレードで異なる特徴量の重み付けや予測ロジックの最適化

### 検討事項
- グレードごとの選手層の違い（SGはA1級が中心）
- 賞金額による選手のモチベーション差
- 節間の疲労度や調整の違い

---

## 7. その他の潜在的な改善点（優先度低）

| 項目 | 現状 | 備考 |
|------|------|------|
| 進入予想 | 未実装 | `config/prediction_improvements.json`で`enabled: false` |
| 潮位補正 | 未実装 | 同上 |
| モーターEWMA | 未実装 | 同上 |
| 確率較正 | 未実装 | 同上 |

---

## 完了済みタスク

### 2025-12-08

- ✅ **データベース最適化**
  - attack_patternsテーブル作成（venue/racer/venue_racer）
  - インデックス追加（4個）
  - 攻略パターンDB実装

- ✅ **買い目システム実装**
  - コアモジュール8個実装完了
  - Phase A〜C全機能実装
  - ロールバック機能完備

### 2025-11-30

- ✅ 直前情報取得ボタンのサイドバーフィルター対応
- ✅ 予測エラーメッセージの改善（展示データ未取得時）
- ✅ 1着固定ルールの閾値調整（データ充実度 60→40）
- ✅ 推定勝率計算の修正（相対スコア方式に変更）
- ✅ 法則エンジンの設計修正
  - 選手ランク法則のフィルタリング（A1/A2/B1/B2）
  - 風向法則のフィルタリング
  - 女子法則のフィルタリング
- ✅ StreamlitDuplicateElementKeyエラーの修正

---

## 最優先タスク（🔴 今日やるべきこと）

1. **Phase Aバックテスト実行**
   ```bash
   python scripts/backtest_v2_edge_test.py
   python scripts/backtest_all_modes.py
   ```

2. **結果分析と採用判定**
   - ROI 120%以上維持できているか確認
   - Phase A機能の採用可否を判定

3. **実運用への移行判断**
   - ROI維持できていれば実運用テスト開始
   - できていなければbaselineに留まる

---

*最終更新: 2025年12月8日*
*更新内容: 買い目システム実装状況反映、attack_patternsDB追加*
