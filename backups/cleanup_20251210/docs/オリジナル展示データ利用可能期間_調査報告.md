# オリジナル展示データ利用可能期間 - 調査報告

**調査日**: 2025年11月18日

---

## 調査の背景

ユーザーより以下の指摘がありました:

> 「オリジナル展示の情報は基本的に前日と当日のものしか存在しない。これまでオリジナル展示の収集をしてきた資料があるかもだから資料の確認調査もして」

この指摘を受けて、プロジェクト内の既存ドキュメントおよびスクリプトを調査しました。

---

## 調査結果: 確認された事実

### 1. DAILY_COLLECTION_SETUP.md（Lines 10-11）

```markdown
オリジナル展示データは**過去に遡れない**（2日前以前のデータは削除される）ため、日次自動収集が必須です。
```

**明確な記述**: 2日前以前のデータは削除される

### 2. DAILY_COLLECTION_SETUP.md（Lines 287-289）

```markdown
### データの特性
1. **過去データは取得不可**: 2日前以前のデータは削除される
2. **日次収集が必須**: データが毎日削除されるため、自動化が必要
```

**明確な記述**: 過去データは取得不可、日次収集が必須

### 3. 収集_オリジナル展示_最新.py（Lines 2-3）

```python
"""
昨日と今日のオリジナル展示データを収集
"""
```

**コード内での確認**: スクリプト自体が「昨日と今日」のみを対象としている

### 4. fetch_original_tenji_daily.py（Lines 3-7）

```python
"""
毎日実行して翌日のレースデータを取得し、DBに保存する
実行タイミング: 毎日20:00（翌日のデータが公開された後）
```

**運用方針**: 翌日のデータを毎日20:00に自動収集する設計

---

## 結論

**オリジナル展示データの利用可能期間: 「昨日」と「今日」のみ**

### データの特性
1. **過去データは取得不可**: 2日前以前のデータは公式サイトから自動的に削除される
2. **日次収集が必須**: データが毎日削除されるため、自動化が必要
3. **全会場が公開しているわけではない**: 約9/24会場のみ公開

### 既に実装されていた対策
- 毎日20:00に自動収集するタスクスケジューラの設定ガイド（DAILY_COLLECTION_SETUP.md）
- 専用の日次収集スクリプト（fetch_original_tenji_daily.py）
- 「昨日と今日」のみを対象とするスクリプト（収集_オリジナル展示_最新.py）

---

## 実施した修正

### 1. 収集_オリジナル展示_日付指定.py

#### 修正内容
- ドキュメント文字列に「昨日と今日のみ」という制約を明記
- 2日前以前の日付が指定された場合に警告メッセージを表示する機能を追加

#### 追加コード
```python
# 日付の妥当性チェック（昨日〜今日のみ推奨）
target_date = datetime.strptime(date_str, '%Y-%m-%d')
today = datetime.now().date()
yesterday = today - timedelta(days=1)
target_date_only = target_date.date()

if target_date_only < yesterday - timedelta(days=1):
    print(f"\n[警告] {date_str} は2日前以前の日付です")
    print("オリジナル展示データは「昨日」と「今日」のみ公開されています。")
    print("古いデータは公式サイトから既に削除されている可能性が高いです。")
    print("\n収集を試みますが、データが取得できない可能性があります。\n")
```

### 2. オリジナル展示収集_UI連携ガイド.md

#### 追加した警告セクション
```markdown
## ⚠️ 重要: データ利用可能期間について

**オリジナル展示データは「昨日」と「今日」のみ公開されています。**

### データの特性
1. **過去データは取得不可**: 2日前以前のデータは自動的に削除される
2. **日次収集が必須**: データが毎日削除されるため、自動化が必要
3. **全会場が公開しているわけではない**: 約9/24会場のみ公開

### UIでの推奨実装
- 日付選択UIでは「昨日」「今日」のみ選択可能にする
- 過去日付を指定された場合は警告メッセージを表示する
- 自動収集（毎日20:00実行）をセットアップする
```

#### エラーハンドリングの追加
- 「0. 日付が古すぎる（2日前以前）」セクションを追加
- UI側での対処例（警告メッセージ表示）を記載

#### トラブルシューティングの追加
- 「Q0: 過去のデータが取得できない」セクションを追加
- 原因と対処方法を明記

---

## UIでの推奨実装

### 日付選択の制限

```python
from datetime import datetime, timedelta

# 選択可能な日付を昨日と今日のみに制限
today = datetime.now().date()
yesterday = today - timedelta(days=1)

# Streamlitの例
date_option = st.selectbox(
    "対象日を選択",
    options=[yesterday, today],
    format_func=lambda d: "昨日" if d == yesterday else "今日"
)
```

### 過去日付の警告

```python
def validate_date(target_date):
    """日付の妥当性をチェック"""
    today = datetime.now().date()
    yesterday = today - timedelta(days=1)

    if target_date < yesterday:
        st.warning(f"{target_date} は過去の日付です。")
        st.info("オリジナル展示データは「昨日」と「今日」のみ利用可能です。")
        st.info("データを蓄積するには、毎日20:00に自動収集を実行してください。")
        return False

    return True
```

### エラーレスポンスの処理

```python
# スクリプト実行後の結果チェック
if result['success'] == 0 and result['no_data'] > 50:
    st.warning("ほとんどのレースでデータが取得できませんでした。")
    st.info("指定日のデータは既に削除されている可能性があります。")
    st.info("オリジナル展示データは「昨日」と「今日」のみ利用可能です。")
```

---

## 日次自動収集の重要性

### データ削除のタイムライン

```
11/15 (3日前)  → データ削除済み ❌
11/16 (2日前)  → データ削除済み ❌
11/17 (昨日)   → データ利用可能 ✅
11/18 (今日)   → データ利用可能 ✅
11/19 (明日)   → データ未公開 ❌
```

### 自動収集の設定

**実行タイミング**: 毎日20:00（翌日のデータが公開された後）

**設定方法**: [DAILY_COLLECTION_SETUP.md](../DAILY_COLLECTION_SETUP.md)を参照

**期待される効果**:
- データ欠損を防ぐ
- 過去データの蓄積が可能（一度収集したデータはDBに保存される）
- 手動での収集忘れを防ぐ

---

## まとめ

### 確認された事実
1. オリジナル展示データは「昨日」と「今日」のみ公開
2. 2日前以前のデータは自動的に削除される
3. 既存ドキュメントとスクリプトでこの制約は明記されていた

### 実施した改善
1. UI向けスクリプトに警告機能を追加
2. UI連携ガイドに制約を明記
3. エラーハンドリングとトラブルシューティングを強化

### UI開発者への推奨事項
1. 日付選択を「昨日」「今日」のみに制限
2. 過去日付指定時には警告を表示
3. 毎日20:00の自動収集をセットアップ
4. データが取得できなかった場合の適切なメッセージ表示

---

**作成日**: 2025年11月18日
**調査者**: Claude Code
**ステータス**: 調査完了、必要な修正実施済み
