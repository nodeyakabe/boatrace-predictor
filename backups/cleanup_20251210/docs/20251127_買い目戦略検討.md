# 買い目戦略検討 - 2024年11月27日

## 1. 検討の背景

バックテストによる予測精度と回収率の検証を行い、最適な買い目戦略を決定した。

## 2. 検討した戦略

### 2.1 フォーメーション買い（点数別）

| 戦略 | 対象レース | 的中率 | 回収率 | 年間収支 |
|------|-----------|--------|--------|----------|
| 3連単4点固定 | 10,945 | 24.5% | 75.5% | -134万円 |
| 3連単6点固定 | 10,945 | 30.2% | 76.5% | -180万円 |
| 動的4-10点 | 10,945 | 25.5% | 76.0% | -175万円 |

**結論**: 回収率はほぼ同じ（約75-76%）。損失を抑える**4点買い**を基本とする。

### 2.2 信頼度フィルター（不採用）

高信頼度レースのみ購入する戦略を検討。

| 信頼度閾値 | 対象レース | 的中率 | 回収率 |
|-----------|-----------|--------|--------|
| 全レース | 10,945 | 24.5% | 75.3% |
| >= 70 | 3,462 | 32.5% | 77.1% |
| >= 80 | 1,145 | 35.2% | 76.8% |

**結論**: 的中率は上がるが回収率は変わらず、対象レースが少なすぎる。**不採用**。

### 2.3 期待値ベース（Bパターン）

予測確率が一定以上の買い目のみ購入する戦略。

| 確率閾値 | 購入点数/R | 的中数 | 回収率 | 年間収支 |
|---------|-----------|--------|--------|----------|
| >= 3% | 0.1点 | 130 | 95.4% | -4,660円 |
| >= 5% | 0.0点 | 0 | 0.0% | -400円 |
| 通常4点 | 4.0点 | 2,682 | 75.3% | -108万円 |

**結論**: 確率閾値を設けることで回収率は大幅改善（95.4%）するが、購入機会が極端に減る。**継続検討**。

## 3. 採用した設定

### 3.1 デフォルト買い目

```python
DEFAULT_BETTING_CONFIG = {
    "trifecta_default_points": 4,      # 3連単基本4点
    "trifecta_max_points": 10,         # 最大10点まで拡張可
    "trio_points": 1,                   # 3連複1点（保険）
    "unit_bet": 100,                    # 1点100円
    "thresholds": {
        "first_dominant_gap": 15,       # 1着圧倒時→6点に拡張
        "melee_gap": 10,                # 混戦時→10点に拡張
    },
}
```

### 3.2 買い目パターン

**3連単4点（基本）**
- 1着固定、2-3着を2位・3位候補で入れ替え
- 例: 1-2-3, 1-2-4, 1-3-2, 1-3-4

**3連複1点（保険）**
- 上位3艇の組み合わせ
- 例: 1=2=3

### 3.3 スコアリング配点

```python
SCORING_WEIGHTS = {
    "course": 35,   # コース有利度
    "racer": 35,    # 選手能力（勝率）
    "motor": 20,    # モーター性能
    "rank": 10,     # 級別
}
```

## 4. 予測精度改善（2024年11月27日追加）

### 4.1 新しい要素の追加: 平均STスコア

平均スタートタイミング(ST)と勝率の間に強い相関があることを確認。

| 平均ST範囲 | 勝率 | 説明 |
|-----------|------|------|
| 0.10-0.15秒 | 24.38% | **最高**（絶好のスタート）|
| 0.15-0.18秒 | 18.61% | 良好 |
| 0.18-0.20秒 | 13.78% | やや遅い |
| 0.20秒以上 | 9.64% | 遅い |

**実装**: `extended_scorer.py` に `calculate_start_timing_score()` を追加。

### 4.2 会場特性の反映

会場別1コース勝率（2024年データ）に基づいた動的配点を実装。

**高イン会場（58%以上）**: コース重視
- 徳山(18): 66.7%, 大村(24): 65.5%, 下関(19): 62.0%

**低イン会場（50%以下）**: モーター・選手重視
- 平和島(04): 45.1%, 戸田(02): 45.4%, 江戸川(03): 48.5%

**実装**: `fast_backtest.py` に `VENUE_IN1_RATES`, `HIGH_IN_VENUES`, `LOW_IN_VENUES` を追加。

### 4.3 配点最適化（グリッドサーチ）

複数の配点パターンをバックテストで検証。

| 配点パターン | 1着的中 | 3連単 | 3連複 |
|-------------|--------|-------|-------|
| コース重視(40) | **57.69%** | **8.36%** | **22.11%** |
| 現行(35/35) | 57.45% | 7.88% | 21.67% |
| ST追加(30/30/10) | 57.06% | 7.76% | 21.22% |
| 選手重視(40) | 56.48% | 7.69% | 21.20% |

**結論**: コース重視配点が最も高い的中率。

### 4.4 機械学習による重み最適化

ロジスティック回帰で各要素の重要度を学習。

**ML推奨配点**:
```python
{
    'course': 68,  # コースが最重要
    'racer': 14,
    'motor': 3,
    'rank': 9,
    'st': 6
}
```

**検証結果** (2024/09-11月):
- ML配点: 1着57.07%, 3連単7.63%
- 現行配点: 1着56.65%, 3連単7.57%

**結論**: MLはコースを非常に重視する配点を推奨。競艇の基本構造（1コース勝率55%）を反映。

## 5. 拡張スコアリング追加（2024年11月27日追加）

### 5.1 追加した新要素

#### 5.1.1 進入コース傾向分析（前付け傾向）
選手の過去データから、枠番と実際の進入コースの関係を分析。

**データ分析結果**:
- 選手3705: 前付け率82.0%（161走中132回）
- 選手2876: 前付け率82.0%（206走中169回）

**スコア計算**:
- 前付け常習者（40%以上）: 進入予測の信頼度を低下
- 内コース取得予測時: スコアボーナス
- 不安定な進入: 全体スコアに5%ペナルティ

#### 5.1.2 展示タイムスコア（max: 8点）
レース当日のモーター調子を反映。他艇との相対比較でランク付け。

**データ件数**: 621,225件

#### 5.1.3 チルト角度スコア（max: 3点）
選手のセッティング傾向とコース特性との相性を評価。

- マイナス（跳ね）: 出足重視 → 4-6コースのまくりに有利
- プラス（伏せ）: 伸び重視 → 1コースの逃げに有利

**データ件数**: 621,475件

#### 5.1.4 直近成績スコア（max: 8点）
racer_featuresから直近3/5/10走の成績を取得し、短期的な調子を評価。

- 勝率トレンド（上昇/安定/下降）
- 直近5走の勝率・平均着順

#### 5.1.5 会場別勝率スコア（max: 6点）
racer_venue_featuresから会場別成績を取得。

**データ件数**: 8,952件

- 得意水面: 全国平均の1.5倍以上でボーナス
- 苦手水面: 全国平均の0.7倍以下でペナルティ

#### 5.1.6 連対率スコア（max: 5点）
2着率・3着率から「連に絡む力」を評価。

- 2連対率（勝率+2着率）: 60%の重み
- 3連対率（勝率+2着率+3着率）: 40%の重み

### 5.2 拡張スコア構成（更新版）

```python
# 拡張スコア構成（合計: -10〜73点）
{
    "class": 10,           # 級別（A1=10, A2=7, B1=4, B2=1）
    "fl_penalty": -10~0,   # F/Lペナルティ
    "session": 5,          # 節間成績
    "prev_race": 5,        # 前走レベル
    "course_entry": 5,     # 進入傾向（新規）
    "matchup": 5,          # 選手間相性
    "motor": 5,            # モーター特性
    "start_timing": 8,     # 平均ST
    "exhibition": 8,       # 展示タイム（新規）
    "tilt": 3,             # チルト角度（新規）
    "recent_form": 8,      # 直近成績（新規）
    "venue_affinity": 6,   # 会場別勝率（新規）
    "place_rate": 5,       # 連対率（新規）
}
```

## 6. 今後の改善検討事項

### 6.1 期待値ベース戦略の精緻化

- 確率閾値の最適化（3-5%の間を細かく検証）
- オッズとの組み合わせによる期待値計算
- リアルタイムオッズ取得による動的判断

### 6.2 追加検討項目

- レース種別（SG/G1/一般）による配点調整
- 風向・潮位との相互作用分析
- 新しいスコア要素のバックテスト検証

## 7. 理論的考察

### 7.1 回収率75%の壁

競艇の控除率は約25%。理論上の期待値は0.75。
回収率を100%超にするには、オッズの歪みを見つける必要がある。

### 7.2 予測精度と回収率の関係

| 予測精度 | 期待される結果 |
|---------|---------------|
| ランダム | 回収率75% |
| 現状 | 回収率75-76% |
| 理想 | 回収率100%超 |

予測精度向上は的中率上昇に寄与するが、回収率改善には別のアプローチが必要。

### 7.3 期待値プラス戦略の可能性

- 人気薄の過小評価を狙う
- 本命過大評価時に回避する
- オッズ変動のタイミングを捉える

## 8. 関連ファイル

- `config/settings.py`: 設定値定義
- `fast_backtest.py`: バックテスト実行
- `src/prediction/betting_strategy.py`: 買い目生成ロジック
- `src/analysis/race_predictor.py`: 予測エンジン

## 9. 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-11-27 | 初版作成。デフォルト4点買い決定 |
| 2024-11-27 | 予測精度改善（ST追加、会場特性、配点最適化、ML導入）|
| 2024-11-27 | 拡張スコアリング追加（進入傾向、展示タイム、チルト、直近成績、会場別勝率、連対率）|
