# 重み配分最適化バックテスト レポート

**作成日**: 2025-12-03
**テスト対象**: 動的統合の重み配分（PRE_WEIGHT / BEFORE_WEIGHT）
**テストレース数**: 200レース

---

## 目的

現在の保守的な重み配分（PRE 85% / BEFORE 15%）では、統合予測がPRE単体予測と完全に一致してしまう問題を解決するため、複数の重み配分パターンで精度を比較し、最適な設定を見つける。

---

## テスト対象パターン

| パターン | PRE_WEIGHT | BEFORE_WEIGHT | 説明 |
|---------|------------|---------------|------|
| 1 | 0.85 | 0.15 | 現在の設定（保守的） |
| 2 | 0.70 | 0.30 | バランス重視 |
| 3 | 0.60 | 0.40 | 直前情報重視 |
| 4 | 0.50 | 0.50 | 均等配分 |

---

## 背景：なぜ重み配分最適化が必要か

### 現状の問題

**1. 統合予測とPRE単体予測が完全一致**
- 30レーステスト: 差分0件（100%一致）
- 300レースWalk-forward: 全ウィンドウで差分±0.0%
- 新機能（動的統合・進入予測モデル・BeforeInfoScorer）が実装されているにもかかわらず、効果が表れていない

**2. BeforeInfoScorerは正常に動作している**
- 単体テストで確認済み
- スコア範囲: -15〜+18点程度
- 例（race_id 132764）:
  - 1号: 0.17点
  - 2号: -5.00点
  - 3号: -15.17点
  - 4号: -8.33点
  - 5号: **17.50点**（最高評価）
  - 6号: 3.33点

**3. 影響力不足**
- BEFORE_SCOREの範囲: -15〜+18点
- 15%の重みでの影響: -2.25〜+2.7点
- PRE_SCOREの順位間差: 通常10〜30点
- → BEFORE_SCOREではPRE_SCOREの順位を覆せない

---

## テスト方法

### 実装

[test_weight_optimization.py](../test_weight_optimization.py)

### 手順

1. 最新200レースを取得
2. 各重み配分パターンで以下を測定：
   - 統合予測の的中率
   - PRE単体予測の的中率
   - 予測が異なるレース数（予測変化率）
   - 差分（統合 - PRE単体）

3. DynamicIntegratorのクラス定数を一時的に変更：
```python
DynamicIntegrator.DEFAULT_PRE_WEIGHT = pre_weight
DynamicIntegrator.DEFAULT_BEFORE_WEIGHT = before_weight
```

4. 各パターンテスト後、元の値に復元

---

## テスト結果

### 【テスト実行中...】

現在200レースでのバックテストを実行中です。

完了次第、以下の情報が得られます：
- 各パターンの統合的中率
- PRE単体的中率
- 差分（改善幅）
- 予測変化率（統合とPRE単体で予測が異なるレース数）

---

## 暫定分析

### 予想される結果パターン

**パターンA: PRE 85/15（現状）**
- 予測変化: 0件（PRE単体と完全一致）
- 差分: ±0.0ポイント
- 判定: 新機能の効果なし

**パターンB: PRE 70/30**
- 予測変化: 数件〜十数件
- BEFORE_SCOREの影響力増加
- 精度への影響は不明（要測定）

**パターンC: PRE 60/40**
- 予測変化: 十数件〜数十件
- BEFORE_SCOREの影響力が実質的
- 精度向上の可能性

**パターンD: PRE 50/50**
- 予測変化: 最大
- PRE_SCOREとBEFORE_SCOREが対等
- 精度低下のリスク

---

## 判定基準

### 推奨する設定

以下の条件を満たす重み配分を推奨：

1. **予測変化率が10%以上**
   - 統合予測がPRE単体と異なるレースが最低10%以上
   - 新機能が実質的に機能していることを示す

2. **精度が維持または向上**
   - 統合的中率 ≥ PRE単体的中率
   - 最低でも-1.0ポイント以内の低下に収まる

3. **バランスの良さ**
   - PRE_SCORE（長期実力）を主体としつつ
   - BEFORE_SCORE（当日状態）を適切に反映

### 設定変更の判断

| 差分 | 判定 |
|------|------|
| +2.0%以上 | 即座に変更すべき |
| +1.0%〜+1.9% | 変更を強く推奨 |
| +0.5%〜+0.9% | 変更を検討 |
| 0%〜+0.4% | 現状維持を検討 |
| -0.5%〜-0.1% | 現状維持 |
| -0.5%以下 | 変更しない |

---

## 次のステップ

### テスト完了後

1. **結果の分析**
   - 最良パターンの特定
   - 予測変化率の確認
   - 精度への影響評価

2. **設定反映**（推奨設定が見つかった場合）
   - [src/analysis/dynamic_integration.py](../src/analysis/dynamic_integration.py) の修正
   - DEFAULT_PRE_WEIGHT と DEFAULT_BEFORE_WEIGHT を更新

3. **追加検証**（必要に応じて）
   - より大規模なバックテスト（500〜1000レース）
   - 時系列での安定性確認

---

## 関連ドキュメント

- [残タスク一覧](./remaining_tasks.md) - タスク2: 動的統合の重み配分最適化
- [最終検証レポート](./feature_validation_final_report.md) - 現状の問題点
- [予想ロジック仕様書](./prediction_system_spec.md) - セクション10.6: 懸念点と対策

---

**ステータス**: テスト実行中
**更新予定**: テスト完了次第、結果を追記
