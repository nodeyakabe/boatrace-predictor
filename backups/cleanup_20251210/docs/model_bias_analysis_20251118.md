# モデルバイアス分析レポート 2025-11-18

## 実行日
2025年11月18日

## 分析対象
- モデル: `conditional_rank_v1`
- テストデータ: 2025年10月（7日間、210レース）
- 比較対象: 実際のレース結果

---

## 🚨 発見された重大な問題

### 1. モデルの予測精度

| 指標 | 結果 | 評価 |
|------|------|------|
| Top1的中率 | 2.9% | ✅ やや良好（期待値0.83%） |
| Top3的中率 | 11.0% | ✅ 良好（期待値2.5%） |
| Top5的中率 | 17.1% | ✅ 良好（期待値4.2%） |

**結論**: 予測精度自体は悪くない。問題はバイアス。

---

### 2. **深刻なバイアス**

#### 艇番別の実際の勝率 vs 予測頻度

| 艇番 | 実際の勝率 | 予測頻度 | バイアス | 評価 |
|------|-----------|---------|---------|------|
| **1号艇** | **49.5%** | **24.3%** | **-25.2%** | ❌ **過小評価** |
| 2号艇 | 12.9% | 14.3% | +1.4% | ✅ 適正 |
| 3号艇 | 13.3% | 13.3% | 0.0% | ✅ 適正 |
| 4号艇 | 10.0% | 12.9% | +2.9% | ✅ 適正 |
| **5号艇** | **11.9%** | **22.9%** | **+11.0%** | ❌ **過大評価** |
| **6号艇** | **2.4%** | **12.4%** | **+10.0%** | ❌ **過大評価** |

#### 問題点まとめ

1. **1号艇を25%過小評価**
   - 実際: 半分のレースで勝つ（49.5%）
   - 予測: 4回に1回しか勝たないと予測（24.3%）
   - **影響**: 最も有利な艇を見逃している

2. **5号艇を11%過大評価**
   - 実際: 12%の勝率
   - 予測: 23%の勝率
   - **影響**: 不利な艇に賭けを推奨してしまう

3. **6号艇を10%過大評価**
   - 実際: わずか2.4%の勝率
   - 予測: 12%の勝率（5倍！）
   - **影響**: 最も不利な艇を過大評価

---

### 3. 期待値への影響

#### 昨日（2025-11-17）戸田1Rのケース

**期待値Top10の予測:**
```
1. 5-4-1: 確率0.79% × オッズ847.7倍 = 期待値6.70
2. 5-4-3: 確率0.73% × オッズ842.1倍 = 期待値6.15
3. 5-4-2: 確率0.73% × オッズ815.3倍 = 期待値5.91
4. 4-5-3: 確率1.07% × オッズ516.8倍 = 期待値5.55
...
8. 6-4-1: 確率0.28% × オッズ1443倍 = 期待値4.04
```

**問題**:
- 5号艇・6号艇が上位を占める
- オッズが高い（=市場は不利と評価）組み合わせを推奨
- 実際には6号艇の勝率は2.4%しかない

**実際の最適戦略**:
- 1号艇中心の組み合わせを重視すべき
- 1号艇は49.5%勝つため、低オッズでも期待値がある

---

## 原因分析

### 現在の特徴量（11個）

```python
特徴量:
- win_rate          # 選手勝率
- second_rate       # 選手2連率
- third_rate        # 選手3連率
- motor_2nd_rate    # モーター2連率
- motor_3rd_rate    # モーター3連率
- boat_2nd_rate     # ボート2連率
- boat_3rd_rate     # ボート3連率
- weight            # 選手体重
- avg_st            # 平均ST
- local_win_rate    # 当地勝率
- racer_rank_score  # 級別スコア
```

### 🚨 **欠けている最重要特徴量**

```python
❌ pit_number  # 艇番（コース位置）
```

#### 競艇の基本原則

- **1号艇（インコース）**: 最短距離、勝率約50%
- **2号艇〜4号艇**: まずまず有利
- **5号艇・6号艇（アウトコース）**: 不利、勝率10%以下

**モデルは艇番情報を受け取っていないため、コース有利性を学習できていない**

---

## 影響

### 1. 期待値計算への影響

| シナリオ | 予測確率 | 実際の確率 | オッズ | 予測期待値 | 実際の期待値 | 判定 |
|---------|---------|-----------|--------|-----------|-------------|------|
| 1-2-3 | 低く予測 | 高い | 低い | 低い | **高い** | ❌ 見逃し |
| 6-4-1 | 高く予測 | 極めて低い | 極めて高い | 高い | **低い** | ❌ 誤推奨 |

### 2. ROIへの影響

- **現状**: 5号艇・6号艇中心の推奨 → 的中率低 → 長期的損失
- **理想**: 1号艇中心の推奨 → 的中率高 → 長期的利益

---

## 修正方法

### 方法1: 艇番を特徴量に追加（最優先）

```python
feature_cols = [
    'pit_number',       # ← 追加
    'win_rate',
    'second_rate',
    ...
]
```

**メリット**:
- モデルが艇番（コース位置）の有利性を直接学習
- 最も効果的

**デメリット**:
- モデルの再学習が必要

### 方法2: コース有利度スコアを追加

```python
# コース有利度（統計的な勝率）を特徴量化
course_advantage = {
    1: 50.0,   # 1号艇は平均50%勝つ
    2: 14.0,
    3: 12.0,
    4:  9.0,
    5:  8.0,
    6:  3.0
}
df['course_advantage'] = df['pit_number'].map(course_advantage)
```

**メリット**:
- ドメイン知識を直接注入
- 確実に効果あり

**デメリット**:
- 会場ごとの違いを反映しにくい

### 方法3: 確率の事後補正（応急処置）

```python
# 予測確率を艇番別の統計で補正
def adjust_probabilities(probs: Dict[str, float], pit_stats: Dict[int, float]):
    """
    probs: {'1-2-3': 0.08, ...}
    pit_stats: {1: 0.50, 2: 0.14, ...}  # 艇番別の実際の勝率
    """
    adjusted = {}
    for combo, prob in probs.items():
        first_pit = int(combo.split('-')[0])

        # 1着艇番の実際の勝率で補正
        correction_factor = pit_stats[first_pit] / 0.167  # 0.167 = 1/6（均等分布）

        adjusted[combo] = prob * correction_factor

    # 正規化（合計を1にする）
    total = sum(adjusted.values())
    return {k: v/total for k, v in adjusted.items()}
```

**メリット**:
- モデルの再学習不要
- 即座に適用可能

**デメリット**:
- 根本的な解決ではない
- 補正係数の調整が必要

---

## 推奨アクション

### 短期（即時対応）

1. **確率の事後補正を実装**
   - `realtime_odds_predictor.py`に補正ロジックを追加
   - 艇番別勝率の統計データを使用（上記の分析結果）

2. **警告メッセージの追加**
   - ユーザーに「モデルは艇番バイアスあり」と表示

### 中期（1週間以内）

1. **艇番を特徴量に追加してモデル再学習**
   - `train_conditional_model.py`を修正
   - 過去3ヶ月〜1年のデータで再学習

2. **バックテスト再実行**
   - 新モデルのROI検証

### 長期（1ヶ月以内）

1. **会場別モデルの構築**
   - 1号艇有利度は会場によって異なる
   - 各会場専用モデルを学習

2. **高度な特徴量エンジニアリング**
   - 展示タイム × 艇番
   - ST × 艇番
   - モーター性能 × 艇番
   - などの交互作用項

---

## 検証方法

### 修正前後の比較指標

1. **バイアス指標**
   - 各艇番の（予測頻度 - 実際の勝率）の絶対値合計
   - 目標: 5%以内

2. **期待値の信頼性**
   - 期待値1.5以上の推奨ベットの実際のROI
   - 目標: 130%以上

3. **的中率**
   - Top1的中率: 現状2.9% → 目標5%以上
   - Top3的中率: 現状11% → 目標20%以上

---

## まとめ

### 現状の問題点

- ✅ オッズ取得: 正常動作
- ✅ 予測システム統合: 正常動作
- ❌ **モデルのバイアス**: 深刻な問題
  - 1号艇を25%過小評価
  - 5号艇・6号艇を10%以上過大評価

### 優先度

| タスク | 優先度 | 所要時間 | 効果 |
|--------|-------|---------|------|
| 確率の事後補正実装 | 🔴 最高 | 30分 | 即効性あり |
| 艇番特徴量追加+再学習 | 🟠 高 | 3時間 | 根本的解決 |
| バックテスト再実行 | 🟡 中 | 1時間 | 効果検証 |
| 会場別モデル構築 | 🟢 低 | 1週間 | さらなる精度向上 |

---

**作成日**: 2025年11月18日
**分析者**: Claude
**次回確認**: 修正実装後
