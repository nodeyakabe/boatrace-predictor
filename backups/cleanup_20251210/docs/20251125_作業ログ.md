# 2025年11月25日 作業ログ

## 実施した作業

### 1. UI不具合の修正（一連のエラー対応）

#### 1.1 過去データ一括取得機能のエラー修正
**問題:** BulkScraper.fetch_date_range メソッドが存在しないエラー
- **ファイル:** `ui/components/bulk_data_collector.py`
- **修正内容:**
  - `fetch_date_range`を日付ループ + `fetch_multiple_venues`に変更（161-184行目）
  - Pythonインタープリタパスを`sys.executable`に変更（203行目）
  - 重複importの削除（timedelta）

#### 1.2 予測生成ワークフローの修正
**問題:** 予測生成が実行されていなかった
- **ファイル:** `ui/components/workflow_manager.py`
- **修正内容:**
  - `fetch_today_data()`の戻り値をboolからscheduleに変更
  - `generate_and_save_predictions()`の呼び出しを追加（80行目）
  - 関数名の修正（generate_today_predictions → generate_and_save_predictions）
  - 文言を「予想準備」→「予測生成」に統一

#### 1.3 信頼度表示の修正
**問題1:** 信頼度が常に100.0%表示
- **ファイル:** `ui/components/unified_race_list.py`
- **修正内容:** A/B/C/D/Eレベルからの加重平均計算に変更（144-155行目）

**問題2:** レース詳細画面でKeyError: 'total_score'
- **ファイル:** `ui/components/unified_race_detail.py`
- **修正内容:** `pred.get('total_score', pred.get('score', 0))`でフォールバック対応（184行目）

**問題3:** TypeError: '>=' not supported between 'str' and 'int'
- **ファイル:** `ui/components/common/widgets.py`
- **修正内容:** `render_confidence_badge()`で文字列レベル(A/B/C/D/E)を数値に変換（80-82行目）

### 2. 設定ファイルの追加
- **ファイル:** `config/prediction_improvements.json`
- **追加内容:** `probability_calibration`セクション

---

## 発見した重大な問題

### 信頼度分布の深刻な偏り

#### 現状データ（過去7日間）
```
A: 0件 (0.0%)
B: 10件 (0.6%)
C: 112件 (7.1%)
D: 194件 (12.2%)
E: 1268件 (80.1%)  ← 圧倒的多数
```

#### 今日(2025-11-25)の分布
```
A: 0件
B: 4件
C: 50件
D: 98件
E: 568件 (79%)  ← 8割がE判定
```

#### スコア分布（信頼度別平均）
```
B: 平均69.5点 (最大76.9, 最小60.8)
C: 平均61.7点 (最大75.7, 最小49.9)
D: 平均49.5点 (最大71.6, 最小37.2)
E: 平均33.8点 (最大48.7, 最小15.7)
```

### 問題の本質

**スコア自体が低すぎる**ことが根本原因。

- 現在の信頼度判定基準:
  - A: 75点以上
  - B: 65点以上
  - C: 55点以上
  - D: 45点以上
  - E: 45点未満

- 実際の平均スコア: **33.8点（E判定レベル）**

これは信頼度判定の問題ではなく、**スコアリングロジック自体の問題**。

---

## 根本原因の分析

### スコアリング重み設定（現状）
```python
course_weight: 35.0     # コース別勝率
racer_weight: 35.0      # 選手成績
motor_weight: 20.0      # モーター性能
kimarite_weight: 5.0    # 決まり手傾向
grade_weight: 5.0       # グレード
合計: 100.0
```

### 推測される問題点

1. **コーススコアの算出方法**
   - 1号艇の勝率55% → そのまま55%のスコア → 35点満点で19.25点
   - 正規化されていないため、理論上の最大値に到達しない

2. **選手・モータースコアの算出方法**
   - 同様に正規化不足で低スコアになっている可能性

3. **スコア計算の各段階で減衰**
   - 各要素が0-1の範囲で計算され、合計しても低い値になる

---

## 残タスク（優先度順）

### 【最優先】スコアリングロジックの抜本的改善

#### Phase 1: 現状分析（1-2時間）
- [ ] 各スコア要素の分布を分析
  - コーススコア、選手スコア、モータースコアの実際の値
  - 各要素が最終スコアにどう寄与しているか

- [ ] 過去データで的中率と各要素の相関を分析
  - どの要素が実際の的中に寄与しているか
  - 現在の重み配分が適切か検証

#### Phase 2: スコア算出ロジックの改善（2-3時間）
- [ ] コーススコアの正規化
  ```python
  # 改善案
  # 各会場のコース別勝率の最大値を100%として正規化
  normalized_score = (win_rate / max_win_rate) * course_weight
  ```

- [ ] 選手スコアの正規化
  ```python
  # 改善案
  # レース内の選手を相対評価（最上位=満点、最下位=0点）
  # または、全選手の勝率分布での偏差値的な算出
  ```

- [ ] モータースコアの正規化
  ```python
  # 改善案
  # 同一会場内での相対評価
  ```

#### Phase 3: 重み配分の最適化（3-4時間）
- [ ] 過去データで各要素と的中率の相関を計算
- [ ] グリッドサーチまたは機械学習で最適な重みを探索
- [ ] バックテストで検証

#### Phase 4: 信頼度判定ロジックの見直し（1時間）
- [ ] スコア分布が改善された後、信頼度基準を再調整
- [ ] データ充実度スコアの基準も見直し

### 【高優先】分析スクリプトの作成

- [ ] `analyze_score_components.py` - 各スコア要素の詳細分析
- [ ] `analyze_accuracy_by_factor.py` - 的中率と各要素の相関分析
- [ ] `optimize_weights.py` - 重み配分の最適化スクリプト

### 【中優先】UI改善

- [ ] スコア内訳の詳細表示
  - 各要素のスコアを個別に表示
  - どの要素が高/低かを可視化

- [ ] 信頼度の説明を改善
  - 現在の判定基準をUI上で明示
  - データ充実度スコアも表示

---

## 技術的知見

### 1. Streamlit UIのベストプラクティス
- 重複するwidgetには必ず一意のkeyを設定する
- date_input等の状態を持つwidgetは特に注意

### 2. Pythonスコープの落とし穴
- 関数内で同名のimportを行うとlocal変数として扱われる
- module levelのimportとfunction levelのimportの混在に注意

### 3. データ構造の互換性
- 予測データの構造が複数の形式で存在
- `total_score` vs `score`
- `confidence`の数値 vs 文字列（A/B/C/D/E）
- 柔軟なkey accessが必要（`dict.get()`のフォールバック活用）

### 4. 信頼度表示の設計思想
- 文字列レベル（A/B/C/D/E）を内部で使用
- UI表示時に数値変換して色分け
- A=100%, B=80%, C=60%, D=40%, E=20%のマッピング

---

## 実装済み改善機能の状態

### ✅ 有効化済み
1. Laplace平滑化（alpha=2.0）
2. 1着固定ルール（閾値0.55）
3. 信頼度Eフィルタ
4. 評価指標の計算
5. 進入予想（前付け傾向）
6. 潮位補正ロジック
7. DBインデックス最適化

### ❌ 未実装/無効
8. モーター指数加重移動平均（EWMA）
9. 展示データ自動取得（骨格のみ）
10. 確率較正（Calibration）

---

## 次回作業の開始点

1. `analyze_score_components.py`を作成して各要素の実際の値を確認
2. スコアが低い原因を特定（正規化不足 or 計算ロジック）
3. コーススコアから順に正規化ロジックを実装
4. 1レース分でテストして効果を確認
5. 全体に適用してバックテスト

---

## 参考資料

### 関連ファイル
- `src/analysis/race_predictor.py` - メインの予測エンジン
  - `_calculate_confidence()` (486-582行目) - 信頼度判定
  - `calculate_course_score()` (60-100行目) - コーススコア計算
- `src/utils/scoring_config.py` - スコアリング重み設定
- `config/prediction_improvements.json` - 改善機能の設定

### データベーステーブル
- `race_predictions` - 予測結果（race_id基準）
- `prediction_history` - 予測履歴
- `races` - レース基本情報
- `results` - レース結果

---

## コミットメッセージ案

```
Fix UI bugs and analyze confidence distribution issues

- Fix bulk data collector errors (fetch_date_range, timedelta import)
- Fix prediction workflow (missing function call, terminology)
- Fix confidence display (100% bug, KeyError, TypeError)
- Add confidence distribution analysis script
- Document critical scoring logic issues (80% E-level predictions)

Next: Improve scoring logic to increase prediction accuracy
```
