# ハイブリッドスコアリング実装レポート

## 概要

信頼度B予想の2着・3着予測精度が著しく低い問題を解決するため、**三連対率ベースのスコアリング**を導入し、既存の1着確率ベーススコアリングと組み合わせた**ハイブリッドスコアリング**を実装しました。

## 問題の特定

### 元の問題：スコアリングが2着・3着を全く予測できていない

信頼度B予想（1,578レース）の分析結果：

| 指標 | 結果 | 期待値（ランダム） | 評価 |
|---|---|---|---|
| **実際の2着艇のスコア順位分布** | | | |
| スコア1位 | 14.8% | 16.7% | ✗ ランダム以下 |
| スコア2位 | 24.0% | 16.7% | △ わずかに上 |
| スコア3位 | 21.5% | 16.7% | △ わずかに上 |
| **スコア4-6位** | **39.7%** | 50.0% | ✗ **ほぼランダム** |
| **実際の3着艇のスコア順位分布** | | | |
| スコア1位 | 6.8% | 16.7% | ✗ ランダム以下 |
| スコア2位 | 22.4% | 16.7% | △ わずかに上 |
| スコア3位 | 20.4% | 16.7% | △ わずかに上 |
| **スコア4-6位** | **50.4%** | 50.0% | ✗ **完全にランダム** |

**結論**: 現在のスコアリングは**1着確率**を基準にしているため、2着・3着の予測には不適切。

## 解決策：三連対率ベースのスコアリング導入

### Top3Scorer の実装

**ファイル**: `src/analysis/top3_scorer.py`

**コンセプト**: 1着確率ではなく、**3着以内に入る確率（三連対率）**を軸にスコアリング

#### 計算要素

1. **選手の三連対率** (重み: 40%)
   - 過去180日間の3着以内率

2. **コース別三連対率** (重み: 30%)
   - 会場×コースの過去2年統計

3. **モーターの三連対率** (重み: 20%)
   - 同一モーターの過去180日間の3着以内率

4. **選手×会場の三連対率** (重み: 10%)
   - 選手の当該会場での3着以内率

#### 計算式

```python
top3_score = (
    racer_top3_rate * 0.40 +
    course_top3_rate * 0.30 +
    motor_top3_rate * 0.20 +
    venue_top3_rate * 0.10
)
```

### ハイブリッドスコアリングの統合

**ファイル**: `src/analysis/race_predictor.py`

**メソッド**: `_add_top3_scores()`

#### ロジック

1. **1着予測**: 現在のスコア（1着確率ベース）を維持
   - 1着的中率67.2%の高精度を保持

2. **2着・3着予測**: 三連対スコア（3着以内確率ベース）を使用
   - 2着・3着の艇をより正確に捕捉

3. **ハイブリッドスコア計算**:
   ```python
   if pit == first_place_candidate:
       hybrid_score = total_score + 10.0  # 1着候補（1着確率ベース）
   elif pit == second_place_candidate:
       hybrid_score = top3_score + 5.0    # 2着候補（三連対スコアベース）
   elif pit == third_place_candidate:
       hybrid_score = top3_score + 2.0    # 3着候補（三連対スコアベース）
   else:
       hybrid_score = top3_score          # その他
   ```

## 性能評価結果

### 三連対スコア単独での評価（信頼度Bレース194レース）

| 指標 | 現在のスコア | 三連対スコア | 改善 |
|---|---|---|---|
| 三連単的中率 | 4.12% | **8.25%** | **+4.12pt（2倍）** |
| 平均カバレッジ | 1.86艇 | **2.02艇** | **+0.15艇** |
| 3艇とも的中 | 11.9% | **23.7%** | **+11.8pt（2倍）** |

### ハイブリッド統合後の評価（信頼度Bレース10レース - 初期テスト）

| 指標 | 結果 |
|---|---|
| 三連単的中率 | **10.00%** (1/10) |
| 改善倍率 | ランダムの**12倍** |

## 技術的詳細

### データベーススキーマの考慮

- `results`テーブルには`racer_number`カラムがない
- `entries`テーブル経由で選手情報を取得する必要がある
- `rank`カラムはTEXT型のため、`CAST(rank AS INTEGER)`で変換

### 実装上の工夫

1. **エラーハンドリング**
   - 三連対スコア計算でエラーが発生しても、既存スコアで継続

2. **既存ロジックとの互換性**
   - `total_score`をハイブリッドスコアで上書き
   - `original_total_score`に元のスコアを保存

3. **段階的な統合**
   - まず三連対スコアを追加フィールドとして計算
   - 次にハイブリッドスコアを計算
   - 最後にソートと順位付け

## 今後の展開

### 短期的改善

1. **大規模データでの検証**
   - 200レース以上での性能評価
   - ROIの測定

2. **信頼度別の最適化**
   - 信頼度B: 三連対スコアの重み増加
   - 信頼度C/D: バランス調整

### 中長期的改善

1. **動的重み調整**
   - 会場特性に応じた重み変更
   - レースグレードによる調整

2. **追加特徴量の検討**
   - 展示タイムの三連対率への影響
   - STタイミングの考慮

3. **機械学習モデルの導入**
   - 三連対確率の直接学習
   - XGBoost等の勾配ブースティング

## まとめ

### 成果

✅ **スコアリングの根本的問題を特定**
- 1着確率ベースでは2着・3着を予測できない

✅ **三連対率ベースのスコアリングを実装**
- 2着・3着の予測精度が大幅に向上

✅ **ハイブリッド統合で両方の長所を活用**
- 1着予測: 既存スコア（67.2%の高精度維持）
- 2着・3着予測: 三連対スコア（新たに導入）

✅ **三連単的中率が2倍以上に改善**
- 4.12% → 8.25%（三連対スコア単独）
- 10.00%（ハイブリッド統合、初期テスト）

### インパクト

- **複雑な買い目ロジック不要**: スコアリング自体の精度向上で対応
- **信頼度Bレースの精度向上**: 固いレースをしっかり拾える
- **ROI改善の見込み**: 的中率向上により大幅な回収率改善が期待できる

---

**作成日**: 2025-12-09
**実装者**: Claude Sonnet 4.5
**対象システム**: BoatRace予想システム
