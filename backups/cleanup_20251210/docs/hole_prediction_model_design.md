# 穴予測専用モデル設計書

## 1. 背景・課題

### 現状の課題
- 現行モデルは信頼度A/B（鉄板レース）に最適化されており、中穴・大穴レースの予測精度が低い
- 信頼度C/Dの月間的中数は2-3件と少なく、収支が不安定
- 1着予測は高精度（1コースA1で約80%）だが、2着・3着予測が弱い
- 荒れるレース（1コース敗北）での予測精度が特に低い

### バックテスト結果
| 条件 | 1-2着的中率 | 3連単的中率 | ROI |
|------|-------------|-------------|-----|
| 全体 | 16-17% | 5-6% | 70-80% |
| 荒れレース（C） | 2.6% | 1% | 低 |
| 荒れレース（D） | 9.0% | 3% | 中 |

## 2. 設計方針

### 2.1 二段階アプローチ
現行モデルを「鉄板予測モデル」として維持しつつ、別途「穴予測モデル」を構築する。

```
[入力データ] → [レース分類器] → [鉄板 or 荒れ判定]
                                    ↓
              [鉄板モデル] ← 鉄板 → 既存モデル使用
                                    ↓
              [穴モデル] ← 荒れ → 新規モデル使用
```

### 2.2 穴予測モデルの特徴
1. **荒れ判定に特化**: 1コースが負ける条件を学習
2. **2着・3着予測強化**: 展示タイム、直前情報を重視
3. **波乱要因の検出**: スタートタイミング、風向き、水面状況

## 3. 技術仕様

### 3.1 特徴量設計

#### 既存特徴量（継続使用）
- 選手基本情報（勝率、2連率、3連率）
- コース別成績（コース別勝率、コース別2連率）
- 当地成績、モーター成績
- 級別（A1/A2/B1/B2）

#### 新規追加特徴量（穴予測用）
```python
HOLE_FEATURES = {
    # スタート関連
    'start_timing_diff': '1コース選手と他選手の平均STタイミング差',
    'start_consistency': '1コース選手のSTタイミングの安定性（標準偏差）',
    'challenger_start_ability': '2-6コース選手のST能力の最大値',

    # 展示タイム関連
    'exhibition_rank_1c': '1コース選手の展示タイム順位',
    'exhibition_gap_to_top': '1コース選手と展示トップとの差',
    'exhibition_top_boat': '展示タイムトップの艇番',

    # 波乱要因
    'c1_recent_form': '1コース選手の直近10レース成績',
    'c1_course_compatibility': '1コース選手のインコース適性（過去勝率）',
    'weather_upset_factor': '天候による波乱係数（風速×波高）',

    # 対戦相手の強さ
    'opponent_strength_max': '2-6コース選手の最高勝率',
    'opponent_a1_count': '2-6コースにA1級が何人いるか',
    'outer_course_threat': '4-6コースの「まくり」能力（決まり手実績）',
}
```

### 3.2 モデル構造

#### 荒れ判定モデル（分類）
```python
class UpsetClassifier:
    """1コースが負けるかどうかを予測"""

    model: LightGBM / XGBoost
    target: binary (1コース1着 or not)
    threshold: 0.35 (荒れやすいレースを拾う)
```

#### 穴着順予測モデル（回帰/ランキング）
```python
class HoleRankPredictor:
    """荒れレース専用の着順予測"""

    model: LightGBM LambdaRank / Neural Network
    target: ranking (1-6)
    focus: 2-6コースの順位予測に重点
```

### 3.3 学習データ

#### データ選定
- 期間: 2024年1月〜2025年11月
- 対象: 1コースが2着以下になったレース（全体の約35%）
- 除外: 転覆・失格など異常レース

#### ラベル設計
```python
# 荒れ判定ラベル
is_upset = (result_1st_course != 1)

# 着順予測ラベル（荒れレースのみ）
rank_labels = [result_rank_boat1, result_rank_boat2, ..., result_rank_boat6]
```

### 3.4 評価指標

| 指標 | 目標値 | 説明 |
|------|--------|------|
| 荒れ判定Recall | 70%以上 | 実際に荒れるレースを漏らさない |
| 荒れ判定Precision | 40%以上 | 荒れ予測の正確さ |
| 穴3連単的中率 | 5%以上 | 荒れレースでの3連単的中 |
| ROI | 120%以上 | 回収率 |

## 4. 実装計画

### Phase 1: データ準備（1週間）
1. 荒れレースの特徴量データ抽出
2. 新規特徴量の算出
3. 学習/検証データセットの作成

### Phase 2: 荒れ判定モデル構築（1週間）
1. LightGBMによる二値分類モデル
2. ハイパーパラメータチューニング
3. 閾値最適化

### Phase 3: 穴着順予測モデル構築（2週間）
1. ランキングモデルの実装
2. 2着・3着予測の精度向上
3. アンサンブル手法の検討

### Phase 4: 統合・検証（1週間）
1. 既存システムへの統合
2. バックテスト検証
3. 運用条件の最適化

## 5. 期待効果

### 改善予測
| 指標 | 現状 | 改善後 |
|------|------|--------|
| 月間的中数 | 2-3件 | 5-8件 |
| 荒れレース的中率 | 2-3% | 5-8% |
| 月間ROI安定性 | 63.6%黒字月 | 70%以上 |

### リスク
- 過学習の可能性（荒れレースはサンプルが少ない）
- 計算コストの増加
- 既存システムとの統合複雑化

## 6. 代替案

### A案: 現行モデルの微調整
- 特徴量追加のみで対応
- リスク低、効果も限定的

### B案: 完全分離モデル
- 鉄板/荒れで完全に別モデル
- 本設計書の方針

### C案: マルチタスク学習
- 1つのモデルで複数タスクを学習
- 実装複雑、効果は高い可能性

## 7. 結論

穴予測専用モデルの構築により、以下の改善が期待できる：

1. **月間的中数の増加**: 2-3件 → 5-8件
2. **収支安定化**: 黒字月率63.6% → 70%以上
3. **荒れレースへの対応力向上**

実装優先度は「2連単追加」の次とし、Phase 1から順次進める。
