# 2025-11-26 作業ログ：拡張スコアリング実装

## 実施内容

### 1. バックグラウンドジョブシステムの改善
- **問題**: `subprocess.run`の`capture_output=True`がPIPEバッファをブロックしてハング
- **解決**: 出力をファイルにリダイレクトする方式に変更
- **対象ファイル**:
  - `scripts/worker_tenji_collection.py`
  - `scripts/worker_missing_data.py`

### 2. 拡張スコアリング機能の実装（HIGH/MEDIUM優先度）

#### 新規ファイル: `src/analysis/extended_scorer.py`

| 優先度 | 機能 | 説明 | スコア範囲 |
|--------|------|------|-----------|
| HIGH | 選手級別スコア | A1=10点, A2=7点, B1=4点, B2=1点 | 0〜10点 |
| HIGH | F/L持ちペナルティ | F持ち=-3点/回, L持ち=-1.5点/回 | -10〜0点 |
| HIGH | 節間成績分析 | 同会場直近7日の成績を評価 | 0〜5点 |
| HIGH | 前走レベル評価 | 前走グレード×結果で調子を推定 | 0〜5点 |
| MEDIUM | 進入コース予測 | 枠番別の進入傾向から予測 | 情報として提供 |
| MEDIUM | 選手間相性分析 | レース内での相対的力関係 | 0〜5点 |
| MEDIUM | モーター特性分析 | 会場別のモーター勝率を分析 | 0〜5点 |

#### 統合方式
- 拡張スコアは総合重み **15点** として既存スコアに加算
- 合計スコアは0〜100点に正規化
- 詳細情報は `extended_detail` としてUIに提供

#### 保留した機能（LOW優先度）
- 水質/水温影響
- オッズ連動分析
- 疲労度分析

---

## 今後に使える知見

### 信頼度向上について

#### 現状の信頼度判定ロジック
```
信頼度 = min(スコアによる判定, データ量による上限)
```
- スコア判定: 75点以上→A、65点以上→B、55点以上→C...
- データ量上限: 選手の全国/コース/当地成績 + モーター成績のレース数で判定

#### 要素を増やすだけでは信頼度は上がらない理由
1. 新要素の重みが小さい（全体の15%程度）
2. データ量の上限に引っかかっている
3. 信頼度は「予測の確かさ」であり「予測要素の多さ」ではない

#### 改善の優先順位
| 方法 | 効果 | 現状 |
|------|------|------|
| 1. 過去データの蓄積 | △ | **十分**（2年分15,558レース） |
| 2. 的中率ベースの信頼度 | ○ | バックテストで代用可能 |
| 3. 要素の重み最適化 | ◎ | **次のステップ** |

### 重み最適化のアプローチ

| 方法 | 難易度 | 効果 | 説明 |
|------|--------|------|------|
| A. 手動調整 | 低 | △ | バックテストしながら手で調整 |
| B. グリッドサーチ | 中 | ○ | 重みの組み合わせを総当たり |
| C. 機械学習 | 高 | ◎ | 過去データから最適重みを学習 |

**次のステップ**: バックテストで現状の的中率を把握し、その結果を見てから重み調整の方向を決める

---

## 現状のスコア構成

```
コース: 35%
選手: 35%
モーター: 20%
決まり手: 5%
グレード: 5%
拡張: 15%（新規追加）
```

## 今日の予想結果（参考）
- 信頼度分布: A=0件、B=1件、C=15件、D=4件
- スコア86.5でもC判定 → データ量上限に引っかかっている

---

## 次回やること
1. バックテストで現状の的中率を確認
2. 条件別（会場/グレード/コース）の的中率分析
3. 結果を見て重み調整の方向を決定
