# 競艇予測システム 改善計画書

**作成日**: 2024年11月27日
**実装完了日**: 2024年11月27日
**旧・単勝的中率**: 58.75%
**新・単勝的中率**: 59.98% ✅
**改善効果**: **+1.23%**

---

## 実装結果サマリー

```
【バックテスト結果】2024-01-01 ～ 2024-11-20（9,849レース）

旧設定: 58.75%（5,786的中）
新設定: 59.98%（5,907的中）

改善効果: +1.23%（+121件の的中増）
```

### 新設定の重み配分（config/settings.py）
| 要素 | 旧設定 | 新設定 | 変更 |
|------|-------|-------|------|
| コース | 35% | 20% | -15% |
| 選手 | 35% | 31% | -4% |
| モーター | 20% | 14% | -6% |
| 級別 | 10% | 10% | - |
| 展示ST | - | 15% | +15%（新規） |
| 展示タイム | - | 10% | +10%（新規） |

### 追加ファイル
- `src/analysis/improved_scorer.py`: 改善版スコアリングモジュール
- `temp/backtest_all_improvements.py`: 全改善案のバックテスト
- `temp/verify_improvement.py`: 改善効果検証スクリプト

---

## 元の計画書

**目標**: 61〜63%

---

## 1. 外部AI改善案の評価

### データ可用性確認結果

| 改善案 | 必要データ | DBカラム | データ有無 | 件数 |
|--------|-----------|----------|----------|------|
| 展示ST混合 | 当日展示ST | race_details.st_time | ✅ | 716,127件 |
| 展示タイム順位 | 展示タイム | race_details.exhibition_time | ✅ | 622,087件 |
| 進入コース予測 | 実際の進入コース | race_details.actual_course | ✅ | 565,998件 |
| 波高×体重 | 波高、体重 | race_conditions.wave_height, entries.racer_weight | ✅ | 130,380件 / 794,556件 |
| 会場別スコア削除 | - | - | 即時可能 | - |
| モーター配点軽減 | - | - | 即時可能 | - |

---

## 2. 改善案の優先度評価

### Phase 1: 即効性・低リスク（設定変更のみ）

| 改善案 | 期待改善 | 実装難度 | リスク | 優先度 |
|--------|---------|---------|-------|-------|
| **会場別1コース勝率を予測から除外** | +0.3〜0.5% | ★☆☆ 低 | 低 | **🔴 最優先** |
| **モーター配点を20→12に軽減** | +0.5〜0.8% | ★☆☆ 低 | 低 | **🔴 最優先** |

**根拠**:
- ML分析で `venue_in1` が18.3%の逆効果と判明
- モーターは実質2.4%の影響度に対し20%配点は過大

### Phase 2: 高効果・中難度（新機能追加）

| 改善案 | 期待改善 | 実装難度 | リスク | 優先度 |
|--------|---------|---------|-------|-------|
| **展示ST混合（過去6:当日4）** | +1.2〜1.8% | ★★☆ 中 | 低 | **🟠 高** |
| **展示タイム順位評価** | +0.5〜1.0% | ★★☆ 中 | 低 | **🟠 高** |

**根拠**:
- 展示STデータは716,127件と十分
- 相対順位評価は既にML分析で効果確認済み（6.4%影響度）

### Phase 3: 中効果・高難度（進入予測）

| 改善案 | 期待改善 | 実装難度 | リスク | 優先度 |
|--------|---------|---------|-------|-------|
| **進入コース予測** | +0.5〜1.0% | ★★★ 高 | 中 | **🟡 中** |

**根拠**:
- 進入崩れは約5%のレースで発生（確認済み）
- 選手ごとの前付け傾向分析が必要
- 実装が複雑だが、1コース予測精度向上に直結

### Phase 4: 低効果・参考実装

| 改善案 | 期待改善 | 実装難度 | リスク | 優先度 |
|--------|---------|---------|-------|-------|
| 直近3走の傾向 | +0.2〜0.3% | ★★☆ 中 | 低 | **🟢 低** |
| 波高×体重 | +0.2〜0.3% | ★★☆ 中 | 低 | **🟢 低** |

---

## 3. 実装計画

### Phase 1: 設定変更（即日実装可能）

```
作業1-1: 会場別1コース勝率の除外
  - config/settings.py の SCORING_WEIGHTS 調整
  - extended_scorer.py から venue_in1 スコア計算を削除
  - バックテストで効果確認
  - 所要時間: 30分

作業1-2: モーター配点軽減
  - SCORING_WEIGHTS の motor を 20 → 12 に変更
  - 浮いた8ポイントを course と racer に4ずつ配分
  - 新配点: course=39, racer=39, motor=12, rank=10
  - バックテストで効果確認
  - 所要時間: 30分
```

### Phase 2: 展示ST・展示タイム改善

```
作業2-1: 展示ST混合スコア
  - race_predictor.py に展示ST取得ロジック追加
  - スコア計算: score = avg_st * 0.6 + exhibition_st * 0.4
  - 展示STが無い場合は avg_st のみ使用
  - バックテストで最適比率を探索
  - 所要時間: 2時間

作業2-2: 展示タイム順位評価
  - 現在の絶対値評価 → 順位ベース評価に変更
  - スコア: 1位=+20, 2位=+10, 3位=+5, 4位=0, 5位=-5, 6位=-10
  - extended_scorer.py を修正
  - 所要時間: 1時間
```

### Phase 3: 進入コース予測

```
作業3-1: 選手別前付け傾向分析
  - 過去データから選手ごとの枠なり崩れ率を算出
  - 前付け率 > 40% の選手をフラグ
  - racer_analyzer.py に機能追加
  - 所要時間: 3時間

作業3-2: 進入予測ルール実装
  - 前付け常習選手: コース移動予測
  - F持ち: 深イン回避傾向
  - ダッシュ派: 外コース維持
  - 所要時間: 2時間

作業3-3: スコアへの反映
  - 予測進入コースに基づくコーススコア調整
  - バックテストで効果検証
  - 所要時間: 2時間
```

---

## 4. 採用・不採用の判断

### ✅ 採用する改善案

| # | 改善案 | 理由 |
|---|--------|------|
| 1 | 会場別1コース勝率の除外 | ML分析で逆効果と実証済み |
| 2 | モーター配点軽減（20→12） | 影響度2.4%に対し過大配点 |
| 3 | 展示ST混合（過去:当日=6:4） | データ十分、高効果期待 |
| 4 | 展示タイム順位評価 | 相対評価の有効性は確認済み |
| 5 | 進入コース予測 | 1コース予測精度向上に直結 |

### ⏸️ 保留（Phase 4で検討）

| # | 改善案 | 理由 |
|---|--------|------|
| 6 | 直近3走の傾向 | 効果が小さい、実装コスト対効果が低い |
| 7 | 波高×体重 | 効果が小さい、波高データの欠損が多い |

---

## 5. 期待される改善効果

```
Phase 1 完了後: 58.75% → 59.5〜60.0%（+0.8〜1.3%）
Phase 2 完了後: 60.0%  → 61.5〜62.5%（+1.5〜2.5%）
Phase 3 完了後: 62.5%  → 62.5〜63.5%（+0〜1.0%）

最終目標: 62〜64%
```

---

## 6. 実装スケジュール

| Phase | 作業内容 | 推定作業量 |
|-------|---------|-----------|
| Phase 1 | 設定変更（会場・モーター） | 1時間 |
| Phase 2 | 展示ST・展示タイム改善 | 3時間 |
| Phase 3 | 進入コース予測 | 7時間 |
| テスト | バックテスト・検証 | 2時間 |

---

## 7. 次のアクション

1. **Phase 1を即座に実装し、効果を検証**
2. 効果確認後、Phase 2に進む
3. Phase 2完了後、Phase 3の必要性を再評価

---

## 補足: 進入崩れの実態（データ分析結果）

```
枠なり率（pit = actual_course）:
  1枠 → 1コース: 99.0%（ほぼ枠なり）
  2枠 → 2コース: 94.0%
  3枠 → 3コース: 91.3%
  4枠 → 4コース: 87.2%
  5枠 → 5コース: 81.4%
  6枠 → 6コース: 84.8%

主な枠なり崩れパターン:
  - 6枠 → 5コース: 10,975件（11.6%）← 前付け
  - 5枠 → 6コース: 10,975件（11.6%）
  - 4枠 → 5コース: 6,565件（7.0%）
```

内枠ほど枠なり率が高く、外枠で進入変動が多い。
特に5枠・6枠の前付け傾向のある選手を特定することが重要。
