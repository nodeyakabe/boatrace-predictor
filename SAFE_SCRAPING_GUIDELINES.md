# 安全なデータ取得ガイドライン

## リスク軽減策

### 1. 待機時間の調整

#### 現在の設定
```python
time.sleep(0.3)  # レース間: 0.3秒
time.sleep(1)    # 日付間: 1秒
```

#### 推奨設定（1年分取得時）
```python
time.sleep(1.0)   # レース間: 1秒（より安全）
time.sleep(3.0)   # 日付間: 3秒
random.sleep(0.5) # ランダム要素追加
```

**効果**:
- より人間らしいアクセスパターン
- サーバー負荷の軽減
- 検知リスクの低減

**デメリット**:
- 所要時間が3〜5倍に増加（30時間程度）

### 2. 分散実行

#### 方法A: 時間分散
```
- 1日目: 1月〜3月のデータ
- 2日目: 4月〜6月のデータ
- 3日目: 7月〜9月のデータ
- 4日目: 10月〜12月のデータ
```

#### 方法B: 競艇場分散
```
- 1日目: 競艇場1〜6
- 2日目: 競艇場7〜12
- 3日目: 競艇場13〜18
- 4日目: 競艇場19〜24
```

**効果**:
- 1回あたりのアクセス量削減
- 検知リスクの大幅低減

### 3. User-Agent のローテーション

#### 現在
```python
headers = {"User-Agent": "Mozilla/5.0"}
```

#### 推奨
```python
import random

USER_AGENTS = [
    "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
    "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36",
]

headers = {"User-Agent": random.choice(USER_AGENTS)}
```

### 4. エラーハンドリング強化

#### 403/429エラー対応
```python
if response.status_code == 403:
    print("アクセス拒否 - 待機時間を増やします")
    time.sleep(60)  # 1分待機
    retry()

if response.status_code == 429:
    print("リクエスト過多 - 長時間待機")
    time.sleep(300)  # 5分待機
    retry()
```

### 5. 深夜実行

#### 推奨時間帯
- **深夜2時〜5時**: サーバー負荷が低い
- **平日**: 週末より混雑が少ない

**設定例**:
```python
from datetime import datetime

current_hour = datetime.now().hour
if 2 <= current_hour <= 5:
    # 深夜は待機時間を短く
    wait_time = 0.5
else:
    # 日中は待機時間を長く
    wait_time = 2.0
```

## 推奨実行プラン（1年分）

### プランA: 安全重視（推奨）

**期間**: 4日間に分散
**1日あたり**: 3ヶ月分
**待機時間**: レース間1秒、日付間3秒
**実行時間帯**: 深夜2〜5時
**リスク**: **低**

### プランB: バランス

**期間**: 2日間に分散
**1日あたり**: 6ヶ月分
**待機時間**: レース間0.5秒、日付間2秒
**実行時間帯**: 深夜
**リスク**: **中**

### プランC: 速度重視（非推奨）

**期間**: 1日で全取得
**待機時間**: レース間0.3秒、日付間1秒
**実行時間帯**: いつでも
**リスク**: **高**

## 利用規約の確認

### チェック項目

1. [ ] robots.txt の確認
   - URL: https://www.boatrace.jp/robots.txt
   - スクレイピング可否の明示

2. [ ] 利用規約の確認
   - 自動アクセスの禁止条項
   - データ利用の制限

3. [ ] 個人利用の範囲
   - 商用利用は避ける
   - データの再配布は避ける

## モニタリング

### 実行中の監視項目

```python
# エラー率の監視
error_count = 0
total_requests = 0

if error_count / total_requests > 0.1:  # 10%以上
    print("⚠️ エラー率が高い - 実行を一時停止")
    time.sleep(600)  # 10分待機
```

### ログ記録

```python
# アクセスログ
logging.info(f"{datetime.now()} - {venue_code} {date} - Success")
logging.warning(f"{datetime.now()} - {venue_code} {date} - Error: {status_code}")
```

## まとめ

### ✅ 安全な実行のために

1. **待機時間を長めに設定** (1秒以上)
2. **深夜に実行**
3. **4日間に分散** (1日3ヶ月分)
4. **エラーが増えたら即停止**
5. **User-Agentをローテーション**

### ⚠️ やってはいけないこと

1. ❌ 待機時間なしで連続アクセス
2. ❌ 日中のピーク時間に大量取得
3. ❌ エラーを無視して継続
4. ❌ 同じUser-Agentで何万回もアクセス

### 📊 リスク vs 効率のバランス

| プラン | 期間 | リスク | 効率 | 推奨度 |
|--------|------|--------|------|--------|
| 4日分散 | 4日 | 低 | 低 | ⭐⭐⭐⭐⭐ |
| 2日分散 | 2日 | 中 | 中 | ⭐⭐⭐⭐ |
| 1日集中 | 1日 | 高 | 高 | ⭐⭐ |

**結論**: 4日分散プランを強く推奨
