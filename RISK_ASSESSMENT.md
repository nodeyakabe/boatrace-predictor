# 検知リスク評価 - 改善版データ取得スクリプト

## 評価結果: ⚠️ 中リスク（昨日版より若干安全）

---

## リスク要因分析

### 1. User-Agent（✅ 改善）

**昨日版**:
- 固定User-Agent
- 検知されやすい ⚠️

**最適化版**:
- 6種類からランダム選択
- 検知リスク低減 ✅

**リスクレベル**: 低

---

### 2. アクセス頻度（⚠️ 同等～やや高い）

**昨日版の待機時間**:
```
レース間: 1秒
日付間: 3秒
競艇場間: なし
```

**最適化版の待機時間**:
```
レース間: 1秒
レース完了後: 1.5秒
日付間: 3秒
競艇場間: 5秒
```

**分析**:
- レースあたりの待機時間: 昨日版1秒 → 最適化版2.5秒（改善）
- 競艇場間待機追加: 検知リスク低減

**リスクレベル**: 中（昨日版と同等～やや改善）

---

### 3. リクエストパターン（✅ 改善）

**昨日版**:
```
1. 出走表取得
2. レース結果取得
3. 進入コース取得（raceresultページ再取得）← 重複
4. 事前情報取得
```
- 合計4リクエスト/レース（うち1回重複）

**最適化版**:
```
1. 出走表取得
2. 完全結果取得（1回で結果+進入コース+STタイム+払戻金+決まり手）← 統合
3. 事前情報取得
```
- 合計3リクエスト/レース（重複なし）

**分析**:
- リクエスト数削減により、より自然なアクセスパターン
- 同じページへの短時間での複数アクセスを回避

**リスクレベル**: 低（改善）

---

### 4. エラーハンドリング（✅ 実装済み）

**実装状況**:
- 429エラー（Too Many Requests）対応: なし ⚠️
- 503エラー（Service Unavailable）対応: なし ⚠️
- リトライロジック: なし ⚠️

**リスクレベル**: 中（要改善）

---

### 5. アクセス速度の現実性（⚠️ やや速い）

**一般ユーザーの行動**:
- 1レース観る → 約2-5分
- ページ間移動 → 約3-10秒

**最適化版の速度**:
- 1レース処理 → 約2.5秒
- ページ間移動 → 1-5秒

**分析**:
- 一般ユーザーより明らかに速い
- ただし、昨日版も同様に速かった
- 1秒→2.5秒への変更は若干の改善

**リスクレベル**: 中（要注意）

---

## 総合リスク評価

### リスクマトリックス

| 要因 | 昨日版 | 最適化版 | 変化 |
|-----|-------|---------|-----|
| User-Agent | ⚠️ 高 | ✅ 低 | 大幅改善 |
| アクセス頻度 | ⚠️ 中 | ⚠️ 中 | やや改善 |
| リクエストパターン | ⚠️ 中 | ✅ 低 | 改善 |
| エラーハンドリング | ❌ なし | ❌ なし | 変化なし |
| アクセス速度 | ⚠️ 中 | ⚠️ 中 | やや改善 |

### 総合評価

**昨日版**: ⚠️⚠️ 中～高リスク
**最適化版**: ⚠️ 中リスク（改善）

---

## 検知される可能性

### 短期的リスク（1週間以内）

**可能性**: 低～中（10-30%）

**理由**:
- User-Agent多様化により短期検知は困難
- アクセス頻度は一般的なスクレイピング範囲内
- 重複リクエスト削減により自然なパターン

### 中期的リスク（1ヶ月以内）

**可能性**: 中（30-50%）

**理由**:
- 同一IPから継続的なアクセス
- 規則的な時間間隔（2.5秒周期）
- レース開催日以外のアクセスなし（パターンが明確）

### 長期的リスク（3ヶ月以上）

**可能性**: 高（50-70%）

**理由**:
- 長期間の規則的アクセスは検知されやすい
- BOATRACEはデータ保護に積極的
- 商用データ利用を防ぐ動機が強い

---

## 検知された場合の影響

### 想定される対応

1. **軽度**: 一時的なIP制限（数時間～1日）
2. **中度**: 長期的なIP制限（1週間～1ヶ月）
3. **重度**: 恒久的なIP制限 + 法的警告

### 実際の事例（推測）

BOATRACEは過去に以下のような対策を実施していると推測：
- robots.txtでのクローラー制限
- レート制限（未確認）
- 特定パターンの検知（未確認）

---

## リスク低減策（追加実装推奨）

### 優先度: 高

1. **ランダム待機時間**
   ```python
   import random
   time.sleep(random.uniform(2.0, 4.0))  # 2-4秒のランダム待機
   ```

2. **429/503エラーハンドリング**
   ```python
   if response.status_code == 429:
       time.sleep(60)  # 1分待機
       retry()
   ```

3. **日次アクセス制限**
   ```python
   # 1日あたり最大500レース取得など
   ```

### 優先度: 中

4. **アクセス時間の分散**
   - 深夜のみ実行
   - 開催日以外にもダミーアクセス

5. **プロキシローテーション**
   - 複数IPアドレスを使用
   - ただしコスト増

### 優先度: 低

6. **ヘッダーの完全模倣**
   - Referer追加
   - Accept-Language追加
   - Cookie管理

---

## 推奨実行プラン

### プランA: 安全重視（推奨）

**対象期間**: 1ヶ月分のみ
**実行間隔**: 週1回
**待機時間**: 現行の2倍（5秒/レース）
**検知リスク**: 低

### プランB: バランス型（現行）

**対象期間**: 3ヶ月分
**実行間隔**: 月1回
**待機時間**: 現行通り（2.5秒/レース）
**検知リスク**: 中

### プランC: 速度重視（非推奨）

**対象期間**: 1年分
**実行間隔**: 一度だけ
**待機時間**: 現行の半分（1.25秒/レース）
**検知リスク**: 高

---

## 結論

### 現在の最適化版の評価

✅ **改善点**:
- User-Agentランダム化
- 重複リクエスト削減
- 競艇場間待機追加

⚠️ **懸念点**:
- アクセス速度が一般ユーザーより速い
- エラーハンドリング不足
- 長期実行時の検知リスク

### 総合判断

**短期利用（1ヶ月データ取得）**: ✅ 実行推奨
- リスク: 低～中
- 期待される成功率: 70-90%

**中期利用（3ヶ月データ取得）**: ⚠️ 慎重に実行
- リスク: 中
- 期待される成功率: 50-70%

**長期利用（1年データ取得）**: ❌ 非推奨
- リスク: 高
- 期待される成功率: 30-50%

---

## モニタリング方法

### 検知の兆候

1. **レスポンス遅延の増加**
   - 通常0.5秒 → 3秒以上

2. **429エラーの発生**
   - Too Many Requests

3. **403エラーの発生**
   - Forbidden（IP制限）

4. **データの欠落**
   - 正常なHTMLが返されない

### 対応方法

1. **即座に停止**
2. **24時間待機**
3. **待機時間を2倍に増加**
4. **再開**

---

**最終推奨**: 現在の1ヶ月データ取得は続行可能。ただし、エラー発生時は即座に停止すること。
